[{"title":"面试题(网络搜集)四","date":"2019-09-17T08:54:26.000Z","path":"2019/09/17/面试题-网络搜集-四/","content":"<h2 id=\"31-算法\"><a href=\"#31-算法\" class=\"headerlink\" title=\"31. 算法\"></a>31. 算法</h2><a id=\"more\"></a>\n\n<p>在utf8字符串判断是否包含指定字符串，并返回下标。<br>“北京天安门最美丽” , “天安门”<br>结果：2</p>\n<p>解答：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"strings\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tfmt.Println(Utf8Index(<span class=\"string\">\"北京天安门最美丽\"</span>, <span class=\"string\">\"天安门\"</span>))</span><br><span class=\"line\">\tfmt.Println(strings.Index(<span class=\"string\">\"北京天安门最美丽\"</span>, <span class=\"string\">\"男\"</span>))</span><br><span class=\"line\">\tfmt.Println(strings.Index(<span class=\"string\">\"\"</span>, <span class=\"string\">\"男\"</span>))</span><br><span class=\"line\">\tfmt.Println(Utf8Index(<span class=\"string\">\"12ws北京天安门最美丽\"</span>, <span class=\"string\">\"天安门\"</span>))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Utf8Index</span><span class=\"params\">(str, substr <span class=\"keyword\">string</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\tasciiPos := strings.Index(str, substr)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> asciiPos == <span class=\"number\">-1</span> || asciiPos == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> asciiPos</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpos := <span class=\"number\">0</span></span><br><span class=\"line\">\ttotalSize := <span class=\"number\">0</span></span><br><span class=\"line\">\treader := strings.NewReader(str)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, size, err := reader.ReadRune(); err == <span class=\"literal\">nil</span>; _, size, err = reader.ReadRune() &#123;</span><br><span class=\"line\">\t\ttotalSize += size</span><br><span class=\"line\">\t\tpos++</span><br><span class=\"line\">\t\t<span class=\"comment\">// 匹配到</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> totalSize == asciiPos &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> pos</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> pos</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"32，编程\"><a href=\"#32，编程\" class=\"headerlink\" title=\"32，编程\"></a>32，编程</h2><p>实现一个单例</p>\n<p>解答：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"sync\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 实现一个单例</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> singleton <span class=\"keyword\">struct</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> ins *singleton</span><br><span class=\"line\"><span class=\"keyword\">var</span> mu sync.Mutex</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//懒汉加锁:虽然解决并发的问题，但每次加锁是要付出代价的</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetIns</span><span class=\"params\">()</span> *<span class=\"title\">singleton</span></span> &#123;</span><br><span class=\"line\">\tmu.Lock()</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> mu.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ins == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tins = &amp;singleton&#123;&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ins</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//双重锁:避免了每次加锁，提高代码效率</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetIns1</span><span class=\"params\">()</span> *<span class=\"title\">singleton</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ins == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tmu.Lock()</span><br><span class=\"line\">\t\t<span class=\"keyword\">defer</span> mu.Unlock()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ins == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tins = &amp;singleton&#123;&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ins</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//sync.Once实现</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> once sync.Once</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetIns2</span><span class=\"params\">()</span> *<span class=\"title\">singleton</span></span> &#123;</span><br><span class=\"line\">\tonce.Do(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tins = &amp;singleton&#123;&#125;</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ins</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"33-执行下面的代码发生什么？\"><a href=\"#33-执行下面的代码发生什么？\" class=\"headerlink\" title=\"33,执行下面的代码发生什么？\"></a>33,执行下面的代码发生什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tch := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">1000</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++ &#123;</span><br><span class=\"line\">\t\t\tch &lt;- i</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t\ta, ok := &lt;-ch</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !ok &#123;</span><br><span class=\"line\">\t\t\t\tfmt.Println(<span class=\"string\">\"close\"</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">\"a: \"</span>, a)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"built_in\">close</span>(ch)</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"ok\"</span>)</span><br><span class=\"line\">\ttime.Sleep(time.Second * <span class=\"number\">100</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"考点-channel\"><a href=\"#考点-channel\" class=\"headerlink\" title=\"考点:channel\"></a>考点:<strong>channel</strong></h3><p>往已经关闭的channel写入数据会panic的。<br>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">panic: send on closed channel</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"34-执行下面的代码发生什么？\"><a href=\"#34-执行下面的代码发生什么？\" class=\"headerlink\" title=\"34,执行下面的代码发生什么？\"></a>34,执行下面的代码发生什么？</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">type ConfigOne struct &#123;</span><br><span class=\"line\">\tDaemon string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (c *ConfigOne) String() string &#123;</span><br><span class=\"line\">\treturn fmt.Sprintf(&quot;print: %v&quot;, p)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tc := &amp;ConfigOne&#123;&#125;</span><br><span class=\"line\">\tc.String()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"考点-fmt-Sprintf\"><a href=\"#考点-fmt-Sprintf\" class=\"headerlink\" title=\"考点:fmt.Sprintf\"></a>考点:<strong>fmt.Sprintf</strong></h3><p>如果类型实现String()，％v和％v格式将使用String()的值。因此，对该类型的String()函数内的类型使用％v会导致无限递归。<br>编译报错：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">runtime: goroutine stack exceeds 1000000000-byte limit</span><br><span class=\"line\">fatal error: stack overflow</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"35，编程题\"><a href=\"#35，编程题\" class=\"headerlink\" title=\"35，编程题\"></a>35，编程题</h2><p>反转整数<br>反转一个整数，例如：</p>\n<p>例子1: x = 123, return 321<br>例子2: x = -123, return -321  </p>\n<p>输入的整数要求是一个 32bit 有符号数，如果反转后溢出，则输出 0  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func reverse(x int) (num int) &#123;</span><br><span class=\"line\">\tfor x != 0 &#123;</span><br><span class=\"line\">\t\tnum = num*10 + x%10</span><br><span class=\"line\">\t\tx = x / 10</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 使用 math 包中定义好的最大最小值</span><br><span class=\"line\">\tif num &gt; math.MaxInt32 || num &lt; math.MinInt32 &#123;</span><br><span class=\"line\">\t\treturn 0</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"36，编程题\"><a href=\"#36，编程题\" class=\"headerlink\" title=\"36，编程题\"></a>36，编程题</h2><p>合并重叠区间<br>给定一组 区间，合并所有重叠的 区间。</p>\n<p>例如：<br>给定：[1,3],[2,6],[8,10],[15,18]<br>返回：[1,6],[8,10],[15,18]</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Interval struct &#123;</span><br><span class=\"line\">\tStart int</span><br><span class=\"line\">\tEnd   int</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func merge(intervals []Interval) []Interval &#123;</span><br><span class=\"line\">\tif len(intervals) &lt;= 1 &#123;</span><br><span class=\"line\">\t\treturn intervals</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsort.Slice(intervals, func(i, j int) bool &#123;</span><br><span class=\"line\">\t\treturn intervals[i].Start &lt; intervals[j].Start</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tres := make([]Interval, 0)</span><br><span class=\"line\">\tswap := Interval&#123;&#125;</span><br><span class=\"line\">\tfor k, v := range intervals &#123;</span><br><span class=\"line\">\t\tif k == 0 &#123;</span><br><span class=\"line\">\t\t\tswap = v</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif v.Start &lt;= swap.End &#123;</span><br><span class=\"line\">\t\t\tswap.End = v.End</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\tres = append(res, swap)</span><br><span class=\"line\">\t\t\tswap = v</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tres = append(res, swap)</span><br><span class=\"line\">\treturn res</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"37-输出什么？\"><a href=\"#37-输出什么？\" class=\"headerlink\" title=\"37.输出什么？\"></a>37.输出什么？</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t&quot;fmt&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tfmt.Println(len(&quot;你好bj!&quot;))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"考点-编码长度\"><a href=\"#考点-编码长度\" class=\"headerlink\" title=\"考点:编码长度\"></a>考点:<strong>编码长度</strong></h3><p>输出9</p>\n<h2 id=\"38-编译并运行如下代码会发生什么？\"><a href=\"#38-编译并运行如下代码会发生什么？\" class=\"headerlink\" title=\"38.编译并运行如下代码会发生什么？\"></a>38.编译并运行如下代码会发生什么？</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">type Test struct &#123;</span><br><span class=\"line\">\tName string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">var list map[string]Test</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlist = make(map[string]Test)</span><br><span class=\"line\">\tname := Test&#123;&quot;xiaoming&quot;&#125;</span><br><span class=\"line\">\tlist[&quot;name&quot;] = name</span><br><span class=\"line\">\tlist[&quot;name&quot;].Name = &quot;Hello&quot;</span><br><span class=\"line\">\tfmt.Println(list[&quot;name&quot;])</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"考点-map\"><a href=\"#考点-map\" class=\"headerlink\" title=\"考点:map\"></a>考点:<strong>map</strong></h3><p>编程报错<code>cannot assign to struct field list[&quot;name&quot;].Name in map</code>。\n因为list[“name”]不是一个普通的指针值，map的value本身是不可寻址的，因为map中的值会在内存中移动，并且旧的指针地址在map改变时会变得无效。<br>定义的是var list map[string]Test，注意哦Test不是指针，而且map我们都知道是可以自动扩容的，那么原来的存储name的Test可能在地址A，但是如果map扩容了地址A就不是原来的Test了，所以go就不允许我们写数据。你改为var list map[string]*Test试试看。</p>\n<h2 id=\"39-ABCD中哪一行存在错误？\"><a href=\"#39-ABCD中哪一行存在错误？\" class=\"headerlink\" title=\"39.ABCD中哪一行存在错误？\"></a>39.ABCD中哪一行存在错误？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> S <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">f</span><span class=\"params\">(x <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">g</span><span class=\"params\">(x *<span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ts := S&#123;&#125;</span><br><span class=\"line\">\tp := &amp;s</span><br><span class=\"line\">\tf(s) <span class=\"comment\">//A</span></span><br><span class=\"line\">\tg(s) <span class=\"comment\">//B</span></span><br><span class=\"line\">\tf(p) <span class=\"comment\">//C</span></span><br><span class=\"line\">\tg(p) <span class=\"comment\">//D</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"考点-interface\"><a href=\"#考点-interface\" class=\"headerlink\" title=\"考点:interface\"></a>考点:<strong>interface</strong></h3><p>看到这道题需要第一时间想到的是Golang是强类型语言，interface是所有golang类型的父类，类似Java的Object。<br>函数中<code>func f(x interface{})</code>的<code>interface{}</code>可以支持传入golang的任何类型，包括指针，但是函数<code>func g(x *interface{})</code>只能接受<code>*interface{}</code>.</p>\n<h2 id=\"40-编译并运行如下代码会发生什么？\"><a href=\"#40-编译并运行如下代码会发生什么？\" class=\"headerlink\" title=\"40.编译并运行如下代码会发生什么？\"></a>40.编译并运行如下代码会发生什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"sync\"</span></span><br><span class=\"line\">\t<span class=\"comment\">//\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> N = <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> wg = &amp;sync.WaitGroup&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; N; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\t\t\twg.Add(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">println</span>(i)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">defer</span> wg.Done()</span><br><span class=\"line\">\t\t&#125;(i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\twg.Wait()</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"考点-WaitGroup\"><a href=\"#考点-WaitGroup\" class=\"headerlink\" title=\"考点:WaitGroup\"></a>考点:<strong>WaitGroup</strong></h3><p>这是使用WaitGroup经常犯下的错误！请各位同学多次运行就会发现输出都会不同甚至又出现报错的问题。<br>这是因为<code>go</code>执行太快了，导致<code>wg.Add(1)</code>还没有执行main函数就执行完毕了。<br>改为如下试试</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for i := 0; i &lt; N; i++ &#123;</span><br><span class=\"line\">        wg.Add(1)</span><br><span class=\"line\">\t\tgo func(i int) &#123;</span><br><span class=\"line\">\t\t\tprintln(i)</span><br><span class=\"line\">\t\t\tdefer wg.Done()</span><br><span class=\"line\">\t\t&#125;(i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\twg.Wait()</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h2><p><a href=\"https://zhuanlan.zhihu.com/p/35058068?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/35058068?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a></p>\n<p><a href=\"https://stackoverflow.com/questions/42600920/runtime-goroutine-stack-exceeds-1000000000-byte-limit-fatal-error-stack-overf\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/42600920/runtime-goroutine-stack-exceeds-1000000000-byte-limit-fatal-error-stack-overf</a></p>\n<p><a href=\"https://studygolang.com/topics/3853\" target=\"_blank\" rel=\"noopener\">https://studygolang.com/topics/3853</a></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"面试","slug":"面试","permalink":"chunlife.top/tags/面试/"}]},{"title":"面试题(网络搜集)三","date":"2019-09-17T08:53:42.000Z","path":"2019/09/17/面试题-网络搜集-三/","content":"<h1 id=\"21-编译执行下面代码会出现什么\"><a href=\"#21-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"21.编译执行下面代码会出现什么?\"></a>21.编译执行下面代码会出现什么?</h1><a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"><span class=\"keyword\">var</span>(</span><br><span class=\"line\">    size :=<span class=\"number\">1024</span></span><br><span class=\"line\">    max_size = size*<span class=\"number\">2</span></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">println</span>(size,max_size)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析\"><a href=\"#解析\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点:<strong>变量简短模式</strong><br>变量简短模式限制：</p>\n<ul>\n<li>定义变量同时显式初始化</li>\n<li>不能提供数据类型</li>\n<li>只能在函数内部使用</li>\n</ul>\n<p>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">syntax error: unexpected :=</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"22-下面函数有什么问题？\"><a href=\"#22-下面函数有什么问题？\" class=\"headerlink\" title=\"22.下面函数有什么问题？\"></a>22.下面函数有什么问题？</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\">const cl  = 100</span><br><span class=\"line\"></span><br><span class=\"line\">var bl    = 123</span><br><span class=\"line\"></span><br><span class=\"line\">func main()  &#123;</span><br><span class=\"line\">    println(&amp;bl,bl)</span><br><span class=\"line\">    println(&amp;cl,cl)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-1\"><a href=\"#解析-1\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点:<strong>常量</strong><br>常量不同于变量的在运行期分配内存，常量通常会被编译器在预处理阶段直接展开，作为指令数据使用，</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cannot take the address of cl</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"23-编译执行下面代码会出现什么\"><a href=\"#23-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"23.编译执行下面代码会出现什么?\"></a>23.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">func main()  &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    for i:=0;i&lt;10 ;i++  &#123;</span><br><span class=\"line\">    loop:</span><br><span class=\"line\">        println(i)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    goto loop</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-2\"><a href=\"#解析-2\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：<strong>goto</strong><br>goto不能跳转到其他函数或者内层代码</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">goto loop jumps into block starting at</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"24-编译执行下面代码会出现什么\"><a href=\"#24-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"24.编译执行下面代码会出现什么?\"></a>24.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">func main()  &#123;</span><br><span class=\"line\">    type MyInt1 int</span><br><span class=\"line\">    type MyInt2 = int</span><br><span class=\"line\">    var i int =9</span><br><span class=\"line\">    var i1 MyInt1 = i</span><br><span class=\"line\">    var i2 MyInt2 = i</span><br><span class=\"line\">    fmt.Println(i1,i2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-3\"><a href=\"#解析-3\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：*<em>Go 1.9 新特性 Type Alias *</em><br>基于一个类型创建一个新类型，称之为defintion；基于一个类型创建一个别名，称之为alias。<br>MyInt1为称之为defintion，虽然底层类型为int类型，但是不能直接赋值，需要强转；<br>MyInt2称之为alias，可以直接赋值。</p>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cannot use i (type int) as type MyInt1 in assignment</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"25-编译执行下面代码会出现什么\"><a href=\"#25-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"25.编译执行下面代码会出现什么?\"></a>25.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">type User struct &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type MyUser1 User</span><br><span class=\"line\">type MyUser2 = User</span><br><span class=\"line\">func (i MyUser1) m1()&#123;</span><br><span class=\"line\">    fmt.Println(&quot;MyUser1.m1&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (i User) m2()&#123;</span><br><span class=\"line\">    fmt.Println(&quot;User.m2&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    var i1 MyUser1</span><br><span class=\"line\">    var i2 MyUser2</span><br><span class=\"line\">    i1.m1()</span><br><span class=\"line\">    i2.m2()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-4\"><a href=\"#解析-4\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：*<em>Go 1.9 新特性 Type Alias *</em><br>因为MyUser2完全等价于User，所以具有其所有的方法，并且其中一个新增了方法，另外一个也会有。<br>但是</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">i1.m2()</span><br></pre></td></tr></table></figure>\n\n<p>是不能执行的，因为MyUser1没有定义该方法。<br>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyUser1.m1</span><br><span class=\"line\">User.m2</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"26-编译执行下面代码会出现什么\"><a href=\"#26-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"26.编译执行下面代码会出现什么?\"></a>26.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">type T1 struct &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (t T1) m1()&#123;</span><br><span class=\"line\">    fmt.Println(&quot;T1.m1&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type T2 = T1</span><br><span class=\"line\">type MyStruct struct &#123;</span><br><span class=\"line\">    T1</span><br><span class=\"line\">    T2</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    my:=MyStruct&#123;&#125;</span><br><span class=\"line\">    my.m1()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-5\"><a href=\"#解析-5\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：*<em>Go 1.9 新特性 Type Alias *</em><br>是不能正常编译的,异常：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ambiguous selector my.m1</span><br></pre></td></tr></table></figure>\n\n<p>结果不限于方法，字段也也一样；也不限于type alias，type defintion也是一样的，只要有重复的方法、字段，就会有这种提示，因为不知道该选择哪个。<br>改为:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">my.T1.m1()</span><br><span class=\"line\">my.T2.m1()</span><br></pre></td></tr></table></figure>\n\n<p>type alias的定义，本质上是一样的类型，只是起了一个别名，源类型怎么用，别名类型也怎么用，保留源类型的所有方法、字段等。</p>\n<h1 id=\"27-编译执行下面代码会出现什么\"><a href=\"#27-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"27.编译执行下面代码会出现什么?\"></a>27.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;errors&quot;</span><br><span class=\"line\">    &quot;fmt&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">var ErrDidNotWork = errors.New(&quot;did not work&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">func DoTheThing(reallyDoIt bool) (err error) &#123;</span><br><span class=\"line\">    if reallyDoIt &#123;</span><br><span class=\"line\">        result, err := tryTheThing()</span><br><span class=\"line\">        if err != nil || result != &quot;it worked&quot; &#123;</span><br><span class=\"line\">            err = ErrDidNotWork</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func tryTheThing() (string,error)  &#123;</span><br><span class=\"line\">    return &quot;&quot;,ErrDidNotWork</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    fmt.Println(DoTheThing(true))</span><br><span class=\"line\">    fmt.Println(DoTheThing(false))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-6\"><a href=\"#解析-6\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：<strong>变量作用域</strong><br>因为 if 语句块内的 err 变量会遮罩函数作用域内的 err 变量，结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;nil&gt;</span><br><span class=\"line\">&lt;nil&gt;</span><br></pre></td></tr></table></figure>\n\n<p>改为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func DoTheThing(reallyDoIt bool) (err error) &#123;</span><br><span class=\"line\">    var result string</span><br><span class=\"line\">    if reallyDoIt &#123;</span><br><span class=\"line\">        result, err = tryTheThing()</span><br><span class=\"line\">        if err != nil || result != &quot;it worked&quot; &#123;</span><br><span class=\"line\">            err = ErrDidNotWork</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"28-编译执行下面代码会出现什么\"><a href=\"#28-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"28.编译执行下面代码会出现什么?\"></a>28.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">func test() []func()  &#123;</span><br><span class=\"line\">    var funs []func()</span><br><span class=\"line\">    for i:=0;i&lt;2 ;i++  &#123;</span><br><span class=\"line\">        funs = append(funs, func() &#123;</span><br><span class=\"line\">            println(&amp;i,i)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return funs</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main()&#123;</span><br><span class=\"line\">    funs:=test()</span><br><span class=\"line\">    for _,f:=range funs&#123;</span><br><span class=\"line\">        f()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-7\"><a href=\"#解析-7\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：<strong>闭包延迟求值</strong><br>for循环复用局部变量i，每一次放入匿名函数的应用都是想一个变量。<br>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0xc042046000 2</span><br><span class=\"line\">0xc042046000 2</span><br></pre></td></tr></table></figure>\n\n<p>如果想不一样可以改为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func test() []func()  &#123;</span><br><span class=\"line\">    var funs []func()</span><br><span class=\"line\">    for i:=0;i&lt;2 ;i++  &#123;</span><br><span class=\"line\">        x:=i</span><br><span class=\"line\">        funs = append(funs, func() &#123;</span><br><span class=\"line\">            println(&amp;x,x)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return funs</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"29-编译执行下面代码会出现什么\"><a href=\"#29-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"29.编译执行下面代码会出现什么?\"></a>29.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">func test(x int) (func(),func())  &#123;</span><br><span class=\"line\">    return func() &#123;</span><br><span class=\"line\">        println(x)</span><br><span class=\"line\">        x+=10</span><br><span class=\"line\">    &#125;, func() &#123;</span><br><span class=\"line\">        println(x)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main()  &#123;</span><br><span class=\"line\">    a,b:=test(100)</span><br><span class=\"line\">    a()</span><br><span class=\"line\">    b()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-8\"><a href=\"#解析-8\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：<strong>闭包引用相同变量*</strong><br>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">100</span><br><span class=\"line\">110</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"30-编译执行下面代码会出现什么\"><a href=\"#30-编译执行下面代码会出现什么\" class=\"headerlink\" title=\"30.编译执行下面代码会出现什么?\"></a>30.编译执行下面代码会出现什么?</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;fmt&quot;</span><br><span class=\"line\">    &quot;reflect&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func main1()  &#123;</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">       if err:=recover();err!=nil&#123;</span><br><span class=\"line\">           fmt.Println(err)</span><br><span class=\"line\">       &#125;else &#123;</span><br><span class=\"line\">           fmt.Println(&quot;fatal&quot;)</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        panic(&quot;defer panic&quot;)</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    panic(&quot;panic&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main()  &#123;</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        if err:=recover();err!=nil&#123;</span><br><span class=\"line\">            fmt.Println(&quot;++++&quot;)</span><br><span class=\"line\">            f:=err.(func()string)</span><br><span class=\"line\">            fmt.Println(err,f(),reflect.TypeOf(err).Kind().String())</span><br><span class=\"line\">        &#125;else &#123;</span><br><span class=\"line\">            fmt.Println(&quot;fatal&quot;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        panic(func() string &#123;</span><br><span class=\"line\">            return  &quot;defer panic&quot;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    panic(&quot;panic&quot;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析-9\"><a href=\"#解析-9\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>考点：<strong>panic仅有最后一个可以被revover捕获</strong><br>触发<code>panic(&quot;panic&quot;)</code>后顺序执行defer，但是defer中还有一个panic，所以覆盖了之前的<code>panic(&quot;panic&quot;)</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">defer panic</span><br></pre></td></tr></table></figure>","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"面试","slug":"面试","permalink":"chunlife.top/tags/面试/"}]},{"title":"面试题(网络搜集)二","date":"2019-09-17T08:50:18.000Z","path":"2019/09/17/面试题-网络搜集-二/","content":"<h2 id=\"12-是否可以编译通过？如果通过，输出什么？\"><a href=\"#12-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"12.是否可以编译通过？如果通过，输出什么？\"></a>12.是否可以编译通过？如果通过，输出什么？</h2><a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ti := GetValue()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> i.(<span class=\"keyword\">type</span>) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"keyword\">int</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"int\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"keyword\">string</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"string\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"keyword\">interface</span>&#123;&#125;:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"interface\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"unknown\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetValue</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析\"><a href=\"#解析\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点：<strong>type</strong></p>\n<p>编译失败，因为type只能使用在interface</p>\n<h2 id=\"13-下面函数有什么问题？\"><a href=\"#13-下面函数有什么问题？\" class=\"headerlink\" title=\"13.下面函数有什么问题？\"></a>13.下面函数有什么问题？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">funcMui</span><span class=\"params\">(x,y <span class=\"keyword\">int</span>)</span><span class=\"params\">(sum <span class=\"keyword\">int</span>,error)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> x+y,<span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-1\"><a href=\"#解析-1\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点：<strong>函数返回值命名</strong><br>在函数有多个返回值时，只要有一个返回值有指定命名，其他的也必须有命名。<br>如果返回值有有多个返回值必须加上括号；<br>如果只有一个返回值并且有命名也需要加上括号；<br>此处函数第一个返回值有sum名称，第二个未命名，所以错误。</p>\n<h2 id=\"14-是否可以编译通过？如果通过，输出什么？\"><a href=\"#14-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"14.是否可以编译通过？如果通过，输出什么？\"></a>14.是否可以编译通过？如果通过，输出什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">println</span>(DeferFunc1(<span class=\"number\">1</span>))</span><br><span class=\"line\">\t<span class=\"built_in\">println</span>(DeferFunc2(<span class=\"number\">1</span>))</span><br><span class=\"line\">\t<span class=\"built_in\">println</span>(DeferFunc3(<span class=\"number\">1</span>))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">DeferFunc1</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span> <span class=\"params\">(t <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tt = i</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tt += <span class=\"number\">3</span></span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">DeferFunc2</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\tt := i</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tt += <span class=\"number\">3</span></span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">DeferFunc3</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span> <span class=\"params\">(t <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tt += i</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">2</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-2\"><a href=\"#解析-2\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点:<strong>defer和函数返回值</strong><br>需要明确一点是defer需要在函数结束前执行。<br>函数返回值名字会在函数起始处被初始化为对应类型的零值并且作用域为整个函数<br>DeferFunc1有函数返回值t作用域为整个函数，在return之前defer会被执行，所以t会被修改，返回4;<br>DeferFunc2函数中t的作用域为函数，返回1;<br>DeferFunc3返回3</p>\n<h2 id=\"15-是否可以编译通过？如果通过，输出什么？\"><a href=\"#15-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"15.是否可以编译通过？如果通过，输出什么？\"></a>15.是否可以编译通过？如果通过，输出什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlist := <span class=\"built_in\">new</span>([]<span class=\"keyword\">int</span>)</span><br><span class=\"line\">\tlist = <span class=\"built_in\">append</span>(list, <span class=\"number\">1</span>)</span><br><span class=\"line\">\tfmt.Println(list)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-3\"><a href=\"#解析-3\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点：<strong>new</strong><br>list:=make([]int,0)</p>\n<h2 id=\"16-是否可以编译通过？如果通过，输出什么？\"><a href=\"#16-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"16.是否可以编译通过？如果通过，输出什么？\"></a>16.是否可以编译通过？如果通过，输出什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ts1 := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;</span><br><span class=\"line\">\ts2 := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">4</span>, <span class=\"number\">5</span>&#125;</span><br><span class=\"line\">\ts1 = <span class=\"built_in\">append</span>(s1, s2)</span><br><span class=\"line\">\tfmt.Println(s1)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-4\"><a href=\"#解析-4\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点：<strong>append</strong><br>append切片时候别漏了’…’</p>\n<h2 id=\"17-是否可以编译通过？如果通过，输出什么？\"><a href=\"#17-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"17.是否可以编译通过？如果通过，输出什么？\"></a>17.是否可以编译通过？如果通过，输出什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsn1 := <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tage  <span class=\"keyword\">int</span></span><br><span class=\"line\">\t\tname <span class=\"keyword\">string</span></span><br><span class=\"line\">\t&#125;&#123;age: <span class=\"number\">11</span>, name: <span class=\"string\">\"qq\"</span>&#125;</span><br><span class=\"line\">\tsn2 := <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tage  <span class=\"keyword\">int</span></span><br><span class=\"line\">\t\tname <span class=\"keyword\">string</span></span><br><span class=\"line\">\t&#125;&#123;age: <span class=\"number\">11</span>, name: <span class=\"string\">\"qq\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> sn1 == sn2 &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"sn1 == sn2\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsm1 := <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tage <span class=\"keyword\">int</span></span><br><span class=\"line\">\t\tm   <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span></span><br><span class=\"line\">\t&#125;&#123;age: <span class=\"number\">11</span>, m: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"a\"</span>: <span class=\"string\">\"1\"</span>&#125;&#125;</span><br><span class=\"line\">\tsm2 := <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tage <span class=\"keyword\">int</span></span><br><span class=\"line\">\t\tm   <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span></span><br><span class=\"line\">\t&#125;&#123;age: <span class=\"number\">11</span>, m: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"a\"</span>: <span class=\"string\">\"1\"</span>&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> sm1 == sm2 &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"sm1 == sm2\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-5\"><a href=\"#解析-5\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点:<strong>结构体比较</strong><br>进行结构体比较时候，只有相同类型的结构体才可以比较，结构体是否相同不但与属性类型个数有关，还与属性顺序相关。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sn3:= struct &#123;</span><br><span class=\"line\">    name string</span><br><span class=\"line\">    age  int</span><br><span class=\"line\">&#125;&#123;age:11,name:&quot;qq&quot;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>sn3与sn1就不是相同的结构体了，不能比较。<br>还有一点需要注意的是结构体是相同的，但是结构体属性中有不可以比较的类型，如map,slice。<br>如果该结构属性都是可以比较的，那么就可以使用“==”进行比较操作。</p>\n<p>可以使用reflect.DeepEqual进行比较</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if reflect.DeepEqual(sn1, sm) &#123;</span><br><span class=\"line\">    fmt.Println(&quot;sn1 ==sm&quot;)</span><br><span class=\"line\">&#125;else &#123;</span><br><span class=\"line\">    fmt.Println(&quot;sn1 !=sm&quot;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>所以编译不通过： invalid operation: sm1 == sm2</p>\n<h2 id=\"18-是否可以编译通过？如果通过，输出什么？\"><a href=\"#18-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"18.是否可以编译通过？如果通过，输出什么？\"></a>18.是否可以编译通过？如果通过，输出什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Foo</span><span class=\"params\">(x <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> x == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"empty interface\"</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"non-empty interface\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> x *<span class=\"keyword\">int</span> = <span class=\"literal\">nil</span></span><br><span class=\"line\">\tFoo(x)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-6\"><a href=\"#解析-6\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点：<strong>interface内部结构</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">non-empty interface</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"19-是否可以编译通过？如果通过，输出什么？\"><a href=\"#19-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"19.是否可以编译通过？如果通过，输出什么？\"></a>19.是否可以编译通过？如果通过，输出什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetValue</span><span class=\"params\">(m <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">string</span>, id <span class=\"keyword\">int</span>)</span> <span class=\"params\">(<span class=\"keyword\">string</span>, <span class=\"keyword\">bool</span>)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _, exist := m[id]; exist &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"存在数据\"</span>, <span class=\"literal\">true</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tintmap:=<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">string</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"number\">1</span>:<span class=\"string\">\"a\"</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">2</span>:<span class=\"string\">\"bb\"</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">3</span>:<span class=\"string\">\"ccc\"</span>,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tv,err:=GetValue(intmap,<span class=\"number\">3</span>)</span><br><span class=\"line\">\tfmt.Println(v,err)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-7\"><a href=\"#解析-7\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点：<strong>函数返回值类型</strong><br>nil 可以用作 interface、function、pointer、map、slice 和 channel 的“空值”。但是如果不特别指定的话，Go 语言不能识别类型，所以会报错。通常编译的时候不会报错，但是运行是时候会报:<code>cannot use nil as type string in return argument</code>.</p>\n<h2 id=\"20-是否可以编译通过？如果通过，输出什么？\"><a href=\"#20-是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"20.是否可以编译通过？如果通过，输出什么？\"></a>20.是否可以编译通过？如果通过，输出什么？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tx = <span class=\"literal\">iota</span></span><br><span class=\"line\">\ty</span><br><span class=\"line\">\tz = <span class=\"string\">\"zz\"</span></span><br><span class=\"line\">\tk</span><br><span class=\"line\">\tp = <span class=\"literal\">iota</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tfmt.Println(x,y,z,k,p)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析-8\"><a href=\"#解析-8\" class=\"headerlink\" title=\"解析\"></a>解析</h3><p>考点：<strong>iota</strong><br>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0 1 zz zz 4</span><br></pre></td></tr></table></figure>","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"面试","slug":"面试","permalink":"chunlife.top/tags/面试/"}]},{"title":"面试题(网络搜集)一","date":"2019-09-17T08:46:40.000Z","path":"2019/09/17/面试题-网络搜集-一/","content":"<p>最近在很多地方看到了<a href=\"https://zhuanlan.zhihu.com/p/26972862\" target=\"_blank\" rel=\"noopener\">golang的面试题</a>，看到了很多人对Golang的面试题心存恐惧，也是为了复习基础，我把解题的过程总结下来。</p>\n<h2 id=\"面试题一\"><a href=\"#面试题一\" class=\"headerlink\" title=\"面试题一\"></a>面试题一</h2><a id=\"more\"></a>\n\n<h3 id=\"1-写出下面代码输出内容。\"><a href=\"#1-写出下面代码输出内容。\" class=\"headerlink\" title=\"1. 写出下面代码输出内容。\"></a>1. 写出下面代码输出内容。</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    defer_call()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">defer_call</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123; fmt.Println(<span class=\"string\">\"打印前\"</span>) &#125;()</span><br><span class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123; fmt.Println(<span class=\"string\">\"打印中\"</span>) &#125;()</span><br><span class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123; fmt.Println(<span class=\"string\">\"打印后\"</span>) &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">panic</span>(<span class=\"string\">\"触发异常\"</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>defer执行顺序</strong><br>解答：<br>defer 是<strong>后进先出</strong>。\n协程遇到panic时，遍历本协程的defer链表，并执行defer。在执行defer过程中，遇到recover则停止panic，返回recover处继续往下执行。如果没有遇到recover，遍历完本协程的defer链表后，向stderr抛出panic信息。从执行顺序上来看，实际上是按照先进后出的顺序执行defer</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">打印后</span><br><span class=\"line\">打印中</span><br><span class=\"line\">打印前</span><br><span class=\"line\"><span class=\"built_in\">panic</span>: 触发异常</span><br></pre></td></tr></table></figure>\n\n<p><strong>注意：请用独立终端运行，排查某些IDE对stderr和stdout处理问题导致输出顺序不一致。</strong></p>\n<h3 id=\"2-以下代码有什么问题，说明原因。\"><a href=\"#2-以下代码有什么问题，说明原因。\" class=\"headerlink\" title=\"2. 以下代码有什么问题，说明原因。\"></a>2. 以下代码有什么问题，说明原因。</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> student <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Name <span class=\"keyword\">string</span></span><br><span class=\"line\">    Age  <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">pase_student</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    m := <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]*student)</span><br><span class=\"line\">    stus := []student&#123;</span><br><span class=\"line\">        &#123;Name: <span class=\"string\">\"zhou\"</span>, Age: <span class=\"number\">24</span>&#125;,</span><br><span class=\"line\">        &#123;Name: <span class=\"string\">\"li\"</span>, Age: <span class=\"number\">23</span>&#125;,</span><br><span class=\"line\">        &#123;Name: <span class=\"string\">\"wang\"</span>, Age: <span class=\"number\">22</span>&#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> _, stu := <span class=\"keyword\">range</span> stus &#123;</span><br><span class=\"line\">        m[stu.Name] = &amp;stu</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>foreach</strong><br>解答：<br>这样的写法初学者经常会遇到的，很危险！<br>与Java的foreach一样，都是使用副本的方式。所以m[stu.Name]=&amp;stu实际上一致指向同一个指针，<br>最终该指针的值为遍历的最后一个struct的值拷贝。<br>就像想修改切片元素的属性：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> _, stu := <span class=\"keyword\">range</span> stus &#123;</span><br><span class=\"line\">    stu.Age = stu.Age+<span class=\"number\">10</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>也是不可行的。<br>大家可以试试打印出来：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func pase_student() &#123;</span><br><span class=\"line\">    m := make(map[string]*student)</span><br><span class=\"line\">    stus := []student&#123;</span><br><span class=\"line\">        &#123;Name: &quot;zhou&quot;, Age: 24&#125;,</span><br><span class=\"line\">        &#123;Name: &quot;li&quot;, Age: 23&#125;,</span><br><span class=\"line\">        &#123;Name: &quot;wang&quot;, Age: 22&#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // 错误写法</span><br><span class=\"line\">    for _, stu := range stus &#123;</span><br><span class=\"line\">        m[stu.Name] = &amp;stu</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    for k,v:=range m&#123;</span><br><span class=\"line\">        println(k,&quot;=&gt;&quot;,v.Name)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // 正确</span><br><span class=\"line\">    for i:=0;i&lt;len(stus);i++  &#123;</span><br><span class=\"line\">        m[stus[i].Name] = &amp;stus[i]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    for k,v:=range m&#123;</span><br><span class=\"line\">        println(k,&quot;=&gt;&quot;,v.Name)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-下面的代码会输出什么，并说明原因\"><a href=\"#3-下面的代码会输出什么，并说明原因\" class=\"headerlink\" title=\"3. 下面的代码会输出什么，并说明原因\"></a>3. 下面的代码会输出什么，并说明原因</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    runtime.GOMAXPROCS(<span class=\"number\">1</span>)</span><br><span class=\"line\">    wg := sync.WaitGroup&#123;&#125;</span><br><span class=\"line\">    wg.Add(<span class=\"number\">20</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++ &#123;</span><br><span class=\"line\">        <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">            fmt.Println(<span class=\"string\">\"A: \"</span>, i)</span><br><span class=\"line\">            wg.Done()</span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++ &#123;</span><br><span class=\"line\">        <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">            fmt.Println(<span class=\"string\">\"B: \"</span>, i)</span><br><span class=\"line\">            wg.Done()</span><br><span class=\"line\">        &#125;(i)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    wg.Wait()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>go执行的随机性和闭包</strong><br>解答：<br>谁也不知道执行后打印的顺序是什么样的，所以只能说是随机数字。<br>其中<code>A:</code>输出完全随机，取决于goroutine执行时i的值是多少；<br>而<code>B:</code>一定输出为0~9，但顺序不定。  </p>\n<p>第一个go func中i是外部for的一个变量，地址不变化，但是值都在改变。  </p>\n<p>第二个go func中i是函数参数，与外部for中的i完全是两个变量。<br>尾部(i)将发生值拷贝，go func内部指向值拷贝地址。  </p>\n<p>所以在使用goroutine在处理闭包的时候，避免发生类似第一个go func中的问题。</p>\n<h3 id=\"4-下面代码会输出什么？\"><a href=\"#4-下面代码会输出什么？\" class=\"headerlink\" title=\"4. 下面代码会输出什么？\"></a>4. 下面代码会输出什么？</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> People <span class=\"keyword\">struct</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(p *People)</span> <span class=\"title\">ShowA</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"showA\"</span>)</span><br><span class=\"line\">    p.ShowB()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(p *People)</span> <span class=\"title\">ShowB</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"showB\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Teacher <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    People</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *Teacher)</span> <span class=\"title\">ShowB</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"teacher showB\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    t := Teacher&#123;&#125;</span><br><span class=\"line\">    t.ShowA()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>go的组合继承</strong><br>解答：<br>这是Golang的组合模式，可以实现OOP的继承。<br>被组合的类型People所包含的方法虽然升级成了外部类型Teacher这个组合类型的方法（一定要是匿名字段），但它们的方法(ShowA())调用时接受者并没有发生变化。<br>此时People类型并不知道自己会被什么类型组合，当然也就无法调用方法时去使用未知的组合者Teacher类型的功能。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">showA</span><br><span class=\"line\">showB</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-下面代码会触发异常吗？请详细说明\"><a href=\"#5-下面代码会触发异常吗？请详细说明\" class=\"headerlink\" title=\"5. 下面代码会触发异常吗？请详细说明\"></a>5. 下面代码会触发异常吗？请详细说明</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    runtime.GOMAXPROCS(<span class=\"number\">1</span>)</span><br><span class=\"line\">    int_chan := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">    string_chan := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">string</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">    int_chan &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">    string_chan &lt;- <span class=\"string\">\"hello\"</span></span><br><span class=\"line\">    <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> value := &lt;-int_chan:</span><br><span class=\"line\">        fmt.Println(value)</span><br><span class=\"line\">    <span class=\"keyword\">case</span> value := &lt;-string_chan:</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(value)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>select随机性</strong><br>解答：<br>select会随机选择一个可用通用做收发操作。<br>所以代码是有肯触发异常，也有可能不会。<br>单个chan如果无缓冲时，将会阻塞。但结合 select可以在多个chan间等待执行。有三点原则：</p>\n<ul>\n<li>select 中只要有一个case能return，则立刻执行。</li>\n<li>当如果同一时间有多个case均能return则伪随机方式抽取任意一个执行。</li>\n<li>如果没有一个case能return则可以执行”default”块。</li>\n</ul>\n<h3 id=\"6-下面代码输出什么？\"><a href=\"#6-下面代码输出什么？\" class=\"headerlink\" title=\"6. 下面代码输出什么？\"></a>6. 下面代码输出什么？</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">calc</span><span class=\"params\">(index <span class=\"keyword\">string</span>, a, b <span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">    ret := a + b</span><br><span class=\"line\">    fmt.Println(index, a, b, ret)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    a := <span class=\"number\">1</span></span><br><span class=\"line\">    b := <span class=\"number\">2</span></span><br><span class=\"line\">    <span class=\"keyword\">defer</span> calc(<span class=\"string\">\"1\"</span>, a, calc(<span class=\"string\">\"10\"</span>, a, b))</span><br><span class=\"line\">    a = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">defer</span> calc(<span class=\"string\">\"2\"</span>, a, calc(<span class=\"string\">\"20\"</span>, a, b))</span><br><span class=\"line\">    b = <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>defer执行顺序</strong><br>解答：<br>这道题类似第1题<br>需要注意到defer执行顺序和值传递<br>index:1肯定是最后执行的，但是index:1的第三个参数是一个函数，所以最先被调用calc(“10”,1,2)==&gt;10,1,2,3<br>执行index:2时,与之前一样，需要先调用calc(“20”,0,2)==&gt;20,0,2,2<br>执行到b=1时候开始调用，index:2==&gt;calc(“2”,0,2)==&gt;2,0,2,2<br>最后执行index:1==&gt;calc(“1”,1,3)==&gt;1,1,3,4</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">10</span> <span class=\"number\">1</span> <span class=\"number\">2</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">20</span> <span class=\"number\">0</span> <span class=\"number\">2</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2</span> <span class=\"number\">0</span> <span class=\"number\">2</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"number\">1</span> <span class=\"number\">3</span> <span class=\"number\">4</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-请写出以下输入内容\"><a href=\"#7-请写出以下输入内容\" class=\"headerlink\" title=\"7. 请写出以下输入内容\"></a>7. 请写出以下输入内容</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    s := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">5</span>)</span><br><span class=\"line\">    s = <span class=\"built_in\">append</span>(s, <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>)</span><br><span class=\"line\">    fmt.Println(s)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>make默认值和append</strong><br>解答：<br>make初始化是由默认值的哦，此处默认值为0</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">1</span> <span class=\"number\">2</span> <span class=\"number\">3</span>]</span><br></pre></td></tr></table></figure>\n\n<p>大家试试改为:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s := make([]int, 0)</span><br><span class=\"line\">s = append(s, 1, 2, 3)</span><br><span class=\"line\">fmt.Println(s)//[1 2 3]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"8-下面的代码有什么问题\"><a href=\"#8-下面的代码有什么问题\" class=\"headerlink\" title=\"8. 下面的代码有什么问题?\"></a>8. 下面的代码有什么问题?</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> UserAges <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tages <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\">\tsync.Mutex</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(ua *UserAges)</span> <span class=\"title\">Add</span><span class=\"params\">(name <span class=\"keyword\">string</span>, age <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tua.Lock()</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> ua.Unlock()</span><br><span class=\"line\">\tua.ages[name] = age</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(ua *UserAges)</span> <span class=\"title\">Get</span><span class=\"params\">(name <span class=\"keyword\">string</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> age, ok := ua.ages[name]; ok &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> age</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">-1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>map线程安全</strong><br>解答：<br>可能会出现<code>fatal error: concurrent map read and map write</code>.\n修改一下看看效果</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(ua *UserAges)</span> <span class=\"title\">Get</span><span class=\"params\">(name <span class=\"keyword\">string</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">    ua.Lock()</span><br><span class=\"line\">    <span class=\"keyword\">defer</span> ua.Unlock()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> age, ok := ua.ages[name]; ok &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> age</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"9-下面的迭代会有什么问题？\"><a href=\"#9-下面的迭代会有什么问题？\" class=\"headerlink\" title=\"9. 下面的迭代会有什么问题？\"></a>9. 下面的迭代会有什么问题？</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(set *threadSafeSet)</span> <span class=\"title\">Iter</span><span class=\"params\">()</span> &lt;-<span class=\"title\">chan</span> <span class=\"title\">interface</span></span>&#123;&#125; &#123;</span><br><span class=\"line\">\tch := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tset.RLock()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> elem := <span class=\"keyword\">range</span> set.s &#123;</span><br><span class=\"line\">\t\t\tch &lt;- elem</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">close</span>(ch)</span><br><span class=\"line\">\t\tset.RUnlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ch</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>chan缓存池</strong><br>解答：<br>看到这道题，我也在猜想出题者的意图在哪里。<br>chan?sync.RWMutex?go?chan缓存池?迭代?<br>所以只能再读一次题目，就从迭代入手看看。<br>既然是迭代就会要求set.s全部可以遍历一次。但是chan是为缓存的，那就代表这写入一次就会阻塞。<br>我们把代码恢复为可以运行的方式，看看效果</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"sync\"</span></span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//下面的迭代会有什么问题？</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> threadSafeSet <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    sync.RWMutex</span><br><span class=\"line\">    s []<span class=\"keyword\">interface</span>&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(set *threadSafeSet)</span> <span class=\"title\">Iter</span><span class=\"params\">()</span> &lt;-<span class=\"title\">chan</span> <span class=\"title\">interface</span></span>&#123;&#125; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ch := make(chan interface&#123;&#125;) // 解除注释看看！</span></span><br><span class=\"line\">    ch := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;,<span class=\"built_in\">len</span>(set.s))</span><br><span class=\"line\">    <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">        set.RLock()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> elem,value := <span class=\"keyword\">range</span> set.s &#123;</span><br><span class=\"line\">            ch &lt;- elem</span><br><span class=\"line\">            <span class=\"built_in\">println</span>(<span class=\"string\">\"Iter:\"</span>,elem,value)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"built_in\">close</span>(ch)</span><br><span class=\"line\">        set.RUnlock()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ch</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    th:=threadSafeSet&#123;</span><br><span class=\"line\">        s:[]<span class=\"keyword\">interface</span>&#123;&#125;&#123;<span class=\"string\">\"1\"</span>,<span class=\"string\">\"2\"</span>&#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v:=&lt;-th.Iter()</span><br><span class=\"line\">    fmt.Sprintf(<span class=\"string\">\"%s%v\"</span>,<span class=\"string\">\"ch\"</span>,v)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"10-以下代码能编译过去吗？为什么？\"><a href=\"#10-以下代码能编译过去吗？为什么？\" class=\"headerlink\" title=\"10. 以下代码能编译过去吗？为什么？\"></a>10. 以下代码能编译过去吗？为什么？</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> People <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\tSpeak(<span class=\"keyword\">string</span>) <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Stduent <span class=\"keyword\">struct</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(stu *Stduent)</span> <span class=\"title\">Speak</span><span class=\"params\">(think <span class=\"keyword\">string</span>)</span> <span class=\"params\">(talk <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> think == <span class=\"string\">\"bitch\"</span> &#123;</span><br><span class=\"line\">\t\ttalk = <span class=\"string\">\"You are a good boy\"</span></span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\ttalk = <span class=\"string\">\"hi\"</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> peo People = Stduent&#123;&#125;</span><br><span class=\"line\">\tthink := <span class=\"string\">\"bitch\"</span></span><br><span class=\"line\">\tfmt.Println(peo.Speak(think))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>golang的方法集</strong><br>解答：<br>编译不通过！<br>做错了！？说明你对golang的方法集还有一些疑问。<br>一句话：golang的方法集仅仅影响接口实现和方法表达式转化，与通过实例或者指针调用方法无关。</p>\n<h3 id=\"11-以下代码打印出来什么内容，说出为什么。\"><a href=\"#11-以下代码打印出来什么内容，说出为什么。\" class=\"headerlink\" title=\"11. 以下代码打印出来什么内容，说出为什么。\"></a>11. 以下代码打印出来什么内容，说出为什么。</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> People <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\tShow()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Student <span class=\"keyword\">struct</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(stu *Student)</span> <span class=\"title\">Show</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">live</span><span class=\"params\">()</span> <span class=\"title\">People</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> stu *Student</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> stu</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> live() == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"AAAAAAA\"</span>)</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"BBBBBBB\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>考点：<strong>interface内部结构</strong><br>解答：<br>很经典的题！<br>这个考点是很多人忽略的interface内部结构。<br>go中的接口分为两种一种是空的接口类似这样：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var in interface&#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>另一种如题目：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type People interface &#123;</span><br><span class=\"line\">    Show()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>他们的底层结构如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type eface struct &#123;      //空接口</span><br><span class=\"line\">    _type *_type         //类型信息</span><br><span class=\"line\">    data  unsafe.Pointer //指向数据的指针(go语言中特殊的指针类型unsafe.Pointer类似于c语言中的void*)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type iface struct &#123;      //带有方法的接口</span><br><span class=\"line\">    tab  *itab           //存储type信息还有结构实现方法的集合</span><br><span class=\"line\">    data unsafe.Pointer  //指向数据的指针(go语言中特殊的指针类型unsafe.Pointer类似于c语言中的void*)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type _type struct &#123;</span><br><span class=\"line\">    size       uintptr  //类型大小</span><br><span class=\"line\">    ptrdata    uintptr  //前缀持有所有指针的内存大小</span><br><span class=\"line\">    hash       uint32   //数据hash值</span><br><span class=\"line\">    tflag      tflag</span><br><span class=\"line\">    align      uint8    //对齐</span><br><span class=\"line\">    fieldalign uint8    //嵌入结构体时的对齐</span><br><span class=\"line\">    kind       uint8    //kind 有些枚举值kind等于0是无效的</span><br><span class=\"line\">    alg        *typeAlg //函数指针数组，类型实现的所有方法</span><br><span class=\"line\">    gcdata    *byte</span><br><span class=\"line\">    str       nameOff</span><br><span class=\"line\">    ptrToThis typeOff</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type itab struct &#123;</span><br><span class=\"line\">    inter  *interfacetype  //接口类型</span><br><span class=\"line\">    _type  *_type          //结构类型</span><br><span class=\"line\">    link   *itab</span><br><span class=\"line\">    bad    int32</span><br><span class=\"line\">    inhash int32</span><br><span class=\"line\">    fun    [1]uintptr      //可变大小 方法集合</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看出iface比eface 中间多了一层itab结构。<br>itab 存储_type信息和[]fun方法集，从上面的结构我们就可得出，因为data指向了nil 并不代表interface 是nil，<br>所以返回值并不为空，这里的fun(方法集)定义了接口的接收规则，在编译的过程中需要验证是否实现接口<br>结果：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BBBBBBB</span><br></pre></td></tr></table></figure>","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"面试","slug":"面试","permalink":"chunlife.top/tags/面试/"}]},{"title":"copy-on-write技术","date":"2019-09-03T15:48:54.000Z","path":"2019/09/03/copy-on-write技术/","content":"<h2 id=\"前因\"><a href=\"#前因\" class=\"headerlink\" title=\"前因\"></a>前因</h2><p>之所以突然去了解这块内容，是因为是之前做了关于<a href=\"https://github.com/fagongzi/gatewa\" target=\"_blank\" rel=\"noopener\">gateway</a>的一些笔记，想趁着笔记还未落灰，把它里头的代码抠出来看看，加深下了解，毕竟貌似有用的到的地方。</p>\n<a id=\"more\"></a>\n\n<p>看到Gateway中有介绍说使用写时复制（COW）技术，可以减少锁的操作。这项技术于我并不陌生，在写linux驱动的时候，<code>研究</code>（貌似说的有点过，学习）内核时就经常听到这个词汇，毕竟不管是文件系统，还是进程操作都会看见它的身影。</p>\n<h2 id=\"Copy-On-Write\"><a href=\"#Copy-On-Write\" class=\"headerlink\" title=\"Copy-On-Write\"></a>Copy-On-Write</h2><p>引用维基百科的定义：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">写入时复制（英语：Copy-on-write，简称COW）是一种计算机程序设计领域的优化策略。</span><br><span class=\"line\"></span><br><span class=\"line\">其核心思想是，如果有多个调用者（callers）同时请求相同资源（如内存或磁盘上的数据存储），他们会共同获取相同的指针指向相同的资源，直到某个调用者试图修改资源的内容时，系统才会真正复制一份专用副本（private copy）给该调用者，而其他调用者所见到的最初的资源仍然保持不变。这过程对其他的调用者都是透明的（transparently）。此作法主要的优点是如果调用者没有修改该资源，就不会有副本（private copy）被创建，因此多个调用者只是读取操作时可以共享同一份资源。</span><br></pre></td></tr></table></figure>\n\n<p>也就是说，在一份共享资源，被多个调用者共同消费时，若出现修改资源的操作，我们并不直接对资源进行修改，而是对将资源修改操作划分为三个步骤：</p>\n<ul>\n<li>第一：先将资源进行复制，复制出一个新的资源备份；</li>\n<li>第二：往这个资源备份里面添加新的数据；</li>\n<li>第三：将原先资源地址指向资源备份的地址。</li>\n</ul>\n<p>这样的好处是，我们在读数据时不需要加锁，因为资源是不变的，相对于其他不需要修改资源的调用者来说。这类似与一种读写分离的操作，将写和读两种操作作用于两个不同的地址上，互不干扰。</p>\n<h2 id=\"Copy-On-Write实现\"><a href=\"#Copy-On-Write实现\" class=\"headerlink\" title=\"Copy-On-Write实现\"></a>Copy-On-Write实现</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"strconv\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> testMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]*<span class=\"keyword\">string</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">copyBak</span><span class=\"params\">()</span> <span class=\"title\">map</span>[<span class=\"title\">int</span>]*<span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\tvals := <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]*<span class=\"keyword\">string</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> key, value := <span class=\"keyword\">range</span> testMap &#123;</span><br><span class=\"line\">\t\tvals[key] = value</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> vals</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttestMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]*<span class=\"keyword\">string</span>)</span><br><span class=\"line\">\tstr := <span class=\"string\">\"123\"</span></span><br><span class=\"line\">\ttestMap[<span class=\"number\">1</span>] = &amp;str</span><br><span class=\"line\">\ttestMap[<span class=\"number\">2</span>] = &amp;str</span><br><span class=\"line\">\ttestMap[<span class=\"number\">3</span>] = &amp;str</span><br><span class=\"line\">\ttestMap[<span class=\"number\">4</span>] = &amp;str</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(*testMap[<span class=\"number\">3</span>])</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">100000000</span>; i++ &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 写数据是需要加锁的，并发写的情况下，可能会出现copy多份数据的情况</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 但此处只有一个协程做此操作</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 1、复制出新的Map</span></span><br><span class=\"line\">\t\t\tnewVals := copyBak()</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 2、修改已有的元素，或添加新元素</span></span><br><span class=\"line\">\t\t\tstr = <span class=\"string\">\"12343264364634\"</span> + strconv.Itoa(i)</span><br><span class=\"line\">\t\t\tnewVals[<span class=\"number\">3</span>] = &amp;str</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 3、将原有的Map地址指向新的Map</span></span><br><span class=\"line\">\t\t\ttestMap = newVals</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">select</span> &#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>修改时锁住的仅仅是资源的一个备份，所以并不会影响到原有资源的正常访问，原有资源依然可以正常访问。</p>\n<h2 id=\"Copy-On-Write应用场景以及读写锁\"><a href=\"#Copy-On-Write应用场景以及读写锁\" class=\"headerlink\" title=\"Copy-On-Write应用场景以及读写锁\"></a>Copy-On-Write应用场景以及读写锁</h2><p>Copy-On-Write并发容器用于读多写少的并发场景。比如白名单，黑名单，商品类目的访问、更新场景以及一些数据的配置项（Gateway将此作为更新配置项），假如我们有一个搜索网站，用户在这个网站的搜索框中，输入关键字搜索内容，但是某些关键字不允许被搜索。这些不能被搜索的关键字会被放在一个黑名单当中，黑名单每天晚上更新一次。当用户搜索时，会检查当前关键字在不在黑名单当中，如果在，则提示不能搜索。</p>\n<p>读多写少一般还会被介绍使用读写锁，<code>RWMutex</code>，那和<code>COW</code>之前有什么不一样呢。我们顺道来看一下。</p>\n<p>这里直接上一个<code>Golang</code>中读写锁的阻塞状态：</p>\n<blockquote>\n<ol>\n<li>读锁不能阻塞读锁</li>\n<li>读锁需要阻塞写锁，直到所有读锁都释放</li>\n<li>写锁需要阻塞读锁，直到所有写锁都释放</li>\n<li>写锁需要阻塞写锁</li>\n</ol>\n</blockquote>\n<p>可以看到的是，读锁虽然不会阻塞读锁，但是会将写锁给阻塞了，这并不符合我们在读数据时不加锁的想法。</p>\n<p>我们都知道Map并发读写不安全，但Go语言开发小组很长时间都没去修复这个问题，为什么呢，这是因为<code>Go</code>开发组之前在很多Go其他的组件中使用了Map，若给其加锁，则会导致很多其他组件速度下降，所以开发组权衡后不考虑修改Map，而是后期推出了<code>sync.Map</code>来弥补这个遗憾。</p>\n<p>所以，加锁操作带来的是一些多余的瞬间延时，在不需要的时候尽量不需要加锁。减少了资源的分配。</p>\n<h2 id=\"Copy-On-Write缺点\"><a href=\"#Copy-On-Write缺点\" class=\"headerlink\" title=\"Copy-On-Write缺点\"></a>Copy-On-Write缺点</h2><blockquote>\n<p>引用：<a href=\"https://coolshell.cn/articles/11175.html\" target=\"_blank\" rel=\"noopener\">JAVA中的COPYONWRITE容器</a></p>\n</blockquote>\n<p>Copy-On-Write容器有很多优点，但是同时也存在两个问题，即内存占用问题和数据一致性问题。所以在开发的时候需要注意一下。</p>\n<p><strong>内存占用问题</strong>。因为Copy-On-Write的写时复制机制，所以在进行写操作的时候，内存里会同时驻扎两个对象的内存，旧的对象和新写入的对象（注意:在复制的时候只是复制容器里的引用，只是在写的时候会创建新对象添加到新容器里，而旧容器的对象还在使用，所以有两份对象内存）。如果这些对象占用的内存比较大，比如说200M左右，那么再写入100M数据进去，内存就会占用300M，那么这个时候很有可能造成频繁的Yong GC和Full GC。之前我们系统中使用了一个服务由于每晚使用Copy-On-Write机制更新大对象，造成了每晚15秒的Full GC，应用响应时间也随之变长。</p>\n<p>针对内存占用问题，可以通过压缩容器中的元素的方法来减少大对象的内存消耗，比如，如果元素全是10进制的数字，可以考虑把它压缩成36进制或64进制。</p>\n<p>​    * 注意：若是包含有IO读取操作，则也会造成操作上的IO双倍消费。</p>\n<p><strong>数据一致性问题</strong>。Copy-On-Write容器只能保证数据的<code>最终一致性</code>，不能保证数据的实时一致性。所以如果你希望写入的的数据，马上能读到，请不要使用Copy-On-Write容器。这里也就是说会出现一些脏数据，可能凑巧使用的原有资源数据，</p>\n<h2 id=\"Copy-On-Write-Linux下的一些应用\"><a href=\"#Copy-On-Write-Linux下的一些应用\" class=\"headerlink\" title=\"Copy-On-Write Linux下的一些应用\"></a>Copy-On-Write Linux下的一些应用</h2><p>linux中fork()就有COW的应用，父子进程间数据共享，而当子进程并不使用父进程数据的话，数据不需要进行进行复制，这时候使用写时复制就会很划算，只有当子进程需要使用到父进程数据时，系统触发异常，进入中断，复制使用的那份数据上来。</p>\n<p>文件系统中的文件修改也类似，我们所做的修改并不直接作用于源文件，例如，要修改文件A的内容时，先把A读出来，写到临时文件B里面去。然后在B中做修改，我们不保存时，是不会做写回文件操作的。常见的，我们使用vim打开一个文件，做一些修改，但并不保存，突然做关机，会发现源文件并不会变动，但vim会提示我们是否recover文件，做这个操作的依据便是，其有一份备份数据可以参照。</p>\n<blockquote>\n<p>这里讲解的更为详细，若需要详细了解，可以参考这篇博客，<a href=\"https://juejin.im/post/5bd96bcaf265da396b72f855\" target=\"_blank\" rel=\"noopener\">COW奶牛！Copy On Write机制了解一下</a></p>\n</blockquote>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Copy-On-Write","slug":"Copy-On-Write","permalink":"chunlife.top/tags/Copy-On-Write/"},{"name":"COW - 写时复制","slug":"COW-写时复制","permalink":"chunlife.top/tags/COW-写时复制/"}]},{"title":"MySQL简单索引总结汇","date":"2019-08-27T06:48:50.000Z","path":"2019/08/27/MySQL简单索引总结汇/","content":"<p>MySQL中的索引，一般来说，我们使用的比较多的是b+tree，hash索引。</p>\n<p>且因为在MySQL中，存在不同的存储引擎，这两种索引存在的形式也有些不大一样。这里我们也只引入MyISAM和Innodb存储引擎。</p>\n<a id=\"more\"></a>\n\n<p>使用到的示例数据：<a href=\"http://downloads.mysql.com/docs/sakila-db.zip\" target=\"_blank\" rel=\"noopener\">sakila-db</a></p>\n<h1 id=\"索引的好处\"><a href=\"#索引的好处\" class=\"headerlink\" title=\"索引的好处\"></a>索引的好处</h1><p>索引的好处指：索引给数据库带来性能损耗<strong>小于</strong>带来的好处，索引即是有利的。</p>\n<ul>\n<li>索引大大减少了存储引擎需要扫描的<strong>数据量</strong>；</li>\n<li>索引可以帮助我们进行排序以避免使用临时表；</li>\n<li>索引可以把随机I/O变为顺序I/O；</li>\n</ul>\n<p>添加索引会提高查询速度，其实也就是将数据不管从逻辑还是物理上，将无序数据变为有序数据。</p>\n<p>不过索引也是会带来一定的损耗的：</p>\n<p>索引的引入会增加写操作的成本。不过<code>Innodb</code>引入了插入缓存解决了这个问题。</p>\n<p>同时，太多索引会增加查询优化器的选择时间。</p>\n<h1 id=\"Hash索引\"><a href=\"#Hash索引\" class=\"headerlink\" title=\"Hash索引\"></a>Hash索引</h1><p>MyISAM和Innodb都不支持hash索引，不过Innodb有点不同的是，它不能说完全不支持，它的hash索引的创建由引擎自动优化创建，需要开启这个特性，人为无法干预创建。当我们试图创建时，mysql也不会报错，只不过会自动转化为B树索引。</p>\n<h2 id=\"特点\"><a href=\"#特点\" class=\"headerlink\" title=\"特点\"></a>特点</h2><p>Hash索引是基于Hash表实现的，只有查询条件精确匹配Hash索引中的所有列时，才能够使用到hash索引。（故只支持等值比较查询<code>=，in()， &lt;=&gt;</code>，而不包含排序或范围查询的需求）</p>\n<p>对于Hash索引中的所有列，存储引擎都会为每一行计算一个Hash码，Hash索引中存储的就是Hash码。（哈希索引包括哈希值，以及行的指针）。</p>\n<p><strong>限制：</strong></p>\n<ul>\n<li>因索引不保存数据，索引需要读取行来读取想要的数据，发生二次查找，但有缓存，速度很快，所以也就没啥影响。</li>\n<li>无法用于排序，哈希索引数据并不是按照索引列的值顺序存储的，所以也就无法用于排序。</li>\n<li>哈希索引也不支持部分索引列匹配查找，因为哈希索引始终是使用索引的全部列值内容来计算哈希值的。如：数据列（a,b）上建立哈希索引，如果只查询数据列a，则无法使用该索引；也不支持范围查找。</li>\n<li>Hash索引中Hash码的计算可能存在Hash冲突。维护成本比较高。</li>\n</ul>\n<p>​       <strong>因此</strong>在绝大多数需求为单条记录查询的时候，可以选择哈希索引，查询性能最快；其余大部分场景，建议选择BTree索引。</p>\n<h1 id=\"B树索引\"><a href=\"#B树索引\" class=\"headerlink\" title=\"B树索引\"></a>B树索引</h1><p>MyISAM和InnoDB引擎中，<a href=\"#B+Tree结构\">B树索引</a>可不是相对等的，虽然其可以被称为同一类数据结构——平衡查找树。</p>\n<blockquote>\n<p>平衡查找树——每个叶子到根部的距离都是相同的，并且所有的键值都是按照键值的大小存放在同一层的叶子节点上的，各个叶子节点由指针来进行连接。</p>\n</blockquote>\n<p>MyISAM：</p>\n<p>叶子节点存储指向数据的物理地址。</p>\n<p>InnoDB：</p>\n<p>叶子节点指向数据的主键。</p>\n<p>主键即为聚集索引，<code>InnoDB</code>数据文件本身即为索引文件。树的叶节点data域保存了完整的数据记录，而这个索引的<code>key</code>是数据表的主键。</p>\n<p>因为InnoDB作为主流，且在实际业务中好像也没什么机会使用到<code>MyISAM</code>引擎，所以接下来的索引各方面都从<code>InnoDB</code>出发。</p>\n<h1 id=\"MySQL添加索引操作\"><a href=\"#MySQL添加索引操作\" class=\"headerlink\" title=\"MySQL添加索引操作\"></a>MySQL添加索引操作</h1><p><img src=\"1566884936165.png\" alt=\"添加索引\"></p>\n<h1 id=\"使用索引的注意事项\"><a href=\"#使用索引的注意事项\" class=\"headerlink\" title=\"使用索引的注意事项\"></a>使用索引的注意事项</h1><p><img src=\"1566875667532.png\" alt=\"使用索引的注意事项\"></p>\n<h2 id=\"索引列上不能使用表达式或函数\"><a href=\"#索引列上不能使用表达式或函数\" class=\"headerlink\" title=\"索引列上不能使用表达式或函数\"></a>索引列上不能使用表达式或函数</h2><p>例如<code>where id = 1</code>，<code>where to_int(id) = 1</code>，在<code>id</code>作为索引的这两条where子句，前者可以使用索引查询，而后者将无法使用索引。</p>\n<p>所以尽量在数据上动心思，不要在索引列上进行操作。</p>\n<p><img src=\"%E5%9B%BE%E5%83%8F3.png\" alt=\"\"></p>\n<h2 id=\"前缀索引和索引列的选择性\"><a href=\"#前缀索引和索引列的选择性\" class=\"headerlink\" title=\"前缀索引和索引列的选择性\"></a>前缀索引和索引列的选择性</h2><p>选择性怎么体现，例如，数据库中性别列，只有男女两个选择（一般情况下），那么其可选择性即是极差，数据没有变化性，索引了这一组数据，会从文件中捞出一大堆这样的数据（很好理解，男女都有很多记录），我们要的情况是，索引中数据后，只捞出极少数数据或直接命中数据。</p>\n<p>所以我们会追求索引列数据的多样性。但有一些列多样性很好，但宽度极大，不利于索引（很好理解，中国少字姓氏总比外国人一批条字的姓氏好认），同时，索引可是有大小限制的（见上图）。</p>\n<p>这里，就有了前缀索引来解决这个问题。</p>\n<p>对于列的值较长，比如BLOB、TEXT、VARCHAR，就必须建立前缀索引，即将值的前一部分作为索引。这样既可以节约空间，又可以提高查询效率。<strong>但无法使用前缀索引做 ORDER BY 和 GROUP BY，也无法使用前缀索引做覆盖扫描</strong>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 语法</span><br><span class=\"line\">ALTER TABLE table_name ADD KEY(column_name(prefix_length));</span><br><span class=\"line\"># 示例</span><br><span class=\"line\">ALTER TABLE city ADD KEY(cityname(7))</span><br></pre></td></tr></table></figure>\n\n<p><strong>那如何量化前缀索引的选择性？</strong></p>\n<blockquote>\n<p><a href=\"https://www.cnblogs.com/gomysql/p/3628926.html\" target=\"_blank\" rel=\"noopener\">MySQL前缀索引和索引选择性</a></p>\n</blockquote>\n<p>例如有这样一张表。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select count(*) as cnt, city from city_demo group by city order by cnt desc limit 10;               </span><br><span class=\"line\">+-----+--------------+</span><br><span class=\"line\">| cnt | city         |</span><br><span class=\"line\">+-----+--------------+</span><br><span class=\"line\">|   8 | Garden Grove |</span><br><span class=\"line\">|   7 | Escobar      |</span><br><span class=\"line\">|   7 | Emeishan     |</span><br><span class=\"line\">|   6 | Amroha       |</span><br><span class=\"line\">|   6 | Tegal        |</span><br><span class=\"line\">|   6 | Lancaster    |</span><br><span class=\"line\">|   6 | Jelets       |</span><br><span class=\"line\">|   6 | Ambattur     |</span><br><span class=\"line\">|   6 | Yingkou      |</span><br><span class=\"line\">|   6 | Monclova     |</span><br><span class=\"line\">+-----+--------------+</span><br><span class=\"line\">10 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>\n\n<p>可以先计算完整列的选择性。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select count(distinct city) / count(*) from city_demo;</span><br><span class=\"line\">+---------------------------------+</span><br><span class=\"line\">| count(distinct city) / count(*) |</span><br><span class=\"line\">+---------------------------------+</span><br><span class=\"line\">|                          0.4283 |</span><br><span class=\"line\">+---------------------------------+</span><br><span class=\"line\">1 row in set (0.05 sec)</span><br></pre></td></tr></table></figure>\n\n<p>可以在一个查询中针对不同前缀长度的选择性进行计算，这对于大表非常有用，下面给出如何在同一个查询中计算不同前缀长度的选择性：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select count(distinct left(city,3))/count(*) as sel3,</span><br><span class=\"line\">    -&gt; count(distinct left(city,4))/count(*) as sel4,</span><br><span class=\"line\">    -&gt; count(distinct left(city,5))/count(*) as sel5, </span><br><span class=\"line\">    -&gt; count(distinct left(city,6))/count(*) as sel6 </span><br><span class=\"line\">    -&gt; from city_demo;</span><br><span class=\"line\">+--------+--------+--------+--------+</span><br><span class=\"line\">| sel3   | sel4   | sel5   | sel6   |</span><br><span class=\"line\">+--------+--------+--------+--------+</span><br><span class=\"line\">| 0.3367 | 0.4075 | 0.4208 | 0.4267 |</span><br><span class=\"line\">+--------+--------+--------+--------+</span><br><span class=\"line\">1 row in set (0.01 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt;</span><br></pre></td></tr></table></figure>\n\n<p>可以看见当索引前缀为6时的基数是0.4267，已经接近完整列选择性0.4283。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; alter table city_demo add key (city(6));</span><br><span class=\"line\">Query OK, 0 rows affected (0.19 sec)</span><br><span class=\"line\">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"联合索引\"><a href=\"#联合索引\" class=\"headerlink\" title=\"联合索引\"></a>联合索引</h2><p>可以参考一下原则：</p>\n<ul>\n<li>经常会使用到的列优先</li>\n<li>选择性搞的列优先</li>\n<li>宽度小的列优先 </li>\n</ul>\n<p>同时需要注意索引的注意项，例如索引字段不可施加函数，联合索引依然遵循，最左列不可使用函数，而且联合索引在使用时也不能缺失最左列。</p>\n<h2 id=\"覆盖索引\"><a href=\"#覆盖索引\" class=\"headerlink\" title=\"覆盖索引\"></a>覆盖索引</h2><p>优点：</p>\n<ul>\n<li>可以优化缓存，减少磁盘IO操作；</li>\n<li>可以减少随机IO，变随机IO操作为顺序IO操作</li>\n<li>可以避免对InnoDB主键索引的二次查询</li>\n<li>可以避免MyISAM表进行系统调用</li>\n</ul>\n<p>虽然优点很明显，但限制同样很明显，并不是可以任意生效覆盖索引的。例如：</p>\n<ul>\n<li>存储引擎本身不支持覆盖索引；</li>\n<li>查询中使用（获取）了太多列；</li>\n<li>使用了双<code>%</code>号的<code>like</code>查询。</li>\n</ul>\n<blockquote>\n<p>百分号是属于mysql自身的操作，其操作无法在磁盘中进行，必须要将数据读取至内存中进行操作。</p>\n</blockquote>\n<p>以<code>sakila</code>中<code>film</code>表为例。</p>\n<p><img src=\"%E5%9B%BE1.png\" alt=\"film表\"></p>\n<p><strong>操作1：</strong></p>\n<p>获取language_id，可以直接通过索引就能得到数据，不需要拿到索引后去数据列拿取数据。</p>\n<p><img src=\"%E5%9B%BE2.png\" alt=\"图\"></p>\n<p><strong>操作2：</strong></p>\n<p>直接从索引拿不到数据，需要读取索引到内存中，再到数据中过滤数据。</p>\n<p><img src=\"%E5%9B%BE3.png\" alt=\"3\"></p>\n<p><strong>操作3：</strong></p>\n<p>Innodb 主键作为聚集索引，数据与索引是存储在一起的，即使使用的是二级索引查询，获取多列数据，但其包含的是主键，所以依然属于覆盖索引。</p>\n<p><img src=\"%E5%9B%BE4.png\" alt=\"4\"></p>\n<h1 id=\"索引优化查询\"><a href=\"#索引优化查询\" class=\"headerlink\" title=\"索引优化查询\"></a>索引优化查询</h1><h2 id=\"使用索引扫描来优化排序\"><a href=\"#使用索引扫描来优化排序\" class=\"headerlink\" title=\"使用索引扫描来优化排序\"></a>使用索引扫描来优化排序</h2><p>按照索引顺序扫描数据。</p>\n<p>需要的条件：</p>\n<ul>\n<li>索引的列顺序和Order By子句顺序完全一致；</li>\n<li>索引中所有列的方向（升序、降序）和Order By子句完全一致；</li>\n<li>Order By中的字段全部在关联表中的第一张表中。</li>\n</ul>\n<p>表结构：</p>\n<p><img src=\"%E5%9B%BE11.png\" alt=\"表结构\"></p>\n<p><code>rental_date</code>，<code>inventory_id</code>，<code>customer_id</code>，是联合唯一索引。</p>\n<p>INNODB-&gt;使用到了索引（主键）进行排序。success。</p>\n<p><img src=\"%E5%9B%BE12.png\" alt=\"1\"></p>\n<p>myisam使用了文件进行排序。</p>\n<p><img src=\"%E5%9B%BE13.png\" alt=\"12\"></p>\n<p>使用到了联合索引，获取完整的数据则需要回表查询数据。success。</p>\n<p><img src=\"%E5%9B%BE14.png\" alt=\"14\"></p>\n<p>使用到降序<code>desc</code>，则需要使用文件排序。</p>\n<p><img src=\"%E5%9B%BE15.png\" alt=\"123\"></p>\n<p>联合索引中最左边的列使用范围查找，则导致右边的索引失效。</p>\n<p><img src=\"%E5%9B%BE16.png\" alt=\"16\"></p>\n<h2 id=\"模拟Hash索引优化查询\"><a href=\"#模拟Hash索引优化查询\" class=\"headerlink\" title=\"模拟Hash索引优化查询\"></a>模拟Hash索引优化查询</h2><p>Innodb是引擎自动管理，而我们可以手动进行创建。</p>\n<ul>\n<li>其只能处理键值的全值匹配查找；</li>\n<li>所使用的Hash算法决定索引键的大小。</li>\n</ul>\n<p>可以用于对数据很长的列，计算Hash反而会缩短其长度。添加Hash可以使用MySQL触发器。</p>\n<h2 id=\"删除重复和冗余的索引\"><a href=\"#删除重复和冗余的索引\" class=\"headerlink\" title=\"删除重复和冗余的索引\"></a>删除重复和冗余的索引</h2><h3 id=\"使用工具\"><a href=\"#使用工具\" class=\"headerlink\" title=\"使用工具\"></a>使用工具</h3><p><code>pt-duplicate-key-checker</code>，可以检查一些重复和冗余的索引。</p>\n<blockquote>\n<p>使用的话：<a href=\"http://www.fordba.com/percona-toolkit-pt-duplicate-key-checker.html\" target=\"_blank\" rel=\"noopener\">Percona-Toolkit系列之pt-duplicate-key-checker冗余索引/外键检测利器</a></p>\n</blockquote>\n<h3 id=\"查找未使用过的索引\"><a href=\"#查找未使用过的索引\" class=\"headerlink\" title=\"查找未使用过的索引\"></a>查找未使用过的索引</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select object_schema,object_name,index_name,b.`TABLE_ROWS`</span><br><span class=\"line\">FROM performance_schema.table_io_waits_summary_by_index_usage a</span><br><span class=\"line\">JOIN information_schema.tables b ON</span><br><span class=\"line\">    a.`OBJECT_SCHEMA`=b.`TABLE_SCHEMA` AND</span><br><span class=\"line\">    a.`OBJECT_NAME`=b.`TABLE_NAME`</span><br><span class=\"line\">WHERE index_name IS NOT NULL</span><br><span class=\"line\">AND count_star = 0</span><br><span class=\"line\">ORDER BY object_schema, object_name;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"更新索引统计信息以及减少索引碎片\"><a href=\"#更新索引统计信息以及减少索引碎片\" class=\"headerlink\" title=\"更新索引统计信息以及减少索引碎片\"></a>更新索引统计信息以及减少索引碎片</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">analyze talbe table_name</span><br><span class=\"line\"></span><br><span class=\"line\">optimize table table_name  // 使用不当将锁表</span><br></pre></td></tr></table></figure>\n\n<p>经常更新数据的磁盘需要整理碎片，数据库也是这样，Optimize Table语句对MyISAM和InnoDB类型的表都有效。</p>\n<h1 id=\"B-Tree结构\"><a href=\"#B-Tree结构\" class=\"headerlink\" title=\"B+Tree结构\"></a>B+Tree结构</h1><blockquote>\n<p><a href=\"https://www.jianshu.com/p/486a514b0ded\" target=\"_blank\" rel=\"noopener\">MYSQL-B+TREE索引原理</a></p>\n</blockquote>\n<p>非叶子节点不存储data，只存储索引key；只有叶子节点才存储data。<code>（叶子节点为树中没有子节点的节点）</code>（所以B树索引查找数据是一级一级深入的找）</p>\n<p>在B+Tree的每个叶子节点增加一个指向相邻叶子节点的指针，就形成了<strong>带有顺序访问指针的B+Tree</strong>。</p>\n<p><img src=\"3575048-b5309bfe660a8ce9.webp\" alt=\"img\"></p>\n<hr>\n<blockquote>\n<p>参考：[MySQL Index](<a href=\"https://github.com/Snailclimb/JavaGuide/blob/master/docs/database/MySQL\" target=\"_blank\" rel=\"noopener\">https://github.com/Snailclimb/JavaGuide/blob/master/docs/database/MySQL</a> Index.md)</p>\n</blockquote>\n","categories":[{"name":"mysql","slug":"mysql","permalink":"chunlife.top/categories/mysql/"}],"tags":[{"name":"索引","slug":"索引","permalink":"chunlife.top/tags/索引/"},{"name":"优化","slug":"优化","permalink":"chunlife.top/tags/优化/"}]},{"title":"mysql读写分离以及聚集索引知识解","date":"2019-08-26T12:33:19.000Z","path":"2019/08/26/mysql索引知识解/","content":"<p>这篇博客算是我欠下来的，放着思维导图上整理的MySQL索引和读写分离相关的点，到现在都难得下手写出来，因为MySQL索引很多知识，有时候忘了又记，记了又忘，所以把这些知识点都提前放在思维导图上，想着啥时候写下来，不过由于个（懒）人（病）原（发）因（作），所以一直给耽搁了。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"1、基准测试\"><a href=\"#1、基准测试\" class=\"headerlink\" title=\"1、基准测试\"></a>1、基准测试</h2><p>为啥要先介绍基准测试呢，因为其是忠实反应出mysql在不同系统环境呈现出来的性能差异。</p>\n<p>例如在部署完mysql中间件后可以对性能进行重新评估。</p>\n<p>使用的工具一般有两种，<code>mysqlslap</code>和<code>sysbench</code>，前者是mysql自带的，后者是一款开源的性能测试工具，功能更强一些，给出的信息更多，一般用后者就好了。</p>\n<p>这俩工具使用方法介绍的博客非常多了，这里我就不介绍了，摘出两篇放在这里。</p>\n<p><a href=\"https://www.cnblogs.com/kismetv/p/7615738.html\" target=\"_blank\" rel=\"noopener\">详解MySQL基准测试和sysbench工具</a></p>\n<p><a href=\"http://seanlook.com/2016/03/28/mysql-sysbench/\" target=\"_blank\" rel=\"noopener\">使用sysbench对mysql压力测试</a></p>\n<h2 id=\"2、读写分离中间件\"><a href=\"#2、读写分离中间件\" class=\"headerlink\" title=\"2、读写分离中间件\"></a>2、读写分离中间件</h2><blockquote>\n<p>可能需要一篇更详细的博客：<a href=\"https://blog.csdn.net/u013421629/article/details/78793966\" target=\"_blank\" rel=\"noopener\">【mysql 读写分离】10分钟了解读写分离的作用</a></p>\n</blockquote>\n<p>读写分离，基本的原理是让主数据库处理事务性增、改、删操作（INSERT、UPDATE、DELETE），而从数据库处理SELECT查询操作。数据库复制被用来把事务性操作导致的变更同步到集群中的从数据库。</p>\n<p>充分利用MySQL主从复制架构下，主从机的MySQL资源，提高读写效率。</p>\n<p>一般来说，使用的有<code>mysql-proxy</code>和<code>maxScale</code>，这里我们一般使用后者。</p>\n<p><strong>读写分离的优点：</strong></p>\n<ul>\n<li>由中间件根据查询语法分析，自动完成读写分离；</li>\n<li>对程序透明，已有程序不需要做任何调整。</li>\n</ul>\n<p><strong>缺点：</strong></p>\n<ul>\n<li>由于增加了中间层所以对查询效率有损耗；</li>\n<li>对于延迟敏感业务无法自动在主库执行（实时性要求）。</li>\n</ul>\n<p>中间件主要解决的是两个问题，读写分离，其中又包含了读的负载均衡。</p>\n<p><strong>读写分离要解决的是</strong>，如何在复制集群的不同角色上，去执行不同的SQL语句。</p>\n<p><strong>读的负载均衡主要解决的是</strong>，具有相同角色的数据库，如何共同分担相同的负载。</p>\n<h2 id=\"3、数据库索引\"><a href=\"#3、数据库索引\" class=\"headerlink\" title=\"3、数据库索引\"></a>3、数据库索引</h2><h3 id=\"聚集索引\"><a href=\"#聚集索引\" class=\"headerlink\" title=\"聚集索引\"></a>聚集索引</h3><blockquote>\n<p>这里引入一篇博客，他可能说的更好点：<a href=\"https://www.imooc.com/article/22915\" target=\"_blank\" rel=\"noopener\"><strong>聚集索引与非聚集索引的总结</strong></a></p>\n<p>以及<code>stackoverflow</code>上的解答：<a href=\"https://stackoverflow.com/questions/15051869/relationship-of-primary-key-and-clustered-index\" target=\"_blank\" rel=\"noopener\">Relationship of Primary Key and Clustered Index</a></p>\n</blockquote>\n<h4 id=\"概念\"><a href=\"#概念\" class=\"headerlink\" title=\"概念\"></a>概念</h4><p>先点一下，数据库索引中的<code>聚集索引</code>和<code>非聚集索引</code>的概念。</p>\n<p>聚集索引的定义：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">数据行的物理顺序与列值（一般是主键的那一列）的逻辑顺序相同，一个表中只能拥有一个聚集索引。</span><br></pre></td></tr></table></figure>\n\n<p>非聚集索引的定义：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义：该索引中索引的逻辑顺序与磁盘上行的物理存储顺序不同，一个表中可以拥有多个非聚集索引。</span><br></pre></td></tr></table></figure>\n\n<p>我们可以这样进行理解，在实际的MySQL中，<code>聚集索引</code>决定表中数据的<strong>物理存储顺序</strong><code>（例如，ID 1 和 2逻辑顺序上邻近，存储位置也是邻近）</code>，那么表中有且只有一个聚集索引（这里应该很好理解，毕竟顺序的定量条件得是唯一）。同时聚集索引可以由多个列组成。</p>\n<p>所以聚集索引上，存储了实际数据的<code>物理地址</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 创建聚集索引</span><br><span class=\"line\">create CLUSTERED INDEX 索引名称 ON 表名(字段名)</span><br></pre></td></tr></table></figure>\n\n<p>对应的也就说明，非聚集索引，逻辑上顺序存储，但在实际的存储上可能会隔得很远。也就是说聚集索引代表着数据的实际<strong>物理地址</strong>，也就是说通过非聚集索引在查找数据时，经历两次查找，一次是查找到非聚集索引自身。然后查找主键（聚集索引）。</p>\n<p>所以在非聚集索引上，其保存的是指向了实际数据物理地址的聚集索引的值。</p>\n<h4 id=\"更进一步的理解\"><a href=\"#更进一步的理解\" class=\"headerlink\" title=\"更进一步的理解\"></a>更进一步的理解</h4><p><img src=\"1566820696501.png\" alt=\"MySQL聚集索引和非聚集索引\"></p>\n<p><strong>翻译：</strong></p>\n<p>主键是逻辑概念——它是表中行的它是表中行的唯一标识符。因此，它有一堆属性——它可能不是null，而且必须是唯一的。当然，由于你可能会通过唯一键搜索记录，因此在主键上拥有索引会非常好。</p>\n<p>聚簇索引是一个<em>物理</em>概念——它是一个影响记录存储在磁盘上的顺序的索引。这使得它在访问数据时成为一个非常快的索引，但如果主键不是<em><code>连续序列数字</code></em>，它可能会减慢写入速度。（我：在实际应用中，为了不影响写入效率，大多还是以使用自增id为主，即使其没有啥语义）</p>\n<p>是的，您可以拥有一个没有聚簇索引的主键——在你可能想要（例如，当你的主键是连接表上的外键组合时，并且你不希望在插入数据时产生磁盘混乱开销）。</p>\n<p>是的，你可以在不是主键的列上创建聚簇索引。</p>\n<h4 id=\"innodb如何选择聚集索引\"><a href=\"#innodb如何选择聚集索引\" class=\"headerlink\" title=\"innodb如何选择聚集索引\"></a>innodb如何选择聚集索引</h4><blockquote>\n<p>引自：<a href=\"https://www.jianshu.com/p/2879225ba243\" target=\"_blank\" rel=\"noopener\">理解InnoDB的聚集索引（译）</a></p>\n</blockquote>\n<p>对于<code>innodb</code>，主键毫无疑问是一个聚集索引。但是当一个表没有主键，或者没有一个索引，<code>innodb</code>会如何处理呢。请看如下规则。</p>\n<ul>\n<li><p>如果一个主键被定义了，那么这个主键就是作为聚集索引</p>\n</li>\n<li><p>如果没有主键被定义，那么该表的第一个唯一非空索引被作为聚集索引</p>\n</li>\n<li><p>如果没有主键也没有合适的唯一索引，那么<code>innodb</code>内部会生成一个隐藏的主键作为聚集索引，这个隐藏的主键是一个6个字节的列，改列的值会随着数据的插入自增。</p>\n</li>\n</ul>\n<blockquote>\n<p>除了Clustered Index之外的索引都是Secondary Index，每一个Secondary Index的记录中除了索引列的值之外，还包含主健值。</p>\n<p>通过二级索引查询首先查到是主键值，然后InnoDB再根据查到的主键值通过主键/聚簇索引找到相应的数据块。</p>\n</blockquote>\n<h4 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create table student (</span><br><span class=\"line\"></span><br><span class=\"line\">`id` INT UNSIGNED AUTO_INCREMENT,</span><br><span class=\"line\"></span><br><span class=\"line\">`name` VARCHAR(255),</span><br><span class=\"line\"></span><br><span class=\"line\">PRIMARY KEY(`id`),</span><br><span class=\"line\"></span><br><span class=\"line\">KEY(`name`)</span><br><span class=\"line\"></span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>\n\n<p>主键<code>id</code>作为聚集索引，<code>name</code>作为非聚集索引（<strong>secondary index</strong>）。</p>\n<blockquote>\n<p><a href=\"https://zhuanlan.zhihu.com/p/39293940\" target=\"_blank\" rel=\"noopener\">MySQL聚集索引和非聚集索引</a></p>\n</blockquote>\n<p>（1）select * from student where id &gt;5000 and id &lt;20000;</p>\n<p>（2）select * from student where name &gt; ‘Alie’ and name &lt; ‘John’;</p>\n<p>第一条SQL语句根据id进行范围查询，因为(5000, 20000)范围内的记录在磁盘上按顺序存储，顺序读取磁盘很快就能读到这批数据。</p>\n<p>第二条SQL语句查询（’Alie’, ‘John’）范围内的记录，主键id分布可能是离散的1，100，20001，5000…..；</p>\n<p>增加了随机读取数据页几率；所以普通索引的范围查询效率被聚集索引甩开几条街都不止；</p>\n<p>非聚集索引的精确查询效率还是可以的，比聚集索引查询只增加了一次IO开销。</p>\n","categories":[{"name":"mysql","slug":"mysql","permalink":"chunlife.top/categories/mysql/"}],"tags":[{"name":"聚集索引","slug":"聚集索引","permalink":"chunlife.top/tags/聚集索引/"},{"name":"基准测试","slug":"基准测试","permalink":"chunlife.top/tags/基准测试/"},{"name":"读写分离","slug":"读写分离","permalink":"chunlife.top/tags/读写分离/"},{"name":"主键","slug":"主键","permalink":"chunlife.top/tags/主键/"}]},{"title":"USBMS大容量存储设备数据通信","date":"2019-08-15T02:45:01.000Z","path":"2019/08/15/usUSBMS大容量存储设备数据通信/","content":"<p>整理一下在USB通信时所作的相关工作，因为是对USBMS进行相关操作，涉及到了USBMS的传输格式（<code>CBW</code>，<code>CSW</code>），不太熟悉导致前期回补了一下USB的相关知识。</p>\n<p>因为在搜索资料的时候，发现市面上貌似这方面编程相关资料比较少，这里我直接写出来记录一下，也是帮助自己记忆。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"传输数据上的简单概念\"><a href=\"#传输数据上的简单概念\" class=\"headerlink\" title=\"传输数据上的简单概念\"></a>传输数据上的简单概念</h2><p>usb在普通通信过程中，使用端点进行通信，USBMS（USB Mass Storage）设备则在传输过程中遵守一套传输格式。</p>\n<ul>\n<li><p><strong>CBW-&gt;DATA-&gt;CSW</strong></p>\n</li>\n<li><p>CBW：是一个数据块，携带主机发给设备的SCSI命令。接收了CBW后，设备就可以从中知道在接下来的DATA阶段中该干什么。</p>\n</li>\n<li><p>DATA：阶段有三种情况：无数据需要传输，IN传输（设备到主机）或OUT传输（主机到设备）。</p>\n</li>\n<li><p>CSW：阶段反馈这次传输的结果给主机。</p>\n</li>\n</ul>\n<p>发送数据时，host需要按照这个格式与device进行通信，也只有这样的通信，设备才会与host进行正常的交互。</p>\n<h2 id=\"数据详解\"><a href=\"#数据详解\" class=\"headerlink\" title=\"数据详解\"></a>数据详解</h2><p><img src=\"1565836401981.png\" alt=\"USB抓包\"></p>\n<h3 id=\"CBW\"><a href=\"#CBW\" class=\"headerlink\" title=\"CBW\"></a>CBW</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Section 5.1: Command Block Wrapper (CBW)</span><br><span class=\"line\">struct command_block_wrapper &#123;</span><br><span class=\"line\">\tuint8_t dCBWSignature[4];</span><br><span class=\"line\">\tuint32_t dCBWTag;</span><br><span class=\"line\">\tuint32_t dCBWDataTransferLength;</span><br><span class=\"line\">\tuint8_t bmCBWFlags;</span><br><span class=\"line\">\tuint8_t bCBWLUN;</span><br><span class=\"line\">\tuint8_t bCBWCBLength;</span><br><span class=\"line\">\tuint8_t CBWCB[16];</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"20160524224201663.png\" alt=\"Command Block Wrapper\"></p>\n<blockquote>\n<p>注意：发送时指定发送字节为<code>31</code>个字节，发送错误会导致无法识别包为CBW包。</p>\n<p>command_block_wrapper，该数据结构长度为<code>32</code>字节，调用<code>write</code>函数时需注意。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dCBWSignature: CBW的标识，固定值：43425355h(little endian)。</span><br><span class=\"line\">\tdCBWSignature[0] = &apos;U&apos;</span><br><span class=\"line\">\tdCBWSignature[1] = &apos;S&apos;</span><br><span class=\"line\">\tdCBWSignature[2] = &apos;B&apos;</span><br><span class=\"line\">\tdCBWSignature[3] = &apos;C&apos;</span><br><span class=\"line\">\t</span><br><span class=\"line\">dCBWTag: 主机发送的一个命令块标识，设备需要原样作为dCSWTag（CSW中的一部分）再发送给Host; 通信配对。</span><br><span class=\"line\"></span><br><span class=\"line\">dCBWDataTransferLength: 本次CBW命令要求在命令与回应之间传输的字节数（接下要写或读的数据量）。如果为0，则不传输数据。</span><br><span class=\"line\"></span><br><span class=\"line\">bmCBWFlags: 反映数据传输的方向，0x00 表示来自Host，0x80 表示发至Host； </span><br><span class=\"line\"></span><br><span class=\"line\">bCBWLUN: 对于有多个LUN逻辑单元的设备，用来选择具体目标。如果没有多个LUN，则写0。</span><br><span class=\"line\"></span><br><span class=\"line\">bCBWCBLength: 命令的长度，范围在0~16。</span><br><span class=\"line\"></span><br><span class=\"line\">CBWCB: 传输的具体命令，符合bInterfaceSubClass.中定义的命令规范，此处是SCSI指令集。</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DATA\"><a href=\"#DATA\" class=\"headerlink\" title=\"DATA\"></a>DATA</h3><p>这里就是真正的数据传输期了，可以没有数据，可以读数据，可以写数据。</p>\n<p>数据的交互都是双方约定的过程，假设在<code>host</code>发送一个私有命令，设备有数据发上来，此时<code>host</code>调用<code>read</code>函数。</p>\n<h3 id=\"CSW\"><a href=\"#CSW\" class=\"headerlink\" title=\"CSW\"></a>CSW</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Section 5.2: Command Status Wrapper (CSW)</span><br><span class=\"line\">struct command_status_wrapper &#123;</span><br><span class=\"line\">\tuint8_t dCSWSignature[4];</span><br><span class=\"line\">\tuint32_t dCSWTag;</span><br><span class=\"line\">\tuint32_t dCSWDataResidue;</span><br><span class=\"line\">\tuint8_t bCSWStatus;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"20160524224223818.png\" alt=\"CSW（Command Status Wrapper）状态格式\"></p>\n<p> CSW的长度为13个字节，是对应CBW指令的状态返回，它指示了上一条指令执行是否成功。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dCSWSignature: CSW的标识，固定值：53425355h(little endian)。</span><br><span class=\"line\"></span><br><span class=\"line\">dCSWTag: 设置这个标识和CBW中的dCBWTag一致，参照上面关于dCBWTag的解释。</span><br><span class=\"line\"></span><br><span class=\"line\">dCSWDataResidue: 还需要传送的数据，此数据根据dCBWDataTransferLength－本次已经传送的数据得到。</span><br><span class=\"line\"></span><br><span class=\"line\">bCSWStatus: 指示命令的执行状态。如果命令正确执行，bCSWStatus返回0 ，不正确返回1，phase错返回2（当HOST收到此错误时需要对Device复位）。</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以借鉴：<a href=\"https://github.com/younglifestyle/usbOps/blob/master/usbLib/device.go\" target=\"_blank\" rel=\"noopener\">GitHub</a></p>\n</blockquote>\n<h2 id=\"分析工具\"><a href=\"#分析工具\" class=\"headerlink\" title=\"分析工具\"></a>分析工具</h2><p>linux和windows下都通用的是，使用<code>wireshake</code>，抓包工具抓取的包都是一样的，而且都比较好用，算是比较推荐的。推荐文章，<a href=\"http://www.lnsign.com/2018/03/06/usb-packet-capture-usbmon-wireshark/\" target=\"_blank\" rel=\"noopener\">linux下USB数据包分析(usbmon + wireshark)</a>。</p>\n<p>另外windows下，有<code>Bus Hound</code>，也是非常好用，只是linux没有。</p>\n","categories":[{"name":"USB Mass Storage","slug":"USB-Mass-Storage","permalink":"chunlife.top/categories/USB-Mass-Storage/"},{"name":"cbw csw","slug":"USB-Mass-Storage/cbw-csw","permalink":"chunlife.top/categories/USB-Mass-Storage/cbw-csw/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"}]},{"title":"Go语言GoLand——技巧","date":"2019-08-06T16:02:26.000Z","path":"2019/08/07/Go语言GoLand——技巧/","content":"<p>GoLand在其<code>help</code>中即可调出帮助文档，其快捷键都在其中可以查询得到。</p>\n<a id=\"more\"></a>\n\n<p><img src=\"1565107981920.png\" alt=\"1565107981920\"></p>\n<p>不过在这里我将常见的快捷键自己做了个总结，了解这些快捷键完全可以大大的提高我们的编程效率，类似于会快捷键的<code>vim</code>和不会快捷键的<code>vim</code>的差别了。</p>\n<h3 id=\"必须要掌握的快捷键\"><a href=\"#必须要掌握的快捷键\" class=\"headerlink\" title=\"必须要掌握的快捷键\"></a>必须要掌握的快捷键</h3><p>这里头罗列的快捷键需要尽量的进行掌握，而且都是在编程过程中，都是会经常使用到的，可以说是非常有用了。</p>\n<p><img src=\"1565108390295.png\" alt=\"尽量要掌握的快捷键\"></p>\n<h3 id=\"比较神奇，但真的好用的技巧\"><a href=\"#比较神奇，但真的好用的技巧\" class=\"headerlink\" title=\"比较神奇，但真的好用的技巧\"></a>比较神奇，但真的好用的技巧</h3><p>以下技巧参考自：<a href=\"https://www.bilibili.com/video/av57075824/\" target=\"_blank\" rel=\"noopener\">【Go 夜读】#50 GoLand Tips &amp; Tricks</a>，以及自己了解的独到技巧。</p>\n<h4 id=\"1、便捷辅助生成代码\"><a href=\"#1、便捷辅助生成代码\" class=\"headerlink\" title=\"1、便捷辅助生成代码\"></a>1、便捷辅助生成代码</h4><p>在err变量后面，输入<code>.nn</code>即可快捷生成判断语句。</p>\n<p><img src=\"clip_image001.png\" alt=\"快捷\"></p>\n<p><img src=\"clip_image001-1565108828191.png\" alt=\"dasdsa\"></p>\n<h4 id=\"2、根据提示创建变量\"><a href=\"#2、根据提示创建变量\" class=\"headerlink\" title=\"2、根据提示创建变量\"></a>2、根据提示创建变量</h4><p>在编程时，经常会出现需要临时创建一个临时变量的情况，每次我们还需要挪动以下光标，在这种情况下，我们可以使用：<code>Alt+Enter</code>组合键。</p>\n<p><img src=\"clip_image001-1565109052222.png\" alt=\"创建变量\"></p>\n<h4 id=\"3、重构代码，迅速将一串代码拉出来生成函数\"><a href=\"#3、重构代码，迅速将一串代码拉出来生成函数\" class=\"headerlink\" title=\"3、重构代码，迅速将一串代码拉出来生成函数\"></a>3、重构代码，迅速将一串代码拉出来生成函数</h4><p>快捷键：<code>Shift+Ctrl+Alt+T</code>。</p>\n<p><img src=\"clip_image001-1565109182318.png\" alt=\"快捷生成函数\"></p>\n<h4 id=\"4、快捷定义函数返回值\"><a href=\"#4、快捷定义函数返回值\" class=\"headerlink\" title=\"4、快捷定义函数返回值\"></a>4、快捷定义函数返回值</h4><p>快捷键：<code>Shift+Ctrl+Alt+T</code>。</p>\n<p><img src=\"clip_image001-1565109246711.png\" alt=\"定义函数返回值\"></p>\n<h4 id=\"5、快速将函数导出到新建文件（包）中\"><a href=\"#5、快速将函数导出到新建文件（包）中\" class=\"headerlink\" title=\"5、快速将函数导出到新建文件（包）中\"></a>5、快速将函数导出到新建文件（包）中</h4><p>选中函数名，祭出大杀器，<code>Shift+Ctrl+Alt+T</code>，至于怎么用，其实我都没讲后面的事，因为操作非常简单，不需要我来当个蹩脚的翻译。</p>\n<p><img src=\"clip_image001-1565109360701.png\" alt=\"快速将函数导出到新建文件\"></p>\n<h4 id=\"6、多行选中，用于多行同时添加\"><a href=\"#6、多行选中，用于多行同时添加\" class=\"headerlink\" title=\"6、多行选中，用于多行同时添加\"></a>6、多行选中，用于多行同时添加</h4><p><code>Shift + Alt + Insert</code>进入多行选中模式，再按一次退出。</p>\n<h4 id=\"7、快速生成函数的测试程序\"><a href=\"#7、快速生成函数的测试程序\" class=\"headerlink\" title=\"7、快速生成函数的测试程序\"></a>7、快速生成函数的测试程序</h4><p>光标点击到函数，快捷键：<code>Alt+Insert</code>。</p>\n<p>有可能需要安装<code>gotests</code>。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> go get -u github.com/cweill/gotests/...</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"1565109708408.png\" alt=\"1565109708408\"></p>\n<h4 id=\"8、打开最近的文件，方便用于各文件跳转\"><a href=\"#8、打开最近的文件，方便用于各文件跳转\" class=\"headerlink\" title=\"8、打开最近的文件，方便用于各文件跳转\"></a>8、打开最近的文件，方便用于各文件跳转</h4><blockquote>\n<p>Ctrl+ E 打开最近打开的文件  Ctrl + shift + E 打开最近所在的位置</p>\n</blockquote>\n<h4 id=\"9、go-fmt-和-file-watcher\"><a href=\"#9、go-fmt-和-file-watcher\" class=\"headerlink\" title=\"9、go fmt 和 file watcher\"></a>9、go fmt 和 file watcher</h4><p>File watcher 绑定go fmt，可以在保存后操作文件（但我实际使用时觉得不好用，goland已经做了一部分go fmt的功能，但没有那么多），我觉得可以手动使用go fmt。</p>\n<p><img src=\"clip_image001-1565109926332.png\" alt=\"42314321\"></p>\n<h4 id=\"10、自动换行显示\"><a href=\"#10、自动换行显示\" class=\"headerlink\" title=\"10、自动换行显示\"></a>10、自动换行显示</h4><p>setting搜索Soft Wraps。</p>\n<h4 id=\"11、跳转文件首行和末尾\"><a href=\"#11、跳转文件首行和末尾\" class=\"headerlink\" title=\"11、跳转文件首行和末尾\"></a>11、跳转文件首行和末尾</h4><p><code>Ctrl + Home/End</code>，文件首行和末尾。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Goland","slug":"Goland","permalink":"chunlife.top/tags/Goland/"}]},{"title":"(存储)文件系统的选择","date":"2019-07-22T09:48:37.000Z","path":"2019/07/22/存储-文件系统的选择/","content":"<p>针对新增加的文件更新需求来看，在项目整体的需求中，在分布式的需求设计中，单机存储已不再满足现有的系统设计，需要为系统增加一个存储服务系统。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"选择\"><a href=\"#选择\" class=\"headerlink\" title=\"选择\"></a>选择</h2><p>在各类开源的存储文件系统中，前后主要了解过MongoDB的GridFS，bilibili的bfs，淘宝的TFS，MinIO以及fastdfs。</p>\n<p>GridFS，用于存储和恢复那些超过16M的文件，相当于对MongoDB本身Bson存储容量的一个扩展；</p>\n<p>MinIO，同样是存储大容量非结构化的数据所设计，且由于核心算法的需要，集群搭建至少4台机器起，且组件过大，后期维护；</p>\n<p>TFS，在搭建操作时，由于一直看到搭建复杂，维护不太方便，故放弃；</p>\n<p>bfs和fastdfs，bfs是B站为自家网站设计的图片存储系统，fastdfs更适用大众一些，其算起来都不算是一个完整的微型文件系统，当然，在这里，我们需要的是一个文件存储服务系统。</p>\n<p>综合来看，选择<code>fastdfs</code>似乎是当下适合的选择。</p>\n<h2 id=\"延伸\"><a href=\"#延伸\" class=\"headerlink\" title=\"延伸\"></a>延伸</h2><p>fastdfs还有一个Go仓库与之类似，但并不是原仓库作者开发，<a href=\"https://github.com/sjqzhang/go-fastdfs\" target=\"_blank\" rel=\"noopener\">go-fastdfs</a>，虽然作者是号称类<code>fastdfs</code>，但其实还是不太一样的，存储文件方式可能是类似。</p>\n<p>但<code>go-fastdfs</code>是有元数据的存储的（使用<code>leveldb</code>存储），而fastdfs无元数据的存储，当无分布式算法的一致性特性的保证下，元数据的可用性将存在可用性存疑的问题。</p>\n<p>虽然<code>go-fastdfs</code>使用Go开发，操作维护也简便，但出于服务整体的稳定性考虑，还是优先选择<code>fastdfs</code>靠谱一点，毕竟已经经过社区与作者的多年开发及维护，基本全线生产可用，对于本项目来说，已经是完全够用了。</p>\n<h2 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h2><p><code>fastdfs</code>虽然经历了多年的开发迭代，且用于生产环境的公司不少，但还是没有一个完整的介绍文档，显然是一个很大的缺陷，遇到问题大概有两个地方可以寻求帮助：<a href=\"http://bbs.chinaunix.net/forum-240-1.html\" target=\"_blank\" rel=\"noopener\">分布式文件系统（FastDFS）</a>和<a href=\"https://github.com/happyfish100/fastdfs/issues\" target=\"_blank\" rel=\"noopener\">fastdfs issue</a>。</p>\n<p>另外一点就是，Go下的fastdfs client不是官方开发，第三方的仓库也早已经不再开发，简单使用测试没有问题，在分布式下是否会出现问题不太清楚，这块也需要关注，在后期可能也要投入精力。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"fastdfs","slug":"fastdfs","permalink":"chunlife.top/tags/fastdfs/"},{"name":"file system","slug":"file-system","permalink":"chunlife.top/tags/file-system/"},{"name":"go-fastdfs","slug":"go-fastdfs","permalink":"chunlife.top/tags/go-fastdfs/"}]},{"title":"为图片加上水印或文字(使用Go)","date":"2019-07-21T08:29:33.000Z","path":"2019/07/21/为图片加上水印或文字-使用Go/","content":"<p>Go中操作图片需要使用到库，<code>github.com/disintegration/imaging</code>。</p>\n<p>代码和效果图如下：</p>\n<a id=\"more\"></a>\n\n<p><img src=\"1563699357187.png\" alt=\"1563699357187\"></p>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/bregydoc/gtranslate\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"image\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"image/color\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"io/ioutil\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"unicode/utf8\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/disintegration/imaging\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/golang/freetype\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/golang/freetype/truetype\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"golang.org/x/image/font\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tFontSize     = <span class=\"number\">20</span></span><br><span class=\"line\">\tSquareHeight = <span class=\"number\">200</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tHandleUserImage()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// HandleUserImage paste user image onto background</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">HandleUserImage</span><span class=\"params\">()</span> <span class=\"params\">(<span class=\"keyword\">string</span>, error)</span></span> &#123;</span><br><span class=\"line\">\tm, err := imaging.Open(<span class=\"string\">\"target.png\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"open file failed\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tbm, err := imaging.Open(<span class=\"string\">\"bg.jpg\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"open file failed\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 图片按比例缩放</span></span><br><span class=\"line\">\tdst := imaging.Resize(m, bm.Bounds().Max.X, SquareHeight, imaging.Lanczos)</span><br><span class=\"line\">\t<span class=\"comment\">// 将图片粘贴到背景图的固定位置 最后的参数控制虚化程度</span></span><br><span class=\"line\">\tresult := imaging.Overlay(bm, dst, image.Pt(<span class=\"number\">0</span>, bm.Bounds().Max.Y-SquareHeight), <span class=\"number\">0.3</span>)</span><br><span class=\"line\">\twriteOnImage(result)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfileName := fmt.Sprintf(<span class=\"string\">\"%d.jpg\"</span>, <span class=\"number\">1234</span>)</span><br><span class=\"line\">\terr = imaging.Save(result, fileName)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fileName, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">writeOnImage</span><span class=\"params\">(target *image.NRGBA)</span></span> &#123;</span><br><span class=\"line\">\tc := freetype.NewContext()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 设置屏幕每英寸的分辨率</span></span><br><span class=\"line\">\tc.SetDPI(<span class=\"number\">256</span>)</span><br><span class=\"line\">\t<span class=\"comment\">// 背景</span></span><br><span class=\"line\">\tc.SetClip(target.Bounds())</span><br><span class=\"line\">\t<span class=\"comment\">// 设置目标图像</span></span><br><span class=\"line\">\tc.SetDst(target)</span><br><span class=\"line\">\tc.SetHinting(font.HintingFull)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 设置文字颜色、字体、字大小</span></span><br><span class=\"line\">\tc.SetSrc(image.NewUniform(color.RGBA&#123;R: <span class=\"number\">220</span>, G: <span class=\"number\">220</span>, B: <span class=\"number\">220</span>, A: <span class=\"number\">220</span>&#125;))</span><br><span class=\"line\">\t<span class=\"comment\">// 以磅为单位设置字体大小</span></span><br><span class=\"line\">\tc.SetFontSize(FontSize)</span><br><span class=\"line\">\tfontFam, err := getFontFamily()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"get font family error\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// 设置用于绘制文本的字体</span></span><br><span class=\"line\">\tc.SetFont(fontFam)</span><br><span class=\"line\"></span><br><span class=\"line\">\tdrawStr := <span class=\"string\">\"你好，世界\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 获取字体的尺寸大小</span></span><br><span class=\"line\">\tfixed := c.PointToFixed(FontSize)</span><br><span class=\"line\">\t<span class=\"comment\">// fixed.Ceil() 字体大小</span></span><br><span class=\"line\">\t<span class=\"comment\">// utf8.RuneCountInString(drawStr) 获取字符串的实际大小，而不是以byte算</span></span><br><span class=\"line\">\tpt := freetype.Pt(target.Rect.Max.X/<span class=\"number\">2</span>-(utf8.RuneCountInString(drawStr)/<span class=\"number\">2</span>)*fixed.Ceil(), target.Rect.Max.Y-SquareHeight+SquareHeight/<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfontPin, err := c.DrawString(drawStr, pt)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">\"draw error: %v \\n\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 翻译文字，附加一行，以增强国际化（big）</span></span><br><span class=\"line\">\ttranslated, err := gtranslate.TranslateWithFromTo(</span><br><span class=\"line\">\t\tdrawStr,</span><br><span class=\"line\">\t\tgtranslate.FromTo&#123;</span><br><span class=\"line\">\t\t\tFrom: <span class=\"string\">\"zh-cn\"</span>,</span><br><span class=\"line\">\t\t\tTo:   <span class=\"string\">\"ja\"</span>,</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">\"translate error: %v \\n\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t_, err = c.DrawString(translated, freetype.Pt(target.Rect.Max.X/<span class=\"number\">2</span>-(utf8.RuneCountInString(translated)/<span class=\"number\">2</span>)*fixed.Ceil(), fontPin.Y.Ceil()+fixed.Ceil()))</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">\"draw error: %v \\n\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取字符集，仅调用一次</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getFontFamily</span><span class=\"params\">()</span> <span class=\"params\">(*truetype.Font, error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 这里需要读取中文字体，否则中文文字会变成方格</span></span><br><span class=\"line\">\tfontBytes, err := ioutil.ReadFile(<span class=\"string\">\"msyh.ttc\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"read file error:\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> &amp;truetype.Font&#123;&#125;, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tf, err := freetype.ParseFont(fontBytes)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"parse font error:\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> &amp;truetype.Font&#123;&#125;, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> f, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"image","slug":"image","permalink":"chunlife.top/tags/image/"}]},{"title":"函数选择模式(Functional Options Patter)","date":"2019-07-17T09:48:37.000Z","path":"2019/07/17/函数选择模式-Functional-Options-Patter/","content":"<p>有时候一个函数会有很多参数，为了方便函数的使用，我们会给希望给一些参数设定默认值，调用时只需要传与默认值不同的参数即可，类似于 python 里面的默认参数和字典参数，虽然 golang 里面既没有默认参数也没有字典参数，但是我们有选项模式。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"可变长参数列表\"><a href=\"#可变长参数列表\" class=\"headerlink\" title=\"可变长参数列表\"></a>可变长参数列表</h3><p>在这之前，首先需要介绍一下可变长参数列表，顾名思义，就是参数的个数不固定，可以是一个也可以是多个，最典型的用法就是标准库里面的 <code>fmt.Printf</code>，语法比较简单，如下面例子实现任意多个参数的加法</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func add(nums ...int) int &#123;</span><br><span class=\"line\">    sum := 0</span><br><span class=\"line\">    for _, num := range nums &#123;</span><br><span class=\"line\">        sum += num</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return sum</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">So(add(1, 2), ShouldEqual, 3)</span><br><span class=\"line\">So(add(1, 2, 3), ShouldEqual, 6)</span><br></pre></td></tr></table></figure>\n\n<p>在类型前面加 <code>...</code> 来表示这个类型的变长参数列表，使用上把参数当成 <code>slice</code> 来用即可</p>\n<h3 id=\"选项模式\"><a href=\"#选项模式\" class=\"headerlink\" title=\"选项模式\"></a>选项模式</h3><p>假设我们要实现这样一个函数，这个函数接受5个参数，三个 <code>string</code>（其中第一个参数是必填参数），两个 <code>int</code>，这里功能只是简单输出这个参数，于是我们可以简单用如下代码实现</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func MyFunc1(requiredStr string, str1 string, str2 string, int1 int, int2 int) &#123;</span><br><span class=\"line\">    fmt.Println(requiredStr, str1, str2, int1, int2)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">// 调用方法</span><br><span class=\"line\">MyFunc1(&quot;requiredStr&quot;, &quot;defaultStr1&quot;, &quot;defaultStr2&quot;, 1, 2)</span><br></pre></td></tr></table></figure>\n\n<p>这种实现比较简单，但是同时传入参数较多，对调用方来说，使用的成本就会比较高，而且每个参数的具体含义这里并不清晰，很容易出错</p>\n<p>那选项模式怎么实现这个需求呢？先来看下最终的效果</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyFunc2(&quot;requiredStr&quot;)</span><br><span class=\"line\">MyFunc2(&quot;requiredStr&quot;, WithOptionStr1(&quot;mystr1&quot;))</span><br><span class=\"line\">MyFunc2(&quot;requiredStr&quot;, WithOptionStr2AndInt2(&quot;mystr2&quot;, 22), WithOptionInt1(11))</span><br></pre></td></tr></table></figure>\n\n<p>如上面代码所示，你可以根据自己的需求选择你需要传入的参数，大大简化了函数调用的复杂度，并且每个参数都有了清晰明确的含义</p>\n<p>那怎么实现上面的功能呢</p>\n<h4 id=\"定义可选项和默认值\"><a href=\"#定义可选项和默认值\" class=\"headerlink\" title=\"定义可选项和默认值\"></a>定义可选项和默认值</h4><p>首先定义可选项和默认值，这里有4个可选项，第一个参数为必填项</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type MyFuncOptions struct &#123;</span><br><span class=\"line\">    optionStr1 string</span><br><span class=\"line\">    optionStr2 string</span><br><span class=\"line\">    optionInt1 int</span><br><span class=\"line\">    optionInt2 int</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">var defaultMyFuncOptions = MyFuncOptions&#123;</span><br><span class=\"line\">    optionStr1: &quot;defaultStr1&quot;,</span><br><span class=\"line\">    optionStr2: &quot;defaultStr2&quot;,</span><br><span class=\"line\">    optionInt1: 1,</span><br><span class=\"line\">    optionInt2: 2,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"实现-With-方法\"><a href=\"#实现-With-方法\" class=\"headerlink\" title=\"实现 With 方法\"></a>实现 With 方法</h4><p>这些 With 方法看起来有些古怪，接受一个选项参数，返回一个选项方法，而选项方法以选项作为参数负责修改选项的值，如果没看明白没关系，可以先看函数功能如何实现</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type MyFuncOption func(options *MyFuncOptions)</span><br><span class=\"line\">func WithOptionStr1(str1 string) MyFuncOption &#123;</span><br><span class=\"line\">    return func(options *MyFuncOptions) &#123;</span><br><span class=\"line\">        options.optionStr1 = str1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func WithOptionInt1(int1 int) MyFuncOption &#123;</span><br><span class=\"line\">    return func(options *MyFuncOptions) &#123;</span><br><span class=\"line\">        options.optionInt1 = int1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func WithOptionStr2AndInt2(str2 string, int2 int) MyFuncOption &#123;</span><br><span class=\"line\">    return func(options *MyFuncOptions) &#123;</span><br><span class=\"line\">        options.optionStr2 = str2</span><br><span class=\"line\">        options.optionInt2 = int2</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里我们让 optionStr2 和 optionInt2 合并一起设置，实际应用场景中可以用这种方式将相关的参数放到一起设置</p>\n<h4 id=\"实现函数功能\"><a href=\"#实现函数功能\" class=\"headerlink\" title=\"实现函数功能\"></a>实现函数功能</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func MyFunc2(requiredStr string, opts ...MyFuncOption) &#123;</span><br><span class=\"line\">    options := defaultMyFuncOptions</span><br><span class=\"line\">    for _, o := range opts &#123;</span><br><span class=\"line\">        o(&amp;options)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    fmt.Println(requiredStr, options.optionStr1, options.optionStr2, options.optionInt1, options.optionInt2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>使用 With 方法返回的选项方法作为参数列表，用这些方法去设置选项。</strong></p>\n<blockquote>\n<p>转载自：<a href=\"http://www.hatlonely.com/2018/03/10/golang-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%80%89%E9%A1%B9%E6%A8%A1%E5%BC%8F/index.html\" target=\"_blank\" rel=\"noopener\">golang 设计模式之选项模式</a></p>\n</blockquote>\n<hr>\n<p>将代码直接拿出运行即可知道其中奥妙，这里面合理运行了Go的可变长参数特性。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> MyFuncOptions <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\toptionStr1 <span class=\"keyword\">string</span></span><br><span class=\"line\">\toptionStr2 <span class=\"keyword\">string</span></span><br><span class=\"line\">\toptionInt1 <span class=\"keyword\">int</span></span><br><span class=\"line\">\toptionInt2 <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">var</span> defaultMyFuncOptions = MyFuncOptions&#123;</span><br><span class=\"line\">\toptionStr1: <span class=\"string\">\"defaultStr1\"</span>,</span><br><span class=\"line\">\toptionStr2: <span class=\"string\">\"defaultStr2\"</span>,</span><br><span class=\"line\">\toptionInt1: <span class=\"number\">1</span>,</span><br><span class=\"line\">\toptionInt2: <span class=\"number\">2</span>,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> MyFuncOption <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(options *MyFuncOptions)</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">func</span> <span class=\"title\">WithOptionStr1</span><span class=\"params\">(str1 <span class=\"keyword\">string</span>)</span> <span class=\"title\">MyFuncOption</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(options *MyFuncOptions)</span></span> &#123;</span><br><span class=\"line\">\t\toptions.optionStr1 = str1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">WithOptionInt1</span><span class=\"params\">(int1 <span class=\"keyword\">int</span>)</span> <span class=\"title\">MyFuncOption</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(options *MyFuncOptions)</span></span> &#123;</span><br><span class=\"line\">\t\toptions.optionInt1 = int1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">WithOptionStr2AndInt2</span><span class=\"params\">(str2 <span class=\"keyword\">string</span>, int2 <span class=\"keyword\">int</span>)</span> <span class=\"title\">MyFuncOption</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(options *MyFuncOptions)</span></span> &#123;</span><br><span class=\"line\">\t\toptions.optionStr2 = str2</span><br><span class=\"line\">\t\toptions.optionInt2 = int2</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">MyFunc2</span><span class=\"params\">(requiredStr <span class=\"keyword\">string</span>, opts ...MyFuncOption)</span></span> &#123;</span><br><span class=\"line\">\toptions := defaultMyFuncOptions</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, o := <span class=\"keyword\">range</span> opts &#123;</span><br><span class=\"line\">\t\to(&amp;options)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfmt.Println(requiredStr, options.optionStr1, options.optionStr2, options.optionInt1, options.optionInt2)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//grpc.Dial(\"xxx\", grpc.WithInsecure(), grpc.WithTimeout(time.Duration(10*time.Second)))</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tMyFunc2(<span class=\"string\">\"requiredStr\"</span>)</span><br><span class=\"line\">\tMyFunc2(<span class=\"string\">\"requiredStr\"</span>, WithOptionStr1(<span class=\"string\">\"mystr1\"</span>))</span><br><span class=\"line\">\tMyFunc2(<span class=\"string\">\"requiredStr\"</span>, WithOptionStr2AndInt2(<span class=\"string\">\"mystr2\"</span>, <span class=\"number\">22</span>), WithOptionInt1(<span class=\"number\">11</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"GRPC\"><a href=\"#GRPC\" class=\"headerlink\" title=\"GRPC\"></a>GRPC</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grpc.Dial(addr, grpc.WithInsecure())</span><br><span class=\"line\">grpc.Dial(addr, grpc.WithInsecure(), grpc.WithTimeout(time.Duration(<span class=\"number\">10</span>*time.Second)))</span><br></pre></td></tr></table></figure>\n\n<p>在<code>grpc</code>中，这样的设计在<code>google.golang.org/grpc/clientconn.go</code>的<code>Dial(target string, opts ...DialOption)</code>，其中<code>DialOption</code>各函数在<code>google.golang.org/grpc/dialoptions.go</code>中。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Dial</span><span class=\"params\">(target <span class=\"keyword\">string</span>, opts ...DialOption)</span> <span class=\"params\">(*ClientConn, error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> DialContext(context.Background(), target, opts...)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">DialContext</span><span class=\"params\">(ctx context.Context, target <span class=\"keyword\">string</span>, opts ...DialOption)</span> <span class=\"params\">(conn *ClientConn, err error)</span></span> &#123;</span><br><span class=\"line\">\tcc := &amp;ClientConn&#123;</span><br><span class=\"line\">\t\ttarget:            target,</span><br><span class=\"line\">\t\tcsMgr:             &amp;connectivityStateManager&#123;&#125;,</span><br><span class=\"line\">\t\tconns:             <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[*addrConn]<span class=\"keyword\">struct</span>&#123;&#125;),</span><br><span class=\"line\">\t\tdopts:             defaultDialOptions(),</span><br><span class=\"line\">\t\tblockingpicker:    newPickerWrapper(),</span><br><span class=\"line\">\t\tczData:            <span class=\"built_in\">new</span>(channelzData),</span><br><span class=\"line\">\t\tfirstResolveEvent: grpcsync.NewEvent(),</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"comment\">// 调用传入的设置函数 拿出来一个一个的设置</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, opt := <span class=\"keyword\">range</span> opts &#123;</span><br><span class=\"line\">\t\topt.apply(&amp;cc.dopts)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>而这些函数设计思路和上面讲述是一样的。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">WithDisableRetry</span><span class=\"params\">()</span> <span class=\"title\">DialOption</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> newFuncDialOption(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(o *dialOptions)</span></span> &#123;</span><br><span class=\"line\">\t\to.disableRetry = <span class=\"literal\">true</span></span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">WithTimeout</span><span class=\"params\">(d time.Duration)</span> <span class=\"title\">DialOption</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> newFuncDialOption(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(o *dialOptions)</span></span> &#123;</span><br><span class=\"line\">\t\to.timeout = d</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>此外，当我们需要加入的新的参数时，我们只需要加入新函数选项，以前的调用则给定一个默认值。</p>\n<p>函数式选择模式比较常见的用法即是在<code>GRPC</code>上所用，在其他开源基本也是如此用法。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Functional Options Patter","slug":"Functional-Options-Patter","permalink":"chunlife.top/tags/Functional-Options-Patter/"},{"name":"函数选择模式","slug":"函数选择模式","permalink":"chunlife.top/tags/函数选择模式/"}]},{"title":"go操作usb","date":"2019-07-17T09:44:37.000Z","path":"2019/07/17/go操作usb/","content":"<p>因为要涉及到重新置换以前的硬件操作方案，在重新梳理以前项目后，发现使用的语言繁多，其中使用到了一种公司内部开发的脚本，从易读性和功能性上来看，出于<code>减负</code>的目的，将这些个能被替换的语言，尽量统一。</p>\n<p>同时，在使用过程中，这个库能找到的相关博客少的可怜，于是写下这一篇详细的使用解析，方便后来人进行使用该库，避免遇到一知半解的问题。</p>\n<a id=\"more\"></a>\n\n<p>像一些USB设备，都是串接在一个arm设备上进行管理，然后由arm设备进行状态控制。（这里有点疑惑以前的方案为啥要使用USB，一般情况这种一对多的，使用像485组网大概会更方便些，算是一个比较性价比的方案，当然现在的方案是不可能变动的了。）</p>\n<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><h3 id=\"gousb\"><a href=\"#gousb\" class=\"headerlink\" title=\"gousb\"></a>gousb</h3><p>Go操作USB使用到的库是<a href=\"https://github.com/google/gousb\" target=\"_blank\" rel=\"noopener\">gousb</a>，不过在使用过程中，库不支持USB的热插拔event，在这个<a href=\"https://github.com/google/gousb/issues/8\" target=\"_blank\" rel=\"noopener\">issue</a>中有coder完成了这项功能，在这里贴上。感谢作者<a href=\"https://github.com/nkovacs\" target=\"_blank\" rel=\"noopener\">nkovacs</a>。当然作者提交了pr，当被拒绝了，主要是维护者认为库的注册方式是链式调用函数，他们认为在Go中不太常使用，更为常见的是使用的是<code>函数选择模式</code>，这在我之前的博客有讲解过（竟然又见了）。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">h := gousb.Hotplug().Enumerate().ProductID(<span class=\"number\">0x1234</span>).Register(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">...</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>因为主库没有合并这个特性，我们直接使用该特性即可，这里我讲主库与这个特性合并了。<a href=\"https://github.com/younglifestyle/gousb\" target=\"_blank\" rel=\"noopener\">库</a>。</p>\n<h3 id=\"libusb\"><a href=\"#libusb\" class=\"headerlink\" title=\"libusb\"></a>libusb</h3><p>很遗憾，这个库是一个Cgo库，也就是需要使用到C库，所以程序并不是一个无依赖，可直接单文件使用的库，这里我们需要按照<a href=\"http://sourceforge.net/projects/libusb/files/libusb-1.0/\" target=\"_blank\" rel=\"noopener\">libusb</a>。</p>\n<p>安装：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install libudev-dev</span><br><span class=\"line\">./configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"举个栗子\"><a href=\"#举个栗子\" class=\"headerlink\" title=\"举个栗子\"></a>举个栗子</h2><p>使用介绍可以参考<a href=\"https://godoc.org/github.com/google/gousb\" target=\"_blank\" rel=\"noopener\">GoDoc</a>，这里头有两个简单的例子，若使用，则最好清楚函数的为何要填写这些数据。</p>\n<p>直接上我写的一个例子，</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Initialize a new Context.</span></span><br><span class=\"line\">ctx := gousb.NewContext()</span><br><span class=\"line\"><span class=\"keyword\">defer</span> ctx.Close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Open any device with a given VID/PID using a convenience function.</span></span><br><span class=\"line\">dev, err := ctx.OpenDeviceWithVIDPID(<span class=\"number\">0xba57</span>, <span class=\"number\">0x1001</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"Could not open a device: \"</span>, err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">defer</span> dev.Close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Detach INTERFACE1 &amp; INTERFACE2</span></span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"Set auto-detach\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err := dev.SetAutoDetach(<span class=\"literal\">true</span>); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"Failed to set auto-detach: %v\"</span>, err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Switch the configuration to #1</span></span><br><span class=\"line\">cfg, err := dev.Config(<span class=\"number\">1</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%s.Config(1): %v \\n\"</span>, dev, err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">defer</span> cfg.Close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// In the config #1, claim interface #0 with alt setting #0.</span></span><br><span class=\"line\">intf, err := cfg.Interface(<span class=\"number\">0</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%s.Interface(0, 0): %v \\n\"</span>, cfg, err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">defer</span> intf.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(intf.Setting.Endpoints)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// And in the same interface open endpoint #5 for writing.</span></span><br><span class=\"line\">epOut, err := intf.OutEndpoint(<span class=\"number\">0x02</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%s.OutEndpoint(0x02): %v\"</span>, intf, err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">fmt.Println(epOut.String())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// In this interface open endpoint #6 for reading. 0x81</span></span><br><span class=\"line\">epIn, err := intf.InEndpoint(<span class=\"number\">0x82</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%s.InEndpoint(0x81): %v\"</span>, intf, err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">fmt.Println(epIn.String())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// writeBytes might be smaller than the buffer size if an error occurred. writeBytes might be greater than zero even if err is not nil.</span></span><br><span class=\"line\">writes, err := epOut.Write([]<span class=\"keyword\">byte</span>(<span class=\"string\">`&#123;\"xxx\":\"xxx\"&#125;\\r`</span>))</span><br><span class=\"line\"><span class=\"comment\">//writes, err := epOut.Write([]byte(\"123\"))</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"Write returned an error:\"</span>, err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"write :\"</span>, writes)</span><br><span class=\"line\"></span><br><span class=\"line\">buf := <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, <span class=\"number\">20</span>)</span><br><span class=\"line\">readBytes, err := epIn.Read(buf)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"Read returned an error:\"</span>, err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> readBytes == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"IN endpoint returned 0 bytes of data.\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"read :\"</span>, readBytes, <span class=\"keyword\">string</span>(buf))</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解析函数\"><a href=\"#解析函数\" class=\"headerlink\" title=\"解析函数\"></a>解析函数</h2><ul>\n<li><code>gousb.NewContext()</code>中的context：</li>\n</ul>\n<p>Context管理与USB设备通信所需的所有资源。通过Context，用户可以遍历可用的USB设备。</p>\n<ul>\n<li><code>OpenDeviceWithVIDPID</code>：</li>\n</ul>\n<p>根据PID和VID打开设备，当设备不存在，则无法打开。还可以循环遍历设备进行打开设备操作。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// var devs []*gousb.Device</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// OpenDevices is used to find the devices to open.</span></span><br><span class=\"line\">devs, err := ctx.OpenDevices(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(desc *gousb.DeviceDesc)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// After inspecting the descriptor, return true or false depending on whether</span></span><br><span class=\"line\">\t<span class=\"comment\">// the device is \"interesting\" or not.  Any descriptor for which true is returned</span></span><br><span class=\"line\">\t<span class=\"comment\">// opens a Device which is retuned in a slice (and must be subsequently closed).</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> desc.Vendor == gousb.ID(xxxx) &amp;&amp; desc.Product == gousb.ID(xxxx) &#123;</span><br><span class=\"line\">\t\tlog.Debugf(<span class=\"string\">\"Found device: %v\"</span>, desc)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>SetAutoDetach</code>：</li>\n</ul>\n<p>SetAutoDetach启用/禁用自动内核驱动程序分离。 启用auto-detach后，gousb将自动分离接口上的内核驱动程序，并在释放接口时重新挂接它。 默认情况下，在新打开的设备句柄上禁用自动内核驱动程序分离。</p>\n<ul>\n<li><code>dev.Config(1)</code>：</li>\n</ul>\n<p>获取配置描述符，这里涉及usb的一些概念，在usb中其实有很多描述符来配置usb的相关属性，和描述usb的相关特性，这里就是通过该函数去获取其中的配置描述符。可以在linux中使用<code>lsusb</code>命令查看到。<br><img src=\"1563335549361.png\" alt=\"1563335549361\"></p>\n<p>这些是概念，其中参数填<code>1</code>，我们还未搞清楚。</p>\n<p>接下来，看代码，配置描述符是具象化在库中的结构体<code>ConfigDesc</code>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> ConfigDesc <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Number         <span class=\"keyword\">int</span></span><br><span class=\"line\">    SelfPowered    <span class=\"keyword\">bool</span></span><br><span class=\"line\">    RemoteWakeup   <span class=\"keyword\">bool</span></span><br><span class=\"line\">    MaxPower       Milliamperes</span><br><span class=\"line\">    Interfaces     []InterfaceDesc</span><br><span class=\"line\">    iConfiguration <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>而这些数据都在调用<code>OpenDeviceWithVIDPID</code>函数后，被读取到程序中，相应的配置描述符在<code>dev.Desc.Configs</code>中，该变量为<code>map[int]ConfigDesc</code>，而案例中，我只有一个配置描述符，且<code>key</code>为<code>1</code>，所以在程序中直接就给定了。</p>\n<ul>\n<li><code>cfg.Interface(0, 0)</code>：</li>\n</ul>\n<p>程序需要透过操作系统的中间层<code>USB controller interface</code>，以此来和device进行交互操作。接口声明并返回USB设备上的接口。 num指定要声明的接口的编号，alt指定该接口的备用设置编号。若指定出错，库会打印出正确的配置信息。</p>\n<p><strong>这里的参数时怎么得来的呢</strong>？</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fmt.Println(<span class=\"built_in\">len</span>(cfg.Desc.Interfaces), cfg.Desc.Interfaces[<span class=\"number\">0</span>].String())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 1    Interface 0 (1 alternate settings)</span></span><br></pre></td></tr></table></figure>\n\n<p>填入<code>interface</code>数组索引，引用其中的第一个<code>alternate settings</code>。根据实际设备上的参数可以得到<code>(0, 0)</code>的传参。</p>\n<ul>\n<li><code>endpoint</code>：</li>\n</ul>\n<p>usb中数据传输有个endpoint的概念，可以被认为类似于UDP / IP端口，但数据传输是单向的。端点由Endpoint结构表示，所有定义的端点都可以通过Interface.Setting的Endpoints字段获得。<br>调用函数返回的结构体中分别含有<code>read</code>或<code>write</code>方法。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> epNum, endpoints := <span class=\"keyword\">range</span> st.intf.Setting.Endpoints &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> endpoints.Direction == gousb.EndpointDirectionOut &#123;</span><br><span class=\"line\">\t\tst.output, err = st.intf.OutEndpoint(<span class=\"keyword\">int</span>(epNum))</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tlog.Error(<span class=\"string\">\"set outpoint error,\"</span>, err)</span><br><span class=\"line\">\t\t\tst.Close()</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tst.input, err = st.intf.InEndpoint(<span class=\"keyword\">int</span>(epNum))</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tlog.Error(<span class=\"string\">\"set inpoint error,\"</span>, err)</span><br><span class=\"line\">\t\t\tst.Close()</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>control</code>函数：</li>\n</ul>\n<p>这里提一下，USB传输可以分为四种传输方式：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">传输方式</span><br><span class=\"line\">      USB，有四种的传输方式，控制(Control)，同步(isochronous)，中断(interrupt)，大量(bulk)。如果你是从硬件开始来设计整个的系统，你还要正确选择传输的方式，而作为一个驱动程序的书写者，就只需要弄清楚他是采用的什么工作方式就行了，通常所有的传输方式下的主动权都在PC边,也就是host边。</span><br><span class=\"line\">1、控制(Control)方式传输，控制传输是双向传输，数据量通常较小，USB系统软件用来主要进行查询，配置和给USB设备发送通用的命令，控制传输方式可以包括，8，16，32和64字节的数据，这依赖于设备和传输速度，控制传输典型地用在主计算机和USB外设之间的端点(Endpoint)0之间的传输，但是指定供应商的控制传输可能用到其它的端点。</span><br><span class=\"line\"></span><br><span class=\"line\">2、同步(isochronous)方式传输，同步传输提供了确定的带宽和间隔时间（latency)，它被用于时间严格并具有较强容错性的流数据传输，或者用于要求恒定的数据传输率的即时应用中，例如执行即时通话的网络电话应用时，使用同步传输模式是很好的选择，同步数据要求确定的带宽值和确定的最大传输次数，对于同步传输来说，即时的数据传递比完美的精度和数据的完整性更重要一些。</span><br><span class=\"line\"></span><br><span class=\"line\">3、中断(interrupt)方式传输，中断方式传输主要用于定时查询设备是否有中断数据要传输设备的端点模式器的结构决定了它的查询频率，从1到255ms之间，这种传输方式典型的应用在少量的分散的，不可预测数据的传输，键盘，操纵杆和鼠标就属于这一类型中断方式传输是单向的并且对于host，来说只有输入的方式。</span><br><span class=\"line\"></span><br><span class=\"line\">4、大量(bulk)传输，主要应用在数据大量传输传输和接受数据上，同时又没有带宽和间隔时间要求的情况下，要求保证传输，打印机和扫描仪属于这种类型，这种类型的设备适合于传输非常慢和大量被延迟的传输，可以等到所有其它类型的数据的传输完成之后再传输和接收数据。</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>   USB将其有效的带宽分成各个不同的帧(frame)，每帧通常是1ms时间长，每个设备每帧只能传输一个同步的传输包，在完成了系统的配置信息和连接之后，USB的host就会对不同的传输点和传输方式做一个统筹安排，用来适应整个的USB的带宽，<strong>通常情况下，同步方式和中断方式的传输会占据整个带宽的90%，剩下的就安排给控制方式传输数据。</strong></p>\n</blockquote>\n<p>函数有为control传输留有函数：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(d *Device)</span> <span class=\"title\">Control</span><span class=\"params\">(rType <span class=\"keyword\">uint8</span>, request <span class=\"keyword\">uint8</span>, val <span class=\"keyword\">uint16</span>, idx <span class=\"keyword\">uint16</span>, data []<span class=\"keyword\">byte</span>)</span> <span class=\"params\">(<span class=\"keyword\">int</span>, error)</span></span></span><br></pre></td></tr></table></figure>\n\n<p>参数的填写需要对照数据手册：<a href=\"http://www.jungo.com/st/support/documentation/windriver/802/wdusb_man_mhtml/node55.html\" target=\"_blank\" rel=\"noopener\">USB Control Transfers Overview</a>。这里头就有几张表记录着这些参数的对照。</p>\n<h3 id=\"热插拔\"><a href=\"#热插拔\" class=\"headerlink\" title=\"热插拔\"></a>热插拔</h3><p>热插拔的使用在这个issue中被介绍，<a href=\"https://github.com/google/gousb/issues/8\" target=\"_blank\" rel=\"noopener\">Hot Plug Support</a>，可以参考，使用也很简单，这插一段简单使用的代码。</p>\n<p>值得注意的是，注册热插拔函数后，热插拔函数会自动去扫描USB设备，然后触发注册的热插拔处理函数，也就是说，我的系统有三个usb设备，在注册完函数后，其会被自动调用三次，也就说可以在被触发函数中open设备，<code>evt.DeviceDesc()</code>可以获取<code>pid</code>和<code>vid</code>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ctx.RegisterHotplug(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(evt gousb.HotplugEvent)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> evt.Type() == gousb.HotplugEventDeviceArrived &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"arrived device\"</span>, evt.Type())</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"un-arrived device\"</span>, evt.Type())</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Functional Options Patter","slug":"Functional-Options-Patter","permalink":"chunlife.top/tags/Functional-Options-Patter/"},{"name":"函数选择模式","slug":"函数选择模式","permalink":"chunlife.top/tags/函数选择模式/"}]},{"title":"CSDN自动展开chorme插件","date":"2019-07-01T04:52:06.000Z","path":"2019/07/01/CSDN自动展开chorme插件/","content":"<p>之前推荐过CSDN自动展开阅读的<a href=\"https://github.com/silenceshell/csdn-auto-readmore\" target=\"_blank\" rel=\"noopener\">chorme插件</a>，但今天无法使用了，这让我很不解，于是去翻看了CSDN的HTML页面代码。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a <span class=\"class\"><span class=\"keyword\">class</span></span>=<span class=\"string\">\"btn-readmore\"</span> data-track-click=<span class=\"string\">\"&#123;&amp;quot;mod&amp;quot;:&amp;quot;popu_376&amp;quot;,&amp;quot;con&amp;quot;:&amp;quot;,https://blog.csdn.net/jiangxuege/article/details/87912947,readmore&amp;quot;&#125;\"</span>&gt;</span><br><span class=\"line\">                展开阅读全文</span><br><span class=\"line\">                &lt;svg <span class=\"class\"><span class=\"keyword\">class</span></span>=<span class=\"string\">\"icon chevrondown\"</span> aria-hidden=<span class=\"string\">\"true\"</span>&gt;</span><br><span class=\"line\">                    &lt;use xlink:href=<span class=\"string\">\"#csdnc-chevrondown\"</span>&gt;&lt;/use&gt;</span><br><span class=\"line\">                &lt;<span class=\"regexp\">/svg&gt;</span></span><br><span class=\"line\"><span class=\"regexp\">            &lt;/</span>a&gt;</span><br></pre></td></tr></table></figure>\n\n<p>在插件中的JS代码为：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> btn = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"btn-readmore\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (btn)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    btn.click();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这应该是CSDN方修改了一些页面结构，这里不管，看到<code>class</code>，手动修改插件为<code>document.getElementsByClassName</code>，但实际上我从浏览器console上得到的结果是：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">auto.js:4 Uncaught TypeError: btn.click is not a function</span><br></pre></td></tr></table></figure>\n\n<p>这貌似有些尴尬，但还有方法，就是查看CSDN是怎么找到这个标签的。</p>\n<p>使用浏览器的<code>检查</code>找到这个标签，右键——&gt; Copy ——&gt; Copy Js Path。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">document</span>.querySelector(<span class=\"string\">\"#mainBox &gt; main &gt; div.hide-article-box.hide-article-pos.text-center &gt; a\"</span>)</span><br></pre></td></tr></table></figure>\n\n<p>我们借鉴一下采用<code>querySelector</code>这个方法，结果是成功的，将JS代码改为：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> btn = <span class=\"built_in\">document</span>.querySelector(<span class=\"string\">\".btn-readmore\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (btn)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    btn.click();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>已提交pr并合并，直接拉仓库即可。</p>\n</blockquote>\n<p>还有没有其他简单的方法去除CSDN的这个展开呢，有的，chorme使用油猴插件，其中有一个作者的插件就能完成，而且自带去除广告的功能，比这个更为强大。</p>\n<p><a href=\"[https://greasyfork.org/zh-CN/scripts/372452-csdn%E8%87%AA%E5%8A%A8%E5%B1%95%E5%BC%80-%E5%8E%BB%E5%B9%BF%E5%91%8A-%E5%87%80%E5%8C%96%E5%89%AA%E8%B4%B4%E6%9D%BF-%E5%85%8D%E7%99%BB%E9%99%86](https://greasyfork.org/zh-CN/scripts/372452-csdn自动展开-去广告-净化剪贴板-免登陆)\">CSDN自动展开+去广告+净化剪贴板+免登陆</a>。</p>\n","categories":[{"name":"实用工具","slug":"实用工具","permalink":"chunlife.top/categories/实用工具/"}],"tags":[{"name":"便笺","slug":"便笺","permalink":"chunlife.top/tags/便笺/"},{"name":"Sticky Notes","slug":"Sticky-Notes","permalink":"chunlife.top/tags/Sticky-Notes/"}]},{"title":"一致性hash","date":"2019-07-01T01:47:08.000Z","path":"2019/07/01/一致性hash/","content":"<p>在分布式应用中，我们希望服务器能够分担整体框架的缓冲压力，希望存储请求能够均匀的分散在已有的服务器中，足够平均，也就能最大化的使用服务器，比如falcon的<code>transfer</code>模块，经过一致性哈希算法，对数据的发送目的地进行均匀分布后，有效进行存储，而其中的关键即是<code>均匀</code>，当然后面还会将会提到节点变化引发的映射变化。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"解析\"><a href=\"#解析\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>当看到这里的时候，可以联想一下<code>Map</code>，这和分布式里头的运用是很像的，map也是要讲究让数据均匀分布，以此来保证map操作时间都为O(1)。<br>可以想象，map的结构是一个哈希key后头挂一个链表，在数据均匀的挂在每一个哈希值上时，map时间才会是O(1)<code>常量时间</code>。这样理想的存储方式，才既不会浪费空间，也不会消耗时间。</p>\n<p><img src=\"1561981837185.png\" alt=\"图片来自《算法图解》\"></p>\n<p>鉴于此，假如我们有100台服务器作为服务节点<code>nodes</code>，将1000W个数据分布到这100台数据节点上，使用普通哈希算法进行计算，然后以服务节点取模，算出落到服务器节点上的数量。</p>\n<p><img src=\"fe155f98-3a5e-11e6-834d-193e6f85afcd.png\" alt=\"normal_hash\"></p>\n<p>大致<a href=\"https://github.com/younglifestyle/hash_test/blob/master/%E6%99%AE%E9%80%9A%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0.go\" target=\"_blank\" rel=\"noopener\">代码（Go）</a>：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tITEMS = <span class=\"number\">10000000</span></span><br><span class=\"line\">\tNODES = <span class=\"number\">100</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 创建节点数据</span></span><br><span class=\"line\">\tnodeStat := <span class=\"built_in\">make</span>(byInt, NODES)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; ITEMS; i++ &#123;</span><br><span class=\"line\">\t\tmd5Byte := MD5(strconv.Itoa(i))</span><br><span class=\"line\">\t\tvalue := genValue(md5Byte[<span class=\"number\">6</span>:<span class=\"number\">10</span>])</span><br><span class=\"line\">\t\tn := value % NODES</span><br><span class=\"line\">\t\tnodeStat[n] += <span class=\"number\">1</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsort.Sort(nodeStat)</span><br><span class=\"line\"></span><br><span class=\"line\">\tave := ITEMS / NODES</span><br><span class=\"line\">\tMax := nodeStat[<span class=\"built_in\">len</span>(nodeStat)<span class=\"number\">-1</span>]</span><br><span class=\"line\">\tMin := nodeStat[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"Ave: %d \\n\"</span>, ave)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"Max: %d\\t(%0.2f%%) \\n\"</span>, Max,</span><br><span class=\"line\">\t\t<span class=\"keyword\">float64</span>(Max-ave)*<span class=\"number\">100.0</span>/<span class=\"keyword\">float64</span>(ave))</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"Min: %d\\t(%0.2f%%) \\n\"</span>, Min,</span><br><span class=\"line\">\t\t<span class=\"keyword\">float64</span>(ave-Min)*<span class=\"number\">100.0</span>/<span class=\"keyword\">float64</span>(ave))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//  其中一次运行的数据</span></span><br><span class=\"line\"><span class=\"comment\">//  Ave: 100000 </span></span><br><span class=\"line\"><span class=\"comment\">//  Max: 100656\t(0.66%) </span></span><br><span class=\"line\"><span class=\"comment\">//  Min: 99188\t(0.81%)</span></span><br></pre></td></tr></table></figure>\n\n<p>均匀分布后，就需要考虑另一个显著的问题，例如在分布式场景中，有服务器节点掉线或增加节点后，哈希分布就会重新变化，原有的节点映射将发生变化，这是因为普通哈希算法依赖于节点的数量（<code>node</code>），当节点数量变化后，数据项也将发生变化。</p>\n<p><a href=\"https://github.com/younglifestyle/hash_test/blob/master/%E6%99%AE%E9%80%9A%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0%E4%B9%8B%E8%8A%82%E7%82%B9%E5%8F%98%E5%8C%96.go\" target=\"_blank\" rel=\"noopener\">代码</a>：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tchange := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; ITEMS; i++ &#123;</span><br><span class=\"line\">\t\tmd5Byte := MD5(strconv.Itoa(i))</span><br><span class=\"line\">\t\tvalue := genValue(md5Byte[<span class=\"number\">6</span>:<span class=\"number\">10</span>])</span><br><span class=\"line\">\t\t<span class=\"comment\">// 原映射结果</span></span><br><span class=\"line\">\t\tn := value % NODES</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//现映射结果</span></span><br><span class=\"line\">\t\tnNew := value % NEW_NODES</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n != nNew &#123;</span><br><span class=\"line\">\t\t\tchange += <span class=\"number\">1</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Println(<span class=\"keyword\">float64</span>(change) / <span class=\"keyword\">float64</span>(ITEMS))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 0.9799679</span></span><br></pre></td></tr></table></figure>\n\n<p>结果上可以看出，变化率极高，在分布式场景中，这显然是不适用的。</p>\n<h2 id=\"一致性哈希\"><a href=\"#一致性哈希\" class=\"headerlink\" title=\"一致性哈希\"></a>一致性哈希</h2><blockquote>\n<p>维基百科：</p>\n</blockquote>\n<p><strong>需求</strong></p>\n<blockquote>\n<p>在使用n台缓存服务器时，一种常用的负载均衡方式是，对资源o的请求使用hash(o)=o mod n来映射到某一台缓存服务器。当增加或减少一台缓存服务器时这种方式可能会改变所有资源对应的hash值，也就是所有的缓存都失效了，这会使得缓存服务器大量集中地向原始内容服务器更新缓存。因此需要一致哈希算法来避免这样的问题。<br> 一致哈希尽可能使同一个资源映射到同一台缓存服务器。这种方式要求增加一台缓存服务器时，新的服务器尽量分担存储其他所有服务器的缓存资源。减少一台缓存服务器时，其他所有服务器也可以尽量分担存储它的缓存资源。 一致哈希算法的主要思想是将每个缓存服务器与一个或多个哈希值域区间关联起来，其中区间边界通过计算缓存服务器对应的哈希值来决定。（定义区间的哈希函数不一定和计算缓存服务器哈希值的函数相同，但是两个函数的返回值的范围需要匹配。）如果一个缓存服务器被移除，则它所对应的区间会被并入到邻近的区间，其他的缓存服务器不需要任何改变。</p>\n</blockquote>\n<p>一致性哈希算法解决的痛点，就是当node数发生变化时，尽可能减少数据迁移，减少数据变动。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">具体原理：</span><br><span class=\"line\">先构造一个长度为2^32的整数环（这个环被称为一致性Hash环），根据节点名称的Hash值（其分布为[0, 2^32-1]）将服务器节点放置在这个Hash环上，然后根据数据的Key值计算得到其Hash值（其分布也为[0, 2^32-1]），接着在Hash环上顺时针查找距离这个Key值的Hash值最近的服务器节点，完成Key到服务器的映射查找。</span><br></pre></td></tr></table></figure>\n\n<p><strong>实现</strong></p>\n<blockquote>\n<p>一致哈希将每个对象映射到圆环边上的一个点，系统再将可用的节点机器映射到圆环的不同位置。</p>\n<p>查找某个对象对应的机器时，需要用一致哈希算法计算得到对象对应圆环边上位置，沿着圆环边上查找直到遇到某个节点机器，这台机器即为对象应该保存的位置。 </p>\n<p>当删除一台节点机器时，这台机器上保存的所有对象都要移动到下一台机器。添加一台机器到圆环边上某个点时，这个点的下一台机器需要将这个节点前对应的对象移动到新机器上。 </p>\n<p>更改对象在节点机器上的分布可以通过调整节点机器的位置来实现。</p>\n</blockquote>\n<p>服务器三个节点：node 1~3，四个数据，a、b、c、d。<br>将服务器节点经过哈希计算后，写入哈希环中。数据在决定被写入服务器时，由数据经过哈希计算后，其与服务器节点的值经过比较（<code>找到第一个大于其哈希值的服务器节点</code>），得到其哈希值就可以将哈希值发送给该服务器节点。<br>若该服务器节点失效，则需要再向下遍历出一个大于数据哈希值的节点，将数据重新发送给该服务器节点即可，而其他服务器节点数据不受影响，也就摆脱了第一种普通哈希算法对服务器节点<code>node</code>的依赖。</p>\n<p><img src=\"hash-3.png\" alt=\"hash\"></p>\n<p>直接上<a href=\"https://github.com/younglifestyle/hash_test/blob/master/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C_%E4%B8%8D%E5%B8%A6%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9.go\" target=\"_blank\" rel=\"noopener\">代码</a>：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\thashMap := New(<span class=\"literal\">nil</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tnodes := <span class=\"built_in\">make</span>(UInt32Slice, NODES)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; NODES; i++ &#123;</span><br><span class=\"line\">\t\thashMap.Add(strconv.Itoa(i))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; ITEMS; i++ &#123;</span><br><span class=\"line\">\t\tkey := hashMap.Get(strconv.Itoa(i))</span><br><span class=\"line\">\t\tinter, _ := strconv.Atoi(key)</span><br><span class=\"line\">\t\tnodes[inter] += <span class=\"number\">1</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsort.Sort(nodes)</span><br><span class=\"line\"></span><br><span class=\"line\">\tave := <span class=\"keyword\">uint32</span>(ITEMS / NODES)</span><br><span class=\"line\">\tMax := nodes[<span class=\"built_in\">len</span>(nodes)<span class=\"number\">-1</span>]</span><br><span class=\"line\">\tMin := nodes[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"Ave: %d \\n\"</span>, ave)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"Max: %d\\t(%0.2f%%) \\n\"</span>, Max,</span><br><span class=\"line\">\t\t<span class=\"keyword\">float64</span>(Max-ave)*<span class=\"number\">100.0</span>/<span class=\"keyword\">float64</span>(ave))</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"Min: %d\\t(%0.2f%%) \\n\"</span>, Min,</span><br><span class=\"line\">\t\t<span class=\"keyword\">float64</span>(ave-Min)*<span class=\"number\">100.0</span>/<span class=\"keyword\">float64</span>(ave))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Ave: 100000 </span></span><br><span class=\"line\"><span class=\"comment\">// Max: 497263\t(397.26%) </span></span><br><span class=\"line\"><span class=\"comment\">// Min: 781\t(99.22%)</span></span><br></pre></td></tr></table></figure>\n\n<p>可以看到实际结果和理论上需要达到的效果有所不同，甚至区别相差很大，<strong>数据本身的hash值未发生变化，但服务器节点本身就在环上分布不均匀，导致了每个节点实际占据环上的区间大小就不一样</strong> ，这种情况下，会出现某一节点可能有着巨大的负载。</p>\n<p><img src=\"8c9e6caa-3a5f-11e6-87ad-fdb462b76aef.png\" alt=\"consist_hash_1\"></p>\n<p>该现象被称作<code>Hash环</code>倾斜问题，于是针对这个问题引出了下一个概念。</p>\n<h2 id=\"虚拟节点\"><a href=\"#虚拟节点\" class=\"headerlink\" title=\"虚拟节点\"></a>虚拟节点</h2><p>针对上述的问题，由于服务器节点分布不均匀，导致数据分布不均匀。而节点分布不均，可以看做是环上节点填充不够充分。当我们将环都填充满时，近似的可以看做这样的分布式均匀的，数据可以均匀的分布在每一个节点上。</p>\n<p>根据这个想法，引入虚拟节点的操作。那么我们可以以现有节点为基数来增加虚节点，对每一个节点进行扩充。这样就既保证了在节点变化时，尽可能小的影响数据分布的变化，而同时又保证了数据分布的均匀。也就是靠增加“节点数量”加强管辖区间的均匀。</p>\n<p><img src=\"hash-model.png\" alt=\"hash-model\"></p>\n<p>通过<a href=\"https://github.com/younglifestyle/hash_test/blob/master/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C_%E5%B8%A6%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9_crc32.go\" target=\"_blank\" rel=\"noopener\">代码</a>可以实际看到结果，均匀度相较于之前提升了不少。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ave: 100000 </span><br><span class=\"line\">Max: 156298\t(56.30%) </span><br><span class=\"line\">Min: 9109\t(90.89%)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"哈希的优化\"><a href=\"#哈希的优化\" class=\"headerlink\" title=\"哈希的优化\"></a>哈希的优化</h2><p>这个优化不是我做的，我是直接使用别人的结果，做了后期的验证，在文章<a href=\"https://n4mine.github.io/post/optimize-falcon-graph/\" target=\"_blank\" rel=\"noopener\">Falcon存储做过的那些优化</a>，博主在使用原仓库的哈希函数进行部署falcon，但实际使用中还是出现了流量不均的问题，于是对哈希的各类算法实际表现进行了评估，得出了在哈希函数算法的速度与均匀性上，各类算法的差距是明显的，我在之后的实际验证中也验证了博主的观点，所以在看到文章后，我是直接对falcon这出位置进行了改造（falcon仓库现在还是使用的<code>crc32</code>）。</p>\n<p><a href=\"https://github.com/younglifestyle/hash_test/blob/master/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C_%E5%B8%A6%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9_md5.go\" target=\"_blank\" rel=\"noopener\">例如</a>：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MD5 哈希：</span><br><span class=\"line\">Ave: 100000 </span><br><span class=\"line\">Max: 124240\t(24.24%) </span><br><span class=\"line\">Min: 11585\t(88.42%) </span><br><span class=\"line\"></span><br><span class=\"line\">CRC32 ：</span><br><span class=\"line\">Ave: 100000 </span><br><span class=\"line\">Max: 156298\t(56.30%) </span><br><span class=\"line\">Min: 9109\t(90.89%)</span><br></pre></td></tr></table></figure>\n\n<p>对比的结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">murmur32 &gt; fnv1 &gt; fnv1a &gt; xxHash &gt; crc32</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>参考：</p>\n<p>维基百科的解释：<a href=\"https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C\" target=\"_blank\" rel=\"noopener\">一致哈希</a></p>\n<p><a href=\"http://vitoliu.top/2018/03/14/%E4%B8%80%E8%87%B4%E6%80%A7hash/\" target=\"_blank\" rel=\"noopener\">分布式系统下一致性hash的作用及实现原理</a></p>\n<p><a href=\"https://yikun.github.io/2016/06/09/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E7%9A%84%E7%90%86%E8%A7%A3%E4%B8%8E%E5%AE%9E%E8%B7%B5/\" target=\"_blank\" rel=\"noopener\">一致性哈希算法的理解与实践</a></p>\n<p><a href=\"https://github.com/g4zhuj/hashring\" target=\"_blank\" rel=\"noopener\">一致性哈希Go实现代码</a>和falcon使用的<a href=\"https://github.com/toolkits/consistent\" target=\"_blank\" rel=\"noopener\">代码</a></p>\n</blockquote>\n","categories":[],"tags":[]},{"title":"小工具CSDN自动点击插件和GitHub在线代码阅读","date":"2019-06-28T02:59:17.000Z","path":"2019/06/28/小工具CSDN自动点击插件和GitHub在线代码阅读/","content":"<p><a href=\"https://github.com/silenceshell/csdn-auto-readmore\" target=\"_blank\" rel=\"noopener\">csdn-auto-readmore</a></p>\n<p><a href=\"https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc\" target=\"_blank\" rel=\"noopener\">Octotree</a></p>\n","categories":[],"tags":[]},{"title":"根据业务改造ops-update——添加跳板机","date":"2019-06-27T07:30:58.000Z","path":"2019/06/27/根据业务改造ops-update/","content":"<p>首先，这里面包含两个模块<a href=\"https://github.com/Cepave/ops-meta\" target=\"_blank\" rel=\"noopener\">meta</a>，<a href=\"https://github.com/open-falcon/ops-updater\" target=\"_blank\" rel=\"noopener\">updater</a>。</p>\n<p>meta负责接收<code>updater</code>上传上来的设备软件运行信息，以及下发运行软件的地址等相关参数；</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;name&quot;: &quot;falcon-agent&quot;,</span><br><span class=\"line\">        &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class=\"line\">        &quot;tarball&quot;: &quot;http://11.11.11.11:8888/falcon&quot;,</span><br><span class=\"line\">        &quot;md5&quot;: &quot;http://11.11.11.11:8888/falcon&quot;,</span><br><span class=\"line\">        &quot;cmd&quot;: &quot;start&quot;    // 运行参数</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;name&quot;: &quot;dinp-agent&quot;,</span><br><span class=\"line\">        &quot;version&quot;: &quot;2.0.0&quot;,</span><br><span class=\"line\">        &quot;tarball&quot;: &quot;http://11.11.11.11:8888/dinp&quot;,</span><br><span class=\"line\">        &quot;md5&quot;: &quot;&quot;,</span><br><span class=\"line\">        &quot;cmd&quot;: &quot;stop&quot; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n\n<p><code>updater</code>则被用来下载软件，以及上报软件运行状态信息。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;name&quot;: &quot;falcon-agent&quot;,</span><br><span class=\"line\">        &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class=\"line\">        &quot;status&quot;: &quot;started&quot; </span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;name&quot;: &quot;dinp-agent&quot;,</span><br><span class=\"line\">        &quot;version&quot;: &quot;2.0.0&quot;,</span><br><span class=\"line\">        &quot;status&quot;: &quot;stoped&quot; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"流程简述\"><a href=\"#流程简述\" class=\"headerlink\" title=\"流程简述\"></a>流程简述</h2><p>两个模块都比较简单，不过也是由于简单它们也就被我看上了，在我的项目中，<code>meta</code>是需要和服务器通信的，但服务器不需要<code>meta</code>将数据发送给服务器进行保存（可以指定其监听相应的<code>hostname</code>），<code>updater</code>基本是4min向<code>meta</code>心跳一次。</p>\n<p><img src=\"1561624471274.png\" alt=\"信息流动\"></p>\n<p>服务器在得到更新或添加软件的信后，主动向<code>meta</code>下发下载软件的地址指令，<code>meta</code>附加上用户信息、PC信息等其他信息进行下载请求（这里可以交由其他模块进行下载操作，下载完成后通知到<code>meta</code>模块即可）。</p>\n<h2 id=\"新增功能\"><a href=\"#新增功能\" class=\"headerlink\" title=\"新增功能\"></a>新增功能</h2><h3 id=\"bash指令控制\"><a href=\"#bash指令控制\" class=\"headerlink\" title=\"bash指令控制\"></a>bash指令控制</h3><p>下发的指令多添加一些bash指令，主要是为了给出一些自定义的操作，对于这个操作一般也只会针对一两个设备先进行测试，测试没发现问题后，再逐步将这些指令更新入<code>control</code>文件，当然，这是长期的过程。</p>\n<p>防止<code>cmd</code>出问题，协程无法退出的问题，当然也是可以利用<code>contorl</code>文件中的方法的，利用linux命令来kill掉这个卡住的命令。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   ctx, cancelFunc := context.WithCancel(context.TODO())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;  <span class=\"comment\">// 会阻塞，开个协程</span></span><br><span class=\"line\">    \t</span><br><span class=\"line\">       cmd := exec.CommandContext(ctx, <span class=\"string\">`sh`</span>, <span class=\"string\">\"-c\"</span>, <span class=\"string\">\"sleep 2;echo hello;\"</span>)</span><br><span class=\"line\">       <span class=\"comment\">// 执行任务, 捕获输出</span></span><br><span class=\"line\">       output, err := cmd.CombinedOutput()  </span><br><span class=\"line\">       </span><br><span class=\"line\">       <span class=\"keyword\">chan</span> &lt;- output  <span class=\"comment\">// 抛出结果</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// select等待时间，等不到就调用cancelFunc\t</span></span><br><span class=\"line\"><span class=\"comment\">// 取消上下文</span></span><br><span class=\"line\">cancelFunc()</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"跳板机的操作\"><a href=\"#跳板机的操作\" class=\"headerlink\" title=\"跳板机的操作\"></a>跳板机的操作</h3><p>在实际的应用中，设备都处于内网环境下，当我们需要对设备进行操作时，就需要跳板机了，这里不需要太过于复杂的跳板机操作，不过这里需要对接自家的后台用户的验证，刚好网上有一些简单的跳板机server，这里的实现，多是参考网上代码。</p>\n<p>跳板机不仅仅是需要使用到密码进行验证，这里，拉出一个动态验证密码（手机、邮箱、站内信），设定一个超时时间。</p>\n<p>可以通过<code>control</code>脚本来控制跳板机服务的起停，跳板机的状态和重启操作这里是直接塞给了<code>meta</code>，毕竟算起来，没有违背<code>meta</code>设计简单的初衷。</p>\n<blockquote>\n<p>参考：<a href=\"https://blog.yumaojun.net/2017/02/23/go-ssh-server/\" target=\"_blank\" rel=\"noopener\">https://blog.yumaojun.net/2017/02/23/go-ssh-server/</a>   服务端</p>\n<p>参考：<a href=\"https://mritd.me/2018/11/09/go-interactive-shell/\" target=\"_blank\" rel=\"noopener\">https://mritd.me/2018/11/09/go-interactive-shell/</a>   客户端</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"encoding/binary\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"io\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"io/ioutil\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"log\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"net\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"os/exec\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"sync\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"syscall\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"unsafe\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/kr/pty\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"golang.org/x/crypto/ssh\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// In the latest version of crypto/ssh (after Go 1.3), the SSH server type has been removed</span></span><br><span class=\"line\">\t<span class=\"comment\">// in favour of an SSH connection type. A ssh.ServerConn is created by passing an existing</span></span><br><span class=\"line\">\t<span class=\"comment\">// net.Conn and a ssh.ServerConfig to ssh.NewServerConn, in effect, upgrading the net.Conn</span></span><br><span class=\"line\">\t<span class=\"comment\">// into an ssh.ServerConn</span></span><br><span class=\"line\">\tconfig := &amp;ssh.ServerConfig&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//Define a function to run when a client attempts a password login</span></span><br><span class=\"line\">\t\tPasswordCallback: <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(c ssh.ConnMetadata, pass []<span class=\"keyword\">byte</span>)</span> <span class=\"params\">(*ssh.Permissions, error)</span></span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Should use constant-time compare (or better, salt+hash) in a production setting.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> c.User() == <span class=\"string\">\"foo\"</span> &amp;&amp; <span class=\"keyword\">string</span>(pass) == <span class=\"string\">\"bar\"</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, <span class=\"literal\">nil</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, fmt.Errorf(<span class=\"string\">\"password rejected for %q\"</span>, c.User())</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t<span class=\"comment\">// You may also explicitly allow anonymous client authentication, though anon bash</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// sessions may not be a wise idea</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// NoClientAuth: true,</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// You can generate a keypair with 'ssh-keygen -t rsa'</span></span><br><span class=\"line\">\tprivateBytes, err := ioutil.ReadFile(<span class=\"string\">\"id_rsa\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatal(<span class=\"string\">\"Failed to load private key (./id_rsa)\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tprivate, err := ssh.ParsePrivateKey(privateBytes)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatal(<span class=\"string\">\"Failed to parse private key\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tconfig.AddHostKey(private)</span><br><span class=\"line\">\t<span class=\"comment\">// Once a ServerConfig has been configured, connections can be accepted.</span></span><br><span class=\"line\">\tlistener, err := net.Listen(<span class=\"string\">\"tcp\"</span>, <span class=\"string\">\"0.0.0.0:2200\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">\"Failed to listen on 2200 (%s)\"</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Accept all connections</span></span><br><span class=\"line\">\tlog.Print(<span class=\"string\">\"Listening on 2200...\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\ttcpConn, err := listener.Accept()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tlog.Printf(<span class=\"string\">\"Failed to accept incoming connection (%s)\"</span>, err)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Before use, a handshake must be performed on the incoming net.Conn.</span></span><br><span class=\"line\">\t\tsshConn, chans, reqs, err := ssh.NewServerConn(tcpConn, config)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tlog.Printf(<span class=\"string\">\"Failed to handshake (%s)\"</span>, err)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tlog.Printf(<span class=\"string\">\"New SSH connection from %s (%s)\"</span>, sshConn.RemoteAddr(), sshConn.ClientVersion())</span><br><span class=\"line\">\t\t<span class=\"comment\">// Discard all global out-of-band Requests</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> ssh.DiscardRequests(reqs)</span><br><span class=\"line\">\t\t<span class=\"comment\">// Accept all channels</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> handleChannels(chans)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">handleChannels</span><span class=\"params\">(chans &lt;-<span class=\"keyword\">chan</span> ssh.NewChannel)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Service the incoming Channel channel in go routine</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> newChannel := <span class=\"keyword\">range</span> chans &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> handleChannel(newChannel)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">handleChannel</span><span class=\"params\">(newChannel ssh.NewChannel)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Since we're handling a shell, we expect a</span></span><br><span class=\"line\">\t<span class=\"comment\">// channel type of \"session\". The also describes</span></span><br><span class=\"line\">\t<span class=\"comment\">// \"x11\", \"direct-tcpip\" and \"forwarded-tcpip\"</span></span><br><span class=\"line\">\t<span class=\"comment\">// channel types.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t := newChannel.ChannelType(); t != <span class=\"string\">\"session\"</span> &#123;</span><br><span class=\"line\">\t\tnewChannel.Reject(ssh.UnknownChannelType, fmt.Sprintf(<span class=\"string\">\"unknown channel type: %s\"</span>, t))</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// At this point, we have the opportunity to reject the client's</span></span><br><span class=\"line\">\t<span class=\"comment\">// request for another logical connection</span></span><br><span class=\"line\">\tconnection, requests, err := newChannel.Accept()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Printf(<span class=\"string\">\"Could not accept channel (%s)\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Fire up bash for this session</span></span><br><span class=\"line\">\tbash := exec.Command(<span class=\"string\">\"bash\"</span>)</span><br><span class=\"line\">\t<span class=\"comment\">// Prepare teardown function</span></span><br><span class=\"line\">\t<span class=\"built_in\">close</span> := <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tconnection.Close()</span><br><span class=\"line\">\t\t_, err := bash.Process.Wait()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tlog.Printf(<span class=\"string\">\"Failed to exit bash (%s)\"</span>, err)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tlog.Printf(<span class=\"string\">\"Session closed\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Allocate a terminal for this channel</span></span><br><span class=\"line\">\tlog.Print(<span class=\"string\">\"Creating pty...\"</span>)</span><br><span class=\"line\">\tbashf, err := pty.Start(bash)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Printf(<span class=\"string\">\"Could not start pty (%s)\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"built_in\">close</span>()</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//pipe session to bash and visa-versa</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> once sync.Once</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tio.Copy(connection, bashf)</span><br><span class=\"line\">\t\tonce.Do(<span class=\"built_in\">close</span>)</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tio.Copy(bashf, connection)</span><br><span class=\"line\">\t\tonce.Do(<span class=\"built_in\">close</span>)</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\t<span class=\"comment\">// Sessions have out-of-band requests such as \"shell\", \"pty-req\" and \"env\"</span></span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> req := <span class=\"keyword\">range</span> requests &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span> req.Type &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"string\">\"shell\"</span>:</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// We only accept the default shell</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// (i.e. no command in the Payload)</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(req.Payload) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\treq.Reply(<span class=\"literal\">true</span>, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"string\">\"pty-req\"</span>:</span><br><span class=\"line\">\t\t\t\ttermLen := req.Payload[<span class=\"number\">3</span>]</span><br><span class=\"line\">\t\t\t\tw, h := parseDims(req.Payload[termLen+<span class=\"number\">4</span>:])</span><br><span class=\"line\">\t\t\t\tSetWinsize(bashf.Fd(), w, h)</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Responding true (OK) here will let the client</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// know we have a pty ready for input</span></span><br><span class=\"line\">\t\t\t\treq.Reply(<span class=\"literal\">true</span>, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"string\">\"window-change\"</span>:</span><br><span class=\"line\">\t\t\t\tw, h := parseDims(req.Payload)</span><br><span class=\"line\">\t\t\t\tSetWinsize(bashf.Fd(), w, h)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// parseDims extracts terminal dimensions (width x height) from the provided buffer.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">parseDims</span><span class=\"params\">(b []<span class=\"keyword\">byte</span>)</span> <span class=\"params\">(<span class=\"keyword\">uint32</span>, <span class=\"keyword\">uint32</span>)</span></span> &#123;</span><br><span class=\"line\">\tw := binary.BigEndian.Uint32(b)</span><br><span class=\"line\">\th := binary.BigEndian.Uint32(b[<span class=\"number\">4</span>:])</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> w, h</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Winsize stores the Height and Width of a terminal.</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> Winsize <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tHeight <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tWidth  <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tx      <span class=\"keyword\">uint16</span> <span class=\"comment\">// unused</span></span><br><span class=\"line\">\ty      <span class=\"keyword\">uint16</span> <span class=\"comment\">// unused</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SetWinsize sets the size of the given pty.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SetWinsize</span><span class=\"params\">(fd <span class=\"keyword\">uintptr</span>, w, h <span class=\"keyword\">uint32</span>)</span></span> &#123;</span><br><span class=\"line\">\tws := &amp;Winsize&#123;Width: <span class=\"keyword\">uint16</span>(w), Height: <span class=\"keyword\">uint16</span>(h)&#125;</span><br><span class=\"line\">\tsyscall.Syscall(syscall.SYS_IOCTL, fd, <span class=\"keyword\">uintptr</span>(syscall.TIOCSWINSZ), <span class=\"keyword\">uintptr</span>(unsafe.Pointer(ws)))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[],"tags":[]},{"title":"设计小册——序","date":"2019-06-27T03:11:13.000Z","path":"2019/06/27/设计小册——序/","content":"<p>写写自己当初写<a href=\"https://chunlife.top/categories/%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%86%8C/\">PowerPoint 2013设计小册</a>，到如今的想法，确实有很多想写出来的，毕竟不管怎么样，情愿或非情愿，这都是自己的经历，现在想来其实也不是那么让人头疼。</p>\n<a id=\"more\"></a>\n\n<p>来来回回的写，来来回回的删，不知道现在该以什么样的心情写出这些东西，大概是想抱怨的吧，要不就煽情？想想也就算了吧，其实也没啥大不了的。。。</p>\n<p>写书动机呢，肯定不是自愿的，但写好它的动机大概也是自愿的，而且神奇的是，它竟然能够完成，也就只能说一句，了不起，嘿嘿、、、</p>\n<blockquote>\n<p>最后我想说，幸好那个时候有你相伴，让我依然保持对这个世界最大的善意，不至于过于抱怨，不至于对自己过于失望，坚持下去，给了自己信心和自傲。以前的我让你受累了，谢谢你的包容。</p>\n<p>——致温柔美丽如初的你。</p>\n</blockquote>\n","categories":[],"tags":[]},{"title":"中小型公司如何保存密码？","date":"2019-06-24T03:07:41.000Z","path":"2019/06/24/中小型公司如何保存密码？/","content":"<p>一般的，我们在后端保存密码时，不会使用明文进行保存，明文保存意味着数据库被爆的损失将直线型上升，例如<code>CSDN</code>密码泄露事件，常见的方式是加盐操作，所谓的盐（salt）是一个随机数，算法演示入：<code>MD5（MD5（P） + salt）</code>、<code>SHA1（MD5（P） + salt）</code>或<code>MD5（P + salt）</code>等。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h2><p>但这种方式到如今，基本上都说是不安全的加密方式，这让我在使用的过程中，不免出现一些担心，这需要进行更换加密方式么，它为什么不安全呢？</p>\n<p>在上述操作后，服务器保存的是<code>H = MD5（MD5（P） + salt）</code>中的<code>H</code>，这样会避免即使服务器因为某些原因，数据库泄露导致实际密码被泄露，这里也就是利用了哈希函数运算不可逆的特性。</p>\n<p><img src=\"1561347903109.png\" alt=\"1561347903109\"></p>\n<p>但存在暴力破解的可能性，因为用户保存密码的方式是有迹可循的，例如生日，数字简单循环密码（<code>123456</code>），简单英文密码（<code>qwert</code>），事实上也确实存在这样一张常见密码的表，攻击者若还能拿到盐<code>salt</code>，就可以尝试各种哈希来得到这样的一张密码对照表。过程相对简短，但其中有两个难点，第一：如何拿到盐？第二：确定哈希函数。</p>\n<p>在实际的操作中，方法总比困难多，例如，随机盐的存储一般是和用户信息一起放在数据库中的，那也就以为着，爆破掉数据库，就有可能把盐给一锅端，但同时攻击者需要做的是，每一个盐所产生的对应表并不能套到其他盐的身上，需要根据每个盐都来进行计算。</p>\n<p>这时候就有另一种方案提出，加<code>固定盐</code>，这也就意味着，盐是唯一的，被生成在代码中，并不会随着暴库被偷走，但这时有另外一个问题，那就是：<br>攻击者已经攻破我们的系统进入到内部，也就意味他不进能偷走我们的数据库；<br>也意味着他能够获取到我们的软件运行文件；<br>那也就是意味着，若是攻击者对我们的软件进行分析，找到我们的密码验证的函数；<br>然后一顿分析，是有可能拿出我们的<code>盐</code>的，那攻击者只需要得出一套密码对照表，就能完全对应我们所有的密码信息。</p>\n<h2 id=\"更进一步\"><a href=\"#更进一步\" class=\"headerlink\" title=\"更进一步\"></a>更进一步</h2><p>在需要更强的密码存储中，我所了解到的，一般会推荐<code>PBKDF2</code>和<code>bcrypt</code>之类似的算法，不过这类算法，运行成本对于攻击者来说，是比较高的，没有足够的利益，是不会激起他们的兴趣的，但相对的，对于我们的运算成本也增加了，算是以时间成本来换取安全的方式。</p>\n<p>还有就是既然是为了增加攻击者破解的难度，那就多使用哈希函数反复计算，这个其实和上述的算法类似。</p>\n<h2 id=\"我的理解\"><a href=\"#我的理解\" class=\"headerlink\" title=\"我的理解\"></a>我的理解</h2><p>在各种加密方式中，我在选择中，我会选择MD5（SHA1）加随机盐的方式来保存我的后端密码，对于这样的保存方式，在应对中小型网站的存储密码需要中，我觉得是足够了，足以保证数据的相对安全，同时其计算成本也足以保证我的用户密码的安全性，若是测试部门等有关部门对我的选择报以怀疑，这时，我会加上提醒用户不使用类似<code>123456</code>、<code>qwerty</code>等简单密码，且帮助（强制）用户使用字母、数字等混合密码来保证密码的安全性。</p>\n<p>在实际的密码存储中，我记起一句话，抛开业务来谈技术都是耍流氓，不是银行，淘宝等场景下，非得弄个<code>绝对防御</code>，结果保护的也就是些name，发言等一些无关痛痒的数据，这就有点高射炮打蚊子了。所以在这种情况下，MD5（SHA1）加随机盐的方式造成的破解难度，以及网站数据的价值，已经让绝大多数的攻击者难以提起兴趣攻击我们的网站（毕竟人都是要恰饭的嘛）。</p>\n<hr>\n<blockquote>\n<p>参考： <a href=\"http://blog.sina.com.cn/s/blog_77e8d1350100wfc7.html\" target=\"_blank\" rel=\"noopener\">没知识真可怕——应用密码学的笑话之MD5+Salt不安全</a></p>\n</blockquote>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"MD5","slug":"MD5","permalink":"chunlife.top/tags/MD5/"},{"name":"salt","slug":"salt","permalink":"chunlife.top/tags/salt/"},{"name":"加盐","slug":"加盐","permalink":"chunlife.top/tags/加盐/"}]},{"title":"go实现stack","date":"2019-06-23T14:03:53.000Z","path":"2019/06/23/go实现stack/","content":"<p>堆栈（英语：stack）又称为栈或堆叠，是计算机科学中的一种抽象数据类型，只允许在有序的线性数据集合的一端（称为堆栈顶端，英语：top）进行加入数据（英语：push）和移除数据（英语：pop）的运算。因而按照<strong>后进先出</strong>（LIFO, Last In First Out）的原理运作。</p>\n<a id=\"more\"></a>\n\n<p>常与另一种有序的线性数据集合队列相提并论。</p>\n<p>堆栈常用一维数组或链表来实现。</p>\n<h2 id=\"栈\"><a href=\"#栈\" class=\"headerlink\" title=\"栈\"></a>栈</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Stack <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\tPush(i <span class=\"keyword\">int</span>)</span><br><span class=\"line\">\tPop() (i <span class=\"keyword\">int</span>, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> stack <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tslice []<span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s *stack)</span> <span class=\"title\">Push</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\ts.slice = <span class=\"built_in\">append</span>(s.slice, i)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s *stack)</span> <span class=\"title\">Pop</span><span class=\"params\">()</span> <span class=\"params\">(i <span class=\"keyword\">int</span>, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(s.slice) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> i, errors.New(<span class=\"string\">\"no int in stack\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ti = s.slice[<span class=\"built_in\">len</span>(s.slice)<span class=\"number\">-1</span>]</span><br><span class=\"line\">\ts.slice = s.slice[:<span class=\"built_in\">len</span>(s.slice)<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"栈模拟队列\"><a href=\"#栈模拟队列\" class=\"headerlink\" title=\"栈模拟队列\"></a>栈模拟队列</h2><p>队列是<code>fifo</code>结构，先进先出，栈是后进先出，若是用栈模拟队列该如何实现呢，这就需要使用到两个栈，一个存，一个取，类似于左手倒右手的操作来实现<code>先进先出</code>的特性。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Queue <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 将 i 添加到 队尾</span></span><br><span class=\"line\">\tAdd(i <span class=\"keyword\">int</span>)</span><br><span class=\"line\">\t<span class=\"comment\">// 返回队首的i, 如果队空，则返回error</span></span><br><span class=\"line\">\tRemove() (i <span class=\"keyword\">int</span>, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Stack <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\tPush(i <span class=\"keyword\">int</span>)</span><br><span class=\"line\">\tPop() (i <span class=\"keyword\">int</span>, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> stack <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tslice []<span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s *stack)</span> <span class=\"title\">Push</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\ts.slice = <span class=\"built_in\">append</span>(s.slice, i)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s *stack)</span> <span class=\"title\">Pop</span><span class=\"params\">()</span> <span class=\"params\">(i <span class=\"keyword\">int</span>, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(s.slice) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> i, errors.New(<span class=\"string\">\"no int in stack\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ti = s.slice[<span class=\"built_in\">len</span>(s.slice)<span class=\"number\">-1</span>]</span><br><span class=\"line\">\ts.slice = s.slice[:<span class=\"built_in\">len</span>(s.slice)<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 栈组成的队列</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> queueFromStack <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tfs *stack <span class=\"comment\">// 负责存的</span></span><br><span class=\"line\">\tss *stack <span class=\"comment\">// 负责取的</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewQueue</span><span class=\"params\">()</span> *<span class=\"title\">queueFromStack</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;queueFromStack&#123;</span><br><span class=\"line\">\t\tfs: <span class=\"built_in\">new</span>(stack),</span><br><span class=\"line\">\t\tss: <span class=\"built_in\">new</span>(stack),</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(q *queueFromStack)</span> <span class=\"title\">Add</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tq.fs.Push(i)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 这一步是O(n)的时间复杂度</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(q *queueFromStack)</span> <span class=\"title\">Remove</span><span class=\"params\">()</span> <span class=\"params\">(ret <span class=\"keyword\">int</span>, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tpop, _ := q.fs.Pop()</span><br><span class=\"line\">\t\t<span class=\"comment\">// 取走队尾</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(q.fs.slice) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tret = pop</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tq.ss.Push(pop)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> <span class=\"built_in\">len</span>(q.ss.slice) &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tpop, _ := q.ss.Pop()</span><br><span class=\"line\">\t\tq.fs.Push(pop)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"算法","slug":"算法","permalink":"chunlife.top/categories/算法/"}],"tags":[{"name":"stack","slug":"stack","permalink":"chunlife.top/tags/stack/"},{"name":"栈","slug":"栈","permalink":"chunlife.top/tags/栈/"}]},{"title":"go实现队列","date":"2019-06-23T08:44:05.000Z","path":"2019/06/23/go实现队列/","content":"<p>队列是什么？</p>\n<p><code>queue</code>作为一种<code>先进先出</code>（<em>FIFO</em>, First-In-First-Out）的线性表结构，在具体应用中通常用链表或者数组来实现。队列只允许在后端（称为<code>rear</code>）进行插入操作，在前端（称为<code>front</code>）进行删除操作。</p>\n<a id=\"more\"></a>\n\n<p>在Go语言中，使用slice模拟队列结构。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Queue <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 将 i 添加到 队尾</span></span><br><span class=\"line\">\tEnqueue(i <span class=\"keyword\">int</span>)</span><br><span class=\"line\">\t<span class=\"comment\">// 返回队首的i, 如果队空，则返回error</span></span><br><span class=\"line\">\tDequeue() (i <span class=\"keyword\">int</span>, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> queue <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tslice []<span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(q *queue)</span> <span class=\"title\">Enqueue</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tq.slice = <span class=\"built_in\">append</span>(q.slice, i)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(q *queue)</span> <span class=\"title\">Dequeue</span><span class=\"params\">()</span> <span class=\"params\">(i <span class=\"keyword\">int</span>, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(q.slice) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>, errors.New(<span class=\"string\">\"no int in queue\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// 获取队首</span></span><br><span class=\"line\">\ti = q.slice[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"comment\">// 删除队首</span></span><br><span class=\"line\">\tq.slice = q.slice[<span class=\"number\">1</span>:]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(q *queue)</span> <span class=\"title\">String</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fmt.Sprintf(<span class=\"string\">\"%#v\"</span>, q.slice)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"算法","slug":"算法","permalink":"chunlife.top/categories/算法/"}],"tags":[{"name":"queue","slug":"queue","permalink":"chunlife.top/tags/queue/"},{"name":"队列","slug":"队列","permalink":"chunlife.top/tags/队列/"}]},{"title":"转载《Go语言interface底层实现》","date":"2019-06-19T07:15:55.000Z","path":"2019/06/19/转载《Go语言interface底层实现》/","content":"<p>interface底层是怎么实现的，由于一直都是浮于水面，未去深究过，这里也是去查了些资料了解，这篇博客把<code>interface</code>结构解构的很清楚了，我觉得，博主画的那几幅图就能很好的进行理解了。</p>\n<a id=\"more\"></a>\n\n<h1 id=\"简述\"><a href=\"#简述\" class=\"headerlink\" title=\"简述\"></a>简述</h1><p><code>eface</code>的具体结构是：</p>\n<p><img src=\"eface.png\" alt=\"eface\"></p>\n<p><code>eface</code>的整体结构是：</p>\n<p><img src=\"eface_all.png\" alt=\"eface_all\"></p>\n<p><code>iface</code>的具体结构是：</p>\n<p><img src=\"iface.png\" alt=\"iface\"></p>\n<p><code>itab</code>是<code>iface</code>不同于<code>eface</code>比较关键的数据结构。其可包含两部分：一部分是确定唯一的包含方法的interface的具体结构类型，一部分是指向具体方法集的指针。<br>具体结构为：<br><img src=\"iface_itable.png\" alt=\"iface_itable\"></p>\n<hr>\n<hr>\n<blockquote>\n<p>转载自：<a href=\"https://i6448038.github.io/2018/10/01/Golang-interface/\" target=\"_blank\" rel=\"noopener\">https://i6448038.github.io/2018/10/01/Golang-interface/</a></p>\n</blockquote>\n<h1 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h1><p>Go的interface源码在Golang源码的<code>runtime</code>目录中。<br>Go在不同版本之间的interface结构可能会有所不同，但是，整体的结构是不会改变的，此文章用的Go版本是1.11。</p>\n<p>Go的interface是由两种类型来实现的：<code>iface</code>和<code>eface</code>。\n其中，<code>iface</code>表示的是包含方法的interface，例如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Person interface &#123;</span><br><span class=\"line\">\tPrint()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>而<code>eface</code>代表的是不包含方法的interface，即</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Person interface &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>或者</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var person interface&#123;&#125; = xxxx实体</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"eface\"><a href=\"#eface\" class=\"headerlink\" title=\"eface\"></a><code>eface</code></h1><p><code>eface</code>的具体结构是：<br><img src=\"eface.png\" alt=\"eface\"></p>\n<p>一共有两个属性构成，一个是类型信息<code>_type</code>，一个是数据信息。<br>其中，<code>_type</code>可以认为是Go语言中所有类型的公共描述，Go语言中几乎所有的数据结构都可以抽象成<code>_type</code>，是所有类型的表现，可以说是万能类型，<br><code>data</code>是指向具体数据的指针。</p>\n<p><code>type</code>的具体代码为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type _type struct &#123;</span><br><span class=\"line\">\tsize       uintptr </span><br><span class=\"line\">\tptrdata    uintptr // size of memory prefix holding all pointers</span><br><span class=\"line\">\thash       uint32</span><br><span class=\"line\">\ttflag      tflag</span><br><span class=\"line\">\talign      uint8</span><br><span class=\"line\">\tfieldalign uint8</span><br><span class=\"line\">\tkind       uint8</span><br><span class=\"line\">\talg        *typeAlg</span><br><span class=\"line\">\t// gcdata stores the GC type data for the garbage collector.</span><br><span class=\"line\">\t// If the KindGCProg bit is set in kind, gcdata is a GC program.</span><br><span class=\"line\">\t// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.</span><br><span class=\"line\">\tgcdata    *byte</span><br><span class=\"line\">\tstr       nameOff</span><br><span class=\"line\">\tptrToThis typeOff</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>eface</code>的整体结构是：<br><img src=\"eface_all.png\" alt=\"eface_all\"><br>对于没有方法的interface赋值后的内部结构是怎样的呢？<br>可以先看段代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import (</span><br><span class=\"line\">\t&quot;fmt&quot;</span><br><span class=\"line\">\t&quot;strconv&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type Binary uint64</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tb := Binary(200)</span><br><span class=\"line\">\tany := (interface&#123;&#125;)(b)</span><br><span class=\"line\">\tfmt.Println(any)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>输出200，赋值后的结构图是这样的：<br><img src=\"eface_fuzhi.png\" alt=\"eface_fuzhi\"></p>\n<p>对于将不同类型转化成<code>type</code>万能结构的方法，是运行时的<code>convT2E</code>方法，在<code>runtime</code>包中。<br>以上，是对于没有方法的接口说明。<br>对于包含方法的函数，用到的是另外的一种结构，叫<code>iface</code></p>\n<h1 id=\"iface\"><a href=\"#iface\" class=\"headerlink\" title=\"iface\"></a><code>iface</code></h1><p>所有包含方法的接口，都会使用<code>iface</code>结构。包含方法的接口就是一下这种最常见，最普通的接口：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Person interface &#123;</span><br><span class=\"line\">\tPrint()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>iface</code>的源代码是：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type iface struct &#123;</span><br><span class=\"line\">\ttab  *itab</span><br><span class=\"line\">\tdata unsafe.Pointer</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>iface</code>的具体结构是：</p>\n<p><img src=\"iface.png\" alt=\"iface\"></p>\n<p><code>itab</code>是<code>iface</code>不同于<code>eface</code>比较关键的数据结构。其可包含两部分：一部分是确定唯一的包含方法的interface的具体结构类型，一部分是指向具体方法集的指针。<br>具体结构为：<br><img src=\"iface_itable.png\" alt=\"iface_itable\"><br>属性 <code>itab</code>的源代码是：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type itab struct &#123;</span><br><span class=\"line\">\tinter *interfacetype //此属性用于定位到具体interface</span><br><span class=\"line\">\t_type *_type //此属性用于定位到具体interface</span><br><span class=\"line\">\thash  uint32 // copy of _type.hash. Used for type switches.</span><br><span class=\"line\">\t_     [4]byte</span><br><span class=\"line\">\tfun   [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter.</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>属性<code>interfacetype</code>类似于<code>_type</code>，其作用就是interface的公共描述，类似的还有<code>maptype</code>、<code>arraytype</code>、<code>chantype</code>…其都是各个结构的公共描述，可以理解为一种外在的表现信息。<code>interfacetype</code>源码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type interfacetype struct &#123;</span><br><span class=\"line\">\ttyp     _type</span><br><span class=\"line\">\tpkgpath name</span><br><span class=\"line\">\tmhdr    []imethod</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type imethod struct &#123;</span><br><span class=\"line\">\tname nameOff</span><br><span class=\"line\">\tityp typeOff</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>iface</code>的整体结构为：</p>\n<p><img src=\"iface_all.png\" alt=\"iface_all\"></p>\n<p>对于含有方法的interface赋值后的内部结构是怎样的呢？<br>一下代码运行后</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t&quot;fmt&quot;</span><br><span class=\"line\">\t&quot;strconv&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type Binary uint64</span><br><span class=\"line\">func (i Binary) String() string &#123;</span><br><span class=\"line\">\treturn strconv.FormatUint(i.Get(), 10)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (i Binary) Get() uint64 &#123;</span><br><span class=\"line\">\treturn uint64(i)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tb := Binary(200)</span><br><span class=\"line\">\tany := fmt.Stringer(b)</span><br><span class=\"line\">\tfmt.Println(any)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先，要知道代码运行结果为:200。<br>其次，了解到<code>fmt.Stringer</code>是一个包含<code>String</code>方法的接口。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Stringer interface &#123;</span><br><span class=\"line\">\tString() string</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最后，赋值后接口<code>Stringer</code>的内部结构为：<br><img src=\"iface_fuzhi.png\" alt=\"iface_fuzhi\"></p>\n<p>对于将不同类型转化成itable中<code>type(Binary)</code>的方法，是运行时的<code>convT2I</code>方法，在<code>runtime</code>包中。</p>\n<p>参考文献：<br>《Go in action》<br><a href=\"https://research.swtch.com/interfaces\" target=\"_blank\" rel=\"noopener\">https://research.swtch.com/interfaces</a><br><a href=\"https://juejin.im/entry/5a7d08d3f265da4e865a6200\" target=\"_blank\" rel=\"noopener\">https://juejin.im/entry/5a7d08d3f265da4e865a6200</a></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"interface","slug":"interface","permalink":"chunlife.top/tags/interface/"}]},{"title":"转载《解剖Go语言map底层实现》","date":"2019-06-19T06:28:08.000Z","path":"2019/06/19/转载《解剖Go语言map底层实现》/","content":"<blockquote>\n<p>转载自：<a href=\"https://i6448038.github.io/2018/08/26/map-secret/\" target=\"_blank\" rel=\"noopener\">https://i6448038.github.io/2018/08/26/map-secret/</a></p>\n</blockquote>\n<a id=\"more\"></a>\n\n<h1 id=\"附在文章开头\"><a href=\"#附在文章开头\" class=\"headerlink\" title=\"附在文章开头\"></a>附在文章开头</h1><p>这篇博客对<code>map</code>底层解释的很详尽，在之前我也只是了解<code>map</code>、字典这类结构底层是散列表，但并不清楚其内部实现的机理，这篇博客算是让我对其底层有更多的了解了。</p>\n<p>另外，在Go的使用，或更多的在面试中，经常会被问到的一个问题是，<code>map</code>是否是有序的，若无序，则为什么无序？</p>\n<p>首先<code>map</code>数据的存储是无序的，Go <code>map</code>遍历输出是无序的，那么也就是说有一些语言的遍历输出是有序的么？</p>\n<p><code>map</code>其底层为散列表，k-v结构，分布顺序与插入顺序没什么联系，但在实际使用中，散列表在整体插入完成后，其<code>key</code>顺序是固定的，所以在以后的遍历中，访问<code>key</code>的顺序是一致的。</p>\n<p>Go官方明确告诉开发者其<code>map</code>结构遍历输出无序，那什么机制导致其无序呢，查询<a href=\"http://ju.outofmemory.cn/entry/246454\" target=\"_blank\" rel=\"noopener\">资料</a>后发现，<code>for range map</code>在开始处理循环逻辑时，<strong>Go并不是在固定位置上进行遍历，其是随机的，那也就是其起始位置都不固定，遍历顺序肯定会不固定了。</strong></p>\n<hr>\n<hr>\n<p><code>map</code>是Go语言中基础的数据结构，在日常的使用中经常被用到。但是它底层是如何实现的呢？</p>\n<h1 id=\"map的底层\"><a href=\"#map的底层\" class=\"headerlink\" title=\"map的底层\"></a><code>map</code>的底层</h1><p>Golang中<code>map</code>的底层实现是一个散列表，因此实现<code>map</code>的过程实际上就是实现散表的过程。在这个散列表中，主要出现的结构体有两个，一个叫<code>hmap</code>(<code>a header for a go map</code>)，一个叫<code>bmap</code>(<code>a bucket for a Go map</code>，通常叫其<code>bucket</code>)。这两种结构的样子分别如下所示：<br>hmap:</p>\n<p><img src=\"hmap.png\" alt=\"img\"></p>\n<p>图中有很多字段，但是便于理解<code>map</code>的架构，你只需要关心的只有一个，就是标红的字段：buckets数组。Golang的map中用于存储的结构是bucket数组。而bucket(即<code>bmap</code>)的结构是怎样的呢？</p>\n<p>bucket：</p>\n<p><img src=\"bmap.png\" alt=\"img\"></p>\n<p>相比于<code>hmap</code>，bucket的结构显得简单一些，标红的字段依然是“核心”，我们使用的<code>map</code>中的key和value就存储在这里。“高位哈希值”数组记录的是当前bucket中key相关的“索引”，稍后会详细叙述。还有一个字段是一个指向扩容后的bucket的指针，使得bucket会形成一个链表结构。例如下图：</p>\n<p><img src=\"bmap_chain.png\" alt=\"img\"></p>\n<p>由此看出<code>hmap</code>和<code>bucket</code>的关系是这样的：</p>\n<p><img src=\"hmap_bmap.png\" alt=\"关系图\"></p>\n<p>而bucket又是一个链表，所以，整体的结构应该是这样的：</p>\n<p><img src=\"whole.png\" alt=\"结构\"></p>\n<p>哈希表的特点是会有一个哈希函数，对你传来的key进行哈希运算，得到唯一的值，一般情况下都是一个数值。Golang的<code>map</code>中也有这么一个哈希函数，也会算出唯一的值，对于这个值的使用，Golang也是很有意思。</p>\n<p>Golang把求得的值按照用途一分为二：高位和低位。</p>\n<p><img src=\"num.png\" alt=\"这里写图片描述\"></p>\n<p>如图所示，蓝色为高位，红色为低位。<br>然后低位用于寻找当前key属于<code>hmap</code>中的哪个bucket，而高位用于寻找bucket中的哪个key。上文中提到：bucket中有个属性字段是“高位哈希值”数组，这里存的就是蓝色的高位值，用来声明当前bucket中有哪些“key”，便于搜索查找。<br>需要特别指出的一点是：我们<code>map</code>中的key/value值都是存到同一个数组中的。数组中的顺序是这样的:</p>\n<p><img src=\"key_value.png\" alt=\"这里写图片描述\"></p>\n<p>并不是key0/value0/key1/value1的形式，这样做的好处是：在key和value的长度不同的时候，可以消除padding带来的空间浪费。</p>\n<p>现在，我们可以得到Go语言<code>map</code>的整个的结构图了：</p>\n<p><img src=\"all_elem.png\" alt=\"这里写图片描述\"></p>\n<h1 id=\"map的扩容\"><a href=\"#map的扩容\" class=\"headerlink\" title=\"map的扩容\"></a><code>map</code>的扩容</h1><p>当以上的哈希表增长的时候，Go语言会将bucket数组的数量扩充一倍，产生一个新的bucket数组，并将旧数组的数据迁移至新数组。</p>\n<h2 id=\"加载因子\"><a href=\"#加载因子\" class=\"headerlink\" title=\"加载因子\"></a>加载因子</h2><p>判断扩充的条件，就是哈希表中的<code>加载因子</code>(即loadFactor)。</p>\n<p><code>加载因子</code>是一个阈值，一般表示为：散列包含的元素数 除以 位置总数。是一种“产生冲突机会”和“空间使用”的平衡与折中：<code>加载因子</code>越小，说明空间空置率高，空间使用率小，但是<code>加载因子</code>越大，说明空间利用率上去了，但是“产生冲突机会”高了。</p>\n<p>每种哈希表的都会有一个<code>加载因子</code>，数值超过<code>加载因子</code>就会为哈希表扩容。<br>Golang的<code>map</code>的<code>加载因子</code>的公式是：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">map长度 / 2^B</span><br></pre></td></tr></table></figure>\n\n<p>阈值是<code>6.5</code>。其中<code>B</code>可以理解为已扩容的次数。<br>当Go的<code>map</code>长度增长到大于<code>加载因子</code>所需的<code>map</code>长度时，Go语言就会将产生一个新的bucket数组，然后把旧的bucket数组移到一个属性字段<code>oldbucket</code>中。注意：并不是立刻把旧的数组中的元素转义到新的bucket当中，而是，只有当访问到具体的某个bucket的时候，会把bucket中的数据转移到新的bucket中。</p>\n<p>如下图所示：当扩容的时候，Go的<code>map</code>结构体中，会保存旧的数据，和新生成的数组</p>\n<p><img src=\"extends.png\" alt=\"extends\"></p>\n<p>上面部分代表旧的有数据的bucket，下面部分代表新生成的新的bucket。蓝色代表存有数据的bucket，橘黄色代表空的bucket。<br>扩容时<code>map</code>并不会立即把新数据做迁移，而是当访问原来旧bucket的数据的时候，才把旧数据做迁移，如下图：</p>\n<p><img src=\"move_bucket.png\" alt=\"move_bucket\"></p>\n<p>注意：这里并不会直接删除旧的bucket，而是把原来的引用去掉，利用GC清除内存。</p>\n<h1 id=\"map中数据的删除\"><a href=\"#map中数据的删除\" class=\"headerlink\" title=\"map中数据的删除\"></a><code>map</code>中数据的删除</h1><p>如果理解了<code>map</code>的整体结构，那么查找、更新、删除的基本步骤应该都很清楚了。这里不再赘述。<br>值得注意的是，找到了<code>map</code>中的数据之后，针对key和value分别做如下操作：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、如果``key``是一个指针类型的，则直接将其置为空，等待GC清除；</span><br><span class=\"line\">2、如果是值类型的，则清除相关内存。</span><br><span class=\"line\">3、同理，对``value``做相同的操作。</span><br><span class=\"line\">4、最后把key对应的高位值对应的数组index置为空。</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Map","slug":"Map","permalink":"chunlife.top/tags/Map/"}]},{"title":"转载《一次完整的HTTP网络请求过程详解》","date":"2019-06-19T06:11:12.000Z","path":"2019/06/19/转载《一次完整的HTTP网络请求过程详解》/","content":"<blockquote>\n<p>转载自：<a href=\"https://blog.csdn.net/qq_39393899/article/details/80405979\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/qq_39393899/article/details/80405979 </a></p>\n</blockquote>\n<h2 id=\"0-前言\"><a href=\"#0-前言\" class=\"headerlink\" title=\"0.  前言\"></a>0.  前言</h2><p>从我们在浏览器的地址栏输入http: //blog.csdn.net/seu_calvin后回车，到我们看到该博客的主页，这中间经历了什么呢？简单地回答这个问题，大概是经历了域名解析、TCP的三次握手、建立TCP连接后发起HTTP请求、服务器响应HTTP请求、浏览器解析html代码，同时请求html代码中的资源（如js、css、图片等）、最后浏览器对页面进行渲染并呈现给用户。下面分别介绍一下每个过程。</p>\n <a id=\"more\"></a>\n\n<h2 id=\"1-域名解析\"><a href=\"#1-域名解析\" class=\"headerlink\" title=\"1.  域名解析\"></a><strong>1.  域名解析</strong></h2><p>以Chrome浏览器为例，Chrome会解析域名对应的IP地址。</p>\n<p>（1）Chrome浏览器会首先搜索浏览器自身的DNS缓存（可以使用 chrome://net-internals/#dns 来进行查看），浏览器自身的DNS缓存有效期比较短，且容纳有限，大概是1000条。如果自身的缓存中存在blog.csdn.net 对应的IP地址并且没有过期，则解析成功。</p>\n<p>（2）如果（1）中未找到，那么Chrome会搜索操作系统自身的DNS缓存（可以在命令行下使用 ipconfig /displaydns 查看）。如果找到且没有过期则成功。</p>\n<p>（3）如果（2）中未找到，那么尝试读取位于C:\\Windows\\System32\\drivers\\etc下的hosts文件，如果找到对应的IP地址则解析成功。</p>\n<p>（4）如果（3）中未找到，浏览器首先会找TCP/IP参数中设置的本地DNS服务器，如果要查询的域名包含在本地配置的区域资源中，则完成域名解析，否则根据本地DNS服务器会请求根DNS服务器。</p>\n<p>（5）本地DNS会把请求发至13台根DNS，根DNS服务器收到请求后会返回负责这个域名(.net)的服务器的一个IP，本地DNS服务器使用该IP信息联系负责.net域的这台服务器。这台负责.net域的服务器收到请求后，如果自己无法解析，会返回.net域的下一级DNS服务器地址(blog.csdn.net)给本地DNS服务器。以此类推，直至找到。</p>\n<h2 id=\"2-TCP的三次握手\"><a href=\"#2-TCP的三次握手\" class=\"headerlink\" title=\"2.  TCP的三次握手\"></a><strong>2.  TCP的三次握手</strong></h2><p>这个部分正好之前整理过，可以参考 <em>NetWork——关于TCP协议的三次握手和四次挥手</em>。</p>\n<p>（也可以参考我的<a href=\"https://chunlife.top/2019/06/10/TCP%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2/\">TCP状态转换</a>。）</p>\n<h2 id=\"3-建立TCP连接后发起HTTP请求\"><a href=\"#3-建立TCP连接后发起HTTP请求\" class=\"headerlink\" title=\"3.  建立TCP连接后发起HTTP请求\"></a><strong>3.  建立TCP连接后发起HTTP请求</strong></h2><p>TCP三次握手建立连接成功后，客户端按照指定的格式开始向服务端发送HTTP请求，服务端接收请求后，解析HTTP请求，处理完业务逻辑，最后返回一个具有标准格式的HTTP响应给客户端。</p>\n<h3 id=\"3-1-HTTP请求格式\"><a href=\"#3-1-HTTP请求格式\" class=\"headerlink\" title=\"3.1  HTTP请求格式\"></a><strong>3.1  HTTP请求格式</strong></h3><p>HTTP请求格式如下所示四部分组成，分别是请求行、请求头、空行、消息体，每部分内容占一行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;request-line&gt;  </span><br><span class=\"line\">&lt;general-headers&gt;  </span><br><span class=\"line\">&lt;request-headers&gt;  </span><br><span class=\"line\">&lt;entity-headers&gt;  </span><br><span class=\"line\">&lt;empty-line&gt;  </span><br><span class=\"line\">[&lt;message-body&gt;]  </span><br><span class=\"line\"></span><br><span class=\"line\">请求行：由三部分组成：分别是请求方法（GET/POST/DELETE/PUT/HEAD）、URI路径、HTTP版本号。</span><br><span class=\"line\"></span><br><span class=\"line\">请求头：缓存相关信息（Cache-Control，If-Modified-Since）、客户端身份信息（User-Agent）等键值对信息。</span><br><span class=\"line\"></span><br><span class=\"line\">空行。</span><br><span class=\"line\"></span><br><span class=\"line\">主体：客户端发给服务端的请求数据，这部分数据并不是每个请求必须的。</span><br></pre></td></tr></table></figure>\n\n<p>常用的GET、POST、PUT、DELETE四种请求方式中：</p>\n<p>（1）关于<strong><em>GET和DELETE将要处理的资源信息直接放在了URL中</em></strong>。通过”?&lt;键值对&gt;&amp;&lt;键值对&gt;“的形式追加。但是URL最大长度为1024字节。</p>\n<p>（2）关于<strong><em>POST和PUT的请求参数存储在报文的主体中</em></strong>。每一个参数都以”–boundary值“+”属性信息”+”空行“+”参数值”的数据结构存储。请求数据的最后以”–boundary值–“的格式结尾。</p>\n<h3 id=\"3-2-服务器响应HTTP请求\"><a href=\"#3-2-服务器响应HTTP请求\" class=\"headerlink\" title=\"3. 2  服务器响应HTTP请求\"></a><strong>3. 2  服务器响应HTTP请求</strong></h3><p>服务器接收处理完请求后返回一个HTTP响应消息给客户端。HTTP响应消息的格式包括：状态行、响应头、空行、消息体。每部分内容占一行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;status-line&gt;  </span><br><span class=\"line\">&lt;general-headers&gt;  </span><br><span class=\"line\">&lt;response-headers&gt;  </span><br><span class=\"line\">&lt;entity-headers&gt;  </span><br><span class=\"line\">&lt;empty-line&gt;  </span><br><span class=\"line\">[&lt;message-body&gt;]  </span><br><span class=\"line\"></span><br><span class=\"line\">状态行：有HTTP协议版本号，状态码和状态说明三部分构成。</span><br><span class=\"line\"></span><br><span class=\"line\">响应头：用于说明数据的一些信息，比如数据类型、内容长度等键值对。</span><br><span class=\"line\"></span><br><span class=\"line\">空行。</span><br><span class=\"line\"></span><br><span class=\"line\">消息体：服务端返回给客户端的HTML文本内容。或者其他格式的数据，比如：视频流、图片或者音频数据。</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-浏览器解析html代码，并请求html代码中的资源\"><a href=\"#4-浏览器解析html代码，并请求html代码中的资源\" class=\"headerlink\" title=\"4  浏览器解析html代码，并请求html代码中的资源\"></a><strong>4  浏览器解析html代码，并请求html代码中的资源</strong></h2><p>浏览器拿到html文件后，就开始解析其中的html代码，遇到<strong><em>js/css/image等静态资源时</em></strong>，向服务器端发起一个HTTP请求，如果服务器端返回<strong><em>304状态码</em></strong>（告诉浏览器服务器端没有修改该资源），那么浏览器会直接读取本地的该资源的缓存文件。否则开启新线程向服务器端去请求下载。（这个时候就用上<strong><em>keep-alive</em></strong>特性了，建立一次HTTP连接，可以请求多个资源。）</p>\n<p>最后，浏览器利用自己内部的工作机制，把请求到的<strong><em>静态资源和html代码</em></strong>进行渲染，再呈现给用户。</p>\n","categories":[{"name":"网络","slug":"网络","permalink":"chunlife.top/categories/网络/"}],"tags":[{"name":"UDP","slug":"UDP","permalink":"chunlife.top/tags/UDP/"},{"name":"TCP","slug":"TCP","permalink":"chunlife.top/tags/TCP/"}]},{"title":"Markdown For Typora 中文版使用指南（转载）","date":"2019-06-10T10:10:07.000Z","path":"2019/06/10/Markdown-For-Typora-中文版使用指南（转载）/","content":"<blockquote>\n<p>转载自：<a href=\"https://zhuanlan.zhihu.com/p/39872673\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/39872673</a></p>\n</blockquote>\n<h2 id=\"一、概述\"><a href=\"#一、概述\" class=\"headerlink\" title=\"一、概述\"></a>一、概述</h2><p><strong>Markdown</strong>诞生自 <a href=\"https://link.zhihu.com/?target=http%3A//daringfireball.net/\" target=\"_blank\" rel=\"noopener\">Daring Fireball</a>之手，点击<a href=\"https://link.zhihu.com/?target=http%3A//daringfireball.net/projects/markdown/syntax\" target=\"_blank\" rel=\"noopener\">这里</a>可以找到最早版本的语法标准。然而，它的语法标准因解析器和编辑器而异，<strong>Typora</strong>使用的是<a href=\"https://link.zhihu.com/?target=https%3A//help.github.com/articles/github-flavored-markdown/\" target=\"_blank\" rel=\"noopener\">GitHub Flavored Markdown</a>标准。</p>\n<p>需要注意的是在Markdown中的HTML代码块可以被识别但并不会被解析和编译。同样要注意的是，保存之后的文档格式可能会对最初的编写的文档格式有所微调。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"二、块元件\"><a href=\"#二、块元件\" class=\"headerlink\" title=\"二、块元件\"></a>二、块元件</h2><h2 id=\"1-段落和行间隔\"><a href=\"#1-段落和行间隔\" class=\"headerlink\" title=\"1. 段落和行间隔\"></a>1. 段落和行间隔</h2><p>段落，顾名思义就是由一行或多行文本组成的，以段为形式的结构。在Markdown语法中，段落间以一行以上的空行作分隔。在Typora中，你只需要按一下<code>Enter</code>就可以插入一个新的段落。</p>\n<p>按<code>Shift</code>+<code>Enter</code>可以创建一个比段落间距更小的行间距。然而，大多数的Markdown解析器会忽略这个方式创建的行间距，但是你可以通过在这一行的最后插入两个空格<code>Space</code>或者插入<code>&lt;br/&gt;</code>令解析器强制识别。</p>\n<h2 id=\"2-标题\"><a href=\"#2-标题\" class=\"headerlink\" title=\"2.标题\"></a>2.标题</h2><p>可以通过在一行的开头使用1-6个<code>#</code>符号来创建标题，对应1-6个级别的标题。栗如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 这是一个一级标题</span><br><span class=\"line\"></span><br><span class=\"line\">## 这是一个二级标题</span><br><span class=\"line\"></span><br><span class=\"line\">###### 这是一个六级标题</span><br></pre></td></tr></table></figure>\n\n<p>在Typora中，在标题文本前输入<code>#</code>，然后按下<code>Enter</code>可以创建一个标题。</p>\n<h2 id=\"3-引用\"><a href=\"#3-引用\" class=\"headerlink\" title=\"3.引用\"></a>3.引用</h2><p>Markdown使用邮件风格的<code>&gt;</code>符号来创建引用块。栗如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 这是一个由两个段落组成的引用块，这是第一个段落。</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; 这是第二个段落，爱饭打森，爱乖出台，请曾爱萨菲，撒㩐，经爱抚，百分赛法。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 这是另一个只有一个段落的引用块。两个代码块间可以用一空行来分隔。</span><br></pre></td></tr></table></figure>\n\n<p>在Typora中，只需要输入<code>&gt;</code>之后输入需要的引用内容就可以生成引用块格式。Typora在随后的输入过程中会自动为你添加<code>&gt;</code>和行间隔。引用块内的引用也是被允许的，只需要在引用块内同样使用<code>&gt;</code>即可。</p>\n<h2 id=\"4-普通清单\"><a href=\"#4-普通清单\" class=\"headerlink\" title=\"4. 普通清单\"></a>4. 普通清单</h2><p>输入<code>* 清单事项1</code>就会创建一个无序列表，这里的<code>*</code>符号可以用<code>-</code>和<code>+</code>代替。</p>\n<p>输入<code>1. 清单事项1</code>就会创建一个有序列表，它们的语法如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## 无序列表</span><br><span class=\"line\">* 红色</span><br><span class=\"line\">* 绿色</span><br><span class=\"line\">* 蓝色</span><br><span class=\"line\"></span><br><span class=\"line\">## 有序列表</span><br><span class=\"line\">1. 红色</span><br><span class=\"line\">2. 绿色</span><br><span class=\"line\">3. 蓝色</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-任务清单\"><a href=\"#5-任务清单\" class=\"headerlink\" title=\"5.任务清单\"></a>5.任务清单</h2><p>任务清单是一种特殊的列表，列表中的事项用<code>「 」</code>或者<code>「X」</code>分别标记<code>未完成</code>和<code>已完成</code>。栗如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 「 」一个任务列表事项</span><br><span class=\"line\">- 「 」可以有如下格式</span><br><span class=\"line\">- 「 」正常 **加粗** @提及 #1234 等</span><br><span class=\"line\">- 「 」未完成</span><br><span class=\"line\">- 「x」已完成</span><br></pre></td></tr></table></figure>\n\n<p>你可以通过鼠标点击事项前的任务框，从而切换任务清单事项中的状态。</p>\n<h2 id=\"6-代码块\"><a href=\"#6-代码块\" class=\"headerlink\" title=\"6.代码块\"></a>6.代码块</h2><p>Typora仅仅支持<a href=\"https://link.zhihu.com/?target=https%3A//help.github.com/articles/github-flavored-markdown/\" target=\"_blank\" rel=\"noopener\">GFM</a>的代码块，源码块是不支持的。[^此处翻译不确定]使用代码块的语法非常简单，输入<figure class=\"highlight plain\"><figcaption><span>就可以。</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">另外还可以自定义代码块的语言，只需要在 `````后追加输入所需要的语法名称后，我们就会通过语法高亮来实现它，栗如：</span><br><span class=\"line\"></span><br><span class=\"line\">~~~text</span><br><span class=\"line\">这是一个栗子：</span><br></pre></td></tr></table></figure></p>\n<p>function test() {<br>  console.log(“notice the blank line before this function?”);<br>}</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">syntax highlighting:</span><br><span class=\"line\">```ruby</span><br><span class=\"line\">require &apos;redcarpet&apos;</span><br><span class=\"line\">markdown = Redcarpet.new(&quot;Hello World!&quot;)</span><br><span class=\"line\">puts markdown.to_html</span><br></pre></td></tr></table></figure>\n\n<p><del>~</del></p>\n<h2 id=\"7-数学公式\"><a href=\"#7-数学公式\" class=\"headerlink\" title=\"7.数学公式\"></a>7.数学公式</h2><p>你可以通过使用<strong>MathJax</strong>来实现<em>LaTeX</em>的数学符号的表达。</p>\n<p>输入<code>$$</code>，然后按下<code>Enter</code>键就会弹出一个支持TeX/LaTeX语法的输入框，下面是一个栗子：<br>$$<br>\\mathbf{V}_1 \\times \\mathbf{V}_2 = \\begin{vmatrix}<br>\\mathbf{i} &amp; \\mathbf{j} &amp; \\mathbf{k} <br>\\frac{\\partial X}{\\partial u} &amp; \\frac{\\partial Y}{\\partial u} &amp; 0 <br>\\frac{\\partial X}{\\partial v} &amp; \\frac{\\partial Y}{\\partial v} &amp; 0 <br>\\end{vmatrix}<br>$$<br>在Markdown源文件中，数学的公式块是通过利用<code>$$</code>标记借用<em>LaTeX</em>语言来实现的：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$$</span><br><span class=\"line\">\\mathbf&#123;V&#125;_1 \\times \\mathbf&#123;V&#125;_2 =  \\begin&#123;vmatrix&#125; </span><br><span class=\"line\">\\mathbf&#123;i&#125; &amp; \\mathbf&#123;j&#125; &amp; \\mathbf&#123;k&#125; \\\\</span><br><span class=\"line\">\\frac&#123;\\partial X&#125;&#123;\\partial u&#125; &amp;  \\frac&#123;\\partial Y&#125;&#123;\\partial u&#125; &amp; 0 \\\\</span><br><span class=\"line\">\\frac&#123;\\partial X&#125;&#123;\\partial v&#125; &amp;  \\frac&#123;\\partial Y&#125;&#123;\\partial v&#125; &amp; 0 \\\\</span><br><span class=\"line\">\\end&#123;vmatrix&#125;</span><br><span class=\"line\">$$</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8-表格\"><a href=\"#8-表格\" class=\"headerlink\" title=\"8.表格\"></a>8.表格</h2><p>输入<code>|标题一|标题二|</code>然后按下<code>Enter</code>将会创建一个有两个列的表格。</p>\n<p>表格创建之后，你会看到一个顶部工具栏也会随之出现，通过工具栏你可以实现调整大小，增添和删除表格的功能，你也可以使用</p>\n<p>下面的描述可以跳过，因为表格的源码语法是Typora自动生成的。</p>\n<p>在markdown语法中，它们如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| First Header  | Second Header |</span><br><span class=\"line\">| ------------- | ------------- |</span><br><span class=\"line\">| Content Cell  | Content Cell  |</span><br><span class=\"line\">| Content Cell  | Content Cell  |</span><br></pre></td></tr></table></figure>\n\n<p>效果如下：</p>\n<table>\n<thead>\n<tr>\n<th>First Header</th>\n<th>Second Header</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Content Cell</td>\n<td>Content Cell</td>\n</tr>\n<tr>\n<td>Content Cell</td>\n<td>Content Cell</td>\n</tr>\n</tbody></table>\n<p>你也可以修饰内部的文本格式，比如链接、粗体、斜体、删除线等。</p>\n<p>最后，通过使用冒号<code>：</code>你可以实现标题栏文字的对齐功能，比如向左对齐、向右对齐和居中对齐：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| Left-Aligned  | Center Aligned  | Right Aligned |</span><br><span class=\"line\">| :------------ |:---------------:| -----:|</span><br><span class=\"line\">| col 3 is      | some wordy text | $1600 |</span><br><span class=\"line\">| col 2 is      | centered        |   $12 |</span><br><span class=\"line\">| zebra stripes | are neat        |    $1 |</span><br></pre></td></tr></table></figure>\n\n<p>效果如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Left-Aligned</th>\n<th align=\"center\">Center Aligned</th>\n<th align=\"right\">Right Aligned</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">col 3 is</td>\n<td align=\"center\">some wordy text</td>\n<td align=\"right\">$1600</td>\n</tr>\n<tr>\n<td align=\"left\">col 2 is</td>\n<td align=\"center\">centered</td>\n<td align=\"right\">$12</td>\n</tr>\n<tr>\n<td align=\"left\">zebra stripes</td>\n<td align=\"center\">are neat</td>\n<td align=\"right\">$1</td>\n</tr>\n</tbody></table>\n<p>最左侧的<code>：</code>是向左对齐；最右侧的<code>：</code>是向右对齐；两侧各一个<code>：</code>是居中对齐。</p>\n<h2 id=\"9-脚注\"><a href=\"#9-脚注\" class=\"headerlink\" title=\"9.脚注\"></a>9.脚注</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">你可以创建一个脚注，如下所示：</span><br><span class=\"line\"></span><br><span class=\"line\">脚注示范[^这是一个脚注]</span><br></pre></td></tr></table></figure>\n\n<p>上面的语法会编译成：</p>\n<p>脚注示范[^这是一个脚注]</p>\n<p>鼠标移动到<code>这是一个脚注</code>超链接可以看到脚注的文本内容。</p>\n<h2 id=\"10-分割线\"><a href=\"#10-分割线\" class=\"headerlink\" title=\"10.分割线\"></a>10.分割线</h2><p>在一空行输入<code>***</code>或者<code>---</code> 然后按下<code>Enter</code>可以创建一条分隔线。</p>\n<hr>\n<h2 id=\"11-YAML-Front-Matter\"><a href=\"#11-YAML-Front-Matter\" class=\"headerlink\" title=\"11.YAML Front Matter\"></a>11.YAML Front Matter</h2><p>Typora现在支持 <a href=\"https://link.zhihu.com/?target=http%3A//jekyllrb.com/docs/frontmatter/\" target=\"_blank\" rel=\"noopener\">YAML Front Matter</a>了，在文章的顶部输入<code>---</code>然后按下<code>Enter</code>就会创建。或者从菜单插入一个元数据块。</p>\n<h2 id=\"12-目录\"><a href=\"#12-目录\" class=\"headerlink\" title=\"12.目录\"></a>12.目录</h2><p>输入<code>［toc］</code>然后按下<code>Enter</code>就会产生一个自动根据标题和标题等级自动创建的目录框。</p>\n<h2 id=\"13-示意图\"><a href=\"#13-示意图\" class=\"headerlink\" title=\"13.示意图\"></a>13.示意图</h2><p>Typora支持 <a href=\"https://link.zhihu.com/?target=https%3A//bramp.github.io/js-sequence-diagrams/\" target=\"_blank\" rel=\"noopener\">sequence</a>, <a href=\"https://link.zhihu.com/?target=http%3A//flowchart.js.org/\" target=\"_blank\" rel=\"noopener\">flowchart</a> 和 <a href=\"https://link.zhihu.com/?target=https%3A//knsv.github.io/mermaid/%23mermaid\" target=\"_blank\" rel=\"noopener\">mermaid</a>，之后的版本将会在设置面板中实现设置。</p>\n<h2 id=\"三、实时元件\"><a href=\"#三、实时元件\" class=\"headerlink\" title=\"三、实时元件\"></a>三、实时元件</h2><p>实时元件将会在你输入完成后立即解码和编译完成。通过鼠标移动到这些语法元件上会显示出这些元件的源码内容，下面就将逐一介绍这些实时元件。</p>\n<h2 id=\"1-链接\"><a href=\"#1-链接\" class=\"headerlink\" title=\"1.链接\"></a>1.链接</h2><p>Markdown支持两种类型的链接：直连链接和间接链接。</p>\n<p>在上面两种链接类型中，链接文本都用<code>[方框]</code>来定义。</p>\n<p>通过在<code>[ ]</code>后追加带有链接地址的<code>( )</code>来创建一个直接链接。在括号中，插入你需转到的网址链接，还可以在链接后追加一个<code>&quot;文本&quot;</code>来自定义所通往链接的网站标题。栗子如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这是一个[栗子](http://example.com/ &quot;栗子网站&quot;)网站的链接实例。</span><br><span class=\"line\"></span><br><span class=\"line\">这个[栗子](http://example.com/)没有网站标题。</span><br></pre></td></tr></table></figure>\n\n<p>上面语法效果如下：</p>\n<p>这是一个<a href=\"https://link.zhihu.com/?target=http%3A//example.com/\" target=\"_blank\" rel=\"noopener\">栗子</a>网站的链接实例。</p>\n<p>这个<a href=\"https://link.zhihu.com/?target=http%3A//example.com/\" target=\"_blank\" rel=\"noopener\">栗子</a>没有网站标题。</p>\n<h2 id=\"1-内部链接\"><a href=\"#1-内部链接\" class=\"headerlink\" title=\"1).内部链接\"></a>1).内部链接</h2><p><strong>你可以把( )中的链接换成所在文档的标题</strong>，这样通过点击这个链接就能实现文档内部的跳转。<br>例如：</p>\n<p><code>Ctrl</code>（在Mac上是<code>Command</code>）+ <code>Click</code> <a href=\"https://zhuanlan.zhihu.com/write#二、块元素\" target=\"_blank\" rel=\"noopener\">这个链接</a>就会跳转到标题<code>二、块元素</code>。如果你想看这是怎么做到的，你可以将鼠标移动到这个链接然后点击就可以看到此链接方式的markdown的语法结构。</p>\n<h2 id=\"2-引用链接\"><a href=\"#2-引用链接\" class=\"headerlink\" title=\"2).引用链接\"></a>2).引用链接</h2><p>引用类型的链接会使用第二个<code>[ ]</code>用来放置一个对应相应链接地址的标签，栗子如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这是个引用链接的[栗子][id]呦。</span><br><span class=\"line\"></span><br><span class=\"line\">然后，你需要在文档的任何位置对标签作出有效的定义。</span><br><span class=\"line\"></span><br><span class=\"line\">[id]:http://example/com/ &quot;可选标题&quot;</span><br></pre></td></tr></table></figure>\n\n<p>效果如下：</p>\n<p>这是个引用链接的<a href=\"https://link.zhihu.com/?target=http%3A//example/com/\" target=\"_blank\" rel=\"noopener\">栗子</a>呦。</p>\n<p>然后，你需要在文档的任何位置对标签作出有效的定义。</p>\n<p>另一种简洁的语法可以使用文本本身作为链接的名称，因而允许忽略掉链接的名称也可以实现地址追踪，所以第二个<code>[ ]</code>只需要空着就好了，但是还是需要对文本本身作出定义以提供追踪地址。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[baidu][]</span><br><span class=\"line\">然后输入对文本本身的定义：</span><br><span class=\"line\"></span><br><span class=\"line\">[baidu]:http://baidu.com/</span><br></pre></td></tr></table></figure>\n\n<p>在Typora中，<code>Click</code>链接就会展开语法结构供你编辑，<code>Ctrl</code> + <code>Click</code>会在内置浏览器中此超链接。</p>\n<h2 id=\"2-URLs\"><a href=\"#2-URLs\" class=\"headerlink\" title=\"2.URLs\"></a>2.URLs</h2><p>Typora允许你插入urls作为链接内容，用<code>&lt;括号&gt;</code>修饰。</p>\n<p><code>&lt;i@typora.io&gt;</code>就变成如下效果：<a href=\"mailto:i@typora.io\" target=\"_blank\" rel=\"noopener\">i@typora.io</a>。</p>\n<p>Typora也支持链接标准的URLs，栗如：</p>\n<h2 id=\"3-图片\"><a href=\"#3-图片\" class=\"headerlink\" title=\"3.图片\"></a>3.图片</h2><p>图片也类似链接，但是需要额外的符号<code>!</code>放置在这一行的最开头。图片的语法结构如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![图片名称](/path/to/img.jpg)</span><br><span class=\"line\">![图片名称](/path/to/img.jpg &quot;可选名字&quot;)</span><br></pre></td></tr></table></figure>\n\n<p>你也可以使用<code>drag&amp;drop</code>动作从图片文件或者网页浏览器实现插入图片的操作。随后可以通过点击图片来编辑语法的源码达到进一步修饰图片的效果。如果图片文件和所编辑的markdown文档在相同目录或亚目录则<code>drop&amp;drop</code>操作会自动生成对应的相对路径。</p>\n<p>如果你想查看更多插入图片的技巧，请阅读 <a href=\"https://link.zhihu.com/?target=http%3A//support.typora.io//Images/\" target=\"_blank\" rel=\"noopener\">http://support.typora.io//Images/</a>。</p>\n<h2 id=\"4-斜体\"><a href=\"#4-斜体\" class=\"headerlink\" title=\"4.斜体\"></a>4.斜体</h2><p>Markdown识别<code>*</code>和<code>_</code>作为斜体语法的标识。用一个<code>*</code>或<code>_</code>修饰的文本会有一个HTML的标签<code>&lt;em&gt;</code>，栗如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*一个乘号*</span><br><span class=\"line\"></span><br><span class=\"line\">_一个下划线_</span><br></pre></td></tr></table></figure>\n\n<p>效果如下：</p>\n<p><em>一个乘号</em></p>\n<p><em>一个下划线</em></p>\n<p>GFM会忽视掉文本中的下划线，而下划线在编码和名字中使用普遍，栗如：</p>\n<blockquote>\n<p>wow_great_stuff<br>do_this_and_do_that_and_another_thing.</p>\n</blockquote>\n<p>另一需要注意的问题是如果你需要<code>*</code>或<code>_</code>本身而不想让它编译成此处的强调标识，你可以使用<code>\\</code>来免除编译，栗如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\*这个文本是被乘号修饰的，但是但不会变成斜体\\*</span><br></pre></td></tr></table></figure>\n\n<p>效果如下：</p>\n<p><em>这个文本是被乘号修饰的，但是但不会变成斜体</em></p>\n<p>附：Typora推荐使用<code>*</code>符号。</p>\n<h2 id=\"5-强调\"><a href=\"#5-强调\" class=\"headerlink\" title=\"5.强调\"></a>5.强调</h2><p>两个<code>*</code>或者<code>_</code>连用就会产生一个HTML标签<code>&lt;strong&gt;</code>实现强调加粗的效果。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">**两个乘号连用**</span><br><span class=\"line\">__两个下划线连用__</span><br></pre></td></tr></table></figure>\n\n<p>效果如下：</p>\n<p><strong>两个乘号连用两个下划线连用</strong></p>\n<p>附：Typora推荐使用<code>*</code>符号。</p>\n<h2 id=\"6-代码\"><a href=\"#6-代码\" class=\"headerlink\" title=\"6.代码\"></a>6.代码</h2><p>想要创建一个实时显示的代码，用两个` ``符号修饰就可以了。不像预格式化的代码块，这里的实时代码使用正常的段落来表达代码形式。栗如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用 `printf()`功能。</span><br></pre></td></tr></table></figure>\n\n<p>效果如下：</p>\n<p>使用 <code>printf()</code>功能。</p>\n<h2 id=\"7-删除线\"><a href=\"#7-删除线\" class=\"headerlink\" title=\"7.删除线\"></a>7.删除线</h2><p>GFM增添了使用符号添加删除线的语法，而标准的Markdown无此功能。</p>\n<p><code>~~错误的文本~~</code> 显示为 <del>错误的文本</del>。</p>\n<h2 id=\"8-下划线\"><a href=\"#8-下划线\" class=\"headerlink\" title=\"8.下划线\"></a>8.下划线</h2><p>下划线功能由来源HTML的标签代码实现。</p>\n<p><code>&lt;u&gt;下划线&lt;/u&gt;</code> 显示为下划线。</p>\n<h2 id=\"9-表情\"><a href=\"#9-表情\" class=\"headerlink\" title=\"9.表情\"></a>9.表情</h2><p>输出表情需要借助 <code>：</code>符号。</p>\n<p>栗子：<code>:smile</code> 显示为 :smile:。</p>\n<p>使用者可以通过使用<code>ESC</code>键触发表情建议补全功能，也可在功能面板启用后自动触发此功能。同时，直接从菜单栏<code>Edit</code> -&gt; <code>Emoji &amp; Symbols</code>插入UTF8表情符号也是可以的。</p>\n<h2 id=\"10-HTML\"><a href=\"#10-HTML\" class=\"headerlink\" title=\"10.HTML\"></a>10.HTML</h2><p>Typora不能使用HTML元素，但是Typora可以解析和编译非常有限的HTML元素，作为Markdown功能的补充，这些有限的功能包括：</p>\n<ul>\n<li>下划线： <code>&lt;u&gt;underline&lt;/u&gt;</code></li>\n<li>图片：<code>&lt;img src=&quot;http://www.w3.org/html/logo/img/mark-word-icon.png&quot; width=&quot;200px&quot; /&gt;</code>（HTML标签中的<code>width</code>, <code>height</code> 以及属于样式的<code>width</code>, <code>height</code>, <code>zoom</code>样式可以被识别和应用。）</li>\n<li>评论：<code>&lt;!-- This is some comments --&gt;</code></li>\n<li>超链接： <code>&lt;a href=&quot;http://typora.io&quot; target=&quot;_blank&quot;&gt;link&lt;/a&gt;</code> 。</li>\n</ul>\n<p>大多数这些属性、样式或分类会被忽略。对其他的标签，Typora会将它们以HTML片段的形式表达。</p>\n<h2 id=\"11-行内嵌数学符号\"><a href=\"#11-行内嵌数学符号\" class=\"headerlink\" title=\"11.行内嵌数学符号\"></a>11.行内嵌数学符号</h2><p>想要使用这个功能，需要在设置面板的 <code>Markdown</code>栏启用它。然后使用<code>$</code>来启动TeX命令，栗如：<code>$\\lim_{x \\to \\infty} \\exp(-x) = 0$</code> 会以LaTeX的命令形式表达出来。</p>\n<p>为了触发行内内嵌数学符号的实时编译你需要：输入<code>$</code>然后按下<code>ESC</code>键之后输入TeX命令，之后就会弹出一个如图所示的工具提示栏：</p>\n<p><img src=\"v2-4033508b043cad96c59ec4edbca92f36_b.gif\" alt=\"img\"></p>\n<h2 id=\"12-下标\"><a href=\"#12-下标\" class=\"headerlink\" title=\"12.下标\"></a>12.下标</h2><p>想要使用这个功能，需要在设置面板的 <code>Markdown</code> 栏启动它，之后使用<code>~</code>来修饰下标文本。栗如：</p>\n<p><code>H~2~O</code> 和<code>X~long\\ text~</code> 显示为 H<del>2</del>O 和X<del>long\\ text</del> 。</p>\n<h2 id=\"13-上标\"><a href=\"#13-上标\" class=\"headerlink\" title=\"13.上标\"></a>13.上标</h2><p>想要使用这个功能，需要在设置面板的 <code>Markdown</code> 栏启动它，之后使用<code>^</code>来修饰下标文本。栗如：</p>\n<p><code>X^2^</code> 显示为 X^2^ 。</p>\n<h2 id=\"14-高亮\"><a href=\"#14-高亮\" class=\"headerlink\" title=\"14.高亮\"></a>14.高亮</h2><p>想要使用这个功能，需要在设置面板的<code>Markdown</code> 栏启动它，之后使用<code>==</code>来修饰高亮文本，栗如：</p>\n<p><code>==highlight==</code> 显示为 ==highlight== 。</p>\n","categories":[{"name":"实用工具","slug":"实用工具","permalink":"chunlife.top/categories/实用工具/"}],"tags":[{"name":"markdown","slug":"markdown","permalink":"chunlife.top/tags/markdown/"}]},{"title":"TCP实现聊天室","date":"2019-06-10T09:19:48.000Z","path":"2019/06/10/TCP实现聊天室/","content":"<p>简单的练手，使用到TCP协议和协程。</p>\n<a id=\"more\"></a>\n\n<p><code>chan struct{}</code>：<code>struct{}</code>不占用内存，仅做signal使用；<br><code>time.After</code>：超时函数是在进入<code>select</code>中才开始运行，通信每次使用<code>hasData</code>进行重置，不让<code>select</code>走到timeout分支。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"net\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"strings\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 用户结构体类型</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> Client <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tC    <span class=\"keyword\">chan</span> <span class=\"keyword\">string</span></span><br><span class=\"line\">\tName <span class=\"keyword\">string</span></span><br><span class=\"line\">\tAddr <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 全局map，存储在线用户</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> onlineMap <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]Client</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 全局 channel 传递用户消息。</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> message = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">string</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">WriteMsgToClient</span><span class=\"params\">(clnt Client, conn net.Conn)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 监听 用户自带Channel 上是否有消息。</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> msg := <span class=\"keyword\">range</span> clnt.C &#123;</span><br><span class=\"line\">\t\tconn.Write([]<span class=\"keyword\">byte</span>(msg + <span class=\"string\">\"\\n\"</span>))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">MakeMsg</span><span class=\"params\">(clnt Client, msg <span class=\"keyword\">string</span>)</span> <span class=\"params\">(buf <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">\tbuf = <span class=\"string\">\"[\"</span> + clnt.Addr + <span class=\"string\">\"]\"</span> + clnt.Name + <span class=\"string\">\": \"</span> + msg</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">HandlerConnect</span><span class=\"params\">(conn net.Conn)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> conn.Close()</span><br><span class=\"line\">\t<span class=\"comment\">// 创建channel 判断，用户是否活跃。</span></span><br><span class=\"line\">\thasData := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span>&#123;&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 获取用户 网络地址 IP+port</span></span><br><span class=\"line\">\tnetAddr := conn.RemoteAddr().String()</span><br><span class=\"line\">\t<span class=\"comment\">// 创建新连接用户的 结构体. 默认用户是 IP+port</span></span><br><span class=\"line\">\tclnt := Client&#123;<span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">string</span>), netAddr, netAddr&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 将新连接用户，添加到在线用户map中. key: IP+port value：client</span></span><br><span class=\"line\">\tonlineMap[netAddr] = clnt</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 创建专门用来给当前 用户发送消息的 go 程</span></span><br><span class=\"line\">\t<span class=\"keyword\">go</span> WriteMsgToClient(clnt, conn)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 发送 用户上线消息到 全局channel 中</span></span><br><span class=\"line\">\t<span class=\"comment\">//message &lt;- \"[\" + netAddr + \"]\" + clnt.Name + \"login\"</span></span><br><span class=\"line\">\tmessage &lt;- MakeMsg(clnt, <span class=\"string\">\"login\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 创建一个 channel， 用来判断用退出状态</span></span><br><span class=\"line\">\tisQuit := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span>&#123;&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 创建一个匿名 go 程， 专门处理用户发送的消息。</span></span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tbuf := <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, <span class=\"number\">4096</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t\tn, err := conn.Read(buf)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\tisQuit &lt;- <span class=\"keyword\">struct</span>&#123;&#125;&#123;&#125;</span><br><span class=\"line\">\t\t\t\tfmt.Printf(<span class=\"string\">\"检测到客户端:%s退出\\n\"</span>, clnt.Name)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tfmt.Println(<span class=\"string\">\"conn.Read err:\"</span>, err)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 将读到的用户消息，保存到msg中，string 类型</span></span><br><span class=\"line\">\t\t\tmsg := <span class=\"keyword\">string</span>(buf[:n<span class=\"number\">-1</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 提取在线用户列表</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> msg == <span class=\"string\">\"who\"</span> &amp;&amp; <span class=\"built_in\">len</span>(msg) == <span class=\"number\">3</span> &#123;</span><br><span class=\"line\">\t\t\t\tconn.Write([]<span class=\"keyword\">byte</span>(<span class=\"string\">\"online user list:\\n\"</span>))</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// 遍历当前 map ，获取在线用户</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> _, user := <span class=\"keyword\">range</span> onlineMap &#123;</span><br><span class=\"line\">\t\t\t\t\tuserInfo := user.Addr + <span class=\"string\">\":\"</span> + user.Name + <span class=\"string\">\"\\n\"</span></span><br><span class=\"line\">\t\t\t\t\tconn.Write([]<span class=\"keyword\">byte</span>(userInfo))</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// 判断用户发送了 改名 命令</span></span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(msg) &gt;= <span class=\"number\">8</span> &amp;&amp; msg[:<span class=\"number\">6</span>] == <span class=\"string\">\"rename\"</span> &#123; <span class=\"comment\">// rename|</span></span><br><span class=\"line\">\t\t\t\tnewName := strings.Split(msg, <span class=\"string\">\"|\"</span>)[<span class=\"number\">1</span>] <span class=\"comment\">// msg[8:]</span></span><br><span class=\"line\">\t\t\t\tclnt.Name = newName                   <span class=\"comment\">// 修改结构体成员name</span></span><br><span class=\"line\">\t\t\t\tonlineMap[netAddr] = clnt             <span class=\"comment\">// 更新 onlineMap</span></span><br><span class=\"line\">\t\t\t\tconn.Write([]<span class=\"keyword\">byte</span>(<span class=\"string\">\"rename successful\\n\"</span>))</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// 将读到的用户消息，写入到message中。</span></span><br><span class=\"line\">\t\t\t\tmessage &lt;- MakeMsg(clnt, msg)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\thasData &lt;- <span class=\"keyword\">struct</span>&#123;&#125;&#123;&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 保证 不退出</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 监听 channel 上的数据流动</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> &lt;-isQuit:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">delete</span>(onlineMap, clnt.Addr)       <span class=\"comment\">// 将用户从 online移除</span></span><br><span class=\"line\">\t\t\tmessage &lt;- MakeMsg(clnt, <span class=\"string\">\"logout\"</span>) <span class=\"comment\">// 写入用户退出消息到全局channel</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> &lt;-hasData:</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 什么都不做。 目的是重置 下面 case 的计时器。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> &lt;-time.After(time.Second * <span class=\"number\">60</span>): <span class=\"comment\">// select进入时，开始计时</span></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">delete</span>(onlineMap, clnt.Addr)                <span class=\"comment\">// 将用户从 online移除</span></span><br><span class=\"line\">\t\t\tmessage &lt;- MakeMsg(clnt, <span class=\"string\">\"time out leaved\"</span>) <span class=\"comment\">// 写入用户退出消息到全局channel</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Manager</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 初始化 onlineMap</span></span><br><span class=\"line\">\tonlineMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]Client)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 监听全局channel 中是否有数据, 有数据存储至 msg， 无数据阻塞。</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tmsg := &lt;-message</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// 循环发送消息给 所有在线用户。要想执行，必须 msg := &lt;-message 执行完， 解除阻塞。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> _, clnt := <span class=\"keyword\">range</span> onlineMap &#123;</span><br><span class=\"line\">\t\t\tclnt.C &lt;- msg</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 创建监听套接字</span></span><br><span class=\"line\">\tlistener, err := net.Listen(<span class=\"string\">\"tcp\"</span>, <span class=\"string\">\"127.0.0.1:8000\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"Listen err\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> listener.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 创建管理者go程，管理map 和全局channel</span></span><br><span class=\"line\">\t<span class=\"keyword\">go</span> Manager()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 循环监听客户端连接请求</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tconn, err := listener.Accept()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">\"Accept err\"</span>, err)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 启动go程处理客户端数据请求</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> HandlerConnect(conn)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"网络","slug":"网络","permalink":"chunlife.top/categories/网络/"}],"tags":[{"name":"UDP","slug":"UDP","permalink":"chunlife.top/tags/UDP/"},{"name":"TCP","slug":"TCP","permalink":"chunlife.top/tags/TCP/"}]},{"title":"TCP状态转换","date":"2019-06-10T06:12:08.000Z","path":"2019/06/10/TCP状态转换/","content":"<h2 id=\"一、概述\"><a href=\"#一、概述\" class=\"headerlink\" title=\"一、概述\"></a>一、概述</h2><p>TCP与UDP属于传输层的基础协议，在实际的应用中，我们使用到的也就是传输层及传输层以上的协议，其他的底层协议，一般都是以了解基础协议原理即可。</p>\n<a id=\"more\"></a>\n\n<p><img src=\"1560220515829.png\" alt=\"协议\"></p>\n<h2 id=\"二、TCP与UDP\"><a href=\"#二、TCP与UDP\" class=\"headerlink\" title=\"二、TCP与UDP\"></a>二、TCP与UDP</h2><h3 id=\"1、协议的联系\"><a href=\"#1、协议的联系\" class=\"headerlink\" title=\"1、协议的联系\"></a>1、协议的联系</h3><p>为了减少协议设计的复杂性，大多数网络模型均采用分层的方式来组织。每一层都有自己的功能，就像建筑物一样，每一层都靠下一层支持。每一层利用下一层提供的服务来为上一层提供服务，本层服务的实现细节对上层屏蔽。</p>\n<p><img src=\"1560220578955.png\" alt=\"对照\"></p>\n<h3 id=\"2、TCP与UDP\"><a href=\"#2、TCP与UDP\" class=\"headerlink\" title=\"2、TCP与UDP\"></a>2、TCP与UDP</h3><h4 id=\"2-1-定义\"><a href=\"#2-1-定义\" class=\"headerlink\" title=\"2.1 定义\"></a>2.1 定义</h4><p>一般来说，若是对两者协议进行定义，有个经典的归纳：</p>\n<p><strong>TCP通信：</strong><br>    面向连接的，可靠的数据包传输。</p>\n<p><strong>UDP通信：</strong><br>    无连接的，不可靠的报文传递。</p>\n<h4 id=\"2-2-对协议进行理解\"><a href=\"#2-2-对协议进行理解\" class=\"headerlink\" title=\"2.2 对协议进行理解\"></a>2.2 对协议进行理解</h4><p>为什么会出现上述的定义呢，这是由于两者本身的特点决定的。</p>\n<p>TCP有这么两个特点：</p>\n<ul>\n<li>发送数据前必须建立连接，建立链接后，发送数据的路线确定；</li>\n<li>发送完数据需要有ACK回执包，否则将进行重发；</li>\n</ul>\n<p>TCP在网络上对现有的环境，<em>对不稳定的网络层做完全弥补操作</em>，保证数据传输稳定。</p>\n<hr>\n<p>UDP，靠路由网络分发，无需提前建立连接，只需知道目标机器的IP地址，发送的路线不确定。<em>对不稳定的网络层，不作为</em>。</p>\n<h4 id=\"2-3-比较\"><a href=\"#2-3-比较\" class=\"headerlink\" title=\"2.3 比较\"></a>2.3 比较</h4><table>\n<thead>\n<tr>\n<th align=\"center\">TCP</th>\n<th align=\"center\">UDP</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">面向连接</td>\n<td align=\"center\">面向无连接</td>\n</tr>\n<tr>\n<td align=\"center\">要求系统资源较多</td>\n<td align=\"center\">要求系统资源较少</td>\n</tr>\n<tr>\n<td align=\"center\">TCP程序结构较复杂</td>\n<td align=\"center\">UDP程序结构较简单</td>\n</tr>\n<tr>\n<td align=\"center\">使用流式</td>\n<td align=\"center\">使用数据包式</td>\n</tr>\n<tr>\n<td align=\"center\">保证数据准确性</td>\n<td align=\"center\">不保证数据准确性</td>\n</tr>\n<tr>\n<td align=\"center\">保证数据顺序</td>\n<td align=\"center\">不保证数据顺序</td>\n</tr>\n<tr>\n<td align=\"center\">通讯速度较慢</td>\n<td align=\"center\">通讯速度较快</td>\n</tr>\n</tbody></table>\n<p>TCP：对数据传输安全性、稳定性要求较高的场合。 网络文件传输。下载、上传。</p>\n<p>UDP：对数据实时传输要求较高的场合。视频直播、在线电话会议。游戏。</p>\n<h3 id=\"3、TCP状态转换\"><a href=\"#3、TCP状态转换\" class=\"headerlink\" title=\"3、TCP状态转换\"></a>3、TCP状态转换</h3><p>由于TCP在通信时，有连接动作，这个动作并不是一个单一的动作，而是一连串动作的集合，也就是TCP中经典的<code>三次握手，四次挥手</code>。</p>\n<p><img src=\"TCP%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png\" alt=\"TCP状态转换图\"></p>\n<p>连接过程经历的状态变化：</p>\n<p><img src=\"1560222452099.png\" alt=\"连接状态变化\"></p>\n<p>关闭连接时的状态变化：</p>\n<p><img src=\"1560222690302.png\" alt=\"关闭连接\"></p>\n<p>那为什么是三次握手和四次挥手呢？</p>\n<p>在实际的通信中，三次握手阶段的第二次的通信中，被动接收端是将<code>ACK</code>与<code>SYN</code>包一起发送给主动发起连接端，也就省去了一次过程。那为什么会合并呢，这个问题也可以问，为什么挥手的过程不是合并发送呢？</p>\n<p>我的理解是关闭过程是各自关闭各自的发送功能，也就是：<strong>你关闭你的发送通道，我关闭我的发送通道</strong>。</p>\n<p>而握手阶段，若接收端没有准备好，则<code>ACK</code>包都不会回复。</p>\n<p>可以参考这张图，更为详细的了解状态间的变换。</p>\n<p><img src=\"TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E3%80%814%E6%AC%A1%E6%8C%A5%E6%89%8B.png\" alt=\"TCP三次握手、4次挥手\"></p>\n<h3 id=\"4、TCP沾包\"><a href=\"#4、TCP沾包\" class=\"headerlink\" title=\"4、TCP沾包\"></a>4、TCP沾包</h3><blockquote>\n<p>以下转载自：<a href=\"https://www.v2ex.com/t/478610?p=2\" target=\"_blank\" rel=\"noopener\">TCP 粘包问题浅析及其解决方案</a></p>\n</blockquote>\n<p>如下图所示，出现的粘包问题一共有三种情况：</p>\n<p><img src=\"TCP-PACKAGE.jpg\" alt=\"TCP沾包\"></p>\n<p><strong>第一种情况：</strong> 如上图中的第一根<strong>bar</strong>所示，服务端一共读到两个数据包，每个数据包都是完成的，并没有发生粘包的问题，这种情况比较好处理，服务器只需要简单的从网络缓冲区去读就好了，每次服务端读取到的消息都是完成的，并不会出现数据不正确的情况。</p>\n<p><strong>第二种情况：</strong> 服务端仅收到一个数据包，这个数据包包含客户端发出的两条消息的完整信息，这个时候基于第一种情况的逻辑实现的服务端就蒙了，因为服务端并不能很好的处理这个数据包，甚至不能处理，这种情况其实就是 TCP 的粘包问题。</p>\n<p><strong>第三种情况：</strong> 服务端收到了两个数据包，第一个数据包只包含了第一条消息的一部分，第一条消息的后半部分和第二条消息都在第二个数据包中，或者是第一个数据包包含了第一条消息的完整信息和第二条消息的一部分信息，第二个数据包包含了第二条消息的剩下部分，这种情况其实是发送了 TCP 拆包问题，因为发生了一条消息被拆分在两个包里面发送了，同样上面的服务器逻辑对于这种情况是不好处理的。</p>\n<p><strong>为什么会发生 TCP 粘包、拆包</strong></p>\n<ol>\n<li>应用程序写入的数据大于套接字缓冲区大小，这将会发生拆包。</li>\n<li>应用程序写入数据小于套接字缓冲区大小，网卡将应用多次写入的数据发送到网络上，这将会发生粘包。</li>\n<li>进行 MSS （最大报文长度）大小的 TCP 分段，当 TCP 报文长度-TCP 头部长度&gt;MSS 的时候将发生拆包。</li>\n<li>接收方法不及时读取套接字缓冲区数据，这将发生粘包。</li>\n</ol>\n<p><strong>如何处理粘包、拆包</strong></p>\n<p>通常会有以下一些常用的方法：</p>\n<ol>\n<li>使用带消息头的协议、消息头存储消息开始标识及消息长度信息，服务端获取消息头的时候解析出消息长度，然后向后读取该长度的内容。</li>\n<li>设置定长消息，服务端每次读取既定长度的内容作为一条完整消息，当消息不够长时，空位补上固定字符。</li>\n<li>设置消息边界，服务端从网络流中按消息编辑分离出消息内容，一般使用‘\\n ’。</li>\n<li>更为复杂的协议，例如楼主最近接触比较多的车联网协议 808,809 协议。</li>\n</ol>\n<hr>\n<p>另外解决方法还可以看程序前辈怒怼TCP，看着很搞笑，<a href=\"https://github.com/ideawu/FUCK_TCP\" target=\"_blank\" rel=\"noopener\"><strong>FUCK_TCP</strong></a>。</p>\n<p>彻底解决 TCP 粘包和拆包问题的代码架构如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char tmp[];</span><br><span class=\"line\">Buffer buffer;</span><br><span class=\"line\">// 网络循环：必须在一个循环中读取网络，因为网络数据是源源不断的。</span><br><span class=\"line\">while(1)&#123;</span><br><span class=\"line\">    // 从TCP流中读取不定长度的一段流数据，不能保证读到的数据是你期望的长度</span><br><span class=\"line\">    tcp.read(tmp);</span><br><span class=\"line\">    // 将这段流数据和之前收到的流数据拼接到一起</span><br><span class=\"line\">    buffer.append(tmp);</span><br><span class=\"line\">    // 解析循环：必须在一个循环中解析报文，应对所谓的粘包</span><br><span class=\"line\">    while(1)&#123;</span><br><span class=\"line\">        // 尝试解析报文</span><br><span class=\"line\">        msg = parse(buffer);</span><br><span class=\"line\">        if(!msg)&#123;</span><br><span class=\"line\">            // 报文还没有准备好，糟糕，我们遇到拆包了！跳出解析循环，继续读网络。</span><br><span class=\"line\">            break;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // 将解析过的报文对应的流数据清除</span><br><span class=\"line\">        buffer.remove(msg.length);</span><br><span class=\"line\">        // 业务处理</span><br><span class=\"line\">        process(msg);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":[{"name":"网络","slug":"网络","permalink":"chunlife.top/categories/网络/"}],"tags":[{"name":"UDP","slug":"UDP","permalink":"chunlife.top/tags/UDP/"},{"name":"TCP","slug":"TCP","permalink":"chunlife.top/tags/TCP/"}]},{"title":"MongoDB命令一览","date":"2019-06-07T06:21:05.000Z","path":"2019/06/07/MongoDB命令一览/","content":"<p>整理一下基础命令：</p>\n<a id=\"more\"></a>\n\n<p><img src=\"MongoDB.png\" alt=\"MongoDB\"></p>\n","categories":[{"name":"MongoDB","slug":"MongoDB","permalink":"chunlife.top/categories/MongoDB/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"MongoDB","slug":"MongoDB","permalink":"chunlife.top/tags/MongoDB/"}]},{"title":"funny/link TCP库的使用和bug fix","date":"2019-06-06T02:55:52.000Z","path":"2019/06/06/funny-link-TCP库的使用和bug-fix/","content":"<p>公司项目需要对接嵌入式设备，底层<code>stm32</code>使用的是TCP网络协议，go语言中原生TCP编程还是比较简单的，像网络方面的编程，其实很多操作都比较繁复，在编写时，就希望能够有类似的框架性质的库帮助统一所有网络的代码，以及减轻网络编写的负担。</p>\n<a id=\"more\"></a>\n\n<p>找到一个项目，<a href=\"https://github.com/funny/link\" target=\"_blank\" rel=\"noopener\">link</a>。</p>\n<p>就像它README所说的，它不是一个完整网络层也不是一个框架，它只是一个脚手架，它可以帮助你快速的实现出你所需要的网络层或者通讯框架，帮你约束网络层的实现方式，不至于用不合理的方式实现网络层，除此之外它不会管更多的事情。</p>\n<p>这样的话其实也就足够使用了，毕竟我要的功能并不复杂，仅需要为了屏蔽掉一些细节问题，除此之外，好像也并不需要什么多余的东西了。</p>\n<h2 id=\"bug-fix\"><a href=\"#bug-fix\" class=\"headerlink\" title=\"bug fix\"></a>bug fix</h2><p>仓库中有对<code>json</code>解码的原生支持，但其中似乎存在一些问题，这里补齐一下。</p>\n<blockquote>\n<p>当client端发送的数据为空时，这里会传入nil，也就会出现panic，需要判断body是否为空。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--- a/codec/json.<span class=\"keyword\">go</span></span><br><span class=\"line\">+++ b/codec/json.<span class=\"keyword\">go</span></span><br><span class=\"line\">@@ <span class=\"number\">-2</span>,<span class=\"number\">7</span> +<span class=\"number\">2</span>,<span class=\"number\">6</span> @@ <span class=\"keyword\">package</span> codec</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">import</span> (</span><br><span class=\"line\">        <span class=\"string\">\"encoding/json\"</span></span><br><span class=\"line\">-       <span class=\"string\">\"errors\"</span></span><br><span class=\"line\">        <span class=\"string\">\"io\"</span></span><br><span class=\"line\">        <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">@@ <span class=\"number\">-74</span>,<span class=\"number\">18</span> +<span class=\"number\">73</span>,<span class=\"number\">10</span> @@ <span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *jsonCodec)</span> <span class=\"title\">Receive</span><span class=\"params\">()</span> <span class=\"params\">(<span class=\"keyword\">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> body <span class=\"keyword\">interface</span>&#123;&#125;</span><br><span class=\"line\">+</span><br><span class=\"line\">        <span class=\"keyword\">if</span> in.Head != <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> t, exists := c.p.types[in.Head]; exists &#123;</span><br><span class=\"line\">                        body = reflect.New(t).Interface()</span><br><span class=\"line\">+               &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">+                       <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, errors.New(<span class=\"string\">\"Receive Json have no Head match, Close connection\"</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">+       &#125;</span><br><span class=\"line\">+       <span class=\"keyword\">if</span> in.Body == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">+               <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, errors.New(<span class=\"string\">\"Receive Json have no Body field, Close connection\"</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        err = json.Unmarshal(*in.Body, &amp;body)</span><br></pre></td></tr></table></figure>\n\n<p>另外还有一处编译的地方，对于win32位来说会报错的地方。</p>\n<blockquote>\n<p><code>math.MaxUint32</code>会超出win32位<code>int</code>的大小，当然这是在编译时就会报错（并不会直接按照类型大小截取大小，反而会直接丢出错误）。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--- a/codec/fixlen.<span class=\"keyword\">go</span></span><br><span class=\"line\">+++ b/codec/fixlen.<span class=\"keyword\">go</span></span><br><span class=\"line\">@@ <span class=\"number\">-54</span>,<span class=\"number\">11</span> +<span class=\"number\">54</span>,<span class=\"number\">17</span> @@ <span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">FixLen</span><span class=\"params\">(base link.Protocol, n <span class=\"keyword\">int</span>, byteOrder binary.ByteOrder, maxRecv, maxS</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                        byteOrder.PutUint16(b, <span class=\"keyword\">uint16</span>(size)</span>)</span></span><br><span class=\"line\"><span class=\"function\">                &#125;</span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"title\">case</span> 4:</span></span><br><span class=\"line\"><span class=\"function\">-               <span class=\"title\">if</span> <span class=\"title\">maxRecv</span> &gt; <span class=\"title\">math</span>.<span class=\"title\">MaxUint32</span></span> &#123;</span><br><span class=\"line\">-                       maxRecv = math.MaxUint32</span><br><span class=\"line\">+               <span class=\"comment\">// if maxRecv &gt; math.MaxUint32 &#123;</span></span><br><span class=\"line\">+               <span class=\"comment\">//      maxRecv = math.MaxUint32</span></span><br><span class=\"line\">+               <span class=\"comment\">// &#125;</span></span><br><span class=\"line\">+               <span class=\"comment\">// if maxSend &gt; math.MaxUint32 &#123;</span></span><br><span class=\"line\">+               <span class=\"comment\">//      maxSend = math.MaxUint32</span></span><br><span class=\"line\">+               <span class=\"comment\">// &#125;</span></span><br><span class=\"line\">+               <span class=\"keyword\">if</span> maxRecv &gt; math.MaxInt32 &#123;</span><br><span class=\"line\">+                       maxRecv = math.MaxInt32</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">-               <span class=\"keyword\">if</span> maxSend &gt; math.MaxUint32 &#123;</span><br><span class=\"line\">-                       maxSend = math.MaxUint32</span><br><span class=\"line\">+               <span class=\"keyword\">if</span> maxSend &gt; math.MaxInt32 &#123;</span><br><span class=\"line\">+                       maxSend = math.MaxInt32</span><br><span class=\"line\">                &#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"自定义codec\"><a href=\"#自定义codec\" class=\"headerlink\" title=\"自定义codec\"></a>自定义codec</h2><p>和底层的通信采用字节流，需要自定义协议进行操作。这里只需要参照codec里面的协议，自定义一个协议就可以了。</p>\n<p><code>codec</code>其实很好理解，相当于socket的句柄传入包中，由包中函数进行自定义处理数据。</p>\n<blockquote>\n<p>需要注意的一点是：<code>io.Reader</code>类的<code>read</code>函数传入的参数，是一个len不为零的byte的数组，也就是有接收数据的空间，需要提前分配，这里是我在编写的时候不注意的地方，测试程序的read老是过不去。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> codec</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"errors\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"io\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"string\">\"gitlab.com/link\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> ByteProtocol <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//data []byte</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(b *ByteProtocol)</span> <span class=\"title\">NewCodec</span><span class=\"params\">(rw io.ReadWriter)</span> <span class=\"params\">(link.Codec, error)</span></span> &#123;</span><br><span class=\"line\">\tcodec := &amp;byteCodec&#123;</span><br><span class=\"line\">\t\tp: b,</span><br><span class=\"line\">\t\tr: rw,</span><br><span class=\"line\">\t\tw: rw,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tcodec.closer, _ = rw.(io.Closer)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> codec, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Byte</span><span class=\"params\">()</span> *<span class=\"title\">ByteProtocol</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;ByteProtocol&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//data: make([]byte, 0),</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> byteCodec <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tr      io.Reader</span><br><span class=\"line\">\tw      io.Writer</span><br><span class=\"line\">\tp      *ByteProtocol</span><br><span class=\"line\">\tcloser io.Closer</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *byteCodec)</span> <span class=\"title\">Receive</span><span class=\"params\">()</span> <span class=\"params\">(<span class=\"keyword\">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\trecvData := <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, <span class=\"number\">4092</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tcnt, err := c.r.Read(recvData)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> recvData[:cnt], err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *byteCodec)</span> <span class=\"title\">Send</span><span class=\"params\">(msg <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tb, ok := msg.([]<span class=\"keyword\">byte</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !ok &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> errors.New(<span class=\"string\">\"Send Byte Format Error\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t_, err := c.w.Write(b)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *byteCodec)</span> <span class=\"title\">Close</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> c.closer != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> c.closer.Close()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以上还可以将reader改为<code>bufio.Reader</code>和<code>bufio.Writer</code>，但记住，带缓冲的IO，在写完数据后，一定要去记得显示调用<code>Flush()</code>函数，不然数据不会写入的。</p>\n</blockquote>\n<p>建议使用<code>bufio</code>，例如可以使用<code>peek</code>函数，读取协议包（自定义）中实际大小，通过实际的大小去读取<code>data</code>数据，可以设计用来解决TCP沾包的问题。</p>\n<p><code>Receive()</code>中使用for循环读取包，当然这里调用<code>Receive()</code>就要用到<code>Goroutine</code>，然后数据通信则使用channel进行通信，我在实际的程序中就是这样操作的。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"TCP","slug":"TCP","permalink":"chunlife.top/tags/TCP/"},{"name":"funny/link","slug":"funny-link","permalink":"chunlife.top/tags/funny-link/"}]},{"title":"斐波那契数列——Go","date":"2019-06-04T07:08:21.000Z","path":"2019/06/04/斐波那契数列——Golang/","content":"<p>fibonacci 数列算是不管哪个语言里头都能碰到的一个问题，其过于经典，导致其有很多解法，大体上可以归为遍历，递归，优化的递归，矩阵（矩阵这个确实很厉害）。</p>\n<p>什么是 斐波那契数列？ 0,1,1,2,3,5,8 … 除了<code>1</code>和<code>2</code>以外，剩下的数都满足 <code>f(n) = f(n-2)+f(n-1)</code>。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"递归方式：\"><a href=\"#递归方式：\" class=\"headerlink\" title=\"递归方式：\"></a>递归方式：</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 递归的方式 - 时间复杂度 O(2^n)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">fibonacciRecusive</span><span class=\"params\">(num <span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num == <span class=\"number\">1</span> || num == <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fibonacciRecusive(num<span class=\"number\">-1</span>) + fibonacciRecusive(num<span class=\"number\">-2</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"改进递归方式：\"><a href=\"#改进递归方式：\" class=\"headerlink\" title=\"改进递归方式：\"></a>改进递归方式：</h3><p>使用<code>map</code>保存计算结果，相当于对已经计算过的数，避免计算第二次。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 时间复杂度 O(n)</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> resultMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">fibonacciRecusiveMem</span><span class=\"params\">(num <span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> val, ok := resultMap[num]; ok &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> val</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num == <span class=\"number\">1</span> || num == <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tresult := fibonacciRecusive(num<span class=\"number\">-1</span>) + fibonacciRecusive(num<span class=\"number\">-2</span>)</span><br><span class=\"line\">\tresultMap[num] = result</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> result</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"遍历的方式：\"><a href=\"#遍历的方式：\" class=\"headerlink\" title=\"遍历的方式：\"></a>遍历的方式：</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 时间复杂度 O(n)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">fibonacciIterative</span><span class=\"params\">(num <span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> f = []<span class=\"keyword\">int</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"number\">0</span>, <span class=\"number\">1</span>,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">2</span>; i &lt;= num; i++ &#123;</span><br><span class=\"line\">\t\tf = <span class=\"built_in\">append</span>(f, f[i<span class=\"number\">-1</span>]+f[i<span class=\"number\">-2</span>])</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> f[num]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>还有个矩阵的方式，这个建议直接搜索其他文章，因为光看代码完全不好懂，还是得伴着原理一起下饭。</p>\n</blockquote>\n","categories":[{"name":"算法","slug":"算法","permalink":"chunlife.top/categories/算法/"}],"tags":[{"name":"fibonacci","slug":"fibonacci","permalink":"chunlife.top/tags/fibonacci/"},{"name":"斐波那契数列","slug":"斐波那契数列","permalink":"chunlife.top/tags/斐波那契数列/"}]},{"title":"Google浏览器翻墙工具（持续更新）","date":"2019-05-30T01:39:03.000Z","path":"2019/05/30/Google浏览器翻墙工具/","content":"<p>由于一些已知和未知的原因，我朝对网络的管控愈发严格，各类新操作已经是直接导致<code>hosts</code>扶墙直接崩塌，有介于扶墙是程序员必备的技能，这里有必要将这些平时翻墙的方法写出来，也是留作自己的备份。</p>\n<a id=\"more\"></a>\n\n<p>可见的下载VPN有自由门，赛风，Tor，蓝灯等工具，貌似也只有<strong>蓝灯</strong>，赛风勉强可以用一用，蓝灯专业版需要付费，免费版有限定流量，基本可以使用。</p>\n<p>赛风基本在国内是个残废状态。其他工具则基本不可用，若要使用Tor，一般是使用<code>二次扶梯</code>，在挂了一个VPN的情况下，再挂上Tor，这样才能正常使用该工具。</p>\n<p>另外还有一个勉强可以用的是，<code>SoftEther VPN</code>，这是一个公益性的VPN，属于日本国立筑波大学。<a href=\"https://github.com/SoftEtherVPN/SoftEtherVPN/\" target=\"_blank\" rel=\"noopener\"><strong>SoftEtherVPN</strong></a>。</p>\n<p>若是仅限于访问谷歌，那可以选择<strong><em>谷歌访问助手</em></strong>，对Google系进行访问完全没有问题，使用Gmail等，比较好用，当然，这个工具需要设定主页，但可以使用GitHub上的版本解除限制。<a href=\"https://github.com/haotian-wang/google-access-helper\" target=\"_blank\" rel=\"noopener\"><strong>google-access-helper</strong></a>。</p>\n<p>还有一个需要介绍的是在GitHub上，使用<code>chromium</code>内置了VPN的一款浏览器，时灵时不灵，就是GitHub下载比较慢，不挂VPN基本下不动，这里持续会更新到百度云上(链接有可能会失效，可提醒我，也可直接访问GitHub<a href=\"https://github.com/jjqqkk/chromium\" target=\"_blank\" rel=\"noopener\">仓库地址</a>)。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">链接: https://pan.baidu.com/s/1lmxqvDEc5yj4r1DBUaNs9w </span><br><span class=\"line\">提取码: 2333</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"实用工具","slug":"实用工具","permalink":"chunlife.top/categories/实用工具/"}],"tags":[{"name":"Google","slug":"Google","permalink":"chunlife.top/tags/Google/"},{"name":"lantern","slug":"lantern","permalink":"chunlife.top/tags/lantern/"},{"name":"chromium 谷歌访问助手","slug":"chromium-谷歌访问助手","permalink":"chunlife.top/tags/chromium-谷歌访问助手/"}]},{"title":"Jetbrains系列产品最新激活方法","date":"2019-05-29T03:23:58.000Z","path":"2019/05/29/Jetbrains系列产品最新激活方法/","content":"<p>Go可以选择的IDE其实是有一些的，在初学阶段我比较推荐的是<em>LiteIDE</em>，使用<code>qt</code>进行开发，国产IDE（<img src=\"zan.png\" alt=\"img\">），简单易用，学习上来说是已经够用了，不折腾，不损耗自信心。</p>\n<a id=\"more\"></a>\n\n<p>其他的话，比价推荐的就是<code>Visual studio code</code>和<code>Jetbrains IDEA</code>，VSC在拥有各类插件，且占用内存空间相对后者较小，易用性很高，在安装方面，其本身是免费的，插件也是免费使用的，但Go的一些工具包是需要自己去GitHub手动拉取的，由于被墙的缘故。</p>\n<p><code>IDEA</code>同样是该有的都有（意思是具备IDE通常应该具备的便捷功能），且有相对少一些的插件，但其能够针对不同的<code>project</code>配置对应的<code>GOPATH</code>，这点，可以说是很方便的，不过其内存占用较前者是多一些的，但其是收费的。</p>\n<p>对于<code>IDEA</code>收费，其实网上有很多解决方法，可以去TB买一个教育邮箱，申请免费使用的年限，同样的，也可以使用一些非常规手段进行正常使用，不过对于公司来说，为了排除被告的风险，还是跟自家的员工搞一个企业版的使用使用吧（或者是强制使用vsc等其他工具）。</p>\n<blockquote>\n<p>以下仅用于学习目的</p>\n</blockquote>\n<p><a href=\"https://zhile.io/2018/08/25/jetbrains-license-server-crack.html\" target=\"_blank\" rel=\"noopener\">Jetbrains系列产品2019.1.3最新激活方法[持续更新]</a></p>\n","categories":[{"name":"实用工具","slug":"实用工具","permalink":"chunlife.top/categories/实用工具/"}],"tags":[{"name":"Jetbrains","slug":"Jetbrains","permalink":"chunlife.top/tags/Jetbrains/"}]},{"title":"解析Content-Disposition，获取文件名","date":"2019-05-28T01:52:25.000Z","path":"2019/05/28/解析Content-Disposition，获取文件名/","content":"<p>在文件下载中，我们需要设置一个header头，在浏览器下载文件时，指定下载文件的文件名。<code>Content-Disposition</code>，这里做的实用<code>golang</code>就是取出设置在<code>header</code>中的文件名。</p>\n<a id=\"more\"></a>\n\n<p>服务器设置该header（这里是使用的<code>gin</code>框架）。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c.Header(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\"</span>+url.QueryEscape(fileName))</span><br></pre></td></tr></table></figure>\n\n<p>使用<code>mime.ParseMediaType</code>函数解析。</p>\n<blockquote>\n<p>代码中使用<code>resty</code>库。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 下载文件</span></span><br><span class=\"line\">req := resty.R()</span><br><span class=\"line\">resp, err := req.SetBody(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span>&#123;&#125;).</span><br><span class=\"line\">\tPost(<span class=\"string\">\"xxxxxxxxxxx\"</span>) <span class=\"comment\">// download接口</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tlog.Debug(<span class=\"string\">\"http request error,\"</span>, err)</span><br><span class=\"line\">\tc.JSON(http.StatusInternalServerError, ERROR[<span class=\"string\">\"INTERNAL_ERROR\"</span>])</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取filename</span></span><br><span class=\"line\">getDispos := resp.Header().Get(<span class=\"string\">\"Content-Disposition\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> getDispos != <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">\t_, params, err := mime.ParseMediaType(getDispos)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Debug(<span class=\"string\">\"http request error,\"</span>, err)</span><br><span class=\"line\">\t\tc.JSON(http.StatusInternalServerError, ERROR[<span class=\"string\">\"INTERNAL_ERROR\"</span>])</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfileName, ok = params[<span class=\"string\">\"filename\"</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !ok &#123;</span><br><span class=\"line\">\t\tlog.Debug(<span class=\"string\">\"filename parameter not exist!\"</span>)</span><br><span class=\"line\">\t\tc.JSON(http.StatusInternalServerError, ERROR[<span class=\"string\">\"INTERNAL_ERROR\"</span>])</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>go client发送文件，即multipart/form-data</p>\n</blockquote>\n<p>可以参考<a href=\"https://github.com/go-resty/resty\" target=\"_blank\" rel=\"noopener\"><strong>go-resty/resty</strong></a>。</p>\n<p>原生库可以参考<a href=\"https://blog.cyeam.com/go/2019/03/15/form-post\" target=\"_blank\" rel=\"noopener\">Go http 如何发送 multipart/form-data (发送文件)？</a>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bodyBuf := &amp;bytes.Buffer&#123;&#125;</span><br><span class=\"line\">bodyWriter := multipart.NewWriter(bodyBuf)</span><br><span class=\"line\">_ = bodyWriter.WriteField(<span class=\"string\">\"param\"</span>, <span class=\"keyword\">string</span>(param))</span><br><span class=\"line\"><span class=\"keyword\">defer</span> bodyWriter.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">req, err := http.NewRequest(<span class=\"string\">\"POST\"</span>, callbackUrl, bodyBuf)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">req.Header.Set(<span class=\"string\">\"Content-Type\"</span>, bodyWriter.FormDataContentType())</span><br><span class=\"line\">req.WithContext(ctx)</span><br><span class=\"line\"></span><br><span class=\"line\">resp, err := http.DefaultClient.Do(req)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">defer</span> resp.Body.Close()</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"HTTP","slug":"HTTP","permalink":"chunlife.top/categories/HTTP/"}],"tags":[{"name":"http","slug":"http","permalink":"chunlife.top/tags/http/"}]},{"title":"检查回文数","date":"2019-05-26T07:55:23.000Z","path":"2019/05/26/检查回文数/","content":"<p>回文数类似于这样的字符串和整数<code>123321</code>。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 检查数字是否是回文数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">checkNum2</span><span class=\"params\">(num <span class=\"keyword\">int</span>)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num &lt; <span class=\"number\">0</span> || (num != <span class=\"number\">0</span> &amp;&amp; num%<span class=\"number\">10</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> num == reverseInt(num)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">reverseInt</span><span class=\"params\">(num <span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\tres := <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> ; num != <span class=\"number\">0</span>; num = num / <span class=\"number\">10</span> &#123;</span><br><span class=\"line\">\t\tres = res*<span class=\"number\">10</span> + num%<span class=\"number\">10</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 检查数字是否是回文数  类似于先转换成字符串再做比较</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">checkNum</span><span class=\"params\">(num <span class=\"keyword\">int</span>)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num &lt; <span class=\"number\">0</span> || (num != <span class=\"number\">0</span> &amp;&amp; num%<span class=\"number\">10</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tnumByte := []<span class=\"keyword\">byte</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\ttheNum := num % <span class=\"number\">10</span></span><br><span class=\"line\">\t\tnum = num / <span class=\"number\">10</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> theNum == <span class=\"number\">0</span> &amp;&amp; num == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tnumByte = <span class=\"built_in\">append</span>(numByte, <span class=\"keyword\">byte</span>(theNum))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, j := <span class=\"number\">0</span>, <span class=\"built_in\">len</span>(numByte)<span class=\"number\">-1</span>; i &lt; j; i, j = i+<span class=\"number\">1</span>, j<span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> numByte[i] != numByte[j] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 检查字符串是否是回文数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">checkPalindRome</span><span class=\"params\">(str <span class=\"keyword\">string</span>)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> str == <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttoBytes := []<span class=\"keyword\">rune</span>(str)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, j := <span class=\"number\">0</span>, <span class=\"built_in\">len</span>(toBytes)<span class=\"number\">-1</span>; i &lt; j; i, j = i+<span class=\"number\">1</span>, j<span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> toBytes[i] != toBytes[j] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tfmt.Println(checkPalindRome(<span class=\"string\">\"中国中\"</span>))</span><br><span class=\"line\">\tfmt.Println(checkPalindRome(<span class=\"string\">\"123321\"</span>))</span><br><span class=\"line\">\tfmt.Println(checkPalindRome(<span class=\"string\">\"\"</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Println(checkNum(<span class=\"number\">11011</span>))</span><br><span class=\"line\">\tfmt.Println(checkNum2(<span class=\"number\">-1911</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"算法","slug":"算法","permalink":"chunlife.top/categories/算法/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"算法","slug":"算法","permalink":"chunlife.top/tags/算法/"}]},{"title":"小工具（windows 便笺）","date":"2019-05-23T05:50:42.000Z","path":"2019/05/23/小工具（windows-便笺）/","content":"<blockquote>\n<p>转载自<a href=\"https://blog.csdn.net/chenghuikai/article/details/45173953\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/chenghuikai/article/details/45173953</a></p>\n</blockquote>\n<p>平时我们使用WIN7的便签，挺方便的，而且是系统自带的，还不用额外的安装，当你新建完标签，以后就会随系统开机启动，非常方便，唯一不足的是，不能最小化到右下角，可惜了，不过还是挺好用的，下面告诉你些使用的快捷键，看个图片吧：</p>\n<a id=\"more\"></a>\n\n<p><img src=\"20150421183545151.jpg\" alt=\"img\"></p>\n<p>有了这些快捷键，用起来是不是很方便呢，而且还可以标注一些重点，分类。图片可以存起来，放到桌面，以备随时查看。</p>\n<p>另外在开始-&gt;运行里，直接输入stikynot，然后回车，就可以打开便签了，免得去程序里翻半天了</p>\n<p>顺便告诉你，便签在程序里的位置，依次打到：开始-&gt;所有程序-&gt;附件，看到了吧，便签就在里面呆着呢！</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ctrl + N    新建便笺                  Ctrl + D    删除当前便笺</span><br><span class=\"line\"></span><br><span class=\"line\">Ctrl + E    居中对齐                  Ctrl + R   右对齐</span><br><span class=\"line\"></span><br><span class=\"line\">Ctrl + J   左对齐                     Ctrl + B 粗体</span><br><span class=\"line\"></span><br><span class=\"line\">Ctrl + I    斜体                     Ctrl + U   下划线</span><br><span class=\"line\"></span><br><span class=\"line\">Ctrl + T   删除线                    Ctrl + Shift + &gt;    增大字体</span><br><span class=\"line\"></span><br><span class=\"line\">Ctrl + Shift + &lt; 缩小字体            Ctrl + Shift + L    添加项目符号和编号（重复按可切换、取消）</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"实用工具","slug":"实用工具","permalink":"chunlife.top/categories/实用工具/"}],"tags":[{"name":"便笺","slug":"便笺","permalink":"chunlife.top/tags/便笺/"},{"name":"Sticky Notes","slug":"Sticky-Notes","permalink":"chunlife.top/tags/Sticky-Notes/"}]},{"title":"docker pxc部署","date":"2019-05-21T05:55:04.000Z","path":"2019/05/21/docker-pxc部署/","content":"<p>参考之前的博客，将docker的跨宿主机overlay网络部署成功，然后再进行此次操作。</p>\n<a id=\"more\"></a>\n\n<h1 id=\"pxc集群\"><a href=\"#pxc集群\" class=\"headerlink\" title=\"pxc集群\"></a>pxc集群</h1><p>第一个节点：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker volume create v01</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -d \\</span><br><span class=\"line\">-p 3306:3306 \\</span><br><span class=\"line\">-e MYSQL_ROOT_PASSWORD=abc123456 \\</span><br><span class=\"line\">-e CLUSTER_NAME=PXC \\</span><br><span class=\"line\">-e XTRABACKUP_PASSWORD=abc123456 \\</span><br><span class=\"line\">-v v01:/var/lib/mysql \\</span><br><span class=\"line\">--privileged \\</span><br><span class=\"line\">--name=node1 \\</span><br><span class=\"line\">--net=pxc_overlay \\</span><br><span class=\"line\">percona/percona-xtradb-cluster:5.7</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>docker privileged</strong>：</p>\n<p>使用该参数，container内的root拥有真正的root权限。<br>否则，container内的root只是外部的一个普通用户权限。</p>\n</blockquote>\n<p>在官方的<a href=\"https://www.percona.com/doc/percona-xtradb-cluster/LATEST/install/docker.html\" target=\"_blank\" rel=\"noopener\">演示文档</a>中，pxc官方并没有使用这个参数，但其他博客在部署过程中都使用了这个参数，理论上那这个就是没有问题的，但在我的实际部署中，有些节点若使用这个参数反而会报出无法操作某些文件夹的错误，所以在子节点上，我没有加入这个参数。</p>\n<p>其他节点：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker volume create v02</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -d \\</span><br><span class=\"line\">-p 3306:3306 \\</span><br><span class=\"line\">-e MYSQL_ROOT_PASSWORD=abc123456 \\</span><br><span class=\"line\">-e CLUSTER_NAME=PXC \\</span><br><span class=\"line\">-e XTRABACKUP_PASSWORD=abc123456 \\</span><br><span class=\"line\">-e CLUSTER_JOIN=node1 \\</span><br><span class=\"line\">-v v02:/var/lib/mysql \\</span><br><span class=\"line\">--name=node2 \\</span><br><span class=\"line\">--net=pxc_overlay \\</span><br><span class=\"line\">percona/percona-xtradb-cluster:5.7</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><p>一个节点: </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -uroot -p -hxxx.xxx.xxx.xxx -P3306</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>create database   wubotest;</p>\n</blockquote>\n<p>另一个节点: </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -uroot -p -hxxx.xxx.xxx.xxx -P3306</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>show databases;</p>\n</blockquote>\n<h1 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h1><p><a href=\"https://idig8.com/2019/02/01/shizhanpiankaiyuanxiangmudockerhuayunweibushu-dajianmysqljiqunsi/\" target=\"_blank\" rel=\"noopener\">「实战篇」开源项目docker化运维部署-搭建mysql集群（四）</a></p>\n<p>安装完成后，为了更好的利用集群的特性，你可能就需要用到负载均衡了。</p>\n<p>这方面我没有做，所以也仅是提供个链接供我以后和大家参考了。</p>\n","categories":[{"name":"docker","slug":"docker","permalink":"chunlife.top/categories/docker/"}],"tags":[{"name":"docker","slug":"docker","permalink":"chunlife.top/tags/docker/"},{"name":"pxc","slug":"pxc","permalink":"chunlife.top/tags/pxc/"},{"name":"Percona XtraDB Cluster","slug":"Percona-XtraDB-Cluster","permalink":"chunlife.top/tags/Percona-XtraDB-Cluster/"}]},{"title":"docker overlay网络部署","date":"2019-05-21T03:16:38.000Z","path":"2019/05/21/docker-overlay网络部署/","content":"<p>在实际的项目中，因为需要部署多节点冗余备份，以实现高可用，这里就要用到各类工具的分布式部署方案了，以前手动部署过mysql replication和pxc，但docker的方案没有尝试成功，无法成功部署，这里也是参考了各类博客和文档后，尝试部署成功。</p>\n<p>假设要在两台节点上安装docker，并使这两个docker可以相互访问。</p>\n<p>环境：Ubuntu 16.04  etcd docker</p>\n<a id=\"more\"></a>\n\n<h1 id=\"安装ETCD\"><a href=\"#安装ETCD\" class=\"headerlink\" title=\"安装ETCD\"></a>安装ETCD</h1><h2 id=\"etcd集群\"><a href=\"#etcd集群\" class=\"headerlink\" title=\"etcd集群\"></a>etcd集群</h2><p>etcd集群参考<a href=\"https://www.kancloud.cn/hanxt/foreign-docker/164734\" target=\"_blank\" rel=\"noopener\">基于etcd服务发现的overlay跨多宿主机容器网络</a>。</p>\n<p>在两台主机上：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L &lt;https://github.com/coreos/etcd/releases/download/v2.2.1/etcd-v2.2.1-linux-amd64.tar.gz&gt; -o etcd-v2.2.1-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">tar xzvf etcd-v2.2.1-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">cd etcd-v2.2.1-linux-amd64</span><br></pre></td></tr></table></figure>\n\n<p>注意下面的命令需要先设置下面值：</p>\n<p>{NODE_NAME}:etcd节点名称，需要和命令中的-initial-cluster的对应的{NODE1_NAME}或{NODE2_NAME}对应</p>\n<p>{NODE_IP}/{NODE1_IP}/{NODE2_NAME}：节点的IP</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./etcd -name &#123;NODE_NAME&#125; -initial-advertise-peer-urls [http://&#123;NODE_IP&#125;:2380](http://NODE_IP:2380) \\</span><br><span class=\"line\">-listen-peer-urls &lt;http://0.0.0.0:2380&gt; \\</span><br><span class=\"line\">-listen-client-urls [http://0.0.0.0:2379,http://127.0.0.1:4001](http://0.0.0.0:2379,http:/127.0.0.1:4001) \\</span><br><span class=\"line\">-advertise-client-urls &lt;http://0.0.0.0:2379&gt; \\</span><br><span class=\"line\">-initial-cluster-token etcd-cluster \\</span><br><span class=\"line\">-initial-cluster &#123;NODE1_NAME&#125;=http://&#123;NODE1_IP&#125;:2380,&#123;NODE2_NAME&#125;=http://&#123;NODE2_IP&#125;:2380 \\</span><br><span class=\"line\">-initial-cluster-state new</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"单个运行etcd\"><a href=\"#单个运行etcd\" class=\"headerlink\" title=\"单个运行etcd\"></a>单个运行etcd</h2><p>参考<a href=\"https://github.com/alfredhuang211/study-doc/blob/master/docker%E8%B7%A8%E4%B8%BB%E6%9C%BAoverlay%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE.md\" target=\"_blank\" rel=\"noopener\">docker跨主机overlay网络配置</a>。</p>\n<h2 id=\"etcd配置\"><a href=\"#etcd配置\" class=\"headerlink\" title=\"etcd配置:\"></a>etcd配置:</h2><h3 id=\"etcd启动\"><a href=\"#etcd启动\" class=\"headerlink\" title=\"etcd启动\"></a>etcd启动</h3><p>etcd启动命令:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">etcd --advertise-client-urls &apos;http://192.168.15.232:2379&apos; --listen-client-urls &apos;http://0.0.0.0:2379&apos;</span><br></pre></td></tr></table></figure>\n\n<p>需要确保 advertise-client-urls 是在正确的ip和端口上监听</p>\n<h3 id=\"etcd检查\"><a href=\"#etcd检查\" class=\"headerlink\" title=\"etcd检查\"></a>etcd检查</h3><ul>\n<li>本机检查:</li>\n</ul>\n<p>在etcd运行的机器上,检查启动情况:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">etcdctl member list</span><br><span class=\"line\">ce2a822cea30bfca: name=default peerURLs=http://localhost:2380,http://localhost:7001 clientURLs=http://192.168.15.232:2379 isLeader=true</span><br></pre></td></tr></table></figure>\n\n<p>检查功能是否正确,能否正确设置和获取</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">etcdctl mk key value</span><br><span class=\"line\">etcdctl get key </span><br><span class=\"line\">value</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>远程检查</li>\n</ul>\n<p>在其他主机上,验证远程连接的正确性,是否可以正确设置和获取</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./etcdctl -endpoints http://192.168.15.232:2379 get key</span><br><span class=\"line\">value</span><br><span class=\"line\">/etcdctl -endpoints http://192.168.15.232:2379 mk key2 value2</span><br><span class=\"line\">value2</span><br><span class=\"line\">./etcdctl -endpoints http://192.168.15.232:2379 get key2 </span><br><span class=\"line\">value2</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装docker\"><a href=\"#安装docker\" class=\"headerlink\" title=\"安装docker\"></a>安装docker</h1><p>如何安装，参考：<a href=\"https://docs.docker.com/install/linux/docker-ce/ubuntu/\" target=\"_blank\" rel=\"noopener\">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>\n<p>在两个节点上:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span>sudo service docker stop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">$</span>sudo vim /etc/default/docker</span><br><span class=\"line\"><span class=\"meta\">#</span> 写入:  (注意下面&#123;NODE_IP&#125;需要改为主机IP)</span><br><span class=\"line\">DOCKER_OPTS=\"-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --cluster-store=etcd://&#123;NODE_IP&#125;:2379 --cluster-advertise=&#123;NODE_IP&#125;:2375\"</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">$</span> sudo service docker start</span><br></pre></td></tr></table></figure>\n\n<p>在其中一台主机上初始化swarm，使其为swarm manager节点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> sudo docker swarm init</span><br></pre></td></tr></table></figure>\n\n<p>加入集群（运行完上面的命令后，会出现指示如何加入网络的指令）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker swarm join --token SWMTKN-1-0qo83je2oxsfxd72m09fgsm598i4dqzu3xfim36f4w20ioovgs-7oj4jufbt6yhsbq8mdxzf0bkj xxx.1xx.xxx.201:2377</span><br></pre></td></tr></table></figure>\n\n<p>在这台主机上，新建overlay network：(注意下面命令{NETWORK_NAME}改为自己的network名称，–attachable参数很重要)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> sudo docker network create --driver overlay --attachable &#123;NETWORK_NAME&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试：\"><a href=\"#测试：\" class=\"headerlink\" title=\"测试：\"></a>测试：</h1><p>  第一个节点: </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -itd --name=worker-1 --net=&#123;NETWORK_NAME&#125; ubuntu</span><br></pre></td></tr></table></figure>\n\n<p> 第二个节点: </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -itd --name=worker-2 --net=&#123;NETWORK_NAME&#125; ubuntu</span><br></pre></td></tr></table></figure>\n\n<p>在两个节点运行的ubuntudocker 容器安装ping和ifconfig并查看各自的ip：</p>\n<p>第一个节点：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker exec worker-1 apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">sudo docker exec worker-1 apt-get install net-tools</span><br><span class=\"line\"></span><br><span class=\"line\">sudo docker exec worker-1 ifconfig      //看到eth0则为该docker容器的ip,比如看到的为10.0.0.2</span><br></pre></td></tr></table></figure>\n\n<p>第二个节点：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker exec worker-2 apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">sudo docker exec worker-2 apt-get install net-tools</span><br><span class=\"line\"></span><br><span class=\"line\">sudo docker exec worker-2 apt-get install inetutils-ping</span><br><span class=\"line\"></span><br><span class=\"line\">sudo docker exec worker-2 ifconfig      //看到eth0则为该docker容器的ip,比如看到的为10.0.0.4</span><br><span class=\"line\"></span><br><span class=\"line\">sudo docker exec worker-2 ping 10.0.0.2   //ping 得通则成功了</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"docker","slug":"docker","permalink":"chunlife.top/categories/docker/"}],"tags":[{"name":"docker","slug":"docker","permalink":"chunlife.top/tags/docker/"},{"name":"overlay","slug":"overlay","permalink":"chunlife.top/tags/overlay/"},{"name":"跨宿主机","slug":"跨宿主机","permalink":"chunlife.top/tags/跨宿主机/"}]},{"title":"mysql集群部署","date":"2019-05-17T12:18:10.000Z","path":"2019/05/17/mysql集群部署/","content":"<p>在实际的开发环境（我的为Ubuntu）中，为了保证数据的有效性以及稳定性，需要对数据库进行冗余设计，也就是集群部署，以此来应对在实际的生产环境中出现的数据库宕机，我这里主要是看了两种mysql集群设计方案，Replication和PXC（percona-xtradb-cluster）。</p>\n<a id=\"more\"></a>\n\n<p>Replication方案，配置比较简单，采用主从的方式，内部机理为二进制日志进行同步，但不具备强一致性，从节点不可以作为读写节点，得不到实际保障，多用于数据备份的环境。</p>\n<p>PXC任意一个节点都可以存在读写的方案，也就是任意一个节点都可以当读或者当写。同步复制。保证强一致性。同步复制，事务在所有节点要提交都提交。要么都不提交。</p>\n<h2 id=\"Replication\"><a href=\"#Replication\" class=\"headerlink\" title=\"Replication\"></a>Replication</h2><h3 id=\"安装mysql\"><a href=\"#安装mysql\" class=\"headerlink\" title=\"安装mysql\"></a>安装mysql</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> apt-get install mysql-server -y</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"master\"><a href=\"#master\" class=\"headerlink\" title=\"master\"></a>master</h3><h4 id=\"编辑和修改MySql-Server的配置文件\"><a href=\"#编辑和修改MySql-Server的配置文件\" class=\"headerlink\" title=\"编辑和修改MySql Server的配置文件\"></a>编辑和修改MySql Server的配置文件</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 注释这句， server可以用其他网卡IP进行访问</span><br><span class=\"line\"># bind-address = 127.0.0.1</span><br></pre></td></tr></table></figure>\n\n<p>在文件末尾添加以下行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server-id = 1   # 不与其他地方相同</span><br><span class=\"line\">log_bin = /var/log/mysql/mysql-bin.log</span><br><span class=\"line\">log_bin_index =/var/log/mysql/mysql-bin.log.index</span><br><span class=\"line\">relay_log = /var/log/mysql/mysql-relay-bin</span><br><span class=\"line\">relay_log_index = /var/log/mysql/mysql-relay-bin.index</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"重启mysql\"><a href=\"#重启mysql\" class=\"headerlink\" title=\"重启mysql\"></a>重启mysql</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># service mysql restart</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"登录mysql，创建用于集群的账号\"><a href=\"#登录mysql，创建用于集群的账号\" class=\"headerlink\" title=\"登录mysql，创建用于集群的账号\"></a>登录mysql，创建用于集群的账号</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql &gt; create user &apos;replica&apos;@&apos;%&apos; identified by &apos;password&apos;;</span><br><span class=\"line\">mysql &gt; GRANT REPLICATION SLAVE ON *.* TO &apos;replica&apos;@&apos;%&apos;;</span><br><span class=\"line\">mysql &gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>\n\n<p>执行命令查看服务器状态</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql &gt; show master status;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>图中是我后来截的图，参数和你不一致很正常</p>\n</blockquote>\n<p><img src=\"1558098597813.png\" alt=\"1558098597813\"></p>\n<h3 id=\"Slave\"><a href=\"#Slave\" class=\"headerlink\" title=\"Slave\"></a><strong>Slave</strong></h3><h4 id=\"编辑和修改MySql-Server的配置文件-1\"><a href=\"#编辑和修改MySql-Server的配置文件-1\" class=\"headerlink\" title=\"编辑和修改MySql Server的配置文件\"></a>编辑和修改MySql Server的配置文件</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 注释这句， server可以用其他网卡IP进行访问</span><br><span class=\"line\"># bind-address = 127.0.0.1</span><br></pre></td></tr></table></figure>\n\n<p>在文件末尾添加以下行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server-id = 2  // 节点这里需要不同</span><br><span class=\"line\">log_bin = /var/log/mysql/mysql-bin.log</span><br><span class=\"line\">log_bin_index =/var/log/mysql/mysql-bin.log.index</span><br><span class=\"line\">relay_log = /var/log/mysql/mysql-relay-bin</span><br><span class=\"line\">relay_log_index = /var/log/mysql/mysql-relay-bin.index</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"重启mysql-1\"><a href=\"#重启mysql-1\" class=\"headerlink\" title=\"重启mysql\"></a>重启mysql</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># service mysql restart</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"登录mysql，配置从节点\"><a href=\"#登录mysql，配置从节点\" class=\"headerlink\" title=\"登录mysql，配置从节点\"></a>登录mysql，配置从节点</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql &gt; stop slave; </span><br><span class=\"line\">mysql &gt; CHANGE MASTER TO MASTER_HOST = &apos;master-ip&apos;, MASTER_USER = &apos;replica&apos;, MASTER_PASSWORD = &apos;password&apos;, MASTER_LOG_FILE = &apos;mysql-bin.000001&apos;, MASTER_LOG_POS = 753; </span><br><span class=\"line\">mysql &gt; start slave;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MASTER_HOST：主服务器的IP地址 </span><br><span class=\"line\">MASTER_USER：我们在之前步骤中创建的主服务器的复制用户。 </span><br><span class=\"line\">MASTER_PASSWORD：我们在之前步骤中创建的主服务器的复制用户密码。 </span><br><span class=\"line\">MASTER_LOG_FILE：主服务器主日志文件的值。 </span><br><span class=\"line\">MASTER_LOG_POS：主服务器的主日志位置的值。</span><br></pre></td></tr></table></figure>\n\n<hr>\n<p>主从节点的配置都完成，此时即可插入一些数据去查看是否配置成功了。</p>\n<h2 id=\"PXC\"><a href=\"#PXC\" class=\"headerlink\" title=\"PXC\"></a>PXC</h2><p>这里推荐一个YouTube的视频进行观看，<a href=\"https://www.youtube.com/watch?v=wIEj3FLAX8M\" target=\"_blank\" rel=\"noopener\">Install Percona XtraDB Cluster on CentOS 7 in simple easy steps</a>。</p>\n<p>可以查看GitHub视频主的仓库，<a href=\"https://github.com/justmeandopensource/percona\" target=\"_blank\" rel=\"noopener\">here</a>。</p>\n<p>可以参考<a href=\"https://www.percona.com/doc/percona-xtradb-cluster/LATEST/index.html\" target=\"_blank\" rel=\"noopener\">官方文档</a>。</p>\n<p>这里简略说一下Ubuntu PXC的安装。</p>\n<p>以前装过mysql需要卸载干净，然后将<code>apparmor</code>也一并卸载。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo apt-get remove apparmor</span><br></pre></td></tr></table></figure>\n\n<p>获取仓库包：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://repo.percona.com/apt/percona-release_latest.generic_all.deb</span><br></pre></td></tr></table></figure>\n\n<p><code>dpkg</code>安装最新的仓库，更新。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo dpkg -i percona-release_latest.generic_all.deb</span><br><span class=\"line\">$ sudo apt-get update</span><br><span class=\"line\">$ sudo apt-get install percona-xtradb-cluster-5.6</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以下均为转载自仓库。</p>\n</blockquote>\n<h3 id=\"Install-instructions-for-Ubuntu-18\"><a href=\"#Install-instructions-for-Ubuntu-18\" class=\"headerlink\" title=\"Install instructions for Ubuntu 18\"></a>Install instructions for Ubuntu 18</h3><h3 id=\"Assumptions\"><a href=\"#Assumptions\" class=\"headerlink\" title=\"Assumptions\"></a>Assumptions</h3><table>\n<thead>\n<tr>\n<th>Role</th>\n<th>machine name</th>\n<th>IP address</th>\n<th>Memory</th>\n<th>Operating System</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>master node 1</td>\n<td>ubuntuvm01</td>\n<td>172.42.42.101</td>\n<td>1G</td>\n<td>Ubuntu 18</td>\n</tr>\n<tr>\n<td>master node 2</td>\n<td>ubuntuvm02</td>\n<td>172.42.42.102</td>\n<td>1G</td>\n<td>Ubuntu 18</td>\n</tr>\n</tbody></table>\n<h3 id=\"On-First-node\"><a href=\"#On-First-node\" class=\"headerlink\" title=\"On First node\"></a>On First node</h3><h5 id=\"Add-Percona-Repository\"><a href=\"#Add-Percona-Repository\" class=\"headerlink\" title=\"Add Percona Repository\"></a>Add Percona Repository</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://repo.percona.com/apt/percona-release_0.1-6.$(lsb_release -sc)_all.deb</span><br><span class=\"line\">dpkg -i percona-release_0.1-6.$(lsb_release -sc)_all.deb</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Install-Percona-XtraDB-Cluster\"><a href=\"#Install-Percona-XtraDB-Cluster\" class=\"headerlink\" title=\"Install Percona-XtraDB-Cluster\"></a>Install Percona-XtraDB-Cluster</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install -y percona-xtradb-cluster-57</span><br><span class=\"line\">systemctl stop mysql</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Configure-Replication-Settings\"><a href=\"#Configure-Replication-Settings\" class=\"headerlink\" title=\"Configure Replication Settings\"></a>Configure Replication Settings</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt;/etc/mysql/my.cnf&lt;&lt;EOF</span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">wsrep_provider=/usr/lib/libgalera_smm.so</span><br><span class=\"line\">wsrep_cluster_name=democluster</span><br><span class=\"line\">wsrep_cluster_address=gcomm://</span><br><span class=\"line\">wsrep_node_name=centosvm01</span><br><span class=\"line\">wsrep_node_address=172.42.42.101</span><br><span class=\"line\">wsrep_sst_method=xtrabackup-v2</span><br><span class=\"line\">wsrep_sst_auth=repuser:reppassword</span><br><span class=\"line\">pxc_strict_mode=ENFORCING</span><br><span class=\"line\">binlog_format=ROW</span><br><span class=\"line\">default_storage_engine=InnoDB</span><br><span class=\"line\">innodb_autoinc_lock_mode=2</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Bootstrap-Initialize-the-Cluster\"><a href=\"#Bootstrap-Initialize-the-Cluster\" class=\"headerlink\" title=\"Bootstrap/Initialize the Cluster\"></a>Bootstrap/Initialize the Cluster</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start mysql</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Create-Replication-User\"><a href=\"#Create-Replication-User\" class=\"headerlink\" title=\"Create Replication User\"></a>Create Replication User</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -uroot -p -e &quot;create user repuser@localhost identified by &apos;reppassword&apos;&quot;</span><br><span class=\"line\">mysql -uroot -p -e &quot;grant reload, replication client, process, lock tables on *.* to repuser@localhost&quot;</span><br><span class=\"line\">mysql -uroot -p -e &quot;flush privileges&quot;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Update-Replication-configuration\"><a href=\"#Update-Replication-configuration\" class=\"headerlink\" title=\"Update Replication configuration\"></a>Update Replication configuration</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &apos;s/^wsrep_cluster_address=.*/wsrep_cluster_address=gcomm:\\/\\/172.42.42.101,172.42.42.102/&apos; /etc/mysql/my.cnf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"On-Second-node\"><a href=\"#On-Second-node\" class=\"headerlink\" title=\"On Second node\"></a>On Second node</h3><h5 id=\"Add-Percona-Repository-1\"><a href=\"#Add-Percona-Repository-1\" class=\"headerlink\" title=\"Add Percona Repository\"></a>Add Percona Repository</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://repo.percona.com/apt/percona-release_0.1-6.$(lsb_release -sc)_all.deb</span><br><span class=\"line\">dpkg -i percona-release_0.1-6.$(lsb_release -sc)_all.deb</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Install-Percona-XtraDB-Cluster-1\"><a href=\"#Install-Percona-XtraDB-Cluster-1\" class=\"headerlink\" title=\"Install Percona-XtraDB-Cluster\"></a>Install Percona-XtraDB-Cluster</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install -y percona-xtradb-cluster-57</span><br><span class=\"line\">systemctl stop mysql</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Configure-Replication-Settings-1\"><a href=\"#Configure-Replication-Settings-1\" class=\"headerlink\" title=\"Configure Replication Settings\"></a>Configure Replication Settings</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt;/etc/mysql/my.cnf&lt;&lt;EOF</span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">wsrep_provider=/usr/lib/libgalera_smm.so</span><br><span class=\"line\">wsrep_cluster_name=democluster</span><br><span class=\"line\">wsrep_cluster_address=gcomm://172.42.42.101,172.42.42.102</span><br><span class=\"line\">wsrep_node_name=centosvm02</span><br><span class=\"line\">wsrep_node_address=172.42.42.102</span><br><span class=\"line\">wsrep_sst_method=xtrabackup-v2</span><br><span class=\"line\">wsrep_sst_auth=repuser:reppassword</span><br><span class=\"line\">pxc_strict_mode=ENFORCING</span><br><span class=\"line\">binlog_format=ROW</span><br><span class=\"line\">default_storage_engine=InnoDB</span><br><span class=\"line\">innodb_autoinc_lock_mode=2</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Start-mysql-to-join-the-cluster\"><a href=\"#Start-mysql-to-join-the-cluster\" class=\"headerlink\" title=\"Start mysql to join the cluster\"></a>Start mysql to join the cluster</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start mysql</span><br></pre></td></tr></table></figure>","categories":[{"name":"mysql","slug":"mysql","permalink":"chunlife.top/categories/mysql/"}],"tags":[{"name":"pxc","slug":"pxc","permalink":"chunlife.top/tags/pxc/"},{"name":"mysql","slug":"mysql","permalink":"chunlife.top/tags/mysql/"},{"name":"replication","slug":"replication","permalink":"chunlife.top/tags/replication/"},{"name":"percona-xtradb-cluster","slug":"percona-xtradb-cluster","permalink":"chunlife.top/tags/percona-xtradb-cluster/"}]},{"title":"分布式定时任务之强杀任务","date":"2019-05-05T08:10:17.000Z","path":"2019/05/05/分布式定时任务之强杀任务/","content":"<p><a href=\"https://github.com/younglifestyle/goexamples/tree/master/cronPro\" target=\"_blank\" rel=\"noopener\">cronPro</a>，其中有一项功能为强杀任务；这里也可以借助<code>shell</code>命令来完成，通过<code>shell</code>脚本获取任务的<code>pid</code>，这样就可以通过脚本来控制程序在操作系统层面上一定会被<code>kill</code>。</p>\n<a id=\"more\"></a>\n\n<p>取自falcon-plus的启动脚本。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_pid() &#123;</span><br><span class=\"line\">    if [ -f $pidfile ];then</span><br><span class=\"line\">        pid=`cat $pidfile`</span><br><span class=\"line\">        if [ -n $pid ]; then</span><br><span class=\"line\">            running=`ps -p $pid|grep -v \"PID TTY\" |wc -l`</span><br><span class=\"line\">            return $running</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    return 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function start() &#123;</span><br><span class=\"line\">    check_pid</span><br><span class=\"line\">    running=$?</span><br><span class=\"line\">    if [ $running -gt 0 ];then</span><br><span class=\"line\">        echo -n \"$app now is running already, pid=\"</span><br><span class=\"line\">        cat $pidfile</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\"></span><br><span class=\"line\">    nohup ./$app &amp;&gt; $logfile &amp;</span><br><span class=\"line\">    echo $! &gt; $pidfile</span><br><span class=\"line\">    echo \"$app started..., pid=$!\"</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function stop() &#123;</span><br><span class=\"line\">    pid=`cat $pidfile`</span><br><span class=\"line\">    kill $pid</span><br><span class=\"line\">    echo \"$app stoped...\"</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"项目","slug":"项目","permalink":"chunlife.top/categories/项目/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"}]},{"title":"进程与线线程的翻译文章","date":"2019-04-25T02:22:20.000Z","path":"2019/04/25/进程与线线程的翻译文章/","content":"<h1 id=\"A-gentle-introduction-to-multithreading\"><a href=\"#A-gentle-introduction-to-multithreading\" class=\"headerlink\" title=\"A gentle introduction to multithreading\"></a>A gentle introduction to multithreading</h1><p><a href=\"https://www.internalpointers.com/post/gentle-introduction-multithreading\" target=\"_blank\" rel=\"noopener\">https://www.internalpointers.com/post/gentle-introduction-multithreading</a></p>\n<a id=\"more\"></a>\n\n<p>额，才发现评论里，已经有人翻译了。时间是2019年3月份。</p>\n<p><a href=\"https://mp.weixin.qq.com/s/2d-xgWbhSgyFJ3zKPOIscg\" target=\"_blank\" rel=\"noopener\">多线程简述</a></p>\n<p><strong>转载：</strong></p>\n<p>一次一步，走进并发的世界。</p>\n<p>现代计算机有能力在同一时间执行多个操作。随着硬件的进步和操作系统的发展，这项特性让程序运行得更快，无论是在执行速度上还是在响应性上。</p>\n<p>编写利用到此特性的软件另人着迷但也需要更多技巧: 你需要明白计算机底层发生了什么。本系列第一篇将对 线程(threads) 进行概述。在这些魔法背后，线程是操作系统(os) 提供的工具之一。</p>\n<h2 id=\"进程-process-和线程-thread-对号入座\"><a href=\"#进程-process-和线程-thread-对号入座\" class=\"headerlink\" title=\"进程(process)和线程(thread): 对号入座\"></a>进程(process)和线程(thread): 对号入座</h2><p>现代操作系统能够在同一时间运行多个程序. 这也是为什么此刻你可以在浏览器中阅读本文，同时又能使用音乐播放器听音乐的原因(浏览器和播放器是两个不同的程序)。每一个运行的程序都会是一个进程(process)。操作系统知晓很多软件技巧，使得多个进程可以一起运行，并能利用好底层的硬件。无论怎样，最终的结果都是，用户 <em>感觉</em> 所有的程序是同时跑着的。</p>\n<p>多进程并非操作系统中在同一时间执行多条任务的惟一方法。每个进程内部也可能同时跑多个子任务，这被叫做 线程(threads)。可以把线程当作进程的切片。每个进程启动时至少激活了一个线程，这个线程叫做 主线程(main thread)。然后，根据程序或程序设计者的需要，额外的线程会被创建或终止。多线程(multitreading) 就是关于单个进程内跑多个线程的。</p>\n<p>例如，很有可能你用的播放器就跑了多个线程: 一个用来渲染用户界面(通常是主线程)，另一个用来播放音乐。</p>\n<p>可以把操作系统当作持有多个进程的容器，而每个容器本身也持有多个线程。本篇文章主要关注线程，完整的话题很吸引人，值得未来写一篇更深入的分析文章。</p>\n<p><img src=\"1556249590804.png\" alt=\"*Operating systems can be seen as a box that contains processes, which in turn contain one or more threads.*\"></p>\n<ol>\n<li>操作系统可以被看作包含了很多进程的盒子，而进程本身则包含了很多线程。</li>\n</ol>\n<h3 id=\"进程和线程的区别\"><a href=\"#进程和线程的区别\" class=\"headerlink\" title=\"进程和线程的区别\"></a>进程和线程的区别</h3><p>操作系统为每个进程分配了自己的一片内存。通常这片内存不与其它进程共享：你的浏览器没法访问你的播放器的内存，反之亦然。把浏览器打开2次也遵循同样的规则，操作系统把一个应用的每个实例都当作一个独立的进程，每个进程都有会分配自己的独占内存。所以，两个或多个进程之间默认无法分享数据，除非它们应用了更高级的技巧–所谓的 进程间通信 (IPC).</p>\n<p>和进程不同，线程与其所在的进程共用一片操作系统分配的内存：播放器主线程内的数据可以轻易地被音频引擎访问到，反之亦然。因此，线程之间通信更加容易。在此基础上，线程通常比进程更轻量：它们资源占用得更少，更易创建。这也是我们称呼线程 轻量化的进程(lightweight processes) 的原因。</p>\n<p>线程让你的程序在同一时间执行多个操作变得方便。没有线程，你要针对每个任务写一个程序，每个任务跑一个进程，并利用操作系统对它们进行同步。这样做更难(进程间通信是棘手的)、更慢(进程比线程的开销更重)</p>\n<h3 id=\"绿色线程，或-纤程\"><a href=\"#绿色线程，或-纤程\" class=\"headerlink\" title=\"绿色线程，或 纤程\"></a>绿色线程，或 纤程</h3><p>目前为止，我们讨论的线程都是操作系统层面的：一个进程想创建一个新线程，必须告诉操作系统。然而，不是每个平台都原生支持线程。绿色线程(green threads), 也叫 纤程(fibers) 是一类模拟，它使得多线程程序在没有多线程支持的环境下也能工作。例如，在底层操作系统没有原生线程支持的情况下，某些虚拟机会实现绿色线程。</p>\n<p>绿色线程的创建和管理都更快速，因为它们完全绕过了操作系统，但也有一些缺点。这个话题在后续的文章中会提到。</p>\n<p>绿色线程(green threads) 这个名字来自于 Sun Microsystem的绿色小组(Green Team), 90年代Java 线程库的初版即在这里设计。今天Java已不再使用绿色线程，在2000年时，他们切换到了原生线程。其它的一些语言–Go, Haskell 或 Rust, 举这几个例子 – 没有使用原生线程，而是实现了和绿色线程类似的功能。</p>\n<h2 id=\"线程的用途\"><a href=\"#线程的用途\" class=\"headerlink\" title=\"线程的用途\"></a>线程的用途</h2><p>进程为什么要使用多个线程？之前提到过，并行可以加快速度。比如，你打算在电影编辑器中渲染一部电影。编辑器可以聪明到将渲染操作分拆给多个线程，每个线程负责处理一部分数据。所以如果让一个线程来做需要1小时，那么2个线程只需要30分钟，而4个线程15分钟就行了，如此这般。</p>\n<p>事情真的这样简单吗？有3个重要的点要考虑：</p>\n<ol>\n<li>不是所有程序都需要多线程。如果你的程序执行的是顺序操作或者总是等待用户操作，多线程不会带来多少好处；</li>\n<li>引入更多线程不一定会让程序跑得更快：每个子任务必须精心设计以保证并行执行；</li>\n<li>多个线程并不能保证100%并行，即，同一时间执行：这取决于底层硬件。</li>\n</ol>\n<p>第3点至关重要：如果你的计算机不支持同一时间多个操作，操作系统必须进行模拟操作。这一点后面会说到。暂时地，我们把并发(concurrency)描述为在同一时间执行多个任务的感受(perception)，而<strong>真实的并行(true parallelism)</strong>是多个任务确确实实地在同一时间运行着。</p>\n<p><img src=\"1556249652132.png\" alt=\"*Parallelism is a subset of concurrency.*\"></p>\n<ol>\n<li>并行是并发的子集.</li>\n</ol>\n<h2 id=\"什么让并发和并行成为可能\"><a href=\"#什么让并发和并行成为可能\" class=\"headerlink\" title=\"什么让并发和并行成为可能\"></a>什么让并发和并行成为可能</h2><p> 程序的运行依赖于计算机中的中央处理器(CPU)。它由多个部分组成，主要的部分被称作 核心(core)：运算就是在这里执行的。一个核心一次只能运行一个操作。</p>\n<p>这自然就成了主要的缺点。为解决这个问题，操作系统发展出了高级技巧，让计算机有能力同时跑多个进程(或线程)，尤其在图形界面环境中，即使是单核机器。其中最重要的部分叫做 先占式多任务处理(preemptive multitasking), 这里 <strong>先占(preemption)</strong> 是这样一种能力: 中断一个任务，切换到另一个任务，稍后再恢复先前中断的任务。</p>\n<p>所以，如果你电脑的cpu只有一个核心，操作系统的职责之一就是将单核的运算能力分拆给多个进程(或线程)，让它们循环地相继执行。这给了我们一种假象，以为有多个程序在并行运行或者一个程序同时做着多件事情(多线程情况下)。这样并发便实现了，但 <em>真正的并行</em> – 同一时间跑多个进程的能力 – 仍然是缺失的。</p>\n<p>时至今日，现代cpu的核心通常不只一个，每个核心都能独立的一次执行一个操作。这意味着，有了多核心，真实的并行有了可能。比如，我自己的 Intel Core i7 有4个核心：它在同一时刻能跑4个不同的进程(或线程)。</p>\n<p>操作系统能监测到cpu的核心数并给它们分配进程或线程。线程可能被分配到任意一个核心上，而且这种调度对于程序是透明的。先占式多任务机制在所有核心都繁忙时也可能介入。这使得计算机有能力执行比核心数更多的进程和线程。</p>\n<h3 id=\"多线程应用在单核机器上：有意义吗？\"><a href=\"#多线程应用在单核机器上：有意义吗？\" class=\"headerlink\" title=\"多线程应用在单核机器上：有意义吗？\"></a>多线程应用在单核机器上：有意义吗？</h3><p>单核机器无法实现真正的并行。不过单核机器上的多线程仍然是有意义的，如果你的程序能够受益的话。当一个进程用到了多线程时，先占式多任务机制可以使你的程序正常的运行，即使某一个线程很慢或者阻塞了。</p>\n<p>比如，你在用一个桌面应用从一个慢速硬盘上读取数据。如果该桌面应用只有一个线程，在读取操作结束前，整个程序都是卡住的：在等待硬盘操作时，赋予该线程的cpu就浪费掉了。当然，除了这个程序外，操作系统还在跑着其它进程，但你在用的这个程序不会有任何进展(除了等待)。</p>\n<p>让我们以多线程方式重新思考这款程序。线程A负责访问硬盘，同时线程B负责处理用户界面。当因为硬盘读取速度慢导致线程A僵住时，线程B仍然管理着用户界面，程序不会丧失响应。这样做是可行的，因为有了2个线程后，当其中一个卡住后，操作系统可以将CPU资源切换给另一个线程使用。</p>\n<h2 id=\"线程越多，风险越多\"><a href=\"#线程越多，风险越多\" class=\"headerlink\" title=\"线程越多，风险越多\"></a>线程越多，风险越多</h2><p>上面谈到，线程和其所在进程共享内存。这使得在一个应用内线程间交换数据变得极其简单。例如，视频编辑器占有了包含视频时间线的内存区域，这片内存又被一些工作线程读取并渲染到文件中。它们只需要一个把手或指针(pointer)指向那个区域，就能够读取它的内容并写入磁盘。</p>\n<p>一切都很顺利，只要两个或多个线程只是从同一内存进行读取操作。问题发生在当有至少一个线程往共享内存执行写入操作而同时有其它线程在读取时。此时可能发生2类问题：</p>\n<ul>\n<li>数据竞争(data race) – 写线程在修改数据时，读线程在执行读入操作。如果写线程还未完成操作，读线程获取的是脏数据。</li>\n<li>竞态条件 – 读线程只应该在写线程写完后执行读取操作。如果不是这样会怎样？比数据竞争更微妙，竞态条件是关于两个或多个线程以不可预测的顺序执行任务，而实际上这些任务要以特定的顺序执行。即使没有数据竞争，程序也可能出现竞态条件。</li>\n</ul>\n<h3 id=\"线程安全的概念\"><a href=\"#线程安全的概念\" class=\"headerlink\" title=\"线程安全的概念\"></a>线程安全的概念</h3><p>没有数据竞争和竞态条件的代码被认为是线程安全的(thread-safe), 即使有多个线程同时执行的情况下。你可能注意过，一些程序库声明自己是线程安全的。如果你在写多线程程序，你会想知道第三方函数在多个线程中执行是否会导致并发问题。</p>\n<h2 id=\"数据竞争的根由\"><a href=\"#数据竞争的根由\" class=\"headerlink\" title=\"数据竞争的根由\"></a>数据竞争的根由</h2><p>我们知道一个CPU核心一次只能执行一个机器指令。这样的指令被称作原子的(atomic)，因为它不可再分了：它无法被分成多个更小的操作。在希腊语中，单词<strong>atom(ἄτομος; atomos)</strong>意即 不可切分的(uncuttable)</p>\n<p>不可切分的特点使得原子操作天生线程安全。一个线程对共享数据进行原子写操作时，操作结束前没有其它线程能读取到该次修改。相反地，当一个线程对共享数据进行原子读操作时，它读到的是该时间点上的完整的数据。一个线程不可能溜进另一个线程的原子操作，因此数据竞争不会发生。</p>\n<p>坏消息是大部分操作都是非原子的。即使诸如<code>x=1</code>这样简单的赋值，在某些硬件上都可能涉及多个原子操作，让赋值操作整体上变成非原子的。所以如果一个线程读取x而另一个线程在对x赋值时，数据竞争便产生了。</p>\n<h2 id=\"竞态条件的根由\"><a href=\"#竞态条件的根由\" class=\"headerlink\" title=\"竞态条件的根由\"></a>竞态条件的根由</h2><p>先占式多任务处理让操作系统对线程管理有了完全的控制权：它可以根据更高级的调度算法，开始、结束或暂停线程。作为程序设计者的你无法控制代码执行的时间或顺序。实际上，像下面这样的代码我们无法保证它们的执行顺序：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">writer_thread.start()</span><br><span class=\"line\">reader_thread.start()</span><br></pre></td></tr></table></figure>\n\n<p>将上述代码执行多次，你会注意到每次表现可能都不一样：有时写线程先开始，有时读线程先开始。如果你的程序需要让写线程跑在读线程前面，你就会遇到竞态条件的问题。</p>\n<p>这类行为被称作 非确定性的(non-deterministic)：结果每次都会变，而且你无法预测。调试受竞态条件影响的程序是烦人的，因为你无法以一种可控的方式重现问题。</p>\n<h2 id=\"让线程们和谐相处-并发控制\"><a href=\"#让线程们和谐相处-并发控制\" class=\"headerlink\" title=\"让线程们和谐相处: 并发控制\"></a>让线程们和谐相处: 并发控制</h2><p>数据竞争和竞态条件都是现实世界中的问题：一些人甚至因为它而丧命(见:<a href=\"https://en.wikipedia.org/wiki/Therac-25)。调节两个或多个并发线程的手段叫并发控制\" target=\"_blank\" rel=\"noopener\">https://en.wikipedia.org/wiki/Therac-25)。调节两个或多个并发线程的手段叫并发控制</a>(concurrency control)：操作系统和编程语言都提供了一些方案。其中最重要的有：</p>\n<ul>\n<li>同步化(synchronization) – 用来确保资源一次只会被一个线程使用。同步即是把代码的一部分标记为<em>受保护的</em>，这样一来，多个线程不能同时执行它，也就不会搞乱共享的数据了。</li>\n<li>原子操作(atomic operations) – 操作系统提供了一些特殊的指令，可以把一组非原子操作(像之前提及的赋值操作)转换成原子操作。这样，共享的数据总是处于有效状态，不管其它线程怎么访问。</li>\n<li>不可变数据(immutable data) – 把共享数据标记为不可变的，这样没有什么可以修改它：线程只允许读取，从根源上把问题解决了。上面说过，只要没有修改，多个线程就能安全的从共享内存读取数据。这也是函数式编程(functional programming) 背后的哲学。</li>\n</ul>\n<p>所有这些迷人的话题，在后续的有关并发的系列文章中都会提到。请继续关注！</p>\n","categories":[{"name":"翻译","slug":"翻译","permalink":"chunlife.top/categories/翻译/"}],"tags":[{"name":"翻译","slug":"翻译","permalink":"chunlife.top/tags/翻译/"},{"name":"多进程","slug":"多进程","permalink":"chunlife.top/tags/多进程/"}]},{"title":"面试相关题一","date":"2019-04-25T02:22:20.000Z","path":"2019/04/25/面试相关题一/","content":"<h2 id=\"1、cap-map-是否正确-请说明理由\"><a href=\"#1、cap-map-是否正确-请说明理由\" class=\"headerlink\" title=\"1、cap(map) 是否正确? 请说明理由\"></a>1、cap(map) 是否正确? 请说明理由</h2><p>不正确，cap是获取slice底层结构中容量（cap）的值，而在go中map结构并没有直接获取长度的函数，若需要获取则只能通过range关键字。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"2、a-make-int-5-20\"><a href=\"#2、a-make-int-5-20\" class=\"headerlink\" title=\"2、a := make([]int, 5, 20)\"></a>2、a := make([]int, 5, 20)</h2><p>fmt.Println(a[6]) </p>\n<p>fmt.Println(a[6:10]) </p>\n<p>编译通过，运行出错。数组越界，此slice是一个长度为5，容量为20的slice，而程序访问到了长度之外的数据。</p>\n<h2 id=\"3、列出-golang-的所有数据类型\"><a href=\"#3、列出-golang-的所有数据类型\" class=\"headerlink\" title=\"3、列出 golang 的所有数据类型\"></a>3、列出 golang 的所有数据类型</h2><p>这道题。。。。。。</p>\n<p>bool，</p>\n<p>数字类型（整型 int 和浮点型 float32、float64，Go 语言支持整型和浮点型数字），</p>\n<p>字符串类型，</p>\n<p>派生类型</p>\n<ul>\n<li>(a) 指针类型（Pointer）</li>\n<li>(b) 数组类型</li>\n<li>(c) 结构化类型(struct)</li>\n<li>(d) Channel 类型</li>\n<li>(e) 函数类型</li>\n<li>(f) 切片类型</li>\n<li>(g) 接口类型（interface）</li>\n<li>(h) Map 类型</li>\n</ul>\n<h2 id=\"4、所有数据类型定义时候的默认值\"><a href=\"#4、所有数据类型定义时候的默认值\" class=\"headerlink\" title=\"4、所有数据类型定义时候的默认值\"></a>4、所有数据类型定义时候的默认值</h2><p>bool为false，int为0，slice，map为nil</p>\n<h2 id=\"5、函数接受者问题\"><a href=\"#5、函数接受者问题\" class=\"headerlink\" title=\"5、函数接受者问题\"></a>5、函数接受者问题</h2><p>哪个无法运行？为什么？如果能运行，使用什么方法能区别出来？或者说如何能使其中看起来不正确的使它不要运行？</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> A <span class=\"keyword\">struct</span> &#123;&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(a A)</span> <span class=\"title\">m</span><span class=\"params\">()</span></span> &#123; </span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"func m...\"</span>) </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(a *A)</span> <span class=\"title\">n</span><span class=\"params\">()</span></span> &#123; </span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"func n...\"</span>) </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\">ao := A&#123;&#125; </span><br><span class=\"line\">ao.m() </span><br><span class=\"line\">ao.n() </span><br><span class=\"line\"></span><br><span class=\"line\">ap := &amp;A&#123;&#125; </span><br><span class=\"line\">ap.m() </span><br><span class=\"line\">ap.n()</span><br></pre></td></tr></table></figure>\n\n<p>实际运行，上下两种情况均能顺利运行。</p>\n<p>这里区分的话，可以以修改receiver的值作为判断依据。</p>\n<h2 id=\"6、需要屏蔽-10-万个关键字，-写算法实现\"><a href=\"#6、需要屏蔽-10-万个关键字，-写算法实现\" class=\"headerlink\" title=\"6、需要屏蔽 10 万个关键字， 写算法实现?\"></a>6、需要屏蔽 10 万个关键字， 写算法实现?</h2><p>AC自动机（Aho-Corasick）。</p>\n<p>也可以使用<code>grep</code>。</p>\n<h2 id=\"7、Golang，empty-slice-与-nil-slice，json包如何应对？\"><a href=\"#7、Golang，empty-slice-与-nil-slice，json包如何应对？\" class=\"headerlink\" title=\"7、Golang，empty slice 与 nil slice，json包如何应对？\"></a>7、Golang，empty slice 与 nil slice，json包如何应对？</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> a []<span class=\"keyword\">int</span></span><br><span class=\"line\">b := []<span class=\"keyword\">int</span>&#123;&#125;</span><br><span class=\"line\">bytes, err := json.Marshal(a)</span><br><span class=\"line\">fmt.Println(<span class=\"keyword\">string</span>(bytes), err)</span><br><span class=\"line\"></span><br><span class=\"line\">bytes, err = json.Marshal(b)</span><br><span class=\"line\">fmt.Println(<span class=\"keyword\">string</span>(bytes), err)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// null &lt;nil&gt;</span></span><br><span class=\"line\"><span class=\"comment\">// [] &lt;nil&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8、空struct-的使用\"><a href=\"#8、空struct-的使用\" class=\"headerlink\" title=\"8、空struct{}的使用\"></a>8、空struct{}的使用</h2><p>空struct不占用内存，也就是说即使分配切片10000个空struct，也只是占用底层结构体的大小。</p>\n<p>用途一般是：chan struct{} 比如用来实现set: map[string]struct{}</p>\n<p>空struct相等的特性在1.6之后不支持了。</p>\n<h2 id=\"9、在Go语言中结构体是否能够比较？该如何比较两个结构体？\"><a href=\"#9、在Go语言中结构体是否能够比较？该如何比较两个结构体？\" class=\"headerlink\" title=\"9、在Go语言中结构体是否能够比较？该如何比较两个结构体？\"></a>9、在Go语言中结构体是否能够比较？该如何比较两个结构体？</h2><p>相同类型的结构体能够进行比较。利用字段标签和反射可以达到比较的目的。</p>\n<p>例如库：<a href=\"https://github.com/r3labs/diff\" target=\"_blank\" rel=\"noopener\">diff</a>。</p>\n<h2 id=\"10、range-关键字\"><a href=\"#10、range-关键字\" class=\"headerlink\" title=\"10、range 关键字\"></a>10、range 关键字</h2><p>大概是有这样一串代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">byteArr := []<span class=\"keyword\">byte</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> i, val := byteArr &#123;</span><br><span class=\"line\">    byteArr := <span class=\"built_in\">append</span>(byteArr, <span class=\"number\">1</span>, <span class=\"number\">2</span>)</span><br><span class=\"line\">    fmt.Println(i, val)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>问，程序是否会终止。</p>\n<p>答，会终止，循环三次，按原有的数据进行遍历。</p>\n<p>参考我之前的博客：<a href=\"https://chunlife.top/2018/10/22/slice理解/#Go-Range\">Go-Range</a></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"面试","slug":"面试","permalink":"chunlife.top/tags/面试/"}]},{"title":"docker Toolbox修改源","date":"2019-04-23T12:05:42.000Z","path":"2019/04/23/docker-Toolbox修改源/","content":"<p>最近尝试部署一些环境进行测试，使用docker可以很方便的搭建一下环境，而且可以现在都是使用docker进行现代化部署的，按理说，我是不能这么落后，连摸都不摸一下的。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"安装docker\"><a href=\"#安装docker\" class=\"headerlink\" title=\"安装docker\"></a>安装docker</h2><p>使用阿里云的地址下载：<a href=\"http://mirrors.aliyun.com/docker-toolbox/windows/\" target=\"_blank\" rel=\"noopener\">阿里</a>。</p>\n<p>win 7、win 8 等需要利用 docker toolbox 来安装；win 10使用<code>docker-for-windows</code>。</p>\n<p>windows下安装是极其方便，基本就是一路next，没有需要配置的地方。</p>\n<p>需要的是安装好后的换源。</p>\n<h2 id=\"换源\"><a href=\"#换源\" class=\"headerlink\" title=\"换源\"></a>换源</h2><p>这里的源使用<a href=\"https://www.daocloud.io/mirror\" target=\"_blank\" rel=\"noopener\">daocloud</a>家的，点击链接，在网页底部可以找到。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span> docker-machine ssh default</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> sudo vi /var/lib/boot2docker/profile</span><br><span class=\"line\"></span><br><span class=\"line\">然后在--label provider=virtualbox的下一行添加--registry-mirror=加速地址</span><br><span class=\"line\">// 保存并退出</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> docker-machine restart default </span><br><span class=\"line\"></span><br><span class=\"line\">// 使用docker info 即可查看设置的源</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"练习\"><a href=\"#练习\" class=\"headerlink\" title=\"练习\"></a>练习</h2><p><a href=\"https://blog.csdn.net/Sicily_winner/article/details/86704459\" target=\"_blank\" rel=\"noopener\">Docker虚拟机入门（二）–2.2 创建MySQL集群</a></p>\n<h2 id=\"使用到的命令\"><a href=\"#使用到的命令\" class=\"headerlink\" title=\"使用到的命令\"></a>使用到的命令</h2><blockquote>\n<p>OneNote 视图很方便即可从图片copy文字。</p>\n</blockquote>\n<p><img src=\"../Go%E6%89%93%E5%8D%B0%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84field/1556022754446.png\" alt=\"test\"></p>\n","categories":[{"name":"docker","slug":"docker","permalink":"chunlife.top/categories/docker/"}],"tags":[{"name":"docker","slug":"docker","permalink":"chunlife.top/tags/docker/"}]},{"title":"golang面试题","date":"2019-04-16T07:52:06.000Z","path":"2019/04/16/golang面试题/","content":"<p>暂时废弃，未补充。</p>\n<p>收集碰到的一些题目：</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> People <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\tShow()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Student <span class=\"keyword\">struct</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(stu *Student)</span> <span class=\"title\">Show</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">live</span><span class=\"params\">()</span> <span class=\"title\">People</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> stu *Student</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> stu == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"123\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> stu</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> live() == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"AAAAAAA\"</span>)</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"BBBBBBB\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// output :</span></span><br><span class=\"line\"><span class=\"comment\">// 123</span></span><br><span class=\"line\"><span class=\"comment\">// BBBBBBB</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ti := GetValue()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> i.(<span class=\"keyword\">type</span>) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"keyword\">int</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"int\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"keyword\">string</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"string\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"keyword\">interface</span>&#123;&#125;:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"interface\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">println</span>(<span class=\"string\">\"unknown\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetValue</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">// 会报错 cannot type switch on non-interface value i (type int)</span></span><br><span class=\"line\"><span class=\"comment\">// func GetValue() int 更换成 func GetValue() interface&#123;&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"是否可以编译通过？如果通过，输出什么？\"><a href=\"#是否可以编译通过？如果通过，输出什么？\" class=\"headerlink\" title=\"是否可以编译通过？如果通过，输出什么？\"></a>是否可以编译通过？如果通过，输出什么？</h2><p><code>list</code>类型是<code>*[]int</code>，append要求的第一个参数是<code>slice []Type</code>。</p>\n<p>编译会失败 59.175.182.99</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlist := <span class=\"built_in\">new</span>([]<span class=\"keyword\">int</span>)</span><br><span class=\"line\">\tlist = <span class=\"built_in\">append</span>(list, <span class=\"number\">1</span>)</span><br><span class=\"line\">\tfmt.Println(list)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<p>可以编译通过，打印<code>0 1 zz zz 4</code>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tx = <span class=\"literal\">iota</span></span><br><span class=\"line\">\ty</span><br><span class=\"line\">\tz = <span class=\"string\">\"zz\"</span></span><br><span class=\"line\">\tk</span><br><span class=\"line\">\tp = <span class=\"literal\">iota</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tfmt.Println(x,y,z,k,p)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"面试","slug":"面试","permalink":"chunlife.top/tags/面试/"}]},{"title":"分布式定时任务控制","date":"2019-04-10T11:27:18.000Z","path":"2019/04/10/分布式定时任务控制/","content":"<p><a href=\"https://github.com/younglifestyle/goexamples/tree/master/cronPro\" target=\"_blank\" rel=\"noopener\">cronPro</a>，实现分布式定时任务，配合etcd进行应用分布式程序设计。</p>\n<ul>\n<li>分布式部署；</li>\n<li>etcd配置中心设置；</li>\n<li>worker超时设置。</li>\n</ul>\n<a id=\"more\"></a>\n\n","categories":[{"name":"项目","slug":"项目","permalink":"chunlife.top/categories/项目/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"}]},{"title":"golang iota枚举的例子","date":"2019-04-10T07:52:16.000Z","path":"2019/04/10/golang iota枚举的例子/","content":"<p>Go语言中没有枚举这个关键字，这会让人很不解，突然想用到的时候，会觉得很不适应。我不用不代表不要有，这可能是Go语言开发的取舍问题，追求精简，去掉不值得的地方。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"缘起\"><a href=\"#缘起\" class=\"headerlink\" title=\"缘起\"></a>缘起</h2><p>在开源项目<code>BaiduPCS-Go</code>中，有这样的一个操作。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\t<span class=\"comment\">// B byte</span></span><br><span class=\"line\">\tB = (<span class=\"keyword\">int64</span>)(<span class=\"number\">1</span> &lt;&lt; (<span class=\"number\">10</span> * <span class=\"literal\">iota</span>))</span><br><span class=\"line\">\t<span class=\"comment\">// KB kilobyte</span></span><br><span class=\"line\">\tKB</span><br><span class=\"line\">\t<span class=\"comment\">// MB megabyte</span></span><br><span class=\"line\">\tMB</span><br><span class=\"line\">\t<span class=\"comment\">// GB gigabyte</span></span><br><span class=\"line\">\tGB</span><br><span class=\"line\">\t<span class=\"comment\">// TB terabyte</span></span><br><span class=\"line\">\tTB</span><br><span class=\"line\">\t<span class=\"comment\">// PB petabyte</span></span><br><span class=\"line\">\tPB</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n<p>从代码里头都可以猜到，<code>iota</code>这肯定是递增的，看定义，其初始值为<code>0</code>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"literal\">iota</span> <span class=\"keyword\">int</span> = <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n<p>具体对于<code>iota</code>的理解，可以参考：<a href=\"https://yourbasic.org/golang/iota/#complete-enum-type-with-strings-best-practice\" target=\"_blank\" rel=\"noopener\">4 iota enum examples</a>。</p>\n<h2 id=\"Iota基本的例子\"><a href=\"#Iota基本的例子\" class=\"headerlink\" title=\"Iota基本的例子\"></a>Iota基本的例子</h2><ul>\n<li><code>iota</code>关键字代表连续整数的常数0，1，2，…</li>\n<li>只要<code>const</code>出现在源代码中，它就会重置为0 ，</li>\n<li>并在每个<code>const</code>之后递增。</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">    C0 = <span class=\"literal\">iota</span></span><br><span class=\"line\">    C1 = <span class=\"literal\">iota</span></span><br><span class=\"line\">    C2 = <span class=\"literal\">iota</span></span><br><span class=\"line\">)</span><br><span class=\"line\">fmt.Println(C0, C1, C2) <span class=\"comment\">// \"0 1 2\"</span></span><br></pre></td></tr></table></figure>\n\n<p>这可以简化为</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tC0 = <span class=\"literal\">iota</span></span><br><span class=\"line\">\tC1</span><br><span class=\"line\">\tC2</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n<p>在这里，我们依赖于在带括号的<code>const</code>声明中隐式重复表达式的事实——表示前面的表达式及其类型的重复。</p>\n<h2 id=\"从一开始\"><a href=\"#从一开始\" class=\"headerlink\" title=\"从一开始\"></a>从一开始</h2><p>要以1而不是0开始常量列表，可以<code>iota</code>在算术表达式中使用。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">    C1 = <span class=\"literal\">iota</span> + <span class=\"number\">1</span></span><br><span class=\"line\">    C2</span><br><span class=\"line\">    C3</span><br><span class=\"line\">)</span><br><span class=\"line\">fmt.Println(C1, C2, C3) <span class=\"comment\">// \"1 2 3\"</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"跳过定义\"><a href=\"#跳过定义\" class=\"headerlink\" title=\"跳过定义\"></a>跳过定义</h2><p>您可以使用空白标识符跳过常量列表中的值。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">    C1 = <span class=\"literal\">iota</span> + <span class=\"number\">1</span></span><br><span class=\"line\">    _</span><br><span class=\"line\">    C3</span><br><span class=\"line\">    C4</span><br><span class=\"line\">)</span><br><span class=\"line\">fmt.Println(C1, C3, C4) <span class=\"comment\">// \"1 3 4\"</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"带字符串的完整枚举类型-最佳实践\"><a href=\"#带字符串的完整枚举类型-最佳实践\" class=\"headerlink\" title=\"带字符串的完整枚举类型[最佳实践]\"></a>带字符串的完整枚举类型[最佳实践]</h2><p>这是实现枚举类型的惯用方法：</p>\n<ul>\n<li>创建一个新的整数类型，</li>\n<li>列出其值，使用<code>iota</code>，</li>\n<li>给类型一个<code>String</code>函数。</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Direction <span class=\"keyword\">int</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">    North Direction = <span class=\"literal\">iota</span></span><br><span class=\"line\">    East</span><br><span class=\"line\">    South</span><br><span class=\"line\">    West</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(d Direction)</span> <span class=\"title\">String</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> [...]<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"North\"</span>, <span class=\"string\">\"East\"</span>, <span class=\"string\">\"South\"</span>, <span class=\"string\">\"West\"</span>&#125;[d]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Ex….</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> d Direction = North</span><br><span class=\"line\">fmt.Print(d)</span><br><span class=\"line\"><span class=\"keyword\">switch</span> d &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> North:</span><br><span class=\"line\">    \tfmt.Println(<span class=\"string\">\" goes up.\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> South:</span><br><span class=\"line\">    \tfmt.Println(<span class=\"string\">\" goes down.\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">    \tfmt.Println(<span class=\"string\">\" stays put.\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Output: North goes up.</span></span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"golang基础知识","slug":"golang基础知识","permalink":"chunlife.top/categories/golang基础知识/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"enum","slug":"enum","permalink":"chunlife.top/tags/enum/"}]},{"title":"服务器上传下载问题之分块上传（断点续传）","date":"2019-04-09T08:06:42.000Z","path":"2019/04/09/服务器上传下载问题之分块上传（断点续传）/","content":"<p>在之前的博客中，对服务器的上传下载就写过一些备忘，当时项目是对文件进行操作，涉及到一些网络文件的基础操作，由于没得网络存储，也就是依靠云的磁盘来存储数据文件。</p>\n<p>这里记录一下分块上传，也就是断点续传的实现。</p>\n<a id=\"more\"></a>\n\n<p>大概可以分为三个步骤：</p>\n<ol>\n<li>尝试秒传接口；</li>\n<li>初始化分块上传信息；</li>\n<li>客户端开始进行分块上传；</li>\n<li>客户端通知服务器完成分块，服务器进行分块合并操作。</li>\n</ol>\n<h1 id=\"分块上传\"><a href=\"#分块上传\" class=\"headerlink\" title=\"分块上传\"></a>分块上传</h1><h2 id=\"1、尝试秒传\"><a href=\"#1、尝试秒传\" class=\"headerlink\" title=\"1、尝试秒传\"></a>1、尝试秒传</h2><p>秒传是利用文件的哈希值，来对文件进行唯一值匹配，若能够匹配成功，则说明文件已被上传，只需要插入下mysql里面的数据即可，这也就是秒传的意思。</p>\n<p>这里在实现秒传时，在开源项目<code>BaiduPCS-Go</code>中，是需要：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">\"path\"</span>:           targetPath,                    <span class=\"comment\">// 上传文件的全路径名</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"content-length\"</span>: strconv.FormatInt(length, <span class=\"number\">10</span>), <span class=\"comment\">// 待秒传的文件长度</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"content-md5\"</span>:    contentMD5,                    <span class=\"comment\">// 待秒传的文件的MD5</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"slice-md5\"</span>:      sliceMD5,                      <span class=\"comment\">// 待秒传的文件前256kb的MD5</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"content-crc32\"</span>:  crc32,                         <span class=\"comment\">// 待秒传文件CRC32</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"ondup\"</span>:          <span class=\"string\">\"overwrite\"</span>,                   <span class=\"comment\">// overwrite: 表示覆盖同名文件; newcopy: 表示生成文件副本并进行重命名，命名规则为“文件名_日期.后缀”</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>不过在<code>github.com/iikira/BaiduPCS-Go/blob/master/pcsutil/checksum/checksum.go</code>文件中：</p>\n<p>作者表示，这个<code>前256kb的MD5</code>和<code>CRC32</code>不是必须。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 314行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 文件大于256kb, 应该要检测秒传, 反之则不应检测秒传</span></span><br><span class=\"line\"><span class=\"comment\">// 经测试, 秒传文件并非一定要大于256KB</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> task.uploadInfo.Length &gt;= requiredSliceSize &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// do nothing</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 经过测试, 秒传文件并非需要前256kb切片的md5值, 只需格式符合即可</span></span><br><span class=\"line\">task.uploadInfo.SliceMD5Sum()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 经测试, 文件的 crc32 值并非秒传文件所必需</span></span><br><span class=\"line\"><span class=\"comment\">// task.uploadInfo.Crc32Sum()</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2、初始化分块上传信息\"><a href=\"#2、初始化分块上传信息\" class=\"headerlink\" title=\"2、初始化分块上传信息\"></a>2、初始化分块上传信息</h2><p>当客户端需要上传文件时，首先会向服务端一个接口传递文件信息，这里我们可以获取：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* @apiParam filehash  string\t文件计算的哈希计算值</span><br><span class=\"line\">* @apiParam filesize  int\t    文件大小</span><br></pre></td></tr></table></figure>\n\n<p>在这步操作中，我们需要填充这个结构体。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> MultipleUploadInfo <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tFileHash   <span class=\"keyword\">string</span></span><br><span class=\"line\">\tFileSize   <span class=\"keyword\">int</span></span><br><span class=\"line\">\tUploadID   <span class=\"keyword\">string</span></span><br><span class=\"line\">\tChunkSize  <span class=\"keyword\">int</span></span><br><span class=\"line\">\tChunkCount <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>例如：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upInfo := &amp;MultipartUploadInfo&#123;</span><br><span class=\"line\">    FileHash:   filehash,</span><br><span class=\"line\">    FileSize:   filesize,</span><br><span class=\"line\">    <span class=\"comment\">// UploadID，我在代码里面是使用的函数NewObjectId()，也就是MongoDB的ID生成方式，这个我在之前的博客中也做了备忘。</span></span><br><span class=\"line\">    UploadID:   username + fmt.Sprintf(<span class=\"string\">\"%x\"</span>, time.Now().UnixNano()),</span><br><span class=\"line\">    ChunkSize:  <span class=\"number\">5</span> &lt;&lt; <span class=\"number\">10</span> &lt;&lt; <span class=\"number\">10</span>, <span class=\"comment\">// 5MB</span></span><br><span class=\"line\">    <span class=\"comment\">// 5MB 为一个分块，可以根据服务器性能适当调整</span></span><br><span class=\"line\">    ChunkCount: <span class=\"keyword\">int</span>(math.Ceil(<span class=\"keyword\">float64</span>(filesize) / (<span class=\"number\">5</span> &lt;&lt; <span class=\"number\">10</span> &lt;&lt; <span class=\"number\">10</span>))),</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>然后需要将这个数据保存下来，因为在后面的使用中需要使用到。</p>\n<p>可以存储在内存中，使用<code>map</code>进行管理（我之前是使用这种方式，所以<code>UploadID</code>我得保持唯一），同样的也可以使用<code>Redis</code>、<code>Memcached</code>，我这里使用到了<code>Map</code>，项目里头有变化。</p>\n<p>此结构体需要返回给客户端。</p>\n<h2 id=\"3、分块上传\"><a href=\"#3、分块上传\" class=\"headerlink\" title=\"3、分块上传\"></a>3、分块上传</h2><p>客户端按照分块上传信息，分块读取文件流上传给服务端，按照<code>ChunkSize</code>进行读取。</p>\n<p>上传时，附带上此次上传的<code>Chunk</code>次数。</p>\n<p>服务器将这些数据保存在一个临时目录下，按先后<code>Chunk</code>顺序进行命名，方便合并时使用。</p>\n<p>服务器同时也需要记录该<code>UploadID</code>上传的<code>Chunk</code>次数</p>\n<h2 id=\"4、合并\"><a href=\"#4、合并\" class=\"headerlink\" title=\"4、合并\"></a>4、合并</h2><p>客户端上传完成后，请求该接口（当然，也可以服务器每次接受分块都去检查分块是否已经上传完了，或者是客户端在最后一次上传时，告知服务器这是最后一次上传，这里为了拆开逻辑，故分开接口）。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 1、验证ChunkCount是否匹配；</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 2、验证分块文件是否对的上ChunkCount；</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 3、新建一个文件，将各个分块文件，以追加的方式写入文件，不需要一次性读取到内存，使用io.copy()；</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 4、上传都完成后，将文件信息保存到MySQL中。</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"断点续传-断点下载\"><a href=\"#断点续传-断点下载\" class=\"headerlink\" title=\"断点续传/断点下载\"></a>断点续传/断点下载</h1><p>这两者可以说都是上面那个过程，操作都是类似的，没有什么不一样，同样是控制分块信息，控制分块上传与下载，即使中间终端，也可以重新确认信息后接上上一次中断的过程继续开始操作。</p>\n<p>这里我偷懒没有将代码拿出来进行展示，这里仅展示逻辑了。</p>\n<h1 id=\"记录代码\"><a href=\"#记录代码\" class=\"headerlink\" title=\"记录代码\"></a>记录代码</h1><p><code>github.com/iikira/BaiduPCS-Go/blob/master/pcsutil/checksum/checksum.go</code></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Package checksum 校验本地文件包</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> checksum</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"crypto/md5\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/iikira/BaiduPCS-Go/pcsutil/converter\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"hash\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"hash/crc32\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"io\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"os\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tdefaultBufSize = <span class=\"number\">256</span> * converter.KB</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> (</span><br><span class=\"line\">\t<span class=\"comment\">// LocalFileMeta 本地文件元信息</span></span><br><span class=\"line\">\tLocalFileMeta <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tPath     <span class=\"keyword\">string</span> <span class=\"string\">`json:\"path\"`</span>     <span class=\"comment\">// 本地路径</span></span><br><span class=\"line\">\t\tLength   <span class=\"keyword\">int64</span>  <span class=\"string\">`json:\"length\"`</span>   <span class=\"comment\">// 文件大小</span></span><br><span class=\"line\">\t\tSliceMD5 []<span class=\"keyword\">byte</span> <span class=\"string\">`json:\"slicemd5\"`</span> <span class=\"comment\">// 文件前 requiredSliceLen (256KB) 切片的 md5 值</span></span><br><span class=\"line\">\t\tMD5      []<span class=\"keyword\">byte</span> <span class=\"string\">`json:\"md5\"`</span>      <span class=\"comment\">// 文件的 md5</span></span><br><span class=\"line\">\t\tCRC32    <span class=\"keyword\">uint32</span> <span class=\"string\">`json:\"crc32\"`</span>    <span class=\"comment\">// 文件的 crc32</span></span><br><span class=\"line\">\t\tModTime  <span class=\"keyword\">int64</span>  <span class=\"string\">`json:\"modtime\"`</span>  <span class=\"comment\">// 修改日期</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// LocalFileInfo LocalFile</span></span><br><span class=\"line\">\tLocalFile <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tLocalFileMeta</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbufSize <span class=\"keyword\">int</span></span><br><span class=\"line\">\t\tbuf     []<span class=\"keyword\">byte</span></span><br><span class=\"line\">\t\tFile    *os.File <span class=\"comment\">// 文件</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// SumConfig 计算文件摘要值配置</span></span><br><span class=\"line\">\tSumConfig <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tIsMD5Sum      <span class=\"keyword\">bool</span></span><br><span class=\"line\">\t\tIsSliceMD5Sum <span class=\"keyword\">bool</span></span><br><span class=\"line\">\t\tIsCRC32Sum    <span class=\"keyword\">bool</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewLocalFileInfo</span><span class=\"params\">(localPath <span class=\"keyword\">string</span>, bufSize <span class=\"keyword\">int</span>)</span> *<span class=\"title\">LocalFile</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;LocalFile&#123;</span><br><span class=\"line\">\t\tLocalFileMeta: LocalFileMeta&#123;</span><br><span class=\"line\">\t\t\tPath: localPath,</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\tbufSize: bufSize,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// OpenPath 检查文件状态并获取文件的大小 (Length)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">OpenPath</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> lf.File != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlf.File.Close()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> err error</span><br><span class=\"line\">\tlf.File, err = os.Open(lf.Path)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinfo, err := lf.File.Stat()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlf.Length = info.Size()</span><br><span class=\"line\">\tlf.ModTime = info.ModTime().Unix()</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Close 关闭文件</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">Close</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> lf.File == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> fmt.Errorf(<span class=\"string\">\"file is nil\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> lf.File.Close()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">initBuf</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> lf.buf == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> lf.bufSize != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tlf.buf = <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, lf.bufSize)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tlf.buf = <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, defaultBufSize)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">repeatRead</span><span class=\"params\">(ws ...io.Writer)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> lf.File == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlf.initBuf()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> (</span><br><span class=\"line\">\t\tbegin <span class=\"keyword\">int64</span></span><br><span class=\"line\">\t\tn     <span class=\"keyword\">int</span></span><br><span class=\"line\">\t\terr   error</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\thandle := <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\tbegin += <span class=\"keyword\">int64</span>(n)</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> k := <span class=\"keyword\">range</span> ws &#123;</span><br><span class=\"line\">\t\t\tws[k].Write(lf.buf[:n])</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 读文件</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tn, err = lf.File.ReadAt(lf.buf, begin)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err == io.EOF &#123;</span><br><span class=\"line\">\t\t\t\thandle()</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tfmt.Printf(<span class=\"string\">\"%s\\n\"</span>, err)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\thandle()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Sum 计算文件摘要值</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">Sum</span><span class=\"params\">(cfg SumConfig)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> (</span><br><span class=\"line\">\t\tmd5w   hash.Hash</span><br><span class=\"line\">\t\tcrc32w hash.Hash32</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\tws := <span class=\"built_in\">make</span>([]io.Writer, <span class=\"number\">0</span>, <span class=\"number\">2</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> cfg.IsMD5Sum &#123;</span><br><span class=\"line\">\t\tmd5w = md5.New()</span><br><span class=\"line\">\t\tws = <span class=\"built_in\">append</span>(ws, md5w)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> cfg.IsCRC32Sum &#123;</span><br><span class=\"line\">\t\tcrc32w = crc32.NewIEEE()</span><br><span class=\"line\">\t\tws = <span class=\"built_in\">append</span>(ws, crc32w)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> cfg.IsSliceMD5Sum &#123;</span><br><span class=\"line\">\t\tlf.SliceMD5Sum()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlf.repeatRead(ws...)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> cfg.IsMD5Sum &#123;</span><br><span class=\"line\">\t\tlf.MD5 = md5w.Sum(<span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> cfg.IsCRC32Sum &#123;</span><br><span class=\"line\">\t\tlf.CRC32 = crc32w.Sum32()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Md5Sum 获取文件的 md5 值</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">Md5Sum</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlf.Sum(SumConfig&#123;</span><br><span class=\"line\">\t\tIsMD5Sum: <span class=\"literal\">true</span>,</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SliceMD5Sum 获取文件前 requiredSliceLen (256KB) 切片的 md5 值</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">SliceMD5Sum</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> lf.File == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 获取前 256KB 文件切片的 md5</span></span><br><span class=\"line\">\tlf.initBuf()</span><br><span class=\"line\"></span><br><span class=\"line\">\tm := md5.New()</span><br><span class=\"line\">\tn, err := lf.File.ReadAt(lf.buf, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err == io.EOF &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">goto</span> md5sum</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tfmt.Printf(<span class=\"string\">\"SliceMD5Sum: %s\\n\"</span>, err)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">md5sum:</span><br><span class=\"line\">\tm.Write(lf.buf[:n])</span><br><span class=\"line\">\tlf.SliceMD5 = m.Sum(<span class=\"literal\">nil</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Crc32Sum 获取文件的 crc32 值</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lf *LocalFile)</span> <span class=\"title\">Crc32Sum</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlf.Sum(SumConfig&#123;</span><br><span class=\"line\">\t\tIsCRC32Sum: <span class=\"literal\">true</span>,</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>github.com/iikira/BaiduPCS-Go/blob/master/pcsutil/checksum/file.go</code></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> checksum</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"bytes\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"os\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"path/filepath\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// EqualLengthMD5 检测md5和大小是否相同</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lfm *LocalFileMeta)</span> <span class=\"title\">EqualLengthMD5</span><span class=\"params\">(m *LocalFileMeta)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> lfm.Length != m.Length &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> bytes.Compare(lfm.MD5, m.MD5) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// CompleteAbsPath 补齐绝对路径</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(lfm *LocalFileMeta)</span> <span class=\"title\">CompleteAbsPath</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> filepath.IsAbs(lfm.Path) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tabsPath, err := filepath.Abs(lfm.Path)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlfm.Path = absPath</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// GetFileSum 获取文件的大小, md5, 前256KB切片的 md5, crc32</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetFileSum</span><span class=\"params\">(localPath <span class=\"keyword\">string</span>, cfg *SumConfig)</span> <span class=\"params\">(lf *LocalFile, err error)</span></span> &#123;</span><br><span class=\"line\">\tfile, err := os.Open(localPath)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> file.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfileStat, err := file.Stat()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> fileStat.IsDir() &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, fmt.Errorf(<span class=\"string\">\"sum %s: is a directory\"</span>, localPath)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlf = &amp;LocalFile&#123;</span><br><span class=\"line\">\t\tFile: file,</span><br><span class=\"line\">\t\tLocalFileMeta: LocalFileMeta&#123;</span><br><span class=\"line\">\t\t\tPath:   localPath,</span><br><span class=\"line\">\t\t\tLength: fileStat.Size(),</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlf.Sum(*cfg)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> lf, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"服务器","slug":"服务器","permalink":"chunlife.top/tags/服务器/"},{"name":"上传下载","slug":"上传下载","permalink":"chunlife.top/tags/上传下载/"}]},{"title":"etcd备份导出数据","date":"2019-04-08T09:20:40.000Z","path":"2019/04/08/etcd备份导出数据/","content":"<p>一般etcd是不需要手动导出数据的，毕竟使用etcd都是使用多节点，也就是说并不需要将数据导入其他节点，当然如果你需要将本机的etcd导入到其他etcd服务器上，使用<code>etcdctl</code>可进行备份和恢复。</p>\n<p>不过这里我们有个需求，在代码里头做一个备份的接口，比较的简单的，这里直接记录一下。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> EtcdStore <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tsync.RWMutex</span><br><span class=\"line\">\tprefix    <span class=\"keyword\">string</span></span><br><span class=\"line\">\trawClient *clientv3.Client</span><br><span class=\"line\">\tkv        clientv3.KV</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(e *EtcdStore)</span> <span class=\"title\">ConnectEtcd</span><span class=\"params\">(addr <span class=\"keyword\">string</span>)</span> <span class=\"params\">(err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 初始化配置</span></span><br><span class=\"line\">\tconfig := clientv3.Config&#123;</span><br><span class=\"line\">\t\tEndpoints:   []<span class=\"keyword\">string</span>&#123;addr&#125;,  <span class=\"comment\">// 集群地址</span></span><br><span class=\"line\">\t\tDialTimeout: time.Second * <span class=\"number\">2</span>, <span class=\"comment\">// 连接超时</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// 建立连接</span></span><br><span class=\"line\">\te.rawClient, err = clientv3.New(config)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\te.kv = clientv3.NewKV(e.rawClient)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(e *EtcdStore)</span> <span class=\"title\">SetPrefixPath</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">\te.prefix = path</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(e *EtcdStore)</span> <span class=\"title\">BackupTo</span><span class=\"params\">(to <span class=\"keyword\">string</span>)</span> <span class=\"params\">(err error)</span></span> &#123;</span><br><span class=\"line\">\te.Lock()</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> e.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 建立连接</span></span><br><span class=\"line\">\ttargetEtcdClient, err := clientv3.New(clientv3.Config&#123;</span><br><span class=\"line\">\t\tEndpoints:   []<span class=\"keyword\">string</span>&#123;to&#125;,    <span class=\"comment\">// 集群地址</span></span><br><span class=\"line\">\t\tDialTimeout: time.Second * <span class=\"number\">2</span>, <span class=\"comment\">// 连接超时</span></span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> targetEtcdClient.Close()</span><br><span class=\"line\">\tkv := clientv3.NewKV(targetEtcdClient)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// get一下`prefix`目录下的所有信息</span></span><br><span class=\"line\">\tgetResp, err := e.kv.Get(context.TODO(),</span><br><span class=\"line\">\t\te.prefix, clientv3.WithPrefix())</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, kvpair := <span class=\"keyword\">range</span> getResp.Kvs &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"keyword\">string</span>(kvpair.Key), <span class=\"keyword\">string</span>(kvpair.Value))</span><br><span class=\"line\">\t\t<span class=\"comment\">// 创建Op: operation  对操作的抽象</span></span><br><span class=\"line\">\t\tputOp := clientv3.OpPut(<span class=\"keyword\">string</span>(kvpair.Key), <span class=\"keyword\">string</span>(kvpair.Value))</span><br><span class=\"line\">\t\t<span class=\"comment\">// 执行OP</span></span><br><span class=\"line\">\t\topResp, err := kv.Do(context.TODO(), putOp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(err, opResp.Put().Header.Revision)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 提取路径， /backup/test/1  取出`1`</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">ExtractPrefix</span><span class=\"params\">(regKey, prefix <span class=\"keyword\">string</span>)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> strings.TrimPrefix(regKey, prefix)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(e *EtcdStore)</span> <span class=\"title\">BackupToSpecifyDir</span><span class=\"params\">(toAddr, newPrefix <span class=\"keyword\">string</span>)</span> <span class=\"params\">(err error)</span></span> &#123;</span><br><span class=\"line\">\te.Lock()</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> e.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 建立连接</span></span><br><span class=\"line\">\ttargetEtcdClient, err := clientv3.New(clientv3.Config&#123;</span><br><span class=\"line\">\t\tEndpoints:   []<span class=\"keyword\">string</span>&#123;toAddr&#125;, <span class=\"comment\">// 集群地址</span></span><br><span class=\"line\">\t\tDialTimeout: time.Second * <span class=\"number\">2</span>,  <span class=\"comment\">// 连接超时</span></span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> targetEtcdClient.Close()</span><br><span class=\"line\">\tkv := clientv3.NewKV(targetEtcdClient)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// get一下`prefix`目录下的所有信息</span></span><br><span class=\"line\">\tgetResp, err := e.kv.Get(context.TODO(),</span><br><span class=\"line\">\t\te.prefix, clientv3.WithPrefix())</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, kvpair := <span class=\"keyword\">range</span> getResp.Kvs &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"keyword\">string</span>(kvpair.Key), <span class=\"keyword\">string</span>(kvpair.Value))</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// 重组路径</span></span><br><span class=\"line\">\t\tnewEtcdPath := path.Join(newPrefix, ExtractPrefix(<span class=\"keyword\">string</span>(kvpair.Key), e.prefix))</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// 创建Op: operation  对操作的抽象</span></span><br><span class=\"line\">\t\tputOp := clientv3.OpPut(newEtcdPath, <span class=\"keyword\">string</span>(kvpair.Value))</span><br><span class=\"line\">\t\t<span class=\"comment\">// 执行OP</span></span><br><span class=\"line\">\t\topResp, err := kv.Do(context.TODO(), putOp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(err, opResp.Put().Header.Revision)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"etcd","slug":"etcd","permalink":"chunlife.top/categories/etcd/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"etcd备份","slug":"etcd备份","permalink":"chunlife.top/tags/etcd备份/"}]},{"title":"golang获取目录下的文件","date":"2019-04-08T08:52:20.000Z","path":"2019/04/08/golang获取目录下的文件/","content":"<p>获取目录下的文件或子目录下的文件。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"一、遍历目录，以及子目录。\"><a href=\"#一、遍历目录，以及子目录。\" class=\"headerlink\" title=\"一、遍历目录，以及子目录。\"></a>一、遍历目录，以及子目录。</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// WalkDir 获取指定目录及所有子目录下的所有文件，可以匹配后缀过滤。 找到第一个.exe文件就返回即可</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">WalkDir</span><span class=\"params\">(dirPth, suffix <span class=\"keyword\">string</span>)</span> <span class=\"params\">(files <span class=\"keyword\">string</span>, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//files = make([]string, 0, 30)</span></span><br><span class=\"line\">\tsuffix = strings.ToLower(suffix) <span class=\"comment\">//忽略后缀匹配的大小写</span></span><br><span class=\"line\"></span><br><span class=\"line\">\terr = filepath.Walk(dirPth, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(filename <span class=\"keyword\">string</span>, fi os.FileInfo, err error)</span> <span class=\"title\">error</span></span> &#123; <span class=\"comment\">//遍历目录</span></span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"file name :\"</span>, fi.Name())</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> files != <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> fi.IsDir() &#123; <span class=\"comment\">// 忽略目录</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> strings.HasSuffix(strings.ToLower(fi.Name()), suffix) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//files = append(files, filename)</span></span><br><span class=\"line\">\t\t\tfiles = filename</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> files, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"二、遍历目录下的文件列表\"><a href=\"#二、遍历目录下的文件列表\" class=\"headerlink\" title=\"二、遍历目录下的文件列表\"></a>二、遍历目录下的文件列表</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">listAll</span><span class=\"params\">(path <span class=\"keyword\">string</span>, suffix <span class=\"keyword\">string</span>)</span> <span class=\"params\">(fileTarget <span class=\"keyword\">string</span>, err error)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// 获取该路径下的文件列表，并不会像Walk一样遍历子目录</span></span><br><span class=\"line\">   files, err := ioutil.ReadDir(path)</span><br><span class=\"line\">   <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, err</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">for</span> _, fi := <span class=\"keyword\">range</span> files &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> fi.IsDir() &#123;</span><br><span class=\"line\">         <span class=\"comment\">// 目录则直接跳过</span></span><br><span class=\"line\">         <span class=\"keyword\">continue</span></span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> strings.HasSuffix(strings.ToLower(fi.Name()), suffix) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//files = append(files, filename)</span></span><br><span class=\"line\">            fileTarget = filepath.Join(path, fi.Name())</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> fileTarget, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"file","slug":"file","permalink":"chunlife.top/tags/file/"}]},{"title":"Go按行读写文件","date":"2019-04-02T06:34:22.000Z","path":"2019/04/02/Go按行读写文件/","content":"<p>代码：</p>\n<a id=\"more\"></a>\n\n<p>按行写文件</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f, err := os.OpenFile(fileName,</span><br><span class=\"line\">os.O_WRONLY|os.O_CREATE|os.O_TRUNC, os.ModePerm)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">w := bufio.NewWriter(f)</span><br><span class=\"line\">fmt.Fprintln(w, fmt.Sprintf(<span class=\"string\">\"start analysis log at the %s \\r\\n\"</span>, <span class=\"string\">`\"`</span>+logFileDir+<span class=\"string\">`\"`</span>))</span><br><span class=\"line\">w.Flush()</span><br></pre></td></tr></table></figure>\n\n<p>按行读文件</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">buf := bufio.NewReader(file)</span><br><span class=\"line\"><span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\tline, err := buf.ReadString(<span class=\"string\">'\\n'</span>)</span><br><span class=\"line\">\tline = strings.TrimSpace(line)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err == io.EOF &#123; <span class=\"comment\">//读取结束，会报EOF</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"基础","slug":"基础","permalink":"chunlife.top/tags/基础/"},{"name":"读写文件","slug":"读写文件","permalink":"chunlife.top/tags/读写文件/"}]},{"title":"etcd分布式乐观锁","date":"2019-04-01T03:15:21.000Z","path":"2019/04/01/etcd分布式乐观锁/","content":"<p>在实际应用中，我们若需要分布式的操作，大多数时候并不需要通过手动实现分布式的协议，而可以借助分布式的应用的来实现分布式应用。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"etcd原理特性\"><a href=\"#etcd原理特性\" class=\"headerlink\" title=\"etcd原理特性\"></a>etcd原理特性</h2><p>etcd实现分布式一致性性，使用到了Raft协议。</p>\n<blockquote>\n<p><a href=\"https://github.com/aCoder2013/blog/issues/30\" target=\"_blank\" rel=\"noopener\">Etcd Raft使用入门及原理解析</a></p>\n<p><strong>Raft</strong>是一个分布式一致性算法，充分的利用了可复制状态机以及日志。其最核心的设计目标就是易于理解。在性能、错误容错等方面来看有点类似<strong>Paxos</strong>，但不同之处在于，Raft论文较为清晰的描述了其主要流程以及其中一些细节问题，而Paxos我们知道非常难以理解。</p>\n<p>当构建一个分布式系统时，一个非常重要的设计目标就是<strong>fault tolerance</strong>。如果系统基于Raft协议实现，那么当其中一个节点挂掉，或者发生了网络分区等异常情况时，只要大多数节点仍然能够正常通讯，整个集群就能够正常对外提供服务而不会挂掉。</p>\n<p>Etcd raft基本上已经实现了Raft协议的完整特性，包括:</p>\n<ul>\n<li>Leader选举</li>\n<li>日志复制</li>\n<li>日志压缩</li>\n<li>成员变更</li>\n<li>Leader和Follower都支持高效的线性只读查询请求</li>\n<li>通过batch、pipeline等手段优化日志复制、网络IO的延迟</li>\n</ul>\n</blockquote>\n<h3 id=\"etcd的重要特性\"><a href=\"#etcd的重要特性\" class=\"headerlink\" title=\"etcd的重要特性\"></a>etcd的重要特性</h3><ul>\n<li>底层存储是按key有序排列的，可以顺序遍历</li>\n<li>因为key有序，所以etcd天然支持按目录结构高效遍历</li>\n<li>支持复杂事务，提供类似if · · then … else …的事务能力 </li>\n<li>基于租约机制实现key的TTL过期</li>\n</ul>\n<h3 id=\"etcd与Raft的关系\"><a href=\"#etcd与Raft的关系\" class=\"headerlink\" title=\"etcd与Raft的关系\"></a>etcd与Raft的关系</h3><ul>\n<li>Raft是强一致的集群日志同步算法</li>\n<li>etcd是一个分布式KV存储</li>\n<li>etcd利用raft算法在集群中同步key-value</li>\n</ul>\n<p>可以理解为Raft协议对日志进行管理，etcd对K/V进行管理。为什么会这么说呢，这里需要先了解一下大多数理论（<code>quorum</code>）。</p>\n<h2 id=\"quorum模型\"><a href=\"#quorum模型\" class=\"headerlink\" title=\"quorum模型\"></a>quorum模型</h2><p>分布式系统的设计中会涉及到许多的协议、机制用来解决可靠性问题、数据一致性问题等，quorum 机制就是其中的一种。</p>\n<h3 id=\"抽屉理论\"><a href=\"#抽屉理论\" class=\"headerlink\" title=\"抽屉理论\"></a>抽屉理论</h3><ul>\n<li>一个班级60人</li>\n<li>有一个秘密，告知给班里的31个人</li>\n<li>那么随便挑选31个人</li>\n<li>一定有1个人知道秘密</li>\n</ul>\n<p>抽屉理论是对<code>quorum</code>模型的理解，实际上<code>quorum</code>模型解析的就是这样的一个机制。</p>\n<h3 id=\"quorum模型-1\"><a href=\"#quorum模型-1\" class=\"headerlink\" title=\"quorum模型\"></a>quorum模型</h3><p>集群要出现大多数，那么就需要奇数个节点，一下为三个节点的实例。<img src=\"1554101624877.png\" alt=\"日志复制\"></p>\n<ul>\n<li>① 前端像etcd中写入数据，请求传递给leader；</li>\n<li>② leader节点将<code>写日志</code>传递给子节点，当其中一个<code>follower</code>，返回日志复制成功后，则表示已成功复制给大多数（leader也算一个节点）。</li>\n<li>③ leader节点确认大多数复制成功后，本地提交用户修改操作（此时子节点并没有进行提交），并返回前端修改成功。</li>\n</ul>\n<p>leader节点在本地提交，且通知到客户端成功进行操作后，会异步的告知子节点进行提交操作，follower也将完成节点的本地提交操作。只需要保证日志能够复制给大多数即可。</p>\n<p><img src=\"1554102404533.png\" alt=\"1554102404533\"></p>\n<blockquote>\n<p>在一个 Raft 集群中只有 Leader 节点能够处理客户端的请求（如果客户端的请求发到了 Follower，Follower 将会把请求重定向到 Leader），客户端的每一个请求都包含一条被复制状态机执行的指令。</p>\n</blockquote>\n<p>更为详细的日志复制过程可以查看，<a href=\"https://gitbook.cn/books/5bb037728f7d8b7e900ff2d7/index.html\" target=\"_blank\" rel=\"noopener\">分布式锁的最佳实践之：基于 Etcd 的分布式锁</a>，其中的<code>Raft 算法之 Log replication 原理</code>。</p>\n<p><img src=\"1554102849417.png\" alt=\"Raft 算法之 Log replication 原理\"></p>\n<h2 id=\"分布式乐观锁简易测试\"><a href=\"#分布式乐观锁简易测试\" class=\"headerlink\" title=\"分布式乐观锁简易测试\"></a>分布式乐观锁简易测试</h2><p>使用etcd的租约和watch，一个用于自动释放锁，一个用于抢占锁。</p>\n<p>这篇博客有更详细的解释：<a href=\"https://segmentfault.com/a/1190000014297365\" target=\"_blank\" rel=\"noopener\">分布式锁的原理和实现详解</a></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"context\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"time\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/coreos/etcd/clientv3\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> (</span><br><span class=\"line\">\t\tconfig         clientv3.Config</span><br><span class=\"line\">\t\tclient         *clientv3.Client</span><br><span class=\"line\">\t\terr            error</span><br><span class=\"line\">\t\tlease          clientv3.Lease</span><br><span class=\"line\">\t\tleaseGrantResp *clientv3.LeaseGrantResponse</span><br><span class=\"line\">\t\tleaseId        clientv3.LeaseID</span><br><span class=\"line\">\t\tkeepRespChan   &lt;-<span class=\"keyword\">chan</span> *clientv3.LeaseKeepAliveResponse</span><br><span class=\"line\">\t\tkeepResp       *clientv3.LeaseKeepAliveResponse</span><br><span class=\"line\">\t\tctx            context.Context</span><br><span class=\"line\">\t\tcancelFunc     context.CancelFunc</span><br><span class=\"line\">\t\tkv             clientv3.KV</span><br><span class=\"line\">\t\ttxn            clientv3.Txn</span><br><span class=\"line\">\t\ttxnResp        *clientv3.TxnResponse</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 客户端配置</span></span><br><span class=\"line\">\tconfig = clientv3.Config&#123;</span><br><span class=\"line\">\t\tEndpoints:   []<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"www.wukoon-app.com:2379\"</span>&#125;,</span><br><span class=\"line\">\t\tDialTimeout: <span class=\"number\">5</span> * time.Second,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 建立连接</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> client, err = clientv3.New(config); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// lease实现锁自动过期:</span></span><br><span class=\"line\">\t<span class=\"comment\">// op操作</span></span><br><span class=\"line\">\t<span class=\"comment\">// txn事务: if else then</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 1, 上锁 (创建租约, 自动续租, 拿着租约去抢占一个key)</span></span><br><span class=\"line\">\tlease = clientv3.NewLease(client)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 申请一个5秒的租约</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> leaseGrantResp, err = lease.Grant(context.TODO(), <span class=\"number\">5</span>); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 拿到租约的ID</span></span><br><span class=\"line\">\tleaseId = leaseGrantResp.ID</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 准备一个用于取消自动续租的context</span></span><br><span class=\"line\">\tctx, cancelFunc = context.WithCancel(context.TODO())</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 确保函数退出后, 自动续租会停止</span></span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> cancelFunc()</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> lease.Revoke(context.TODO(), leaseId)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 5秒后会取消自动续租</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> keepRespChan, err = lease.KeepAlive(ctx, leaseId); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 处理续约应答的协程</span></span><br><span class=\"line\">\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> keepResp = &lt;-keepRespChan:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> keepRespChan == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tfmt.Println(<span class=\"string\">\"租约已经失效了\"</span>)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">goto</span> END</span><br><span class=\"line\">\t\t\t\t&#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 每秒会续租一次, 所以就会受到一次应答</span></span><br><span class=\"line\">\t\t\t\t\tfmt.Println(<span class=\"string\">\"收到自动续租应答:\"</span>, keepResp.ID)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\tEND:</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//  if 不存在key， then 设置它, else 抢锁失败</span></span><br><span class=\"line\">\tkv = clientv3.NewKV(client)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 创建事务</span></span><br><span class=\"line\">\ttxn = kv.Txn(context.TODO())</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 定义事务</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 如果key不存在</span></span><br><span class=\"line\">\ttxn.If(clientv3.Compare(clientv3.CreateRevision(<span class=\"string\">\"/cron/lock/job9\"</span>), <span class=\"string\">\"=\"</span>, <span class=\"number\">0</span>)).</span><br><span class=\"line\">\t\tThen(clientv3.OpPut(<span class=\"string\">\"/cron/lock/job9\"</span>, <span class=\"string\">\"xxx\"</span>, clientv3.WithLease(leaseId))).</span><br><span class=\"line\">\t\tElse(clientv3.OpGet(<span class=\"string\">\"/cron/lock/job9\"</span>)) <span class=\"comment\">// 否则抢锁失败</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 提交事务</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> txnResp, err = txn.Commit(); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"comment\">// 没有问题</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 判断是否抢到了锁</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !txnResp.Succeeded &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"锁被占用:\"</span>, <span class=\"keyword\">string</span>(txnResp.Responses[<span class=\"number\">0</span>].GetResponseRange().Kvs[<span class=\"number\">0</span>].Value))</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 2, 处理业务</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"处理任务\"</span>)</span><br><span class=\"line\">\ttime.Sleep(<span class=\"number\">5</span> * time.Second)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 3, 释放锁(取消自动续租, 释放租约)</span></span><br><span class=\"line\">\t<span class=\"comment\">// defer 会把租约释放掉, 关联的KV就被删除了</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"etcd","slug":"etcd","permalink":"chunlife.top/categories/etcd/"}],"tags":[{"name":"etcd","slug":"etcd","permalink":"chunlife.top/tags/etcd/"},{"name":"分布式","slug":"分布式","permalink":"chunlife.top/tags/分布式/"},{"name":"乐观锁","slug":"乐观锁","permalink":"chunlife.top/tags/乐观锁/"}]},{"title":"es告警功能——elastalert","date":"2019-03-27T08:39:28.000Z","path":"2019/03/27/es告警功能——elastalert/","content":"<p>ElasticSearch可以使用X-Pack进行报警功能，由于其是收费使用，而当下也仅是使用告警功能。</p>\n<a id=\"more\"></a> \n\n<p>所以这里寻求的是开源解决方案，<strong><a href=\"https://github.com/Yelp/elastalert\" target=\"_blank\" rel=\"noopener\">elastalert</a></strong>，在GitHub中star数量5K+，已经算是很受欢迎的项目了，可以配合<code>kibana</code>进行使用，适用于所有版本的Elasticsearch，而且官方使用教程还挺详细，可以参考进行使用。</p>\n<p>使用elastalert需要预先配置rule.yaml，根据软件介绍，选择适合自身规则的软件告警规则，根据告警规则填充详细的文档。</p>\n<p>我们可以定义多个yaml，同时进行多种告警。对于每个rule.yaml，其包含一种告警发生规则，即阈值；包含一些告警方式，即email、jira等。</p>\n<h2 id=\"安装Elastalert\"><a href=\"#安装Elastalert\" class=\"headerlink\" title=\"安装Elastalert\"></a>安装Elastalert</h2><p>安装之前需要准备好Python的环境，这里已经提前安装完成，<code>Python2.7</code>。</p>\n<p>拉取最新的elastalert仓库</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> pip install elastalert</span></span><br><span class=\"line\">或者</span><br><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/Yelp/elastalert.git</span></span><br></pre></td></tr></table></figure>\n\n<p>安装模块：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> pip install <span class=\"string\">\"setuptools&gt;=11.3\"</span></span></span><br><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> sudo python setup.py install</span></span><br></pre></td></tr></table></figure>\n\n<p>安装成功后：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ ls /usr/local/bin/elastalert*</span><br><span class=\"line\">/usr/local/bin/elastalert               /usr/local/bin/elastalert-rule-from-kibana</span><br><span class=\"line\">/usr/local/bin/elastalert-create-index  /usr/local/bin/elastalert-test-rule</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>elastalert-create-index  ElastAlert将有关其查询及其警报的信息和元数据保存回Elasticsearch。这对于审计，调试很有用，它允许ElastAlert重新启动并从中断的位置恢复。并不实际影响ElastAlert运行，但强烈推荐这么做。</li>\n<li>elastalert-rule-from-kibana 从 Kibana 已保存的仪表盘中读取 Filtering 设置，帮助生成 <code>config.yaml</code>里的配置。不过注意，它只会读取 filtering，不包括 queries。</li>\n<li>elastalert-test-rule 测试自定义配置中的 rule 设置。</li>\n<li>elastalert运行elastalert。</li>\n</ul>\n<h2 id=\"设置Elasticsearch\"><a href=\"#设置Elasticsearch\" class=\"headerlink\" title=\"设置Elasticsearch\"></a>设置Elasticsearch</h2><blockquote>\n<p>ElastAlert将有关其查询及其警报的信息和元数据保存回Elasticsearch。这对于审计，调试很有用，它允许ElastAlert重新启动并从中断的位置恢复。并不实际影响ElastAlert运行，但强烈推荐这么做。</p>\n</blockquote>\n<p>会需要输入es host port等参数，其他默认即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ elastalert-create-index</span><br><span class=\"line\">New index name (Default elastalert_status)</span><br><span class=\"line\">Name of existing index to copy (Default None)</span><br><span class=\"line\">New index elastalert_status created</span><br><span class=\"line\">Done!</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"设置配置文件config-yaml和规则Rule\"><a href=\"#设置配置文件config-yaml和规则Rule\" class=\"headerlink\" title=\"设置配置文件config.yaml和规则Rule\"></a>设置配置文件config.yaml和规则Rule</h2><h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`$ cp ~/elastalert/config.yaml.example ~/elastalert/config.yaml$ vi ~/elastalert/config.yaml`</span><br></pre></td></tr></table></figure>\n\n<p>调试时，我仅配置：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># This is the folder that contains the rule yaml files</span></span><br><span class=\"line\"><span class=\"comment\"># Any .yaml file will be loaded as a rule</span></span><br><span class=\"line\"><span class=\"attr\">rules_folder:</span> <span class=\"string\">example_rules</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># How often ElastAlert will query Elasticsearch</span></span><br><span class=\"line\"><span class=\"comment\"># The unit can be anything from weeks to seconds</span></span><br><span class=\"line\"><span class=\"attr\">run_every:</span></span><br><span class=\"line\"><span class=\"attr\">  minutes:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ElastAlert will buffer results from the most recent</span></span><br><span class=\"line\"><span class=\"comment\"># period of time, in case some log sources are not in real time</span></span><br><span class=\"line\"><span class=\"attr\">buffer_time:</span></span><br><span class=\"line\"><span class=\"attr\">  minutes:</span> <span class=\"number\">15</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The Elasticsearch hostname for metadata writeback</span></span><br><span class=\"line\"><span class=\"comment\"># Note that every rule can have its own Elasticsearch host</span></span><br><span class=\"line\"><span class=\"attr\">es_host:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The Elasticsearch port</span></span><br><span class=\"line\"><span class=\"attr\">es_port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The index on es_host which is used for metadata storage</span></span><br><span class=\"line\"><span class=\"comment\"># This can be a unmapped index, but it is recommended that you run</span></span><br><span class=\"line\"><span class=\"comment\"># elastalert-create-index to set a mapping</span></span><br><span class=\"line\"><span class=\"attr\">writeback_index:</span> <span class=\"string\">elastalert_status</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If an alert fails for some reason, ElastAlert will retry</span></span><br><span class=\"line\"><span class=\"comment\"># sending the alert until this time period has elapsed</span></span><br><span class=\"line\"><span class=\"attr\">alert_time_limit:</span></span><br><span class=\"line\"><span class=\"attr\">  days:</span> <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p>配置文件上的参数意义官方都已经注释。</p>\n<p>官方文档中同样也有<a href=\"https://elastalert.readthedocs.io/en/latest/recipes/writing_filters.html#negation-and-or\" target=\"_blank\" rel=\"noopener\">注解</a>。</p>\n<h3 id=\"配置规则\"><a href=\"#配置规则\" class=\"headerlink\" title=\"配置规则\"></a>配置规则</h3><p><strong>特别重要</strong>：监控的index中都必须存在<code>@timestamp</code>字段；go语言中使用time格式进行存储。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;@timestamp&quot; : &#123;</span><br><span class=\"line\">            &quot;type&quot; : &quot;date&quot;,</span><br><span class=\"line\">            &quot;format&quot; : &quot;dateOptionalTime&quot;</span><br><span class=\"line\">          &#125;</span><br></pre></td></tr></table></figure>\n\n<p>基于<code>example_rules/example_percentage_match.yaml</code>更改。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">Example</span> <span class=\"string\">Percentage</span> <span class=\"string\">Match</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">percentage_match</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">es_host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">es_port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">index:</span> <span class=\"string\">pro_record</span></span><br><span class=\"line\"><span class=\"attr\">description:</span> <span class=\"string\">\"95% of all http requests should be successful\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">filter:</span></span><br><span class=\"line\"><span class=\"attr\">- term:</span></span><br><span class=\"line\"><span class=\"attr\">   _type:</span> <span class=\"string\">record</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">buffer_time:</span></span><br><span class=\"line\"><span class=\"attr\">  minutes:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#use_terms_query: true</span></span><br><span class=\"line\"><span class=\"attr\">query_key:</span> <span class=\"string\">[\"binx.keyword\"]</span></span><br><span class=\"line\"><span class=\"attr\">doc_type:</span> <span class=\"string\">record</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">match_bucket_filter:</span></span><br><span class=\"line\"><span class=\"attr\">- term:</span></span><br><span class=\"line\">    <span class=\"string\">binx.keyword:</span> <span class=\"string\">\"xxxxx\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#min_percentage: 1</span></span><br><span class=\"line\"><span class=\"attr\">max_percentage:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#bucket_interval:</span></span><br><span class=\"line\"><span class=\"comment\">#  minutes: 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sync_bucket_interval: true</span></span><br><span class=\"line\"><span class=\"comment\">#allow_buffer_time_overlap: true</span></span><br><span class=\"line\"><span class=\"comment\">#use_run_every_query_size: true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (Required)</span></span><br><span class=\"line\"><span class=\"comment\"># The alert is use when a match is found</span></span><br><span class=\"line\"><span class=\"attr\">alert:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">\"debug\"</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>文件作为演示，数据都已被更改</p>\n</blockquote>\n<p>使用<code>elastalert-test-rule</code>对规则进行测试。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`elastalert-test-rule ~/elastalert/example_rules/example_frequency.yaml`</span><br></pre></td></tr></table></figure>\n\n<p>正常出现<code>Successfully loaded Example Percentage Match</code>，然后实际输出也并没报错，那到这里就规则至少文件是没问题的了。</p>\n<p>参考：<a href=\"https://elastalert.readthedocs.io/en/latest/ruletypes.html#commonconfig\" target=\"_blank\" rel=\"noopener\">Rule Types and Configuration Options</a></p>\n<p>若是想要监控特定订单下的bin错误，那就需要增加查询条件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">match_bucket_filter:</span></span><br><span class=\"line\"><span class=\"attr\">- term:</span></span><br><span class=\"line\">    <span class=\"string\">order.keyword:</span> <span class=\"string\">\"TDRAM19012\"</span></span><br><span class=\"line\"><span class=\"attr\">- term:</span></span><br><span class=\"line\">    <span class=\"string\">bin.keyword:</span> <span class=\"string\">\"2142134038\"</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用HTTP-POST报警\"><a href=\"#使用HTTP-POST报警\" class=\"headerlink\" title=\"使用HTTP POST报警\"></a>使用HTTP POST报警</h3><p>根据官方<a href=\"https://elastalert.readthedocs.io/en/latest/ruletypes.html#rule-types\" target=\"_blank\" rel=\"noopener\">文档</a>，查看配置参数的含义：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">alert:</span> <span class=\"string\">post</span></span><br><span class=\"line\"><span class=\"attr\">http_post_url:</span> <span class=\"string\">\"http://example.com/api\"</span></span><br><span class=\"line\"><span class=\"attr\">http_post_payload:</span></span><br><span class=\"line\"><span class=\"attr\">  ip:</span> <span class=\"string\">clientip</span></span><br><span class=\"line\"><span class=\"attr\">http_post_static_payload:</span></span><br><span class=\"line\"><span class=\"attr\">  apikey:</span> <span class=\"string\">abc123</span></span><br></pre></td></tr></table></figure>\n\n<p><code>alert: post</code>：指定警报方式；</p>\n<p><code>http_post_url: &quot;http://example.com/api&quot;</code>：post地址，route方法同样也为<code>post</code>；</p>\n<p><code>http_post_payload</code>：这个参数表示是否需要重定义ElastAlert的键值，例如设置了<code>ip: clientip</code>，那么原来数据中的<code>clientip</code>键，将被替换成<code>ip</code>，也可以填入没有的键值，只不过value是<code>null</code>。<strong>可以不需要此参数，表示直接返回ES的数据</strong>。</p>\n<p><code>http_post_static_payload</code>：这个表示每次警报发送固定的信息，也就是每次警报都会带上<code>apikey: abc123</code>。</p>\n<p>例如在上面基础上去掉了<code>http_post_payload</code>，返回的json数据是：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;<span class=\"attr\">\"num_hits\"</span>: <span class=\"number\">1</span>, <span class=\"attr\">\"@timestamp\"</span>: <span class=\"string\">\"2019-03-28T06:54:51.043483Z\"</span>, <span class=\"attr\">\"denominator\"</span>: <span class=\"number\">1</span>, <span class=\"attr\">\"bin.keyword\"</span>: <span class=\"string\">\"2142134038\"</span>, <span class=\"attr\">\"num_matches\"</span>: <span class=\"number\">1</span>, <span class=\"attr\">\"percentage\"</span>: <span class=\"number\">100.0</span>, <span class=\"attr\">\"order\"</span>: <span class=\"string\">\"TDRAM19012\"</span>&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h2><p>最后，运行命令:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> python -m elastalert.elastalert --config ./config.yaml</span></span><br></pre></td></tr></table></figure>\n\n<p>或者单独执行 <code>rules_folder</code> 里的某个 rule：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> python -m elastalert.elastalert --config ./config.yaml --rule ./examele_rules/example_percentage_match.yaml</span></span><br></pre></td></tr></table></figure>\n\n<p>调试时使用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> python -m elastalert.elastalert --verbose --rule example_rules/example_percentage_match.yaml --config config.yaml --debug</span></span><br></pre></td></tr></table></figure>\n\n<p>启动后无error错误打印，代表程序运行成功。</p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>向ES index <code>pro_record</code>插入一些数据，因为制定的规则是在一分钟之内，只要有符合匹配规则的数据插入，其百分比超过100%，就将会报错。</p>\n<p>若打印出现类似于：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">Percentage violation, value: 100.0 (min: None max : 1) of 1 items</span><br><span class=\"line\"></span><br><span class=\"line\">@timestamp: 2019-03-27T08:04:16.323823Z</span><br><span class=\"line\">bin.keyword: 2142134038</span><br><span class=\"line\">denominator: 1</span><br><span class=\"line\">num_hits: 21</span><br><span class=\"line\">num_matches: 9</span><br><span class=\"line\">percentage: 100.0</span><br><span class=\"line\"></span><br><span class=\"line\">....</span><br></pre></td></tr></table></figure>\n\n<p>表示规则已正常运行，且能成功进行匹配。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><blockquote>\n<p>介绍命令 <a href=\"https://www.ctolib.com/docs/sfile/ELKstack-guide-cn/elasticsearch/other/elastalert.html\" target=\"_blank\" rel=\"noopener\">ElastAlert</a></p>\n<p>官方文档 <a href=\"https://elastalert.readthedocs.io/en/latest/recipes/writing_filters.html\" target=\"_blank\" rel=\"noopener\">Writing Filters For Rules</a></p>\n<p>对各项报警进行分析，其是使用post方式告警 <a href=\"https://4hou.win/wordpress/?cat=3634\" target=\"_blank\" rel=\"noopener\">基于Elastalert的安全告警剖析</a></p>\n<p>从安装到使用  <a href=\"https://anjia0532.github.io/2017/02/14/elasticsearch-elastalert/\" target=\"_blank\" rel=\"noopener\">ElastAlert 基于Elasticsearch的监控告警</a></p>\n</blockquote>\n","categories":[{"name":"Elastic Search","slug":"Elastic-Search","permalink":"chunlife.top/categories/Elastic-Search/"}],"tags":[{"name":"elasticsearch","slug":"elasticsearch","permalink":"chunlife.top/tags/elasticsearch/"}]},{"title":"Go执行shell命令之copy命令","date":"2019-03-22T15:22:56.000Z","path":"2019/03/22/Go执行shell命令之copy/","content":"<p>当我以为我不会遇到坑的时候，坑就在那里，不偏不移，刚好让我踩过去。之前写了关于如何调用系统命令的小结，这里果然不负我望，当场让我晓得了，总结不够到位，有瑕疵。</p>\n<a id=\"more\"></a>\n\n<p>项目有用到<code>cp</code>的操作，大概就是把某目录下的所有文件复制到上级目录中，也就是<code>cp -rf ./test/* ../</code>。</p>\n<p>首先看代码。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cpCmd := exec.Command(<span class=\"string\">\"cp\"</span>, <span class=\"string\">\"-rf\"</span>, <span class=\"string\">\"./test/*\"</span>, <span class=\"string\">\"../\"</span>)</span><br><span class=\"line\">cpCmd.Dir = <span class=\"string\">\"/home/tmp\"</span></span><br><span class=\"line\">err := cpCmd.Run()</span><br></pre></td></tr></table></figure>\n\n<p>代码看起来是没有问题的，但是运行起来，却是会报出错误。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp: cannot stat ‘./test/*’: No such file or directory</span><br></pre></td></tr></table></figure>\n\n<p>这是为何呢，若是直接在shell中运行该命令，是没有问题的，为什么在程序中运行就会出现问题呢？</p>\n<p>用力Google了一下，查到<a href=\"https://superuser.com/questions/1235420/cp-cannot-stat-some-path-no-such-file-or-directory\" target=\"_blank\" rel=\"noopener\">cp: cannot stat ‘/some/path/*’: No such file or directory</a>。</p>\n<p>大概的意思是，该<code>*</code>会被处理成字符串，而不是特殊意义上的通配符，所以，也就会被认定为一个文件或者文件夹，所以，它就报错了，大概就是这么个情况。</p>\n<p>至于程序中如何解决这种情况呢？准确的来讲，我其实是没有找到解决方式的，也就只是换了种替代方式（一个一个文件/文件夹移动）。</p>\n<p><img src=\"1553269116203.png\" alt=\"链接给的回答\"></p>\n<p>这里，还发现另一个问题，若调用命令如：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cpCmd := exec.Command(<span class=\"string\">\"sh\"</span>, <span class=\"string\">\"-c\"</span>,<span class=\"string\">\"cp\"</span>, <span class=\"string\">\"-rf\"</span>, <span class=\"string\">\"./test/*\"</span>, <span class=\"string\">\"../\"</span>)</span><br></pre></td></tr></table></figure>\n\n<p>则程序将报出：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp: missing file operand</span><br></pre></td></tr></table></figure>\n\n<p>同样的，很遗憾，我未能找到具体发生这个现象的原因，算起来，这算是比较坑爹的问题吧，因为是面对项目，只能说碰到了优先以解决为主，当时间不允许的情况下，赶紧避开。</p>\n<p>这里记录一下，我再找找出现问题的原因。</p>\n<p>这里放一个小的复制封装：<a href=\"https://github.com/juju/utils/blob/master/fs/copy.go\" target=\"_blank\" rel=\"noopener\">https://github.com/juju/utils/blob/master/fs/copy.go</a></p>\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Shell","slug":"Shell","permalink":"chunlife.top/tags/Shell/"}]},{"title":"go执行shell命令","date":"2019-03-21T17:28:06.000Z","path":"2019/03/22/go执行shell命令/","content":"<p>其实在之前的项目中，就有运用到调用linux中的命令，例如，借鉴<a href=\"https://github.com/open-falcon/falcon-plus\" target=\"_blank\" rel=\"noopener\">falcon</a>，里面agent更新文件是调用的wget去获取server端目录下的<code>agent</code>的<code>tar</code>包。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"基础任务调用\"><a href=\"#基础任务调用\" class=\"headerlink\" title=\"基础任务调用\"></a>基础任务调用</h3><p>按道理来讲，官方库<code>os/exec</code>已经将这个操作封装得很好了，我们所需要做的，也就是调用API进行操作即可，这里插入一些关于API调用的流程问题。</p>\n<p>这是一个基础的调用命令的使用方式：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> (</span><br><span class=\"line\">\t\tcmd *exec.Cmd</span><br><span class=\"line\">\t\toutput []<span class=\"keyword\">byte</span></span><br><span class=\"line\">\t\terr error</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 生成Cmd</span></span><br><span class=\"line\">\tcmd = exec.Command(<span class=\"string\">\"/bin/bash\"</span>, <span class=\"string\">\"-c\"</span>, <span class=\"string\">\"echo 1;echo2;\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 执行了命令, 捕获了子进程的输出( pipe )</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> output, err = cmd.CombinedOutput(); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 打印子进程的输出</span></span><br><span class=\"line\">\tfmt.Println(<span class=\"keyword\">string</span>(output))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>其实，它借用到了Linux的进程的相关函数操作，如图：</p>\n<p><img src=\"1553186402784.png\" alt=\"任务执行原理\"></p>\n<p>也就是说，golang在调用fork，其与子进程通过管道进行了相应的连接，这是linux的基础知识——进程间通信（感觉回到了嵌入式）。</p>\n<p>也就是相当于<code>go</code>写入一个<code>command</code>交给子进程去运行，然后结果被子进程输入管道，<code>go</code>会去读取。</p>\n<p>系统调用阶段会使用到：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipe():创建2个文件描述符，fd[0]可读，fd[1]可写</span><br><span class=\"line\">fork()：创建子进程，fd[1]被继承到子进程</span><br><span class=\"line\">dup2():重定向子进程stdout/stderr到fd[1]</span><br><span class=\"line\">exec()：在当前进程内，加载并执行二进制程序</span><br></pre></td></tr></table></figure>\n\n<p>这种调用其实是非常占用空间的，子进程会共享父进程的代码空间，数据空间则互相独立，子进程数据空间中的内容是父进程的<strong>完整拷贝</strong>，指令指针也完全相同。也就是这个的消耗资源也就是比协程消耗得更多的，基本相当于线程对协程而言了。</p>\n<h3 id=\"强制结束任务\"><a href=\"#强制结束任务\" class=\"headerlink\" title=\"强制结束任务\"></a>强制结束任务</h3><p>在实际使用中，我们需要控制任务的生命周期，有时候，我们并不需要任务继续执行下去了，这时候，我们就要使点手段来结束掉任务。</p>\n<p>可以使用如下：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">   <span class=\"string\">\"context\"</span></span><br><span class=\"line\">   <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">   <span class=\"string\">\"os/exec\"</span></span><br><span class=\"line\">   <span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> result <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">   err    error</span><br><span class=\"line\">   output []<span class=\"keyword\">byte</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">   <span class=\"comment\">//  执行1个cmd, 让它在一个协程里去执行, 让它执行2秒: sleep 2; echo hello;</span></span><br><span class=\"line\">   <span class=\"comment\">// 1秒的时候, 我们杀死cmd</span></span><br><span class=\"line\">   <span class=\"keyword\">var</span> (</span><br><span class=\"line\">      ctx        context.Context</span><br><span class=\"line\">      cancelFunc context.CancelFunc</span><br><span class=\"line\">      cmd        *exec.Cmd</span><br><span class=\"line\">      resultChan <span class=\"keyword\">chan</span> *result</span><br><span class=\"line\">      res        *result</span><br><span class=\"line\">   )</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// 创建了一个结果队列</span></span><br><span class=\"line\">   resultChan = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> *result, <span class=\"number\">1000</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// context:   chan byte</span></span><br><span class=\"line\">   <span class=\"comment\">// cancelFunc:  close(chan byte)</span></span><br><span class=\"line\"></span><br><span class=\"line\">   ctx, cancelFunc = context.WithCancel(context.TODO())</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> (</span><br><span class=\"line\">         output []<span class=\"keyword\">byte</span></span><br><span class=\"line\">         err    error</span><br><span class=\"line\">      )</span><br><span class=\"line\">      <span class=\"comment\">//cmd = exec.CommandContext(ctx, \"/bin/bash\", \"-c\", \"sleep 2;echo hello;\")</span></span><br><span class=\"line\">      cmd = exec.CommandContext(ctx, <span class=\"string\">`D:\\Git\\bin\\bash.exe`</span>, <span class=\"string\">\"-c\"</span>, <span class=\"string\">\"sleep 2;echo hello;\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 执行任务, 捕获输出</span></span><br><span class=\"line\">      output, err = cmd.CombinedOutput()</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 把任务输出结果, 传给main协程</span></span><br><span class=\"line\">      resultChan &lt;- &amp;result&#123;</span><br><span class=\"line\">         err:    err,</span><br><span class=\"line\">         output: output,</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// 继续往下走</span></span><br><span class=\"line\">   time.Sleep(<span class=\"number\">1</span> * time.Second)</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// 取消上下文</span></span><br><span class=\"line\">   cancelFunc()</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// 在main协程里, 等待子协程的退出，并打印任务执行结果</span></span><br><span class=\"line\">   res = &lt;-resultChan</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// 打印任务执行结果</span></span><br><span class=\"line\">   fmt.Println(res.err, <span class=\"keyword\">string</span>(res.output))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>注意</strong>：若你在windows下运行该命令，运行得到的结果是（go1.11，go1.12，这俩版本linux不会出现这种情况）：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exit status 1  hello</span><br></pre></td></tr></table></figure>\n\n<p>也就是说程序虽然被kill掉了，但命令还是执行了。</p>\n<p>博客：<a href=\"https://yuerblog.cc/2018/07/23/golang-command-context-not-exit-problem/#comment-575\" target=\"_blank\" rel=\"noopener\">golang的CommandContext取消不退出问题</a>，介绍的是在go1.10中，Linux下运行命令无法终止的情况（go1.11已被修复），但博客中有提到一个<a href=\"https://github.com/golang/go/issues/23019\" target=\"_blank\" rel=\"noopener\">issue</a>，该地址里有介绍到windows相关，我未深究这个问题的解决，毕竟我没在windows下的使用环境（大概都是运行在linux下的吧）。</p>\n<p>这里还是提一下这个问题，望了解。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Shell","slug":"Shell","permalink":"chunlife.top/tags/Shell/"}]},{"title":"slice小问题","date":"2019-03-20T16:32:33.000Z","path":"2019/03/21/slice面试题/","content":"<p>之前我有写过一篇关于slice的博客——<a href=\"https://chunlife.top/2018/10/22/slice%E7%90%86%E8%A7%A3/\">slice理解</a>。其中是对slice的底层结构，扩展，以及range关键字进行解析，而现在刚好又碰到一个关于slice的问题，算是自己粗心犯的一个错吧。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"slice初始化\"><a href=\"#slice初始化\" class=\"headerlink\" title=\"slice初始化\"></a>slice初始化</h3><p>一般来说slice的初始化方式可以有两种：</p>\n<ul>\n<li>通过数组来初始化</li>\n<li>通过内置函数make()初始化</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s :=[]int&#123;1,2,3 &#125; </span><br><span class=\"line\">直接初始化切片，[]表示是切片类型，&#123;1,2,3&#125;初始化值依次是1,2,3.其cap=len=3</span><br><span class=\"line\">s := arr[:] </span><br><span class=\"line\">初始化切片s,是数组arr的引用</span><br><span class=\"line\">s := arr[:endIndex] </span><br><span class=\"line\">缺省startIndex时将表示从arr的第一个元素开始到第endIndex个元素</span><br></pre></td></tr></table></figure>\n\n<p>所以说，若是直接声明一个slice，是不可用的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var s []int</span><br></pre></td></tr></table></figure>\n\n<p>所以，为了偷懒，我一般是使用<code>make</code>的方式。</p>\n<h3 id=\"问题出现\"><a href=\"#问题出现\" class=\"headerlink\" title=\"问题出现\"></a>问题出现</h3><p>我有些忘记了<code>make</code>函数创建slice时，返回的是一个已被填充好值的slice，但我依然习惯性的使用了append去添加元素，这样会导致slice数据出现冗余，类似于这样的代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">   s := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">5</span>)</span><br><span class=\"line\">   s = <span class=\"built_in\">append</span>(s, <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>)</span><br><span class=\"line\">   fmt.Println(s)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>代码运行结果是：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[0 0 0 0 0 1 2 3]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"为什么？\"><a href=\"#为什么？\" class=\"headerlink\" title=\"为什么？\"></a>为什么？</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">make</span><span class=\"params\">([]T, <span class=\"built_in\">len</span>, <span class=\"built_in\">cap</span>)</span> []<span class=\"title\">T</span></span></span><br></pre></td></tr></table></figure>\n\n<p>其中T代表被创建的切片元素的类型。函数 <code>make</code> 接受一个类型、一个长度和一个可选的容量参数。调用 <code>make</code> 时，内部会分配一个数组，然后返回数组对应的切片。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> s []<span class=\"keyword\">byte</span></span><br><span class=\"line\">s = <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, <span class=\"number\">5</span>, <span class=\"number\">5</span>)</span><br><span class=\"line\"><span class=\"comment\">// s == []byte&#123;0, 0, 0, 0, 0&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>当容量参数被忽略时，它默认为指定的长度。下面是简洁的写法：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s := <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, <span class=\"number\">5</span>)</span><br></pre></td></tr></table></figure>\n\n<p>所以说，当继续使用<code>append</code>时，数据时直接填充在这些默认值<code>0</code>的后面的，这也就造成实际数据中出现多余的<code>0</code>，从而影响后续的操作。</p>\n<h3 id=\"附加\"><a href=\"#附加\" class=\"headerlink\" title=\"附加\"></a>附加</h3><h4 id=\"slice追加到另一个slice\"><a href=\"#slice追加到另一个slice\" class=\"headerlink\" title=\"slice追加到另一个slice\"></a>slice追加到另一个slice</h4><p>如果将一个slice追加到另一个slice中需要带上”<strong>…</strong>“，这样才能表示是将slice中的元素依次追加到另一个slice中。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s :=append(s,s1...)</span><br></pre></td></tr></table></figure>\n\n<p>在通过下标访问元素时下标不能超过len大小，如同数组的下标不能超出len范围一样。</p>\n<h4 id=\"删除切片元素\"><a href=\"#删除切片元素\" class=\"headerlink\" title=\"删除切片元素\"></a>删除切片元素</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">index ：= <span class=\"number\">5</span></span><br><span class=\"line\">ss = <span class=\"built_in\">append</span>(ss[:index], ss[index+<span class=\"number\">1</span>:]...)</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"slice","slug":"slice","permalink":"chunlife.top/tags/slice/"}]},{"title":"压缩zip和解压缩unzip","date":"2019-03-20T09:47:28.000Z","path":"2019/03/20/zip解压-压缩/","content":"<p>在项目中需要使用到zip压缩与解压缩的功能，这类功能应该来说是很基础了，直接引用go官方的包<code>archive/zip</code>，对于如何压缩文件夹的功能不是很熟悉，参考别人的代码加入到项目中，在实际使用中发现有些不符合预期的地方。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>代码引用自博客——<a href=\"https://blog.csdn.net/u011304970/article/details/71131592\" target=\"_blank\" rel=\"noopener\">Go压缩解压文件夹</a></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//zipDir(\"F:\\\\dumps\", \"F:\\\\dumps.zip\")</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">zipDir</span><span class=\"params\">(dir, zipFile <span class=\"keyword\">string</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfz, err := os.Create(zipFile)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Debug(<span class=\"string\">\"Create zip file failed: %s\\n\"</span>, err.Error())</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> fz.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tw := zip.NewWriter(fz)</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> w.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfilepath.Walk(dir, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(path <span class=\"keyword\">string</span>, info os.FileInfo, err error)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> !info.IsDir() &#123;</span><br><span class=\"line\">\t\t\tfDest, err := w.Create(path[<span class=\"built_in\">len</span>(dir)+<span class=\"number\">1</span>:])</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tlog.Printf(<span class=\"string\">\"Create failed: %s\\n\"</span>, err.Error())</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tfSrc, err := os.Open(path)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tlog.Printf(<span class=\"string\">\"Open failed: %s\\n\"</span>, err.Error())</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">defer</span> fSrc.Close()</span><br><span class=\"line\">\t\t\t_, err = io.Copy(fDest, fSrc)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tlog.Printf(<span class=\"string\">\"Copy failed: %s\\n\"</span>, err.Error())</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>压缩文件夹函数确实能够压缩文件夹，但实际使用中，我发现和我需要的效果有些出入，例如，我的目录结果为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">frist/</span><br><span class=\"line\">├── second_1</span><br><span class=\"line\">│   └── 1.txt</span><br><span class=\"line\">└── second_2</span><br><span class=\"line\">    └── 1.txt</span><br><span class=\"line\">2 directories, 2 files</span><br></pre></td></tr></table></figure>\n\n<p>我需要连着<code>frist</code>顶级目录一起进行压缩，但事与愿违，即使传入<code>frist</code>的上一级目录，<code>zipDir</code>函数依然只会压缩<code>second_1</code>以及<code>second_2</code>；而且，当我输出的目标ZIP文件是压缩的文件夹中时，压缩包内会出现一个名为<code>zip</code>的临时文件。</p>\n<h2 id=\"解决\"><a href=\"#解决\" class=\"headerlink\" title=\"解决\"></a>解决</h2><p>故此，我本着不应该没人做的更好的想法（嘿嘿~），找到了<a href=\"http://blog.ralch.com/tutorial/golang-working-with-zip/\" target=\"_blank\" rel=\"noopener\">Golang: Working with ZIP archives</a>。</p>\n<p>可以压缩顶层目录，且压缩文件即使要输出到压缩目录，也不会出现什么异常。</p>\n<h3 id=\"Compressing\"><a href=\"#Compressing\" class=\"headerlink\" title=\"Compressing\"></a>Compressing</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// zipit(\"/tmp/documents\", \"/tmp/backup.zip\")</span></span><br><span class=\"line\"><span class=\"comment\">// zipit(\"/tmp/report.txt\", \"/tmp/report-2015.zip\")</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">zipit</span><span class=\"params\">(source, target <span class=\"keyword\">string</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\tzipfile, err := os.Create(target)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> zipfile.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tarchive := zip.NewWriter(zipfile)</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> archive.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tinfo, err := os.Stat(source)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> baseDir <span class=\"keyword\">string</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> info.IsDir() &#123;</span><br><span class=\"line\">\t\tbaseDir = filepath.Base(source)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfilepath.Walk(source, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(path <span class=\"keyword\">string</span>, info os.FileInfo, err error)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\theader, err := zip.FileInfoHeader(info)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> baseDir != <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">\t\t\theader.Name = filepath.Join(baseDir, strings.TrimPrefix(path, source))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> info.IsDir() &#123;</span><br><span class=\"line\">\t\t\theader.Name += <span class=\"string\">\"/\"</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\theader.Method = zip.Deflate</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\twriter, err := archive.CreateHeader(header)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> info.IsDir() &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tfile, err := os.Open(path)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">defer</span> file.Close()</span><br><span class=\"line\">\t\t_, err = io.Copy(writer, file)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2019-3-22-11-47-46\"><a href=\"#2019-3-22-11-47-46\" class=\"headerlink\" title=\"2019-3-22 11:47:46\"></a>2019-3-22 11:47:46</h4><p>发现一个小问题，当传入相对路径<code>./testDir</code>给函数<code>zipit</code>时，会出现两个顶层目录，是因为这行代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">header.Name = filepath.Join(baseDir, strings.TrimPrefix(path, source))</span><br></pre></td></tr></table></figure>\n\n<p><code>strings.TrimPrefix</code>，去掉前缀</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Code:</span><br><span class=\"line\">    <span class=\"keyword\">var</span> s = <span class=\"string\">\"¡¡¡Hello, Gophers!!!\"</span></span><br><span class=\"line\">    s = strings.TrimPrefix(s, <span class=\"string\">\"¡¡¡Hello, \"</span>)</span><br><span class=\"line\">    s = strings.TrimPrefix(s, <span class=\"string\">\"¡¡¡Howdy, \"</span>)</span><br><span class=\"line\">    fmt.Print(s)</span><br><span class=\"line\">Output:</span><br><span class=\"line\">\tGophers!!!</span><br></pre></td></tr></table></figure>\n\n<p>这行代码的意思也就是，去掉前缀的绝对路径，保留下要压缩文件的相对路径，但我们传入的是<code>./testDir</code>，相对于路径来说，多了<code>./</code>，所以其并不会去除成功，那么就会出现顶层目录出现两级的情况。</p>\n<p>解决方法是：</p>\n<ul>\n<li>传入相对路径时，不加<code>./</code>。</li>\n<li>检查传入的路径是否为绝对路径。</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> isAbs := filepath.IsAbs(source); !isAbs &#123;</span><br><span class=\"line\">   <span class=\"comment\">//source, err = filepath.Abs(source)  // 将传入路径直接转化为绝对路径</span></span><br><span class=\"line\">   <span class=\"comment\">//if err != nil &#123;</span></span><br><span class=\"line\">   <span class=\"comment\">// return err</span></span><br><span class=\"line\">   <span class=\"comment\">//&#125;</span></span><br><span class=\"line\">   source = filepath.Base(source)  <span class=\"comment\">// 去掉字符“./”</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>加入以上代码可以解决问题，代码中，其实可以看到我屏蔽了——<code>filepath.Abs</code>函数解决方式，这个函数调用了<code>syscall</code>，也就是说借用了系统命令，这相对而言是比<code>filepath.Base</code>更消耗资源的，因为涉及到了语言系统交互的层面，类似于<a href=\"https://chunlife.top/2019/03/22/go%E6%89%A7%E8%A1%8Cshell%E5%91%BD%E4%BB%A4/\">go执行shell命令</a>。</p>\n<h3 id=\"Extracting\"><a href=\"#Extracting\" class=\"headerlink\" title=\"Extracting\"></a>Extracting</h3><p>附上zip解压缩的代码，以便以后查看。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// unzip(\"/tmp/report-2015.zip\", \"/tmp/reports/\")</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">unzip</span><span class=\"params\">(archive, target <span class=\"keyword\">string</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\treader, err := zip.OpenReader(archive)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err := os.MkdirAll(target, <span class=\"number\">0755</span>); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, file := <span class=\"keyword\">range</span> reader.File &#123;</span><br><span class=\"line\">\t\tpath := filepath.Join(target, file.Name)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> file.FileInfo().IsDir() &#123;</span><br><span class=\"line\">\t\t\tos.MkdirAll(path, file.Mode())</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tfileReader, err := file.Open()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">defer</span> fileReader.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ttargetFile, err := os.OpenFile(path, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, file.Mode())</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">defer</span> targetFile.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> _, err := io.Copy(targetFile, fileReader); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里我在放置一篇博主的：<a href=\"http://blog.ralch.com/articles/golang-working-with-tar-and-gzip/\" target=\"_blank\" rel=\"noopener\">Golang: Working with Gzip and Tar</a></p>\n<p>这里再来一个<a href=\"https://github.com/gpmgo/gopm/tree/master/modules/cae/zip，可以直接自己用这个库，不过这个`pack`函数会自动添加一个`cae`的顶层目录，修改`Flush()`函数，去掉`&quot;cae&quot;`。\" target=\"_blank\" rel=\"noopener\">https://github.com/gpmgo/gopm/tree/master/modules/cae/zip，可以直接自己用这个库，不过这个`pack`函数会自动添加一个`cae`的顶层目录，修改`Flush()`函数，去掉`&quot;cae&quot;`。</a></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tmpPath := path.Join(os.TempDir(), <span class=\"string\">\"cae\"</span>, path.Base(z.FileName))</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"zip","slug":"zip","permalink":"chunlife.top/tags/zip/"}]},{"title":"正则表达式","date":"2019-03-19T13:04:25.000Z","path":"2019/03/19/正则表达式（速查表）/","content":"<p>如果strings包提供的函数能解决你的问题，那么就尽量使用它来解决。因为他们足够简单、而且性能和可读性都要比正则好。</p>\n<a id=\"more\"></a>\n<p>Go使用的正则标准与其他编程语言的标准有些不同，这里参考：<a href=\"http://www.sun190.com/2015/01/re2-正则表达式/\" target=\"_blank\" rel=\"noopener\">re2-正则表达式</a>。</p>\n<p>常用的可以参考以下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">----字符：</span><br><span class=\"line\"></span><br><span class=\"line\">\t“.”: 匹配任意一个字符</span><br><span class=\"line\"></span><br><span class=\"line\">\t&quot;[ ]&quot;: 匹配 [ ] 内任意一个字符。 </span><br><span class=\"line\"></span><br><span class=\"line\">\t“-”：指定范围： a-z、A-Z、0-9</span><br><span class=\"line\"></span><br><span class=\"line\">\t&quot;^&quot;: 取反。 使用在 [ ] 内部。[^xy]8 </span><br><span class=\"line\"></span><br><span class=\"line\">\t[[:digit:]] ——&gt; 数字 == [0-9]</span><br><span class=\"line\"></span><br><span class=\"line\">-----次数：</span><br><span class=\"line\"></span><br><span class=\"line\">\t“?”: 匹配 前面 单元出现 0-1次</span><br><span class=\"line\"></span><br><span class=\"line\">\t“+”：匹配 前面 单元 出现 1-N次</span><br><span class=\"line\"></span><br><span class=\"line\">\t“*”：匹配 前面 单元 出现 0-N次</span><br><span class=\"line\"></span><br><span class=\"line\">\t“&#123;N&#125;”: 匹配 前面 单元  精确匹配 N 次</span><br><span class=\"line\"></span><br><span class=\"line\">\t&quot;&#123;N,&#125;&quot;: 匹配 前面 单元 至少匹配 N 次</span><br><span class=\"line\"></span><br><span class=\"line\">\t&quot;&#123;N,M&#125;&quot;: 匹配 前面 单元 匹配 N -- M 次。</span><br><span class=\"line\"></span><br><span class=\"line\">---- 单元限定符：</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t“()”: 可以将一部分正则表达式，组成一个 单元，可以对该单元使用 数量限定符</span><br></pre></td></tr></table></figure>\n\n<p>更多例子则是参考：<br><img src=\"%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99.png\" alt=\"正则表达式匹配规则\"></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"正则表达式","slug":"正则表达式","permalink":"chunlife.top/tags/正则表达式/"}]},{"title":"搜集赏","date":"2019-03-19T08:54:20.000Z","path":"2019/03/19/搜集赏/","content":"<blockquote>\n<p>我的书，<a href=\"https://purelife.gitbook.io/little-design-powerpoint/\" target=\"_blank\" rel=\"noopener\">PowerPoint设计小册</a>。</p>\n<p>本站所有文章及作品均采用<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh\" target=\"_blank\" rel=\"noopener\">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。转载请注明出处</p>\n</blockquote>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">没有你，良辰美景更与何人说？</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>——《天使爱美丽》</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">“我们命中注定要失去所爱之人，</span><br><span class=\"line\"></span><br><span class=\"line\">不然我们怎么知道他们在我们生命中有多重要？”</span><br></pre></td></tr></table></figure>\n\n<p>——布拉德·皮特主演·《返老还童》</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">想必 女孩子 是由砂糖 香辛料 和某些美好的事物组成的吧</span><br></pre></td></tr></table></figure>\n\n<p>——比企谷八幡 《我的青春恋爱物语果然有问题》</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">要让爱情简单，最好就是精选适合自己的对象。</span><br><span class=\"line\">一个真正值得去爱、也懂得回爱的人，自然会让爱情变得简单。这样，两人之间平时不需要猜测心意，不用担心行踪；不害怕在无意之间激怒，不怀疑做任何事情的动机。两人之间，有一点牵挂，却不会纠缠；两人之间，有一点想念，却不会伤心。</span><br></pre></td></tr></table></figure>\n\n<p>——网络<code>鸡汤类</code>文学</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">总会有光明的东西的，在未来。</span><br></pre></td></tr></table></figure>\n\n<p>——《像少年啦飞驰》韩寒</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">远在远方的风比远方更远</span><br></pre></td></tr></table></figure>\n\n<p>——《九月》海子</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">今夜我不关心人类</span><br><span class=\"line\"></span><br><span class=\"line\">我只想你</span><br></pre></td></tr></table></figure>\n\n<p>——《日记》海子</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">我知道这将是我的一生热爱 我将为此一直奋斗。——张弛（沈腾饰）</span><br></pre></td></tr></table></figure>\n\n<p>——《飞驰人生》，韩寒</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">“以前写过一句话：我所理解的生活，就是和喜欢的一切在一起。</span><br><span class=\"line\"></span><br><span class=\"line\">鸡汤越短，做起来越难。</span><br><span class=\"line\"></span><br><span class=\"line\">此刻，《飞驰人生》应该已经上映了。这是一个很简单的故事，讲的就是和你所爱的一切在一起，以及爱的代价。片子里有对手却没有大反派。你不想索然无味的过完这一生，而反派就是那索然无味的一生。”</span><br></pre></td></tr></table></figure>\n\n<p>——韩寒</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">想你吃醋，却怕你祝我幸福</span><br></pre></td></tr></table></figure>\n\n<p>——网易热心网友</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">我只听音乐 不听故事</span><br></pre></td></tr></table></figure>\n\n<p>——后来我听说你</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">前几天，我听一个广播节目。主持人问，现在很多人开网约车，这样能赚多少钱，能够赚到大钱吗？</span><br><span class=\"line\"></span><br><span class=\"line\">这个问题很容易回答，答案就是不能。出租车司机的收入，主要由营业时间的长短决定。基本上，一天开12个小时，就是比开6个小时，收入高出一倍。每天只有24个小时，因此收入存在上限，不可能偏离平均水平很远。</span><br><span class=\"line\"></span><br><span class=\"line\">出租车是“时间换收入”的典型行业，投入的时间越多，收入越高，在家休息就没收入。很多行业都属于“时间换收入”，所有此类行业都赚不到大钱。因为你能用来交换的时间是有限的，而且进入中年以后，你就拿不出更多的时间来交换。开出租车赚零花钱，或者作为短期过渡，这是没问题的，但作为终身职业是很糟糕的。</span><br><span class=\"line\"></span><br><span class=\"line\">我觉得，越来越多的程序员正在落入这个陷井，用编码的时间换取收入。只有不停地做项目，才能拿到钱。项目做得越多，收入越高。这个项目开发完了，公司又让他去干下一个项目。 忙了好几年，项目完成了一大堆，但是自己什么也没留下，以后的收入还要取决于从零开始的新项目。这样的话，你跟出租车司机有何两样，哪一天你不写代码了，不是照样没收入。</span><br><span class=\"line\"></span><br><span class=\"line\">那些赚到大钱的人，没有一个是靠时间换取收入的。他们要么通过积累资产致富，要么购买他人的时间，为自己创造财富。你应该警惕，不要落入“时间换取收入”的陷井，不要只顾着为别人生产代码，而要注意积累自己的资产，以及适时开展属于自己的业务。</span><br></pre></td></tr></table></figure>\n\n<p>——<a href=\"https://www.yuque.com/ruanyf/share/issue-50\" target=\"_blank\" rel=\"noopener\">阮一峰每周分享第50期</a></p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">生活就像一盒巧克力，你永远不知道下一块是什么味道</span><br></pre></td></tr></table></figure>\n\n<p>——《阿甘正传》</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">车，马，邮件都慢</span><br><span class=\"line\">一生只够爱一个人</span><br></pre></td></tr></table></figure>\n\n<p>——《<a href=\"https://baike.baidu.com/item/%E4%BB%8E%E5%89%8D%E6%85%A2/17158480\" target=\"_blank\" rel=\"noopener\">从前慢</a>》 木心先生</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一个女孩让我帮她寄快递 给了我一个空纸箱让我打包 我好奇的问她:“这是寄给谁的” 她说:“我喜欢很久的一个男生” 我懵了一下:“可是里面没有东西啊” 她说:有些东西只有我自己能看见 我一听更懵逼了 神秘的问她到底是什么 她说:“一箱情愿”</span><br></pre></td></tr></table></figure>\n\n<p>——网易云音乐（虽然知道是假的，但是故事还是狠巧妙）</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">当你抬头奢求天空的时候，你要相信你的脚下踩有黄金。</span><br></pre></td></tr></table></figure>\n\n<p>——PowerPoint 2013设计小册（<a href=\"https://chunlife.top/2016/06/25/%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E5%8D%83%E9%87%8C%E4%B9%8B%E8%A1%8C/\">第二章 本章小结</a>）</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">就像高中夏天某个只有选修课的下午。就像再也买不到的橘子味巧克力。就像甜甜的回笼觉。</span><br></pre></td></tr></table></figure>\n\n<p>——在谢春花《借我》这首歌的网易云页面，有这样一条留言。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">不要放弃，不管多么痛苦，都不要逃往轻松的一边。</span><br></pre></td></tr></table></figure>\n\n<p>——鬼灭之刃 <em>我妻善逸</em>（糟糕的台词和名字）</p>\n","categories":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/categories/随笔/"}],"tags":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/tags/随笔/"}]},{"title":"stringSlice转换——无需内存copy","date":"2019-03-19T02:59:53.000Z","path":"2019/03/19/stringSlice转换——无需内存copy/","content":"<p>摘取自<a href=\"https://github.com/fagongzi/gateway\" target=\"_blank\" rel=\"noopener\"><strong>gateway</strong></a>，作者提到过这种方式，也是来源于另一个开源项目，操作方式极其硬核，故收藏了。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"String与Slice互转\"><a href=\"#String与Slice互转\" class=\"headerlink\" title=\"String与Slice互转\"></a>String与Slice互转</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> hack</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">   <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">   <span class=\"string\">\"unsafe\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SliceToString slice to string with out data copy</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceToString</span><span class=\"params\">(b []<span class=\"keyword\">byte</span>)</span> <span class=\"params\">(s <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">   pbytes := (*reflect.SliceHeader)(unsafe.Pointer(&amp;b))</span><br><span class=\"line\">   pstring := (*reflect.StringHeader)(unsafe.Pointer(&amp;s))</span><br><span class=\"line\">   pstring.Data = pbytes.Data</span><br><span class=\"line\">   pstring.Len = pbytes.Len</span><br><span class=\"line\">   <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// StringToSlice string to slice with out data copy</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">StringToSlice</span><span class=\"params\">(s <span class=\"keyword\">string</span>)</span> <span class=\"params\">(b []<span class=\"keyword\">byte</span>)</span></span> &#123;</span><br><span class=\"line\">   pbytes := (*reflect.SliceHeader)(unsafe.Pointer(&amp;b))</span><br><span class=\"line\">   pstring := (*reflect.StringHeader)(unsafe.Pointer(&amp;s))</span><br><span class=\"line\">   pbytes.Data = pstring.Data</span><br><span class=\"line\">   pbytes.Len = pstring.Len</span><br><span class=\"line\">   pbytes.Cap = pstring.Len</span><br><span class=\"line\">   <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里使用到了slice与string关键字在Go中的本质，直接对关键字的核心构造进行一系列操作，根本不讲Go语言的规矩，算是一种<code>黑魔法</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">string的本质：reflect.StringHeader&#123;&#125;</span><br><span class=\"line\">slice的本质：reflect.SliceHeader&#123;&#125;</span><br><span class=\"line\">go指针的本质：unsafe.Pointer&#123;&#125;、uintptr&#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>查看源码，可以找到Go编译器对slice与string的具体解释，均保留有一个指针，用于指向数据真正的地址。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type SliceHeader struct &#123;</span><br><span class=\"line\">    Data uintptr</span><br><span class=\"line\">    Len  int</span><br><span class=\"line\">    Cap  int</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">SliceHeader是切片的运行时表示。它不能被安全或便携地使用，其表示可能会在以后的版本中更改。此外，数据字段不足以保证它引用的数据不会被垃圾收集，因此程序必须保留一个单独的，正确键入的指向底层数据的指针。</span><br><span class=\"line\"></span><br><span class=\"line\">type StringHeader struct &#123;</span><br><span class=\"line\">    Data uintptr</span><br><span class=\"line\">    Len  int</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">StringHeader是字符串的运行时表示形式。</span><br></pre></td></tr></table></figure>\n\n<p><strong>另外</strong>，我们看到这俩结构体类似，内存布局也是类似的，只是<code>StringHeader</code>少了一个字段，但至少内存是对其的，那么？（C语言又在发威了~）</p>\n<p>注意：反过来转换不行，<code>StringHeader</code>对比<code>SliceHeader</code>少了一个字段</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">byteString</span><span class=\"params\">(b []<span class=\"keyword\">byte</span>)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> *(*<span class=\"keyword\">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"结构体与-byte\"><a href=\"#结构体与-byte\" class=\"headerlink\" title=\"结构体与[]byte\"></a>结构体与[]byte</h3><p>同理，结构体与[]byte也是可以互相转换的，可以用于优化<code>encoding/binady</code>的性能。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> MyStruct <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    A <span class=\"keyword\">int</span></span><br><span class=\"line\">    B <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取结构体真实数据的大小</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> sizeOfMyStruct = <span class=\"keyword\">int</span>(unsafe.Sizeof(MyStruct&#123;&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 填充[]byte的数据结构</span></span><br><span class=\"line\"><span class=\"comment\">// 结构体的数据指针也就是一个4字节的int类型（c基础知识！）</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">MyStructToBytes</span><span class=\"params\">(s *MyStruct)</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> x reflect.SliceHeader</span><br><span class=\"line\">    x.Len = sizeOfMyStruct</span><br><span class=\"line\">    x.Cap = sizeOfMyStruct</span><br><span class=\"line\">    x.Data = <span class=\"keyword\">uintptr</span>(unsafe.Pointer(s))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> *(*[]<span class=\"keyword\">byte</span>)(unsafe.Pointer(&amp;x))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// unsafe.Pointer(&amp;b)：取[]byte首地址</span></span><br><span class=\"line\"><span class=\"comment\">// (*reflect.SliceHeader)(unsafe.Pointer(&amp;b)) ： 强制转换其为reflect.SliceHeader指针</span></span><br><span class=\"line\"><span class=\"comment\">// (*reflect.SliceHeader)(unsafe.Pointer(&amp;b)).Data ： 将slice的数据指针取出来</span></span><br><span class=\"line\"><span class=\"comment\">// unsafe.Pointer((*reflect.SliceHeader)(unsafe.Pointer(&amp;b)).Data) : 将uint指针转成任意指针</span></span><br><span class=\"line\"><span class=\"comment\">// (*MyStruct)(unsafe.Pointer((*reflect.SliceHeader)(unsafe.Pointer(&amp;b)).Data))：成功转换</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">BytesToMyStruct</span><span class=\"params\">(b []<span class=\"keyword\">byte</span>)</span> *<span class=\"title\">MyStruct</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (*MyStruct)(unsafe.Pointer(</span><br><span class=\"line\">        (*reflect.SliceHeader)(unsafe.Pointer(&amp;b)).Data))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"写在后头\"><a href=\"#写在后头\" class=\"headerlink\" title=\"写在后头\"></a>写在后头</h3><p>上头写的东西，感觉有些突破语言既定的规范了，当然我这么想是有根据的，从源码注释上来看，显然，这个语言特性是不稳定的，指不定哪天Go开发人员觉着这个<code>黑魔法</code>不够魔性，直接不允许你这么做了。</p>\n<p><code>黑魔法</code>，也是被一些人诟病的地方吧，有好有坏，不了解也可以，了解了也不是不可。</p>\n<p><strong>注意</strong>：使用这种方式去转换，是无法对数据进行修改的。意思是，调用了<code>ToBytes</code>后得到的<code>[]byte</code>是没有办法改变的，一旦修改即会出现<code>unexpected fault address xxxxx</code>，<strong>只可读，而没有写操作的能力，切记切记</strong>，<img src=\"sort%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%BD%BF%E7%94%A8.png\" alt=\"img\">。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ToString unsafe 转换, 将 []byte 转换为 string</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">ToString</span><span class=\"params\">(p []<span class=\"keyword\">byte</span>)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> *(*<span class=\"keyword\">string</span>)(unsafe.Pointer(&amp;p))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ToBytes unsafe 转换, 将 string 转换为 []byte</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">ToBytes</span><span class=\"params\">(str <span class=\"keyword\">string</span>)</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> *(*[]<span class=\"keyword\">byte</span>)(unsafe.Pointer(&amp;str))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// IntToBool int 类型转换为 bool</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">IntToBool</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> i != <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SliceInt64ToString []int64 转换为 []string</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceInt64ToString</span><span class=\"params\">(si []<span class=\"keyword\">int64</span>)</span> <span class=\"params\">(ss []<span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">\tss = <span class=\"built_in\">make</span>([]<span class=\"keyword\">string</span>, <span class=\"number\">0</span>, <span class=\"built_in\">len</span>(si))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> k := <span class=\"keyword\">range</span> si &#123;</span><br><span class=\"line\">\t\tss = <span class=\"built_in\">append</span>(ss, strconv.FormatInt(si[k], <span class=\"number\">10</span>))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ss</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SliceStringToInt64 []string 转换为 []int64</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceStringToInt64</span><span class=\"params\">(ss []<span class=\"keyword\">string</span>)</span> <span class=\"params\">(si []<span class=\"keyword\">int64</span>)</span></span> &#123;</span><br><span class=\"line\">\tsi = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int64</span>, <span class=\"number\">0</span>, <span class=\"built_in\">len</span>(ss))</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> (</span><br><span class=\"line\">\t\ti   <span class=\"keyword\">int64</span></span><br><span class=\"line\">\t\terr error</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> k := <span class=\"keyword\">range</span> ss &#123;</span><br><span class=\"line\">\t\ti, err = strconv.ParseInt(ss[k], <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tsi = <span class=\"built_in\">append</span>(si, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SliceStringToInt []string 转换为 []int</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceStringToInt</span><span class=\"params\">(ss []<span class=\"keyword\">string</span>)</span> <span class=\"params\">(si []<span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tsi = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">0</span>, <span class=\"built_in\">len</span>(ss))</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> (</span><br><span class=\"line\">\t\ti   <span class=\"keyword\">int</span></span><br><span class=\"line\">\t\terr error</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> k := <span class=\"keyword\">range</span> ss &#123;</span><br><span class=\"line\">\t\ti, err = strconv.Atoi(ss[k])</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tsi = <span class=\"built_in\">append</span>(si, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// MustInt 将string转换为int, 忽略错误</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">MustInt</span><span class=\"params\">(s <span class=\"keyword\">string</span>)</span> <span class=\"params\">(n <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tn, _ = strconv.Atoi(s)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// MustInt64 将string转换为int64, 忽略错误</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">MustInt64</span><span class=\"params\">(s <span class=\"keyword\">string</span>)</span> <span class=\"params\">(i <span class=\"keyword\">int64</span>)</span></span> &#123;</span><br><span class=\"line\">\ti, _ = strconv.ParseInt(s, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"函数","slug":"函数","permalink":"chunlife.top/tags/函数/"}]},{"title":"记录以前使用linux的一些命令","date":"2019-03-19T02:19:44.000Z","path":"2019/03/19/记录以前使用linux的一些命令/","content":"<p>1、find</p>\n<p>find使用在查找大型代码结构的项目时，特别有用，例如linux内核。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在某一目录下查找文件名包含“fb”字样的文件</span><br><span class=\"line\">find -name &quot;*fb*&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">在内核的drivers/net目录下查找文件名包含“fb”字样的文件</span><br><span class=\"line\">find drivers/net -name &quot;*fb*&quot;</span><br></pre></td></tr></table></figure>\n\n<p>2、grep</p>\n<p>针对某些函数，需要对代码进行彻查，查看函数调用的位置。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查找当前目录下的所有文件、目录</span><br><span class=\"line\">grep &quot;request&quot; * -nR</span><br></pre></td></tr></table></figure>\n\n<p>3、ldd</p>\n<p>命令用于判断某个可执行的 binary 档案含有什么动态函式库，这个可能是在嵌入式方向中用到的机会比较多。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--version　　       打印ldd的版本号</span><br><span class=\"line\">-v --verbose　　  打印所有信息，例如包括符号的版本信息</span><br><span class=\"line\">-d --data-relocs　执行符号重部署，并报告缺少的目标对象（只对ELF格式适用）</span><br><span class=\"line\">-r --function-relocs　对目标对象和函数执行重新部署，并报告缺少的目标对象和函数（只对ELF格式适用）</span><br><span class=\"line\">--help 用法信息</span><br></pre></td></tr></table></figure>\n\n<p>4、Shell取出^M</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat -v buildprod.sh | tr -d '^M'  &gt; b1.sh</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/categories/Linux/"}],"tags":[{"name":"linux","slug":"linux","permalink":"chunlife.top/tags/linux/"}]},{"title":"sort接口的使用","date":"2019-03-15T09:01:53.000Z","path":"2019/03/15/sort接口的使用/","content":"<p>该包实现了四种基本排序算法：插入排序、归并排序、堆排序和快速排序。（看到网上貌似有些文章漏掉了堆排序，不知道是不是以前的<code>go</code>没有堆排序）</p>\n<a id=\"more\"></a>\n\n<p>这四种排序方法是不公开的，它们只被用于sort包内部使用，由语言自动选择排序方式。</p>\n<h3 id=\"1、基础类型排序\"><a href=\"#1、基础类型排序\" class=\"headerlink\" title=\"1、基础类型排序\"></a>1、基础类型排序</h3><p>排序是在内部进行的，并不会返回一个新的切片。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"sort\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    strs := []<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"c\"</span>, <span class=\"string\">\"a\"</span>, <span class=\"string\">\"b\"</span>&#125;</span><br><span class=\"line\">    sort.Strings(strs)</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"Strings:\"</span>, strs)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// An example of sorting `int`s.</span></span><br><span class=\"line\">    ints := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">7</span>, <span class=\"number\">2</span>, <span class=\"number\">4</span>&#125;</span><br><span class=\"line\">    sort.Ints(ints)</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"Ints:   \"</span>, ints)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 检查slice是否是排序状态</span></span><br><span class=\"line\">    s := sort.IntsAreSorted(ints)</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"Sorted: \"</span>, s)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、自定义排序\"><a href=\"#2、自定义排序\" class=\"headerlink\" title=\"2、自定义排序\"></a>2、自定义排序</h3><p>实现 sort.Interface 的三个方法，Len，Swap，Less。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Interface <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Len is the number of elements in the collection.</span></span><br><span class=\"line\">        Len() <span class=\"keyword\">int</span></span><br><span class=\"line\">        <span class=\"comment\">// Less reports whether the element with</span></span><br><span class=\"line\">        <span class=\"comment\">// index i should sort before the element with index j.</span></span><br><span class=\"line\">        Less(i, j <span class=\"keyword\">int</span>) <span class=\"keyword\">bool</span></span><br><span class=\"line\">        <span class=\"comment\">// Swap swaps the elements with indexes i and j.</span></span><br><span class=\"line\">        Swap(i, j <span class=\"keyword\">int</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>代码示例：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"sort\"</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> byLength []<span class=\"keyword\">string</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s byLength)</span> <span class=\"title\">Len</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(s)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s byLength)</span> <span class=\"title\">Swap</span><span class=\"params\">(i, j <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">    s[i], s[j] = s[j], s[i]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s byLength)</span> <span class=\"title\">Less</span><span class=\"params\">(i, j <span class=\"keyword\">int</span>)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(s[i]) &lt; <span class=\"built_in\">len</span>(s[j])</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    fruits := []<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"peach\"</span>, <span class=\"string\">\"banana\"</span>, <span class=\"string\">\"kiwi\"</span>&#125;</span><br><span class=\"line\">    sort.Sort(byLength(fruits))</span><br><span class=\"line\">    fmt.Println(fruits)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 生成递减序列</span></span><br><span class=\"line\">    sort.Sort(sort.Reverse(byLength(fruits)))</span><br><span class=\"line\">    fmt.Println(fruits)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"函数","slug":"函数","permalink":"chunlife.top/tags/函数/"},{"name":"排序","slug":"排序","permalink":"chunlife.top/tags/排序/"},{"name":"sort","slug":"sort","permalink":"chunlife.top/tags/sort/"}]},{"title":"移动文件或文件夹","date":"2019-03-15T06:29:30.000Z","path":"2019/03/15/移动文件或文件夹/","content":"<p>golang 移动（重命名）文件或文件夹，移动文件到目标位置时，不会自动创建目标位置的文件夹。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"os\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\terr := os.Rename(<span class=\"string\">\"./tmp\"</span>, <span class=\"string\">\"./tmp1\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"文件处理小程序","slug":"文件处理小程序","permalink":"chunlife.top/tags/文件处理小程序/"}]},{"title":"MongoDB ObjectID生成","date":"2019-03-15T03:10:14.000Z","path":"2019/03/15/MongoDB ObjectID生成/","content":"<p>在项目中需要用到一个随机数，将其作为唯一且无法重复，第一个想到的就是MongoDB里面的objectID，将其作为一个唯一且不重复的键值。</p>\n<a id=\"more\"></a>\n\n<p>ObjectId是一个12字节的 BSON 类型字符串。按照字节顺序，一次代表：</p>\n<ul>\n<li>4字节：UNIX时间戳 </li>\n<li>3字节：表示运行MongoDB的机器 </li>\n<li>2字节：表示生成此_id的进程 </li>\n<li>3字节：由一个随机数开始的计数器生成的值 </li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// machineId stores machine id generated once and used in subsequent calls</span></span><br><span class=\"line\"><span class=\"comment\">// to NewObjectId function.</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> machineId = readMachineId()</span><br><span class=\"line\"><span class=\"keyword\">var</span> processId = os.Getpid()</span><br><span class=\"line\"><span class=\"comment\">// objectIdCounter is atomically incremented when generating a new ObjectId</span></span><br><span class=\"line\"><span class=\"comment\">// using NewObjectId() function. It's used as a counter part of an id.</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> objectIdCounter = readRandomUint32()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// readRandomUint32 returns a random objectIdCounter.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readRandomUint32</span><span class=\"params\">()</span> <span class=\"title\">uint32</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> b [<span class=\"number\">4</span>]<span class=\"keyword\">byte</span></span><br><span class=\"line\">\t_, err := io.ReadFull(rand.Reader, b[:])</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(fmt.Errorf(<span class=\"string\">\"cannot read random object id: %v\"</span>, err))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">uint32</span>((<span class=\"keyword\">uint32</span>(b[<span class=\"number\">0</span>]) &lt;&lt; <span class=\"number\">0</span>) | (<span class=\"keyword\">uint32</span>(b[<span class=\"number\">1</span>]) &lt;&lt; <span class=\"number\">8</span>) | (<span class=\"keyword\">uint32</span>(b[<span class=\"number\">2</span>]) &lt;&lt; <span class=\"number\">16</span>) | (<span class=\"keyword\">uint32</span>(b[<span class=\"number\">3</span>]) &lt;&lt; <span class=\"number\">24</span>))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// readMachineId generates and returns a machine id.</span></span><br><span class=\"line\"><span class=\"comment\">// If this function fails to get the hostname it will cause a runtime error.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readMachineId</span><span class=\"params\">()</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> sum [<span class=\"number\">3</span>]<span class=\"keyword\">byte</span></span><br><span class=\"line\">\tid := sum[:]</span><br><span class=\"line\">\thostname, err1 := os.Hostname()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err1 != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t_, err2 := io.ReadFull(rand.Reader, id)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err2 != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">panic</span>(fmt.Errorf(<span class=\"string\">\"cannot get hostname: %v; %v\"</span>, err1, err2))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> id</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\thw := md5.New()</span><br><span class=\"line\">\thw.Write([]<span class=\"keyword\">byte</span>(hostname))</span><br><span class=\"line\">\t<span class=\"built_in\">copy</span>(id, hw.Sum(<span class=\"literal\">nil</span>))</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> id</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// NewObjectId returns a new unique ObjectId.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewObjectId</span><span class=\"params\">()</span> <span class=\"title\">ObjectId</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> b [<span class=\"number\">12</span>]<span class=\"keyword\">byte</span></span><br><span class=\"line\">\t<span class=\"comment\">// Timestamp, 4 bytes, big endian</span></span><br><span class=\"line\">\tbinary.BigEndian.PutUint32(b[:], <span class=\"keyword\">uint32</span>(time.Now().Unix()))</span><br><span class=\"line\">\t<span class=\"comment\">// Machine, first 3 bytes of md5(hostname)</span></span><br><span class=\"line\">\tb[<span class=\"number\">4</span>] = machineId[<span class=\"number\">0</span>]</span><br><span class=\"line\">\tb[<span class=\"number\">5</span>] = machineId[<span class=\"number\">1</span>]</span><br><span class=\"line\">\tb[<span class=\"number\">6</span>] = machineId[<span class=\"number\">2</span>]</span><br><span class=\"line\">\t<span class=\"comment\">// Pid, 2 bytes, specs don't specify endianness, but we use big endian.</span></span><br><span class=\"line\">\tb[<span class=\"number\">7</span>] = <span class=\"keyword\">byte</span>(processId &gt;&gt; <span class=\"number\">8</span>)</span><br><span class=\"line\">\tb[<span class=\"number\">8</span>] = <span class=\"keyword\">byte</span>(processId)</span><br><span class=\"line\">\t<span class=\"comment\">// Increment, 3 bytes, big endian</span></span><br><span class=\"line\">\ti := atomic.AddUint32(&amp;objectIdCounter, <span class=\"number\">1</span>)</span><br><span class=\"line\">\tb[<span class=\"number\">9</span>] = <span class=\"keyword\">byte</span>(i &gt;&gt; <span class=\"number\">16</span>)</span><br><span class=\"line\">\tb[<span class=\"number\">10</span>] = <span class=\"keyword\">byte</span>(i &gt;&gt; <span class=\"number\">8</span>)</span><br><span class=\"line\">\tb[<span class=\"number\">11</span>] = <span class=\"keyword\">byte</span>(i)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ObjectId(b[:])</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"MongoDB-objectID改变\"><a href=\"#MongoDB-objectID改变\" class=\"headerlink\" title=\"MongoDB objectID改变\"></a>MongoDB objectID改变</h2><p>在golang的MongoDB官方库中，objectID的生成方式发生了改变。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// \"go.mongodb.org/mongo-driver/bson/primitive\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> objectIDCounter = readRandomUint32()</span><br><span class=\"line\"><span class=\"keyword\">var</span> processUnique = processUniqueBytes()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// NewObjectID generates a new ObjectID.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewObjectID</span><span class=\"params\">()</span> <span class=\"title\">ObjectID</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> b [<span class=\"number\">12</span>]<span class=\"keyword\">byte</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tbinary.BigEndian.PutUint32(b[<span class=\"number\">0</span>:<span class=\"number\">4</span>], <span class=\"keyword\">uint32</span>(time.Now().Unix()))</span><br><span class=\"line\">\t<span class=\"built_in\">copy</span>(b[<span class=\"number\">4</span>:<span class=\"number\">9</span>], processUnique[:])</span><br><span class=\"line\">\tputUint24(b[<span class=\"number\">9</span>:<span class=\"number\">12</span>], atomic.AddUint32(&amp;objectIDCounter, <span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> b</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看到这12字节，已改为，4字节unix时间戳+5字节随机值+随机值加上1。</p>\n<p>查看<a href=\"https://docs.mongodb.com/manual/reference/method/ObjectId/#objectid\" target=\"_blank\" rel=\"noopener\">官方文档</a>也可以发现，其对objectID的定义已经更改。</p>\n<ul>\n<li>a 4-byte value representing the seconds since the Unix epoch,</li>\n<li>a 5-byte random value, and</li>\n<li>a 3-byte counter, starting with a random value.</li>\n</ul>\n<p>只找到一篇博客对这个修改的推测，我也确实没有找到确切的修改理由，我认为博主说的有些道理。</p>\n<blockquote>\n<p>引用自：<a href=\"https://blog.wolfogre.com/posts/mongo-objectid-design/\" target=\"_blank\" rel=\"noopener\">Mongo ObjectId 早就不用机器标识和进程号了</a></p>\n<p> mongo 的 C++ 源码中，设置 ObjectId 中间 5 个字节的函数叫 <code>setInstanceUnique</code>，而在官方 golang 驱动中叫 <code>processUnique</code>，字面意思相近，都是说明这个值的作用是“区分不同进程实例”，而这个值具体怎么实现并没有什么要求，所以，使用“机器标识+进程号”来拿区分不同进程实例是可以的，使用互无关联的随机数来拿区分不同进程实例也是可以的。</p>\n<p>可想而知，“在同一秒内，两个进程实例产生了相同的 5 字节随机数，且刚巧这时候两个进程的自增计数器的值也是相同的”——这种情况发生的概率实在太低了，完全可以认为不可能发生，所以使用互无关联的随机数来拿区分不同进程实例是完全合乎需求的。</p>\n<p>那问题来了，为什么不继续使用“机器标识+进程号”呢？主观臆测开始。</p>\n<p>问题就在于，机器标识和进程号一定就那么可靠吗，尤其在这个物理机鲜见，虚拟机、云主机、容器横行的时代？</p>\n<p>先说机器标识码，ObjectId 的机器标识码是取系统 hostname 哈希值的前几位，问题来了，想必在座的各位都有干过吧：准备了几台虚拟机，hostname 都是默认的 localhost，谁都想着这玩意儿能有什么用，还得刻意给不同机器起不同的 hostname？此外，hostname 在容器、云主机里一般默认就是随机数，也不会检查同一集群里是否有 hostname 重名。</p>\n<p>再说进程号，这个问题就更大了，要知道，容器内的进程拥有自己独立的进程空间，在这个空间里只用它自己这一个进程（以及它的子进程），所以它的进程号永远都是 1。也就是说，如果某个服务（既可以是 mongo 实例也可以是 mongo 客户端）是使用容器部署的，无论部署多少个实例，在这个服务上生成的 ObjectId，第八第九个字节恒为 <code>0000 0001</code>，相当于说这两个字节废了。</p>\n<p>综上，与其使用一个固定值来“区分不同进程实例”，且这个固定值还是人类随意设置或随机生成的 hostname 加上一个可能恒为 1 的进程号，倒不如每次都随机生成一个新值。</p>\n</blockquote>\n","categories":[{"name":"MongoDB","slug":"MongoDB","permalink":"chunlife.top/categories/MongoDB/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"MongoDB","slug":"MongoDB","permalink":"chunlife.top/tags/MongoDB/"}]},{"title":"Go API统一注释说明","date":"2019-03-14T14:42:02.000Z","path":"2019/03/14/Go API统一注释说明/","content":"<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>​    运行下面指令后会在$GOPATH/bin中生成一个apidoc的可执行程序</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd $GOPATH/src/github.com/caixw/</span><br><span class=\"line\"></span><br><span class=\"line\">git clone https://github.com/caixw/apidoc.git</span><br><span class=\"line\"></span><br><span class=\"line\">cd $GOPATH/src/github.com/caixw/apidoc</span><br><span class=\"line\"></span><br><span class=\"line\">git checkout v3.0</span><br><span class=\"line\"></span><br><span class=\"line\">go build</span><br><span class=\"line\"></span><br><span class=\"line\">cp apidoc $GOPATH/bin/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"生成流程\"><a href=\"#生成流程\" class=\"headerlink\" title=\"生成流程\"></a>生成流程</h3><ol>\n<li>在项目工程目录下生成apidoc配置文件：</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apidoc -g</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>在代码中每个API接口处理函数前加一些特殊的注释，注释格式见下文</li>\n<li>注释完后运行<code>apidoc</code> ，即在当前目录的<strong>doc</strong>目录生成相应项目的文档</li>\n<li>打开相应的html即可阅读</li>\n</ol>\n<h3 id=\"注释格式\"><a href=\"#注释格式\" class=\"headerlink\" title=\"注释格式\"></a>注释格式</h3><p>​    在写代码时，需要在代码中加上特定格式的注释，以便用apidoc生成文档。</p>\n<ul>\n<li>项目文档的描述：在项目的<strong>某一个源文件（推荐main.go）的开头</strong>加上该项目文档的注释</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * @apidoc &lt;title of doc&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiVersion &lt;version&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiBaseURL &lt;domain&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiContent</span></span><br><span class=\"line\"><span class=\"comment\"> * 描述，可以多行，支持html</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n\n<p>​    &lt;title of doc&gt;填写为文档的名称</p>\n<p>​    &lt;version&gt;为文档的版本</p>\n<p>​    &lt;domain&gt;问API的域名，比如<a href=\"https://test.com\" target=\"_blank\" rel=\"noopener\">https://test.com</a></p>\n<p>​    例子：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * @apidoc USER模块API接口</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiVersion V0.1</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiBaseURL https://www.wukoon-app.com</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiContent</span></span><br><span class=\"line\"><span class=\"comment\"> * 描述，可以多行，支持html</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>API的描述：在需要导出的<strong>API相应处理函数</strong>前加上特定的注释</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * @api &lt;method&gt; &lt;url&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiGroup &lt;group&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiQuery &lt;QueryName&gt; &lt;type&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> </span></span><br><span class=\"line\"><span class=\"comment\"> * @apiRequest json</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiHeader &lt;key&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam &lt;ParamName&gt; &lt;type&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiExample json</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;body data example in json format&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> </span></span><br><span class=\"line\"><span class=\"comment\"> * @apiSuccess &lt;status&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam &lt;ParamName&gt; &lt;type&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiExample json</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;Success data in json format&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> </span></span><br><span class=\"line\"><span class=\"comment\"> * @apiError &lt;status&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam &lt;ParamName&gt; &lt;type&gt; &lt;summary&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiExample json</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;fail data in json format&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n\n<p>​    &lt;method&gt;是API的HTTP method，比如GET</p>\n<p>​    &lt;url&gt;是API的路径，比如/api/v1/user/user</p>\n<p>​    &lt;summary&gt;是简要说明</p>\n<p>​    &lt;group&gt;对 api 的分组信息，不同的分组，最终可能会被呈现在不同的页面。</p>\n<p>​    &lt;QueryName&gt;Query的名称</p>\n<p>​       &lt;type&gt; Query的类型，比如int，string等</p>\n<p>​    &lt;key&gt;HTTP请求头字段，有需要指定的话可以使用</p>\n<p>​    &lt;ParamName&gt; 请求参数名称</p>\n<p>​    &lt;body data example in json format&gt;请求body的例子</p>\n<p>​    &lt;status&gt;HTTP状态码，比如200</p>\n<p>​    &lt;Success data in json format&gt;成功返回数据例子</p>\n<p>​    &lt;fail data in json format&gt;错误返回数据例子</p>\n<p>​    例子：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * @api PUT /api/v1/user/user 修改用户profile</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiGroup user</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiQuery userid int 执行修改请求的用户id</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiQuery token string 执行修改请求的用户token</span></span><br><span class=\"line\"><span class=\"comment\"> </span></span><br><span class=\"line\"><span class=\"comment\"> * @apiRequest json</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiHeader session 12345</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam userid int 要修改的用户id</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam name string 将用户id对应的名称修改为name</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiExample json</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;\"userid\":1,\"name\":\"wubo\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> </span></span><br><span class=\"line\"><span class=\"comment\"> * @apiSuccess 200 OK</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam errcode int 错误代码</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam errmsg string 错误信息</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiExample json</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;\"errcode\":0,\"errmsg\":\"ok\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> </span></span><br><span class=\"line\"><span class=\"comment\"> * @apiError 200 OK</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam errcode int 错误代码</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiParam errmsg string 错误信息</span></span><br><span class=\"line\"><span class=\"comment\"> * @apiExample json</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;\"errcode\":30002,\"errmsg\":\"invalid parameter\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p>apidoc项目：<a href=\"https://github.com/caixw/apidoc\" target=\"_blank\" rel=\"noopener\">https://github.com/caixw/apidoc</a></p>\n<p>apidoc文档：<a href=\"http://apidoc.tools/\" target=\"_blank\" rel=\"noopener\">http://apidoc.tools/</a></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"apidoc","slug":"apidoc","permalink":"chunlife.top/tags/apidoc/"},{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"}]},{"title":"ElasticSearch数据迁移","date":"2019-03-14T14:41:15.000Z","path":"2019/03/14/ElasticSearch数据迁移/","content":"<p>在机器上进行归档数据，需要借助的是<code>reindex</code>API。</p>\n<a id=\"more\"></a>\n\n<h4 id=\"1、第一步\"><a href=\"#1、第一步\" class=\"headerlink\" title=\"1、第一步\"></a>1、第一步</h4><p>迁移数据前，在ES中创建对应的index以及mapping。</p>\n<p>例如：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"settings\"</span>: &#123; </span><br><span class=\"line\">        <span class=\"string\">\"number_of_shards\"</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">\"number_of_replicas\"</span>:<span class=\"number\">0</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"mappings\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"time\"</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">\"type\"</span> : <span class=\"string\">\"integer\"</span></span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">\"uid\"</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">\"type\"</span> : <span class=\"string\">\"text\"</span></span><br><span class=\"line\">          &#125;，</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>为了加快数据迁移，将 <code>refresh_interval</code> 置为-1，<code>number_of_replicas</code> 置为0：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT -H &apos;Content-type&apos;:&apos;application/json&apos; &#123;some ip&#125;:9200/&#123;index&#125;/_settings -d </span><br><span class=\"line\">&apos;&#123;</span><br><span class=\"line\">    &quot;index&quot;: &#123;</span><br><span class=\"line\">        &quot;refresh_interval&quot;: -1,</span><br><span class=\"line\">        &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;&apos;</span><br></pre></td></tr></table></figure>\n\n<p><code>refresh_interval</code>：文档自动刷新功能，文档的变化并不是立即对搜索实时可见的，需要进行一次刷新；</p>\n<p><code>number_of_replicas</code> ：创建副本，存储备份用，在导入时，关闭以节省时间。</p>\n<h4 id=\"2、第二步\"><a href=\"#2、第二步\" class=\"headerlink\" title=\"2、第二步\"></a>2、第二步</h4><p>使用reindex-from-remote来同步数据</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPOST -H &apos;Content-type&apos;:&apos;application/json&apos; http://127.0.0.1:9200/_reindex?pretty -d &apos;&#123;</span><br><span class=\"line\">    &quot;conflicts&quot;: &quot;proceed&quot;,</span><br><span class=\"line\">    &quot;source&quot;: &#123;</span><br><span class=\"line\">        &quot;remote&quot;:&#123;</span><br><span class=\"line\">            &quot;host&quot;:&quot;http://127.0.0.1:9200&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;index&quot;:&quot;produce_record&quot;,</span><br><span class=\"line\">        &quot;query&quot;: &#123;</span><br><span class=\"line\">         &quot;match&quot;: &#123;</span><br><span class=\"line\">            &quot;test&quot;: &quot;data&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;，</span><br><span class=\"line\">        &quot;size&quot;:1000</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;dest&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;produce_record_v1&quot;,</span><br><span class=\"line\">        &quot;version_type&quot;: &quot;external&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;&apos;</span><br></pre></td></tr></table></figure>\n\n<p><code>conflicts</code>：导入过程中，源文档和目标文档出现冲突，不会导致导入失败。</p>\n<p><code>version_type</code>为”external”，当目标文档中_id相同时，将保留文档，而不是去覆盖；</p>\n<p>“internal”则是直接覆盖。</p>\n<h4 id=\"3、第三步\"><a href=\"#3、第三步\" class=\"headerlink\" title=\"3、第三步\"></a>3、第三步</h4><p>将 <code>refresh_interval</code>、<code>number_of_replicas</code> 分别设置回”30s”和1。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT -H 'Content-type':'application/json' &#123;some ip&#125;:9200/&#123;index&#125;/_settings -d </span><br><span class=\"line\">'&#123;</span><br><span class=\"line\">    \"index\": &#123;</span><br><span class=\"line\">        \"refresh_interval\": \"30s\",</span><br><span class=\"line\">        \"number_of_replicas\": 1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;'</span><br></pre></td></tr></table></figure>\n\n<p>ElasticSearch集群方案：</p>\n<p>使用多节点，冷热数据分离的方式，也就是将读写I/O进行区分，在master上进行写操作，大量read操作分散到集群节点上。</p>\n<p><a href=\"https://blog.csdn.net/jiao_fuyou/article/details/78354327\" target=\"_blank\" rel=\"noopener\">Elasticsearch集群冷热分离-实际操作</a></p>\n<p><a href=\"https://blog.csdn.net/eases_stone/article/details/82181244\" target=\"_blank\" rel=\"noopener\">elasticsearch5.x系列之八冷热数据分离方案</a></p>\n","categories":[{"name":"Elastic Search","slug":"Elastic-Search","permalink":"chunlife.top/categories/Elastic-Search/"}],"tags":[{"name":"elasticsearch","slug":"elasticsearch","permalink":"chunlife.top/tags/elasticsearch/"}]},{"title":"etcd配置中心——confd/viper","date":"2019-02-28T02:16:35.000Z","path":"2019/02/28/学习使用confd/","content":"<p>配置中心的使用呢，之前在项目中使用的是<a href=\"https://github.com/spf13/viper\" target=\"_blank\" rel=\"noopener\">viper</a>（现在又给改回去了，误解了viper的操作），但根据实际测试以及在GitHub的<a href=\"https://github.com/spf13/viper/issues?utf8=✓&q=is%3Aissue+concurrent+map+read+and+map+write+\" target=\"_blank\" rel=\"noopener\">issue</a>中看到的帖子，看到viper是线程不安全的（确实是不安全的）。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"viper\"><a href=\"#viper\" class=\"headerlink\" title=\"viper\"></a>viper</h2><p>函数<code>WatchRemoteConfig</code>可以监听ETCD KEY，但实际上这些操作在源码中都没出现加锁的操作，这里我对viper这么受欢迎的库在远端监听时不支持线程安全表示怀疑，因为我在官方README中并没有见到有特地提到说不能在并发环境中使用的注意事项，我想，事情可能并不是那么简单，现实是，事情可能就是这个样子的，监听远程key确实只能在一个协程中进行（为什么需要开多个协程去监听呢？）。</p>\n<p>使用<code>WatchRemoteConfig()</code>，viper会重新获取key中的所有数据，我们需使用<code>Unmarshal</code>将数据进行序列化保存，但这里可以不去<code>Unmarshal</code>，直接使用类似于<code>viper.GetString(&quot;logfile&quot;)</code>去获取key-value。</p>\n<p><strong>注意</strong>：这里就是问题出现的点了，使用<code>viper.GetString(&quot;logfile&quot;)</code>获取数据，相当于从一个map中直接拿数据，要知道，map是不能并发读和并发写的，所以会引发<code>concurrent map read and map write</code>。</p>\n<p>问题找到了，那么viper的用法呢，其实也没有错，但需要注意的是，我们确实<strong>只能</strong>在一个协程中使用viper，且我们在获取到数据后，最好是使用带锁的map或是并发<code>sync.Map</code>将数据保存起来，而不是使用<code>viper.GetString</code>去从viper的缓存中获取数据，我们不应该<code>信任</code>viper。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> runtime_viper = viper.New()</span><br><span class=\"line\"></span><br><span class=\"line\">runtime_viper.AddRemoteProvider(<span class=\"string\">\"etcd\"</span>, <span class=\"string\">\"http://127.0.0.1:4001\"</span>, <span class=\"string\">\"/config/hugo.yml\"</span>)</span><br><span class=\"line\">runtime_viper.SetConfigType(<span class=\"string\">\"yaml\"</span>) <span class=\"comment\">// because there is no file extension in a stream of bytes, supported extensions are \"json\", \"toml\", \"yaml\", \"yml\", \"properties\", \"props\", \"prop\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// read from remote config the first time.</span></span><br><span class=\"line\">err := runtime_viper.ReadRemoteConfig()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// unmarshal config</span></span><br><span class=\"line\">runtime_viper.Unmarshal(&amp;runtime_conf)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// open a goroutine to watch remote changes forever</span></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t    time.Sleep(time.Second * <span class=\"number\">5</span>) <span class=\"comment\">// delay after each request</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t    <span class=\"comment\">// currently, only tested with etcd support</span></span><br><span class=\"line\">\t    err := runtime_viper.WatchRemoteConfig()</span><br><span class=\"line\">\t    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t        log.Errorf(<span class=\"string\">\"unable to read remote config: %v\"</span>, err)</span><br><span class=\"line\">\t        <span class=\"keyword\">continue</span></span><br><span class=\"line\">\t    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t    <span class=\"comment\">// unmarshal new config into our runtime config struct. you can also use channel</span></span><br><span class=\"line\">\t    <span class=\"comment\">// to implement a signal to notify the system of the changes</span></span><br><span class=\"line\">\t    runtime_viper.Unmarshal(&amp;runtime_conf)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 使用线程安全的sync.Map进行保存</span></span><br><span class=\"line\">        SyncCfgMap.Store(<span class=\"string\">\"config\"</span>, &amp;runtime_conf)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;()</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"confd安装\"><a href=\"#confd安装\" class=\"headerlink\" title=\"confd安装\"></a>confd安装</h2><p><a href=\"https://blog.csdn.net/bbwangj/article/details/82953786\" target=\"_blank\" rel=\"noopener\">confd的安装与使用</a></p>\n<p><a href=\"https://github.com/kelseyhightower/confd\" target=\"_blank\" rel=\"noopener\">confd</a>网上资料很多了，基本上算是比较好配置的了，没有什么坑可以占，麻烦点的就是对于解析的配置。</p>\n<p>一般的，confd两个目录：conf.d，templates。</p>\n<p><code>conf.d</code>目录下的一个配置文件，代表将输出一个配置。而输出这些配置的依据或者是规则，放置于templates目录下，语法需要参考confd官方的<a href=\"https://github.com/kelseyhightower/confd/blob/master/docs/templates.md\" target=\"_blank\" rel=\"noopener\">文档</a>。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"etcd","slug":"etcd","permalink":"chunlife.top/tags/etcd/"},{"name":"confd","slug":"confd","permalink":"chunlife.top/tags/confd/"},{"name":"viper","slug":"viper","permalink":"chunlife.top/tags/viper/"}]},{"title":"baiduPCS学习","date":"2019-02-22T03:16:41.000Z","path":"2019/02/22/baiduPCS学习/","content":"<p>首先，百度云是一个非常好用的网盘，因为之前限速是在限得太过于厉害，无法忍受，在网上找了很多工具，其中就有<a href=\"https://github.com/iikira/BaiduPCS-Go\" target=\"_blank\" rel=\"noopener\">BaiduPCS-Go</a>，不得不说特别的好用，之前在此基础上，我添加了一个同步文件夹的功能，感觉代码挺简陋的，所以我也不好意思PR，这里主要是我想把项目中一些可以复用的函数给抽取出来，以便我日后翻阅吧。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Trigger 用于触发事件</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Trigger</span><span class=\"params\">(f <span class=\"keyword\">func</span>()</span>)</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> f == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> f()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// TriggerOnSync 用于触发事件, 同步触发</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">TriggerOnSync</span><span class=\"params\">(f <span class=\"keyword\">func</span>()</span>)</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> f == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tf()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>delay是利用了channel的阻塞性质，以及关闭channel后，接受channel语句会获取数据，不再阻塞，这也就达到了delay的作用。（直接使用定时器也没啥毛病）</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// NewDelayChan 发送延时信号</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewDelayChan</span><span class=\"params\">(t time.Duration)</span> &lt;-<span class=\"title\">chan</span> <span class=\"title\">struct</span></span>&#123;&#125; &#123;</span><br><span class=\"line\">   c := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span>&#123;&#125;)</span><br><span class=\"line\">   <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">      time.Sleep(t)</span><br><span class=\"line\">      <span class=\"built_in\">close</span>(c)</span><br><span class=\"line\">   &#125;()</span><br><span class=\"line\">   <span class=\"keyword\">return</span> c</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// &lt;-delayChan</span></span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"golang基础知识","slug":"golang基础知识","permalink":"chunlife.top/categories/golang基础知识/"}],"tags":[{"name":"go","slug":"go","permalink":"chunlife.top/tags/go/"},{"name":"函数","slug":"函数","permalink":"chunlife.top/tags/函数/"}]},{"title":"mysql并发操作","date":"2019-02-21T01:45:11.000Z","path":"2019/02/21/mysql并发操作/","content":"<p>在项目中，遇到个并发问题，虽然不是个大问题，但确实是之前没考虑到的，具体体现类似于余额扣减，多个客户端同时访问web接口，导致临界数据计算出现异常。此时就代表着我可能就碰到了一个并发问题了。</p>\n<a id=\"more\"></a>\n\n<p>这里资料主要是参考了：</p>\n<p>知乎上的回答：<a href=\"https://www.zhihu.com/question/61484424\" target=\"_blank\" rel=\"noopener\">高并发下怎么做余额扣减？</a></p>\n<p><a href=\"http://blog.51cto.com/1385903/2115479\" target=\"_blank\" rel=\"noopener\">金融系统中高并发下投资余额扣减问题的解决思路</a></p>\n<p>通过知乎上的一些回答，第一个让我get到需要改正的点的是，条件判断和临界参数的比较（与0比较，或是余额比较），都是可以直接交给数据库去做的，这样就可以利用到MySQL自身的锁机制来帮助我们处理并发。</p>\n<h2 id=\"MySQL锁\"><a href=\"#MySQL锁\" class=\"headerlink\" title=\"MySQL锁\"></a>MySQL锁</h2><p>MySQL中一般常见的锁，表锁和行锁，根据mysql引擎使用的不同，能够使用的锁也不同，例如行锁适用于<code>InnoDB</code>，这里也只是介绍行锁，其并发度也是最高的。</p>\n<p>这里介绍InnoDB的行锁模式及加锁方法。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   共享锁（s）：允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。</span><br><span class=\"line\">   排他锁（Ｘ）：允许获取排他锁的事务更新数据，阻止其他事务取得相同的数据集共享读锁和排他写锁。</span><br><span class=\"line\">另外，为了允许行锁和表锁共存，实现多粒度锁机制，InnoDB还有两种内部使用的意向锁（Intention Locks），这两种意向锁都是表锁。</span><br><span class=\"line\">   意向共享锁（IS）：事务打算给数据行共享锁，事务在给一个数据行加共享锁前必须先取得该表的IS锁。</span><br><span class=\"line\">   意向排他锁（IX）：事务打算给数据行加排他锁，事务在给一个数据行加排他锁前必须先取得该表的IX锁。</span><br></pre></td></tr></table></figure>\n\n<p>​    如果一个事务请求的锁模式与当前的锁兼容，InnoDB就请求的锁授予该事务；反之，如果两者两者不兼容，该事务就要等待锁释放。</p>\n<p>​    意向锁是InnoDB自动加的，不需用户干预。对于<strong>UPDATE、DELETE和INSERT</strong>语句，InnoDB会自动给涉及及数据集加排他锁（Ｘ）；对于普通SELECT语句，InnoDB不会加任何锁；<strong>事务</strong>可以通过以下语句显示给记录集加共享锁或排锁。</p>\n<p>共享锁（Ｓ）：SELECT * FROM table_name WHERE … LOCK IN SHARE MODE</p>\n<p>排他锁（X）：SELECT * FROM table_name WHERE … FOR UPDATE</p>\n<p>​    用SELECT .. IN SHARE MODE获得共享锁，主要用在需要数据依存关系时确认某行记录是否存在，并确保没有人对这个记录进行UPDATE或者DELETE操作。但是如果当前事务也需要对该记录进行更新操作，则很有可能造成死锁，对于锁定行记录后需要进行更新操作的应用，应该使用SELECT … FOR UPDATE方式获取排他锁。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Go中显示标明需要获取排他锁的SQL语句， ·WAIT 2·表示其他SQL请求等待2s后timeout，NOWAIT表示不等待</span></span><br><span class=\"line\">tx := Db.Set(<span class=\"string\">\"gorm:query_option\"</span>, <span class=\"string\">\" FOR UPDATE WAIT 2\"</span>)</span><br></pre></td></tr></table></figure>\n\n<p>需要<strong>注意</strong>的是：只有通过 <strong><em>索引</em></strong> 条件检索数据，InnoDB才会使用行级锁，否则，InnoDB将使用表锁！</p>\n<p>使用<code>SELECT ... FOR UPDATE</code>时，只有明确指定<code>主键</code>，mysql才会执行Row Lock（只锁住被选取的数据），否则MySQL将获取表锁。</p>\n<p>总得来说，这里mysql使用的是悲观锁，对于悲观锁的理解是，读写都来一把锁，将数据进行锁定；而乐观锁呢，大意就是不需要锁进行操作，而是通过合理的逻辑，去规避同时操作数据所出现的问题，以不加锁的方式实现同一时间仅一次操作数据的操作能够正常执行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">乐观所和悲观锁策略</span><br><span class=\"line\">悲观锁：在读取数据时锁住那几行，其他对这几行的更新需要等到悲观锁结束时才能继续 。</span><br><span class=\"line\">乐观所：读取数据时不锁，更新时检查是否数据已经被更新过，如果是则取消当前更新，一般在悲观锁的等待时间过长而不能接受时我们才会选择乐观锁。</span><br></pre></td></tr></table></figure>\n\n<p>参考：<a href=\"https://www.cnblogs.com/houweijian/p/5869243.html\" target=\"_blank\" rel=\"noopener\">mysql事务，select for update，及数据的一致性处理</a></p>\n<h2 id=\"too-many-open-file\"><a href=\"#too-many-open-file\" class=\"headerlink\" title=\"too many open file\"></a><em>too</em> <em>many</em> <em>open</em> <em>file</em></h2><p>在服务器端时，在正常运行的过程中，总会出现<code>socket: too many open file</code>，然后当次HTTP请求就会出现访问错误，这是由于linux对程序打开文件的限制，使用命令<code>ulimit -a</code>，默认<code>open file (-n) 1024</code>，解决方法是<code>ulimit -n 8192</code>，将支持打开的文件数量调大些。</p>\n<p>这里还是服务端在请求产生后，资源没有及时释放，我使用<code>resty</code> HTTP库时，会比较快的出现这个问题，我换成使用原生Golang库发起请求时，这个问题会减轻很多，这里我对这个库的资源回收方面的处理表示一些不好的意向。另外<code>viper</code>库竟然不支持并发安全，这也是让我没有预料到的。</p>\n","categories":[{"name":"MySQL","slug":"MySQL","permalink":"chunlife.top/categories/MySQL/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"mysql","slug":"mysql","permalink":"chunlife.top/tags/mysql/"}]},{"title":"自定义json Marshalling","date":"2019-02-17T02:34:35.000Z","path":"2019/02/17/自定义json Marshalling/","content":"<p>在开发中，若是遇到结构体中的私有变量（小写变量），需要出现在<code>json Marshal</code>结果中，使用json外包显然是无法做到的，因为外包是无法看到私有变量的，<code>reflect</code>机制需要的是大写变量，但就是需要这样的操作，怎么办呢，可以实现该结构体自有<code>Marshal</code>方法。</p>\n<a id=\"more\"></a>\n\n<p>看到一篇好文章：<a href=\"http://choly.ca/post/go-json-marshalling/\" target=\"_blank\" rel=\"noopener\">Custom JSON Marshalling in Go</a>，以下是翻译。</p>\n<p>补：</p>\n<blockquote>\n<p>有人问我，这个小写变量没啥软用啊，你咋不大写？</p>\n<p>额，我这里自己对结构体编写了构造函数，我有一些初始设置是写在结构体里的，不想被外界修改，所以使用了这个操作，另外我可以借助这个操作来更改实际输出给外部的结构体格式。</p>\n<p>当然，一切以项目需求为主，<img src=\"2E8E715C.png\" alt=\"img\">。</p>\n</blockquote>\n<p>Go的<code>encoding/json</code>包使得序列化结构体<code>s</code>到JSON数据变得非常容易。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"encoding/json\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"os\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> MyUser <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tID       <span class=\"keyword\">int64</span>     <span class=\"string\">`json:\"id\"`</span></span><br><span class=\"line\">\tName     <span class=\"keyword\">string</span>    <span class=\"string\">`json:\"name\"`</span></span><br><span class=\"line\">\tLastSeen time.Time <span class=\"string\">`json:\"lastSeen\"`</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t_ = json.NewEncoder(os.Stdout).Encode(</span><br><span class=\"line\">\t\t&amp;MyUser&#123;<span class=\"number\">1</span>, <span class=\"string\">\"Ken\"</span>, time.Now()&#125;,</span><br><span class=\"line\">\t)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Output:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;<span class=\"attr\">\"id\"</span>:<span class=\"number\">1</span>,<span class=\"attr\">\"name\"</span>:<span class=\"string\">\"Ken\"</span>,<span class=\"attr\">\"lastSeen\"</span>:<span class=\"string\">\"2009-11-10T23:00:00Z\"</span>&#125;</span><br></pre></td></tr></table></figure>\n\n<p>但是，如果我们想要改变其中一个字段值的显示方式呢？例如，假设我想<code>LastSeen</code>成为一个unix时间戳。</p>\n<p>简单的解决方案是引入另一个辅助<code>struct</code>，并使用方法中正确格式化的值填充它<code>MarshalJSON</code>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(u *MyUser)</span> <span class=\"title\">MarshalJSON</span><span class=\"params\">()</span> <span class=\"params\">([]<span class=\"keyword\">byte</span>, error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> json.Marshal(&amp;<span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tID       <span class=\"keyword\">int64</span>  <span class=\"string\">`json:\"id\"`</span></span><br><span class=\"line\">\t\tName     <span class=\"keyword\">string</span> <span class=\"string\">`json:\"name\"`</span></span><br><span class=\"line\">\t\tLastSeen <span class=\"keyword\">int64</span>  <span class=\"string\">`json:\"lastSeen\"`</span></span><br><span class=\"line\">\t&#125;&#123;</span><br><span class=\"line\">\t\tID:       u.ID,</span><br><span class=\"line\">\t\tName:     u.Name,</span><br><span class=\"line\">\t\tLastSeen: u.LastSeen.Unix(),  <span class=\"comment\">// 调换了参数</span></span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这是有用的，但是当有很多字段时它会变得很麻烦。如果我们可以将原始内容嵌入<code>struct</code>到辅助中<code>struct</code>并使其继承所有不需要更改的字段，这将是好的解决方式。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(u *MyUser)</span> <span class=\"title\">MarshalJSON</span><span class=\"params\">()</span> <span class=\"params\">([]<span class=\"keyword\">byte</span>, error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> json.Marshal(&amp;<span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tLastSeen <span class=\"keyword\">int64</span> <span class=\"string\">`json:\"lastSeen\"`</span></span><br><span class=\"line\">\t\t*MyUser</span><br><span class=\"line\">\t&#125;&#123;</span><br><span class=\"line\">\t\tLastSeen: u.LastSeen.Unix(),</span><br><span class=\"line\">\t\tMyUser:   u,</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里的问题是辅助结构也将继承原始的<code>MarshalJSON</code>方法，导致它进入无限循环（<code>我：这里我不太清楚作者无限循环的意思</code>）。解决方案是为原始类型添加别名。此别名将具有所有相同的字段，但不包含任何方法。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(u *MyUser)</span> <span class=\"title\">MarshalJSON</span><span class=\"params\">()</span> <span class=\"params\">([]<span class=\"keyword\">byte</span>, error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">type</span> Alias MyUser</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> json.Marshal(&amp;<span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tLastSeen <span class=\"keyword\">int64</span> <span class=\"string\">`json:\"lastSeen\"`</span></span><br><span class=\"line\">\t\t*Alias</span><br><span class=\"line\">\t&#125;&#123;</span><br><span class=\"line\">\t\tLastSeen: u.LastSeen.Unix(),</span><br><span class=\"line\">\t\tAlias:    (*Alias)(u),</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>我：辅助<code>struct</code>的<code>lastSeen</code>会覆盖原始<code>struct</code>中的同名<code>tag</code>参数。</p>\n</blockquote>\n<p>可以使用相同的技术来实现<code>UnmarshalJSON</code>方法。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(u *MyUser)</span> <span class=\"title\">UnmarshalJSON</span><span class=\"params\">(data []<span class=\"keyword\">byte</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">type</span> Alias MyUser</span><br><span class=\"line\">\taux := &amp;<span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t\tLastSeen <span class=\"keyword\">int64</span> <span class=\"string\">`json:\"lastSeen\"`</span></span><br><span class=\"line\">\t\t*Alias</span><br><span class=\"line\">\t&#125;&#123;</span><br><span class=\"line\">\t\tAlias: (*Alias)(u),</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err := json.Unmarshal(data, &amp;aux); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tu.LastSeen = time.Unix(aux.LastSeen, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"json","slug":"json","permalink":"chunlife.top/tags/json/"},{"name":"Marshal","slug":"Marshal","permalink":"chunlife.top/tags/Marshal/"}]},{"title":"初步学习ES","date":"2019-01-09T03:34:40.000Z","path":"2019/01/09/初步学习ES/","content":"<h2 id=\"基础ES\"><a href=\"#基础ES\" class=\"headerlink\" title=\"基础ES\"></a>基础ES</h2><p>ES访问基于RESTful web接口，功能可以说是十分强劲（学会用才行），对各类搜索来说可以说特别方便的，可以使用的搜索方式很多。</p>\n<p>先了解了解ES基础的使用方法。</p>\n<a id=\"more\"></a>\n\n<p>基础接口使用：</p>\n<p><img src=\"clip_image001.png\" alt=\"123\"></p>\n<p><img src=\"1547005720207.png\" alt=\"数据库对比\"></p>\n<h2 id=\"资料收集\"><a href=\"#资料收集\" class=\"headerlink\" title=\"资料收集\"></a>资料收集</h2><p>本来是想写点什么的，不过发现前人已经将基础部分描述得很清楚了，对于我来讲，拿出小本本，做好笔，站在前人的肩膀上，坐享成果，岂不是美滋滋。</p>\n<p>简单介绍一些学习的博客，用于帮助理解ES。</p>\n<p>博主写了5篇关于ES的文章，从基础概念到Java API的使用。</p>\n<p><a href=\"https://blog.csdn.net/xialei199023/article/list/2?t=1\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/xialei199023/article/list/2?t=1</a></p>\n<p>一个博客专栏，共有6篇博客。</p>\n<p><a href=\"https://blog.csdn.net/vbirdbest/column/info/19346\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/vbirdbest/column/info/19346</a></p>\n<p>个人比较<strong>喜欢</strong>的一篇博客，写的非常详尽，对初学者极度友好。</p>\n<p><a href=\"https://my.oschina.net/yumg/blog/625448\" target=\"_blank\" rel=\"noopener\">认识ElasticSearch的API，并深入Search的使用</a></p>\n<p>获取筛选字段。</p>\n<p><a href=\"https://blog.csdn.net/afeiqiang/article/details/82999962\" target=\"_blank\" rel=\"noopener\">Elasticsearch搜索详解（三）：返回字段筛选</a></p>\n<p>ES查询使用</p>\n<p><a href=\"https://www.cnblogs.com/yjf512/p/4897294.html\" target=\"_blank\" rel=\"noopener\">elasticsearch 查询（match和term）</a></p>\n<p><strong>聚合</strong>操作可以算是ES中实现一些复杂操作的方式，</p>\n<p><a href=\"https://blog.csdn.net/donghaixiaolongwang/article/details/58597058\" target=\"_blank\" rel=\"noopener\">Elasticsearch–Aggregation详细总结（聚合统计）</a></p>\n<p><a href=\"https://blog.csdn.net/xialei199023/article/details/48298635\" target=\"_blank\" rel=\"noopener\">实时搜索引擎Elasticsearch（4）——Aggregations （聚合）API的使用</a></p>\n<p><a href=\"https://www.jianshu.com/p/6e28c967d872\" target=\"_blank\" rel=\"noopener\">使用Elasticsearch实现统计(golang)</a></p>\n<p>对于随时查找并使用的场景，可以查看官方的手册：</p>\n<p><a href=\"https://www.elastic.co/guide/cn/elasticsearch/guide/current/preface.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/cn/elasticsearch/guide/current/preface.html</a></p>\n<h2 id=\"搜索解决的问题（随时更新）\"><a href=\"#搜索解决的问题（随时更新）\" class=\"headerlink\" title=\"搜索解决的问题（随时更新）\"></a>搜索解决的问题（随时更新）</h2><p><a href=\"https://stackoverflow.com/questions/28189725/find-distinct-values-not-distinct-counts-in-elasticsearch\" target=\"_blank\" rel=\"noopener\">Distinct ES实现方法</a></p>\n","categories":[{"name":"Elastic Search","slug":"Elastic-Search","permalink":"chunlife.top/categories/Elastic-Search/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Elastic Search","slug":"Elastic-Search","permalink":"chunlife.top/tags/Elastic-Search/"}]},{"title":"技术博客的重要性","date":"2018-12-24T14:24:55.000Z","path":"2018/12/24/技术博客的重要性/","content":"<p>本篇文章由我翻译自：<a href=\"https://akomljen.com/the-importance-of-tech-blogging/\" target=\"_blank\" rel=\"noopener\">https://akomljen.com/the-importance-of-tech-blogging/</a>，翻译难免出现差错，尽请谅解。</p>\n<a id=\"more\"></a>\n\n<p>我有很多干货将在博客上分享，这实际上已经是我的第三个技术博客，算是比较的成功的。很多优秀的工程师有很多优秀的想法，但经常找不到开始动笔分享的理由。通常你会听到“我没有时间去写”这样的话，或者他们只是看不到这件事的重要之处。他们不了解博客如何在专业性领域帮助他们。现在，对你来说更重要的是将自己分享给世界，作为技术人员，我们应该成为一个榜样。</p>\n<h2 id=\"为什么要开始写博客？\"><a href=\"#为什么要开始写博客？\" class=\"headerlink\" title=\"为什么要开始写博客？\"></a>为什么要开始写博客？</h2><p>首先我来回答这个问题，为什么？</p>\n<p>这有很多答案，但其中最重要的一个原因是——曝光。作为计算机软件工程师，我们工作范围非常广泛，同时也面对着来自世界不同地区的竞争。<strong>你应该用着眼更大的范围去思考和行动！</strong></p>\n<p>科技世界简历的作用越来越低效，让人们找到你，读到你正在做的事情，之后，这些人总会提供一些东西给你——这也是曝光为何显得如此重要的原因了。根据我作为DevOps工程师的个人经验，我很少发送简历。实际上我自己都不知道上次发简历的时间了。你几乎能在任何地方看到我的文章，HR或公司每周都会直接与我联系。<strong>机会主动靠近我，而不是我去寻找机会。</strong></p>\n<p>记住以上所有内容，你还将学到更多关于写作的知识。</p>\n<p><img src=\"1545658771436.png\" alt=\"分享博客\"></p>\n<h2 id=\"从哪儿开始？\"><a href=\"#从哪儿开始？\" class=\"headerlink\" title=\"从哪儿开始？\"></a>从哪儿开始？</h2><p>你可以写下你最近做过的有趣的事情，或者写一些你想要更好理解的事情。不要试图找到一个完美的写作由头。在学习<a href=\"https://akomljen.com/tag/kubernetes/\" target=\"_blank\" rel=\"noopener\">Kubernetes的过程中</a>，我一直努力寻找帮助我开始学习的好文章。我如今正在写很多关于Kubernetes的文章。再举一个例子，我的未婚妻等了好几年才开始写博客。她不相信她的内容对某人来说会很有趣，并且一直让她感到厌烦。我很自豪她开始了，现在她的写作比我更多。我建议你阅读她关于如何掌握生活改变的两篇博文：</p>\n<ul>\n<li><a href=\"https://gattabrava.com/mastering-life-change-the-unwelcome-kind/\" target=\"_blank\" rel=\"noopener\">掌握生活变化：不受欢迎的种类</a></li>\n<li><a href=\"https://gattabrava.com/mastering-life-change-the-invited-kind/\" target=\"_blank\" rel=\"noopener\">掌握生活变化：邀请的种类</a></li>\n</ul>\n<p><img src=\"1545659175572.png\" alt=\"秀恩爱\"></p>\n<p>不要花太多时间思考写什么以及你的博客应该是什么样子。基本上，你可以立即开始写一些谷歌文档。写作的同时也会得到一些新的想法。无论如何，你可能在一段时间里对第一篇文章并不是那么有感情，对于你投入了努力感觉显得并不重要。这是正常的。随着时间的推移，你将掌握你独有的技能。</p>\n<p>我提到这是我的第三篇博客。我写的是关于FreeBSD的提示和技巧，因为它是我首选的操作系统。这并不是很顺利（谁猜得到呢），几年前研究OpenShift时我决定写一篇关于如何在该平台上免费运行Wordpress博客的博客文章，我很快创建了名为TechBar的新博客并开始写作。新博客也不顺利。问题是我并不专注，一段时间后我完全停止写作。<strong>在博客方面，专注是关键。</strong></p>\n<h2 id=\"技术资料\"><a href=\"#技术资料\" class=\"headerlink\" title=\"技术资料\"></a>技术资料</h2><p>也许你已经写了一些东西，但现在你需要选择你的博客名称，域名，托管地点和其他技术内容。你可能会因为做出很多决定而迷失方向。它可能非常简单或非常复杂，具体取决于您选择的路径。我建议使用一些随时可用的主机平台与Wordpress或Ghost。Medium也是一种选择，但我不是粉丝。</p>\n<p>有很多可以使用的托管服务提供商。对于Wordpress，你可以使用<a href=\"https://www.bluehost.com/track/komljen/\" target=\"_blank\" rel=\"noopener\">Bluehost</a>，只需3.95美元/月，对于Ghost，有官方的<a href=\"https://ghost.org/pricing/\" target=\"_blank\" rel=\"noopener\">Ghost pro</a>计划，其中最便宜的是每月79美元。在我看来，Ghost pro对于初学者来说太贵了。我使用了两个平台，我更喜欢Ghost。只是我个人的偏好。我在<a href=\"https://m.do.co/c/60b55ed9afcf\" target=\"_blank\" rel=\"noopener\">DigitalOcean</a>上部署了Ghost，使用最小的VM进行备份只花了6美元/月。由于Cloudflare，它大部分时间都处于闲置状态，每天有1k用户。</p>\n<p>我是DevOps的人，我无法帮助自己不创建Terraform文件来启动VM，创建防火墙规则，启用备份，设置Cloudflare，复制所有文件并在Docker中启动Ghost博客。当然，使用像Docker和Let’s Encrypt这样的好东西 - 因为HTTPS是必须的。我的Terraform文件仍未准备好共享，但这里是docker compose文件，你可以使用它来启动Ghost博客并通过Let’s Encrypt获得免费的SSL证书：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">⚡ cat &gt; docker-compose.yml &lt;&lt;EOF</span><br><span class=\"line\">version: &apos;3&apos;</span><br><span class=\"line\">services:</span><br><span class=\"line\">   nginx:</span><br><span class=\"line\">     image: nginx</span><br><span class=\"line\">     container_name: nginx-proxy</span><br><span class=\"line\">     restart: always</span><br><span class=\"line\">     volumes:</span><br><span class=\"line\">       - certs:/etc/nginx/certs:ro</span><br><span class=\"line\">       - nginx_conf.d:/etc/nginx/conf.d</span><br><span class=\"line\">       - nginx_vhost.d:/etc/nginx/vhost.d</span><br><span class=\"line\">       - nginx_html:/usr/share/nginx/html</span><br><span class=\"line\">     labels:</span><br><span class=\"line\">       - &quot;com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy&quot;</span><br><span class=\"line\">     ports:</span><br><span class=\"line\">       - &quot;80:80&quot;</span><br><span class=\"line\">       - &quot;443:443&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">   nginx-gen:</span><br><span class=\"line\">     image: jwilder/docker-gen</span><br><span class=\"line\">     restart: always</span><br><span class=\"line\">     command: -notify-sighup nginx-proxy -watch /etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf</span><br><span class=\"line\">     volumes:</span><br><span class=\"line\">       - ./files/nginx.tmpl:/etc/docker-gen/templates/nginx.tmpl:ro</span><br><span class=\"line\">       - /var/run/docker.sock:/tmp/docker.sock:ro</span><br><span class=\"line\">       - certs:/etc/nginx/certs:ro</span><br><span class=\"line\">       - nginx_conf.d:/etc/nginx/conf.d</span><br><span class=\"line\">       - nginx_vhost.d:/etc/nginx/vhost.d</span><br><span class=\"line\">     depends_on:</span><br><span class=\"line\">       - nginx</span><br><span class=\"line\">     labels:</span><br><span class=\"line\">       - &quot;com.github.jrcs.letsencrypt_nginx_proxy_companion.docker_gen&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">   nginx-letsencrypt:</span><br><span class=\"line\">     image: jrcs/letsencrypt-nginx-proxy-companion:stable</span><br><span class=\"line\">     restart: always</span><br><span class=\"line\">     volumes:</span><br><span class=\"line\">       - certs:/etc/nginx/certs</span><br><span class=\"line\">       - nginx_vhost.d:/etc/nginx/vhost.d</span><br><span class=\"line\">       - nginx_html:/usr/share/nginx/html</span><br><span class=\"line\">       - /var/run/docker.sock:/var/run/docker.sock:ro</span><br><span class=\"line\">     depends_on:</span><br><span class=\"line\">       - nginx</span><br><span class=\"line\">       - nginx-gen</span><br><span class=\"line\"></span><br><span class=\"line\">   ghost:</span><br><span class=\"line\">     image: ghost:1.24.7-alpine</span><br><span class=\"line\">     restart: always</span><br><span class=\"line\">     volumes:</span><br><span class=\"line\">       - ./data:/var/lib/ghost/content</span><br><span class=\"line\">       - ./files/config.production.json:/var/lib/ghost/config.production.json</span><br><span class=\"line\">     environment:</span><br><span class=\"line\">       - VIRTUAL_HOST=&lt;YOUR_DOMAIN&gt;, www.&lt;YOUR_DOMAIN&gt;</span><br><span class=\"line\">       - LETSENCRYPT_HOST=&lt;YOUR_DOMAIN&gt;, www.&lt;YOUR_DOMAIN&gt;</span><br><span class=\"line\">       - LETSENCRYPT_EMAIL=&lt;YOUR_EMAIL&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">volumes:</span><br><span class=\"line\">  nginx_vhost.d:</span><br><span class=\"line\">  nginx_conf.d:</span><br><span class=\"line\">  nginx_html:</span><br><span class=\"line\">  certs:</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<p>在使用此文件之前，你需要准备好域名并执行一些准备步骤：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">⚡ mkdir files</span><br><span class=\"line\"></span><br><span class=\"line\">⚡ curl https://raw.githubusercontent.com/jwilder/nginx-proxy/master/nginx.tmpl &gt; files/nginx.tmpl</span><br><span class=\"line\"></span><br><span class=\"line\">⚡ cat &gt; files/config.production.json &lt;&lt;EOF</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;url&quot;: &quot;http://&lt;YOUR_DOMAIN&gt;/&quot;,</span><br><span class=\"line\">  &quot;server&quot;: &#123;</span><br><span class=\"line\">    &quot;port&quot;: 2368,</span><br><span class=\"line\">    &quot;host&quot;: &quot;0.0.0.0&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;database&quot;: &#123;</span><br><span class=\"line\">    &quot;client&quot;: &quot;sqlite3&quot;,</span><br><span class=\"line\">    &quot;connection&quot;: &#123;</span><br><span class=\"line\">      &quot;filename&quot;: &quot;/var/lib/ghost/content/data/ghost.db&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mail&quot;: &#123;</span><br><span class=\"line\">    &quot;transport&quot;: &quot;Direct&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;logging&quot;: &#123;</span><br><span class=\"line\">    &quot;transports&quot;: [</span><br><span class=\"line\">      &quot;file&quot;,</span><br><span class=\"line\">      &quot;stdout&quot;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;process&quot;: &quot;systemd&quot;,</span><br><span class=\"line\">  &quot;paths&quot;: &#123;</span><br><span class=\"line\">    &quot;contentPath&quot;: &quot;/var/lib/ghost/content&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">⚡ docker-compose.yml up -d</span><br></pre></td></tr></table></figure>\n\n<p>这就是我在这个博客中使用的内容，也是我未婚妻的博客<a href=\"https://gattabrava.com/\" target=\"_blank\" rel=\"noopener\">Gatta Brava</a>在Terraform的帮助下也做了同样的事情。</p>\n<p>对于这两个博客，我付出了比想象中更多的努力。我买了一个自定义主题并做了一些定制。我不知道我在CSS方面做了什么，但我尝试过，我对最终结果感到满意。你可以使用默认的Ghost Casper主题来进行写作。你可以随时更改它，所以不用担心。</p>\n<p>我博客的所有访问量中有90％来自自然搜索。在搜索引擎优化和营销方面，我学到了很多东西。所有这些事情都无法在一夜之间学会，所以请写下并学习如何宣传您的内容。有时你会得到很好的反馈，这会增强你的信心。<strong>博客是你的个人项目。</strong>你做出的所有决策，将它将绽放光芒。</p>\n<p>我建议观看Troy Hunt关于如何破解你的职业生涯的演讲（ hack your career）。</p>\n","categories":[{"name":"学习","slug":"学习","permalink":"chunlife.top/categories/学习/"}],"tags":[{"name":"学习","slug":"学习","permalink":"chunlife.top/tags/学习/"},{"name":"博客","slug":"博客","permalink":"chunlife.top/tags/博客/"}]},{"title":"程序员的简历就该这样写","date":"2018-12-14T08:40:42.000Z","path":"2018/12/14/程序员的简历之道/","content":"<p>感觉对我是非常有指导意义的，那看到了实在忍不住就收藏了，收藏了觉着还不得劲，非得转载才安心（要是侵犯了作者权益，请联系我直接删除，非常感谢作者）。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"程序员的简历就该这样写\"><a href=\"#程序员的简历就该这样写\" class=\"headerlink\" title=\"程序员的简历就该这样写\"></a><a href=\"https://github.com/Snailclimb/JavaGuide/blob/master/面试必备/程序员的简历之道.md\" target=\"_blank\" rel=\"noopener\">程序员的简历就该这样写</a></h2><h3 id=\"1-前言\"><a href=\"#1-前言\" class=\"headerlink\" title=\"1 前言\"></a>1 前言</h3><p><font color=\"red\">一份好的简历可以在整个申请面试以及面试过程中起到非常好的作用。</font> 在不夸大自己能力的情况下，写出一份好的简历也是一项很棒的能力。</p>\n<h3 id=\"2-为什么说简历很重要？\"><a href=\"#2-为什么说简历很重要？\" class=\"headerlink\" title=\"2 为什么说简历很重要？\"></a>2 为什么说简历很重要？</h3><h4 id=\"2-1-先从面试前来说\"><a href=\"#2-1-先从面试前来说\" class=\"headerlink\" title=\"2.1 先从面试前来说\"></a>2.1 先从面试前来说</h4><p>假如你是网申，你的简历必然会经过HR的筛选，一张简历HR可能也就花费10秒钟看一下，然后HR就会决定你这一关是Fail还是Pass。</p>\n<p>假如你是内推，如果你的简历没有什么优势的话，就算是内推你的人再用心，也无能为力。</p>\n<p>另外，就算你通过了筛选，后面的面试中，面试官也会根据你的简历来判断你究竟是否值得他花费很多时间去面试。</p>\n<p>所以，简历就像是我们的一个门面一样，它在很大程度上决定了你能否进入到下一轮的面试中。</p>\n<h4 id=\"2-2-再从面试中来说\"><a href=\"#2-2-再从面试中来说\" class=\"headerlink\" title=\"2.2 再从面试中来说\"></a>2.2 再从面试中来说</h4><p>我发现大家比较喜欢看面经 ，这点无可厚非，但是大部分面经都没告诉你很多问题都是在特定条件下才问的。举个简单的例子：一般情况下你的简历上注明你会的东西才会被问到（Java、数据结构、网络、算法这些基础是每个人必问的），比如写了你会 redis,那面试官就很大概率会问你 redis 的一些问题。比如：redis的常见数据类型及应用场景、redis是单线程为什么还这么快、 redis 和 memcached 的区别、redis 内存淘汰机制等等。</p>\n<p>所以，首先，你要明确的一点是：<strong>你不会的东西就不要写在简历上</strong>。另外，<strong>你要考虑你该如何才能让你的亮点在简历中凸显出来</strong>，比如：你在某某项目做了什么事情解决了什么问题（只要有项目就一定有要解决的问题）、你的某一个项目里使用了什么技术后整体性能和并发量提升了很多等等。</p>\n<p>面试和工作是两回事，聪明的人会把面试官往自己擅长的领域领，其他人则被面试官牵着鼻子走。虽说面试和工作是两回事，但是你要想要获得自己满意的 offer ，你自身的实力必须要强。</p>\n<h3 id=\"3-下面这几点你必须知道\"><a href=\"#3-下面这几点你必须知道\" class=\"headerlink\" title=\"3 下面这几点你必须知道\"></a>3 下面这几点你必须知道</h3><ol>\n<li>大部分公司的HR都说我们不看重学历（骗你的！），但是如果你的学校不出众的话，很难在一堆简历中脱颖而出，除非你的简历上有特别的亮点，比如：某某大厂的实习经历、获得了某某大赛的奖等等。</li>\n<li><strong>大部分应届生找工作的硬伤是没有工作经验或实习经历，所以如果你是应届生就不要错过秋招和春招。一旦错过，你后面就极大可能会面临社招，这个时候没有工作经验的你可能就会面临各种碰壁，导致找不到一个好的工作</strong></li>\n<li><strong>写在简历上的东西一定要慎重，这是面试官大量提问的地方；</strong></li>\n<li><strong>将自己的项目经历完美的展示出来非常重要。</strong></li>\n</ol>\n<h3 id=\"4-必须了解的两大法则\"><a href=\"#4-必须了解的两大法则\" class=\"headerlink\" title=\"4  必须了解的两大法则\"></a>4  必须了解的两大法则</h3><p><strong>①STAR法则（Situation Task Action Result）：</strong></p>\n<ul>\n<li><strong>Situation：</strong> 事情是在什么情况下发生；</li>\n<li><strong>Task:：</strong> 你是如何明确你的任务的；</li>\n<li><strong>Action：</strong> 针对这样的情况分析，你采用了什么行动方式；</li>\n<li><strong>Result：</strong> 结果怎样，在这样的情况下你学习到了什么。</li>\n</ul>\n<p>简而言之，STAR法则，就是一种讲述自己故事的方式，或者说，是一个清晰、条理的作文模板。不管是什么，合理熟练运用此法则，可以轻松的对面试官描述事物的逻辑方式，表现出自己分析阐述问题的清晰性、条理性和逻辑性。</p>\n<p>下面这段内容摘自百度百科，我觉得写的非常不错：</p>\n<blockquote>\n<p>STAR法则，500强面试题回答时的技巧法则，备受面试者成功者和500强HR的推崇。<br>由于这个法则被广泛应用于面试问题的回答，尽管我们还在写简历阶段，但是，写简历时能把面试的问题就想好，会使自己更加主动和自信，做到简历，面试关联性，逻辑性强，不至于在一个月后去面试，却把简历里的东西都忘掉了（更何况有些朋友会稍微夸大简历内容）<br>在我们写简历时，每个人都要写上自己的工作经历，活动经历，想必每一个同学，都会起码花上半天甚至更长的时间去搜寻脑海里所有有关的经历，争取找出最好的东西写在简历上。<br>但是此时，我们要注意了，简历上的任何一个信息点都有可能成为日后面试时的重点提问对象，所以说，不能只管写上让自己感觉最牛的经历就完事了，要想到今后，在面试中，你所写的经历万一被面试官问到，你真的能回答得流利，顺畅，且能通过这段经历，证明自己正是适合这个职位的人吗？</p>\n</blockquote>\n<p><strong>②FAB 法则（Feature Advantage Benefit）：</strong></p>\n<ul>\n<li><strong>Feature：</strong> 是什么；</li>\n<li><strong>Advantage：</strong> 比别人好在哪些地方；</li>\n<li><strong>Benefit：</strong> 如果雇佣你，招聘方会得到什么好处。</li>\n</ul>\n<p>简单来说，这个法则主要是让你的面试官知道你的优势、招了你之后对公司有什么帮助。</p>\n<h3 id=\"5-项目经历怎么写？\"><a href=\"#5-项目经历怎么写？\" class=\"headerlink\" title=\"5 项目经历怎么写？\"></a>5 项目经历怎么写？</h3><p>简历上有一两个项目经历很正常，但是真正能把项目经历很好的展示给面试官的非常少。对于项目经历大家可以考虑从如下几点来写：</p>\n<ol>\n<li>对项目整体设计的一个感受</li>\n<li>在这个项目中你负责了什么、做了什么、担任了什么角色</li>\n<li>从这个项目中你学会了那些东西，使用到了那些技术，学会了那些新技术的使用</li>\n<li>另外项目描述中，最好可以体现自己的综合素质，比如你是如何协调项目组成员协同开发的或者在遇到某一个棘手的问题的时候你是如何解决的又或者说你在这个项目用了什么技术实现了什么功能比如:用redis做缓存提高访问速度和并发量、使用消息队列削峰和降流等等。</li>\n</ol>\n<h3 id=\"6-专业技能该怎么写？\"><a href=\"#6-专业技能该怎么写？\" class=\"headerlink\" title=\"6 专业技能该怎么写？\"></a>6 专业技能该怎么写？</h3><p>先问一下你自己会什么，然后看看你意向的公司需要什么。一般HR可能并不太懂技术，所以他在筛选简历的时候可能就盯着你专业技能的关键词来看。对于公司有要求而你不会的技能，你可以花几天时间学习一下，然后在简历上可以写上自己了解这个技能。比如你可以这样写(下面这部分内容摘自我的简历，大家可以根据自己的情况做一些修改和完善)：</p>\n<ul>\n<li>计算机网络、数据结构、算法、操作系统等课内基础知识：掌握</li>\n<li>Java 基础知识：掌握</li>\n<li>JVM 虚拟机（Java内存区域、虚拟机垃圾算法、虚拟垃圾收集器、JVM内存管理）：掌握</li>\n<li>高并发、高可用、高性能系统开发：掌握</li>\n<li>Struts2、Spring、Hibernate、Ajax、Mybatis、JQuery ：掌握</li>\n<li>SSH 整合、SSM 整合、 SOA 架构：掌握</li>\n<li>Dubbo： 掌握</li>\n<li>Zookeeper: 掌握</li>\n<li>常见消息队列: 掌握</li>\n<li>Linux：掌握</li>\n<li>MySQL常见优化手段：掌握 </li>\n<li>Spring Boot +Spring Cloud +Docker:了解</li>\n<li>Hadoop 生态相关技术中的 HDFS、Storm、MapReduce、Hive、Hbase ：了解</li>\n<li>Python 基础、一些常见第三方库比如OpenCV、wxpy、wordcloud、matplotlib：熟悉</li>\n</ul>\n<h3 id=\"7-开源程序员Markdown格式简历模板分享\"><a href=\"#7-开源程序员Markdown格式简历模板分享\" class=\"headerlink\" title=\"7 开源程序员Markdown格式简历模板分享\"></a>7 开源程序员Markdown格式简历模板分享</h3><p>分享一个Github上开源的程序员简历模板。包括PHP程序员简历模板、iOS程序员简历模板、Android程序员简历模板、Web前端程序员简历模板、Java程序员简历模板、C/C++程序员简历模板、NodeJS程序员简历模板、架构师简历模板以及通用程序员简历模板 。<br>Github地址：<a href=\"https://github.com/geekcompany/ResumeSample\" target=\"_blank\" rel=\"noopener\">https://github.com/geekcompany/ResumeSample</a></p>\n<p>我的下面这篇文章讲了如何写一份Markdown格式的简历，另外，文中还提到了一种实现 Markdown 格式到PDF、HTML、JPEG这几种格式的转换方法。</p>\n<p><a href=\"https://mp.weixin.qq.com/s?__biz=MzU4NDQ4MzU5OA==&mid=2247484347&idx=1&sn=a986ea7e199871999a5257bd3ed78be1&chksm=fd9855dacaefdccc2c5d5f8f79c4aa1b608ad5b42936bccaefb99a850a2e6e8e2e910e1b3153&token=719595858&lang=zh_CN#rd\" target=\"_blank\" rel=\"noopener\">手把手教你用Markdown写一份高质量的简历</a></p>\n<h3 id=\"8-其他的一些小tips\"><a href=\"#8-其他的一些小tips\" class=\"headerlink\" title=\"8 其他的一些小tips\"></a>8 其他的一些小tips</h3><ol>\n<li>尽量避免主观表述，少一点语义模糊的形容词，尽量要简洁明了，逻辑结构清晰。</li>\n<li>注意排版（不需要花花绿绿的），尽量使用Markdown语法。</li>\n<li>如果自己有博客或者个人技术栈点的话，写上去会为你加分很多。</li>\n<li>如果自己的Github比较活跃的话，写上去也会为你加分很多。</li>\n<li>注意简历真实性，一定不要写自己不会的东西，或者带有欺骗性的内容</li>\n<li>项目经历建议以时间倒序排序，另外项目经历不在于多，而在于有亮点。</li>\n<li>如果内容过多的话，不需要非把内容压缩到一页，保持排版干净整洁就可以了。</li>\n<li>简历最后最好能加上：“感谢您花时间阅读我的简历，期待能有机会和您共事。”这句话，显的你会很有礼貌。</li>\n</ol>\n","categories":[{"name":"学习","slug":"学习","permalink":"chunlife.top/categories/学习/"}],"tags":[{"name":"简历","slug":"简历","permalink":"chunlife.top/tags/简历/"},{"name":"学习","slug":"学习","permalink":"chunlife.top/tags/学习/"},{"name":"转载","slug":"转载","permalink":"chunlife.top/tags/转载/"}]},{"title":"第一期","date":"2018-12-14T06:50:06.000Z","path":"2018/12/14/第一期/","content":"<p><img src=\"%E4%B9%94%E5%B8%83%E6%96%AF.png\" alt=\"乔布斯\"></p>\n<p>什么事都需要一个开头，也许是兴趣使然，也许是纯属特闲，一切都是这么自然而然，很多时候我们都会迷茫，不清楚未来的方向，谁能搞得清楚自己真的会往哪边走呢，我们需要的也仅是一处避风之所，随心而动，望万事和谐。</p>\n<p>1、<a href=\"http://tech.163.com/18/1214/08/E2VL8R5F00097U7S.html\" target=\"_blank\" rel=\"noopener\">品牌争议性太大 三星取消与意大利Supreme合作</a></p>\n<p>在本周举办的三星A8s发布会上，三星宣布与Supreme进行品牌联合，但仅在发布会举办期间，微博各路大V已开始质疑Supreme发言人发表的相关言论，以及穿着的衣服款式并不属于美国潮牌Supreme。</p>\n<p>发布会后，三星高管在微博与网友进行强行解释（已删除），表示Supreme为意大利Supreme。</p>\n<p>后，美国Supreme不承认与三星进行合作（意大利Supreme与美国Supreme有着宿怨，一般意大利Supreme可以被理解为美国Supreme的山寨牌）。</p>\n<p>2、<a href=\"https://www.bbc.com/zhongwen/simp/business-46517846\" target=\"_blank\" rel=\"noopener\">中国法院给予苹果临时禁令，高通称或将申请强制执行</a></p>\n<p>高通与苹果在全球展开激烈的专利战，相爱相杀。</p>\n<p>此次在中国涉及到的专利纠纷主要涉及：</p>\n<ul>\n<li>一项涉及调整照片的大小和外观；</li>\n<li>一项涉及应用程序在触摸屏上操作时的管理方式；</li>\n</ul>\n<p>已禁止包括iPhone X之前的几乎所有还在生产的iPhone型号。</p>\n<p>对此苹果公司表示尊重法院裁定，但其未接受法院的审判结果，消费者依然可以正常购买iPhone。</p>\n<p>此为专利纠纷案，福州中院表示只接受一次诉讼。而高通在之后的动作中表示会继续诉讼下去，争取禁止掉iPhone最新发布的手机。</p>\n<p>有趣的是，某科技企业副总裁发文（未找到截图出处，真假未考证）：</p>\n<p><img src=\"%E6%9D%8E%E6%A5%A0%E8%AF%84%E8%AE%BA.jpg\" alt=\"李楠评论\"></p>\n<p>4、<a href=\"http://www.xinhuanet.com/tech/2018-12/13/c_1123844656.htm\" target=\"_blank\" rel=\"noopener\">三星手机天津工厂月底停产</a></p>\n<p>今年4月份，三星深圳电子通信公司宣布关闭，三百多名中国员工被遣散，公司内部的韩国高管也被派遣回国，随后就有消息传出，三星天津通信技术有限公司也面临关闭。</p>\n<p>三星天津工厂现有员工约2600名，每年出产智能手机约3600万部左右。</p>\n<p>5、<a href=\"https://cn.engadget.com/2018/12/11/vivo-nex-dual-screen-edition/\" target=\"_blank\" rel=\"noopener\">vivo Nex双屏版发布</a></p>\n<p>高通骁龙 845，提供最高 10GB 的 RAM。</p>\n<p>双屏版作为解放前置摄像头的另一个尝试，真正的使用效率需要经历市场考验，虽然与之前魅族pro7有着不一样的设计语言，但确实与主流相差甚远，作为又一部试水产品，vivo今年的一系列操作确实是大大的拉高了品牌的附加价值。</p>\n","categories":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/categories/随笔/"}],"tags":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/tags/随笔/"},{"name":"手机","slug":"手机","permalink":"chunlife.top/tags/手机/"}]},{"title":"网关插件编写","date":"2018-12-13T14:56:08.000Z","path":"2018/12/13/网关插件编写/","content":"<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>在使用网关的过程中，可能需要对已有功能进行一些扩展，这个时候就需要对网关进行一些改造工作，在gateway中，除了一些核心模块外，相关的功能模块都采用插件的形式进行实现，例如：黑白名单，熔断器，JWT，限流等，所以，在功能上的扩展上是可以按照插件的形式进行添加的，这也是gateway作者推荐的操作。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"接口interface\"><a href=\"#接口interface\" class=\"headerlink\" title=\"接口interface\"></a>接口interface</h2><p>插件的实现依赖于gateway给出的两个接口：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Context filter context</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> Context <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\tStartAt() time.Time</span><br><span class=\"line\">\tEndAt() time.Time</span><br><span class=\"line\"></span><br><span class=\"line\">\tOriginRequest() *fasthttp.RequestCtx</span><br><span class=\"line\">\tForwardRequest() *fasthttp.Request</span><br><span class=\"line\">\tResponse() *fasthttp.Response</span><br><span class=\"line\"></span><br><span class=\"line\">\tAPI() *metapb.API</span><br><span class=\"line\">\tDispatchNode() *metapb.DispatchNode</span><br><span class=\"line\">\tServer() *metapb.Server</span><br><span class=\"line\">\tAnalysis() *util.Analysis</span><br><span class=\"line\"></span><br><span class=\"line\">\tSetAttr(key <span class=\"keyword\">string</span>, value <span class=\"keyword\">interface</span>&#123;&#125;)</span><br><span class=\"line\">\tGetAttr(key <span class=\"keyword\">string</span>) <span class=\"keyword\">interface</span>&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// BaseFilter base filter support default implemention</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> BaseFilter <span class=\"keyword\">struct</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Init init filter</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(f BaseFilter)</span> <span class=\"title\">Init</span><span class=\"params\">(cfg <span class=\"keyword\">string</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Pre execute before proxy</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(f BaseFilter)</span> <span class=\"title\">Pre</span><span class=\"params\">(c Context)</span> <span class=\"params\">(statusCode <span class=\"keyword\">int</span>, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fasthttp.StatusOK, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Post execute after proxy</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(f BaseFilter)</span> <span class=\"title\">Post</span><span class=\"params\">(c Context)</span> <span class=\"params\">(statusCode <span class=\"keyword\">int</span>, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fasthttp.StatusOK, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// PostErr execute proxy has errors</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(f BaseFilter)</span> <span class=\"title\">PostErr</span><span class=\"params\">(c Context)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这些相关的定义都在<code>github.com/fagongzi/gateway/pkg/filter</code>包中，每一个Filter都需要导入。其中的<code>Context</code>的上下文接口，提供了Filter和Gateway交互的能力；<code>BaseFilter</code>定义了默认行为。</p>\n<p>在实际代码中，<code>Context</code>可以让插件在全局获取到route请求中的数据，例如API绑定到网关时，用户填写的相关配置——<code>API()</code>，HTTP请求的request——<code>ForwardRequest()</code>，后台接口返回的结果——<code>Response()</code>。</p>\n<p><code>BaseFilter</code>作为插件的响应动作，并不强制实现所有函数，这里只有两个比较重要的函数需要被关注到，<code>Pre</code>和<code>Post</code>，<code>Pre</code>作为网关在转发请求到后台时的前置性操作，例如黑名单功能插件就需要在<code>Pre</code>函数中判断URI是否匹配预先设置的正则表达式。例如接下来需要实现的一个webhook功能，可能就需要在<code>post</code>中进行一些操作，根据接口返回的一些信息来决定是否访问一些接口。</p>\n<h2 id=\"Request处理流程\"><a href=\"#Request处理流程\" class=\"headerlink\" title=\"Request处理流程\"></a>Request处理流程</h2><p>request -&gt; filter预处理 -&gt; 转发请求 -&gt; filter后置处理 -&gt; 响应客户端</p>\n<p>整个逻辑处理符合以下规则:</p>\n<ul>\n<li>filter预处理返回错误，流程立即终止，并且使用filter返回的状态码响应客户端</li>\n<li>filter后置处理返回错误，使用filter返回的状态码响应客户端</li>\n<li>转发请求，后端返回的状态码<code>&gt;=500</code>，调用filter的错误处理接口</li>\n</ul>\n<p>这里直接截取gateway官方的帮助文档中的内容，代码所体现的内容正如流程所说的。</p>\n<p><code>main</code> ——&gt;</p>\n<p>proxy.go</p>\n<p> <code>Start()</code>——&gt; <code>ServeFastHTTP</code> ——&gt; <code>p.doProxy</code>：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// pre filters  轮询调用所有注册过的插件的pre函数</span></span><br><span class=\"line\">filterName, code, err := p.doPreFilters(c)</span><br><span class=\"line\">......</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// post filters 轮询调用所有注册过的插件的post函数</span></span><br><span class=\"line\">filterName, code, err = p.doPostFilters(c)</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"编写插件\"><a href=\"#编写插件\" class=\"headerlink\" title=\"编写插件\"></a>编写插件</h2><p>预先设定一个简单的需求，例如，在一些特定的接口访问成功后，访问一个特定的地址，传输一些信息给这个地址。</p>\n<p>插件操作简单，不需要一些附加的逻辑，所有编写这个插件，只需要完成<code>BaseFilter</code>的相关函数即可，这里先完成一个大概的框架。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// WebHookFilter is an event handler that triggers web hooks</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> WebHookFilter <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tfilter.BaseFilter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Name name</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *WebHookFilter)</span> <span class=\"title\">Name</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> FilterWebHook</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newWebHookFilter</span><span class=\"params\">()</span> <span class=\"title\">filter</span>.<span class=\"title\">Filter</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;WebHookFilter&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Post execute after proxy</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *WebHookFilter)</span> <span class=\"title\">Post</span><span class=\"params\">(c filter.Context)</span> <span class=\"params\">(statusCode <span class=\"keyword\">int</span>, err error)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(c.API().GetTags()) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> fasthttp.StatusBadRequest, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> isNeedWebHook <span class=\"keyword\">bool</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, tags := <span class=\"keyword\">range</span> c.API().GetTags() &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> tags.Name == <span class=\"string\">\"webhook\"</span> &amp;&amp; tags.Value == <span class=\"string\">\"true\"</span> &#123;</span><br><span class=\"line\">\t\t\tisNeedWebHook = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// web url传递一个统一的地址？</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> isNeedWebHook &amp;&amp; c.Response().StatusCode() == http.StatusOK &#123;</span><br><span class=\"line\">\t\tlog.Info(Send(c.Response().Body()))  <span class=\"comment\">// 处理逻辑</span></span><br><span class=\"line\">        <span class=\"comment\">// go Send(c.Response().Body())</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog.Info(<span class=\"string\">\"webhook post exec!\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fasthttp.StatusOK, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看到在<code>post</code>函数中，出现<code>c.API().GetTags()</code>，这里的tag是API设置时的一个可选填项，用于个性化标记一个API，用在这里是因为不想对已有的gateway参数进行增添，直接使用一个gateway的可选参数来定制自己的参数，算是一种偷懒少改代码的方式。</p>\n<p><code>Post</code>这里是一般压力的话，使用协程进行异步操作；若是访问比较频繁，就使用10个channel限制一下速度，慢慢发送数据；当然更顺畅的做法肯定是引入消息队列（MQ），不过当整个系统没这么复杂时，多上一个组件，可能也会造成一定量的维护负担（视业务来定）。</p>\n<p>若使用代码来设置API（一般使用前端UI较为方便）：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sb := c.NewAPIBuilder()</span><br><span class=\"line\"><span class=\"comment\">// 必选项</span></span><br><span class=\"line\">sb.Name(<span class=\"string\">\"用户API\"</span>)</span><br><span class=\"line\"><span class=\"comment\">// 设置URL规则，匹配所有开头为/api/user的请求</span></span><br><span class=\"line\">sb.MatchURLPattern(<span class=\"string\">\"/hello/(.+)\"</span>)</span><br><span class=\"line\"><span class=\"comment\">// 匹配GET请求</span></span><br><span class=\"line\">sb.MatchMethod(<span class=\"string\">\"GET\"</span>)</span><br><span class=\"line\"><span class=\"comment\">// 添加tag</span></span><br><span class=\"line\">sb.AddTag(<span class=\"string\">\"webhook\"</span>, <span class=\"string\">\"true\"</span>)</span><br></pre></td></tr></table></figure>\n\n<p>到这里代码已完成一个大概的框架，可以看到编写逻辑非常简单，但若要插件插入gateway运行，还需要将插件信息注册gateway中，接口中的<code>Name()</code>需要和这里的name信息能够匹配。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--- &quot;gateway\\pkg\\proxy\\factory.go&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">// Filter WebHook jwt filter</span><br><span class=\"line\">FilterWebHook = &quot;WEBHOOK&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *Proxy) newFilter(filterSpec *FilterSpec) (filter.Filter, error) &#123;</span><br><span class=\"line\">\t......</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tswitch input &#123;</span><br><span class=\"line\">\t......</span><br><span class=\"line\">\tcase FilterWebHook:</span><br><span class=\"line\">\t\treturn newWebHookFilter(), nil</span><br><span class=\"line\">\tdefault:</span><br><span class=\"line\">\t\treturn nil, ErrUnknownFilter</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">--- &quot;gateway\\cmd\\proxy\\proxy.go&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">func init() &#123;</span><br><span class=\"line\">\t......</span><br><span class=\"line\">\tdefaultFilters.Set(proxy.FilterWebHook)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>插件程序编写到这里，其实已经是可以正常运行了，但还缺了一个必要的环节，那就是可配置的参数信息，用于多机环境下进行工作，参数借助etcd进行分布式设置。</p>\n<h2 id=\"获取etcd配置\"><a href=\"#获取etcd配置\" class=\"headerlink\" title=\"获取etcd配置\"></a>获取etcd配置</h2><p><code>initDispatcher()</code>——&gt; <code>GetStoreFrom</code> ——&gt; <code>fn, ok := supportSchema[schema]</code> ——&gt; <code>getEtcdStoreFrom</code> ——&gt; <code>NewEtcdStore</code> ——&gt; <code>store.init()</code>，到这里就配置好各个插件取etcd配置的函数了,<strong>需要动手添加函数</strong>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(e *EtcdStore)</span> <span class=\"title\">init</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\te.watchMethodMapping[EventSrcBind] = e.doWatchWithBind</span><br><span class=\"line\">\te.watchMethodMapping[EventSrcServer] = e.doWatchWithServer</span><br><span class=\"line\">\te.watchMethodMapping[EventSrcCluster] = e.doWatchWithCluster</span><br><span class=\"line\">\te.watchMethodMapping[EventSrcAPI] = e.doWatchWithAPI</span><br><span class=\"line\">\te.watchMethodMapping[EventSrcRouting] = e.doWatchWithRouting</span><br><span class=\"line\">\te.watchMethodMapping[EventSrcProxy] = e.doWatchWithProxy</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>函数是根据配置路径的前缀来匹配插件的配置的，而这些前缀同样也是需要提前写好的，<strong>需要动手添加函数</strong>， <code>NewEtcdStore</code> 函数：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">store := &amp;EtcdStore&#123;</span><br><span class=\"line\">    prefix:             prefix,</span><br><span class=\"line\">    clustersDir:        fmt.Sprintf(<span class=\"string\">\"%s/clusters\"</span>, prefix),</span><br><span class=\"line\">    serversDir:         fmt.Sprintf(<span class=\"string\">\"%s/servers\"</span>, prefix),</span><br><span class=\"line\">    bindsDir:           fmt.Sprintf(<span class=\"string\">\"%s/binds\"</span>, prefix),</span><br><span class=\"line\">    apisDir:            fmt.Sprintf(<span class=\"string\">\"%s/apis\"</span>, prefix),</span><br><span class=\"line\">    proxiesDir:         fmt.Sprintf(<span class=\"string\">\"%s/proxies\"</span>, prefix),</span><br><span class=\"line\">    routingsDir:        fmt.Sprintf(<span class=\"string\">\"%s/routings\"</span>, prefix),</span><br><span class=\"line\">    idPath:             fmt.Sprintf(<span class=\"string\">\"%s/id\"</span>, prefix),</span><br><span class=\"line\">    watchMethodMapping: <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[EvtSrc]<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(EvtType, *mvccpb.KeyValue)</span> *<span class=\"title\">Evt</span>),</span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"title\">base</span>:               100,</span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"title\">end</span>:                100,</span></span><br><span class=\"line\"><span class=\"function\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>接下来就是监听etcd的配置信息：</p>\n<p><code>p.dispatcher.load()</code> ——&gt; <code>go r.watch()</code> ——&gt; <code>r.store.Watch(r.watchEventC, r.watchStopC)</code> ——&gt; <code>e.doWatch()</code> ——&gt; <code>e.evtCh &lt;- e.watchMethodMapping[evtSrc](evtType, ev.Kv)</code></p>\n<p>根据etcd出发的事件，判断是哪个插件的配置进行更改或是删除，然后调用在 <code>store.init()</code>中配置的取etcd配置的函数（还未处理），再通过channel发送出去，<strong>需要动手添加一个case处理自定义的插件</strong>。</p>\n<p>在这个流程中的<code>go r.watch()</code>，有着另一条分支路线，<code>go r.readyToReceiveWatchEvent()</code>，<strong>这里也是需要我们添加函数处理的地方，用于根据etcd事件对参数进行实际处理（增删改）</strong>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *dispatcher)</span> <span class=\"title\">readyToReceiveWatchEvent</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tevt := &lt;-r.watchEventC</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> evt.Src == store.EventSrcCluster &#123;</span><br><span class=\"line\">\t\t\tr.doClusterEvent(evt)</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> evt.Src == store.EventSrcServer &#123;</span><br><span class=\"line\">\t\t\tr.doServerEvent(evt)</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> evt.Src == store.EventSrcBind &#123;</span><br><span class=\"line\">\t\t\tr.doBindEvent(evt)</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> evt.Src == store.EventSrcAPI &#123;</span><br><span class=\"line\">\t\t\tr.doAPIEvent(evt)</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> evt.Src == store.EventSrcRouting &#123;</span><br><span class=\"line\">\t\t\tr.doRoutingEvent(evt)</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> evt.Src == store.EventSrcProxy &#123;</span><br><span class=\"line\">\t\t\tr.doProxyEvent(evt)</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tlog.Warnf(<span class=\"string\">\"unknown event &lt;%+v&gt;\"</span>, evt)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>至此，配置参数信息被保存到了结构体<code>dispatcher</code>中，当然若是新增的配置，这里依然是需要在结构体<code>dispatcher</code>中新增一个结构体成员来保存用于自定义插件的配置的。</p>\n<p>那如何使用这些配置呢？</p>\n<p>在context中，插件所使用的函数由proxyContext实现，<code>&quot;gateway\\pkg\\proxy\\filter.go&quot;</code>，这里保存了<code>dispatcher</code>的相关信息，可以由开发者自由拿取数据。</p>\n<p>至此，整个开发阶段全部完成，插件部分逻辑可随着业务更改而进行些许的更改，但整体插件的编写是不会出现太多变动的。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Gateway","slug":"Gateway","permalink":"chunlife.top/tags/Gateway/"}]},{"title":"《工厂女孩》、《打工男孩》观后感","date":"2018-12-12T09:50:22.000Z","path":"2018/12/12/《工厂女孩》、《打工男孩》观后感/","content":"<p>在2018年11月至12月期间，断断续续的将这两本书读完，感受颇大，里面的生活曾经就和我息息相关，差一点就变成了书中某个人物，当时的我一直疑惑：在这样的环境下，想和他们交朋友貌似有一些困难，他们不愿意和我多说一句话，过得一点也不痛快。现在想起，真是庆幸。</p>\n<a id=\"more\"></a>\n\n<p>书中描写了作者以工厂求职者（通俗叫普工）的身份到不同类型的工厂体验，与其说是体验，在我看来更像是“卧底”，在这里把所看所想全部以书面的形式体现出来，在作者身上好像找到了当时的我，最重要的是又让我知道了更多，也帮我解答了之前的疑惑。</p>\n<p>2016年年初，我含着泪水，从我最爱的他手中接过自己的行李，坐上从武昌站开往常平东站的火车，躺在自己的铺位上，从不舍的情绪中转为迷茫。下车后，有堂哥来接我，在东莞他是那个照顾我，收留我的人，更确切地说，堂哥夫妻俩帮我解决了生活上的后顾之忧，宽慰我找工作时不安的情绪，可我总是感觉到心中不愉快，正式开始在印刷厂工作后，每到下班的时候总是想在外面闲逛到天黑才回家。</p>\n<p>先从在东莞找工作说起吧，当我第一天出门去面试，走在路上，总感觉自己被很多人盯着，好似我是个异类，根据我以前对东莞的看法（应该是道听途说来的），不自觉地捂紧了自己的口袋，抓紧自己的手机。陆陆续续的去了好几家公司，都以我是应届毕业生，没有工作经验告终。其中有一家公司让我记忆深刻，直到现在我才明白，这家公司就是书中所说的老班（其实是与工厂合作的劳务公司）。现在还真是感谢自己的“精明”，面试官在给我面试的时候，不停地打听我来自何处，我的家乡他有多熟悉，有几个熟人，直到最后跟我讲工作性质后，语气不再似开始那么随和，更多的是以一种威逼利诱的形式告诉我这个工作需要我去工厂从一线做起，我需要熟悉公司的产品，公司的文化后才能回来这座写字楼中上班，当时的我一直在问：公司的业务是做什么？产品是什么？而他一直在跟我绕圈子，没有正面回答我。这大概就是他们常用的招式吧！当我准备乘坐电梯离开时，看到几个年龄与我相仿的男生，拖着行李，面带希望，开心的交谈着他们去工厂后，理想中的岗位。书中也有这样被带进工厂的人，从最开始的满怀希望，到抱怨不断，最后有逃离了的、有认命不愿挣扎的。</p>\n<p>经过数次的失败后，堂哥托人给我介绍了工作，是一家印刷厂，老板是香港人，厂内大部分人都是广东本地人。第一次去面试，在大堂等了大概一个多小时后被告知面试官没有时间，前台面带歉意的让我先回去，走出厂门后，去旁边的小店吃饭，如书中描述的吃饭的人，他们的表情，人们的动作，以及菜价都那么相似。当我回到家中，准备进行午休时，前台告知我面试官回来了，让我20分钟内赶到，在面试的时候，他不停地接打电话，最后索性在3分钟不到的时间内告诉我工作性质，工作内容，以及他的要求，不容考虑，可想而知双方都没有看上。可是生活就是这样兜来兜去，三天后另一个部门的经理让我过去面试，职位是跟单员，当时的我想着自己的跟单员证终于可以派上用场了，现实告诉我还是太年轻了。经理很诚意的告诉我工作需要加班，会很累，每周的休息时间，并表明愿意给我机会尝试。</p>\n<p>终于开始上班了，带我的是一个来自广西的女生，她很瘦，不爱说话，或许是因为太瘦了没有力气说话吧！在那段时间做的最多的事情是帮她拿打印的文件，陪她去送文件，当去厂房的时候，我居然有一点羡慕那里的文员，因为他们在不停的忙碌，可是跟他们沟通时，不愿多说一句，生产线上的男男女女见到有人过来，立马活跃了起来，围过来聊天，随即就被喊回去工作。吃饭的时候，路上的人总是三三两两的走在一起，靠近了听他们谈论的话题多是“某个男生/女生怎么样，做了什么事情，买了什么东西让他们很惊讶……”或许这是他们在暂停手上工作时最轻松的时刻。他们好像从来不会主动和新来的人说话，如果你主动亲近他们，他们会立刻的产生防御，警告我，禁止从他们身上套取任何信息。难道这不是很矛盾吗？喜欢和别人聊天放松自己，却又防御新来的同事；告诉别人自己的故事，却不允许别人主动和自己交朋友；想要知道的更多，却又不愿意自己的生活方式有所改变。</p>\n<p>或许他们曾经对未来充满希望，希望通过自己工作、加班获得额外的加班费、奖金改变人生轨迹，但是从未想过跳出工厂这个圈子，也许是工厂的环境早已经把他们磨得寡言少语，不允许问为什么，不需要明白做某件事的原理，只需要做到无条件的服从即可。任何有个性的想法在某些管理者看来皆是异类，会带坏他人，会影响大家的工作热情。工厂内，少了尊重，多了强迫；少了激情，多了服从；少了对未来的担忧，多了不知所谓的“快乐”。当我阅读完这两本书后，我开始庆幸，并感谢我身边的那个人，当我告诉他想要离开时，他给了我肯定的回答，变成了我坚强的后盾。</p>\n<p>在书中，描写了工人在一个充满臭味的，肮脏的环境下工作，接触对人体有害的物质，每天重复简单的动作，在工厂工作时间长，要加班，管制严格，不许说话，不准走神，换来的薪水不算多却可以满足农村不能满足的。工厂大多数只招年轻的女孩，年老的都不要，年轻的时光就只值这么点钱么？一个人的青春花在低劣的高耗能工作上，心痛，这是没文化的可怕。用身体去换暂时的金钱。工厂男女比例的失调，也是很多工厂女孩没有一段很好的爱情，被一些渣男像采蜜一样，完了就丢弃，没有性知识，去做人流，落得终身不育。</p>\n<p>唯一一个让我看到希望，感到欣慰的是女孩尽管受到老乡背地里使坏，被人阴，依然没有选择复仇，误入歧途，而是去学习打字，学习粤语，做一名文员，开始翻身。我同时也看到了在一个糟糕的环境下，承受不住，堕落，受伤的案例。</p>\n<p>不管自己处于多低层的社会，不管自己的身份多么低微，不管你有多穷，不要让自己变得对任何事情麻木，从而忘记拼搏。</p>\n<p><strong>我</strong>：很高兴能够看到某人看完书后写下的观后感，不管怎样，我们互相了解，隔阂不再变深。</p>\n","categories":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/categories/随笔/"}],"tags":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/tags/随笔/"}]},{"title":"文件上传服务器端","date":"2018-12-05T06:17:04.000Z","path":"2018/12/05/文件上传-服务器端/","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在之前的项目中，有做过文件上传下载操作，当时对这些操作都不是非常熟悉，所以在实现功能上，停留在能正常工作的前提下，在找到更好的方法后，回头来尝试优化之前的解决方法。</p>\n<p>上传操作中，服务器常使用<code>ParseMultipartForm</code>，解析form表单传递的文件数据。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// in the body of a http.HandlerFunc</span></span><br><span class=\"line\">err := r.ParseMultipartForm(<span class=\"number\">32</span> &lt;&lt; <span class=\"number\">20</span>) <span class=\"comment\">// 32Mb</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    http.Error(w, err.Error(), http.StatusBadRequest)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>调用函数<code>ParseMultipartForm</code>是没有问题的，它会解析http的request body。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ParseMultipartForm parses a request body as multipart/form-data.</span></span><br><span class=\"line\"><span class=\"comment\">// The whole request body is parsed and up to a total of maxMemory bytes of</span></span><br><span class=\"line\"><span class=\"comment\">// its file parts are stored in memory, with the remainder stored on</span></span><br><span class=\"line\"><span class=\"comment\">// disk in temporary files.</span></span><br><span class=\"line\"><span class=\"comment\">// ParseMultipartForm calls ParseForm if necessary.</span></span><br><span class=\"line\"><span class=\"comment\">// After one call to ParseMultipartForm, subsequent calls have no effect.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ParseMultipartForm将请求主体解析为multipart/form-data。</span></span><br><span class=\"line\"><span class=\"comment\">// 解析整个请求体，并将其文件的总maxMemory字节存储在内存中，其余部分存储在</span></span><br><span class=\"line\"><span class=\"comment\">// 临时文件中的磁盘。</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *Request)</span> <span class=\"title\">ParseMultipartForm</span><span class=\"params\">(maxMemory <span class=\"keyword\">int64</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>根据注释，可以得知，不管文件是否过多，或者文件是否为serve端需要，这些文件都会被缓存，这里体现出这个函数对上传的操作性不是太强，若想要增强对文件上传一些限制操作，也就是在读取文件缓存前的一些限制。</p>\n<ul>\n<li>文件类型验证</li>\n<li>文件大小验证</li>\n<li>白名单“字段”</li>\n<li>按顺序解析字段，如果没有则终止</li>\n<li>如果任何验证失败，则提前终止</li>\n<li>没有预先分配</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// function body of a http.HandlerFunc</span></span><br><span class=\"line\">r.Body = http.MaxBytesReader(w, r.Body, <span class=\"number\">32</span>&lt;&lt;<span class=\"number\">20</span>+<span class=\"number\">1024</span>)</span><br><span class=\"line\">reader, err := r.MultipartReader()</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    http.Error(w, err.Error(), http.StatusBadRequest)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// parse text field</span></span><br><span class=\"line\">text := <span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, <span class=\"number\">512</span>)</span><br><span class=\"line\">p, err := reader.NextPart()</span><br><span class=\"line\"><span class=\"comment\">// one more field to parse, EOF is considered as failure here</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> p.FormName() != <span class=\"string\">\"text_field\"</span> &#123;</span><br><span class=\"line\">    http.Error(w, <span class=\"string\">\"text_field is expected\"</span>, http.StatusBadRequest)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">_, err = p.Read(text)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &amp;&amp; err != io.EOF &#123;</span><br><span class=\"line\">    http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// parse file field</span></span><br><span class=\"line\">p, err = reader.NextPart()</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &amp;&amp; err != io.EOF &#123;</span><br><span class=\"line\">    http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> p.FormName() != <span class=\"string\">\"file_field\"</span> &#123;</span><br><span class=\"line\">    http.Error(w, <span class=\"string\">\"file_field is expected\"</span>, http.StatusBadRequest)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">buf := bufio.NewReader(p)</span><br><span class=\"line\">sniff, _ := buf.Peek(<span class=\"number\">512</span>)   <span class=\"comment\">// 判断文件类型</span></span><br><span class=\"line\">contentType := http.DetectContentType(sniff)</span><br><span class=\"line\"><span class=\"keyword\">if</span> contentType != <span class=\"string\">\"application/zip\"</span> &#123;</span><br><span class=\"line\">    http.Error(w, <span class=\"string\">\"file type not allowed\"</span>, http.StatusBadRequest)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">f, err := ioutil.TempFile(<span class=\"string\">\"\"</span>, <span class=\"string\">\"\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">defer</span> f.Close()</span><br><span class=\"line\"><span class=\"keyword\">var</span> maxSize <span class=\"keyword\">int64</span> = <span class=\"number\">32</span> &lt;&lt; <span class=\"number\">20</span></span><br><span class=\"line\">lmt := io.MultiReader(buf, io.LimitReader(p, maxSize - <span class=\"number\">511</span>))</span><br><span class=\"line\">written, err := io.Copy(f, lmt)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &amp;&amp; err != io.EOF &#123;</span><br><span class=\"line\">    http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> written &gt; maxSize &#123;</span><br><span class=\"line\">    os.Remove(f.Name())</span><br><span class=\"line\">    http.Error(w, <span class=\"string\">\"file size over limit\"</span>, http.StatusBadRequest)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// schedule for other stuffs (s3, scanning, etc.)</span></span><br></pre></td></tr></table></figure>\n\n<p>内容参考自：<code>https://medium.com/@owlwalks/dont-parse-everything-from-client-multipart-post-golang-9280d23cd4ad</code>。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"file","slug":"file","permalink":"chunlife.top/tags/file/"},{"name":"http","slug":"http","permalink":"chunlife.top/tags/http/"}]},{"title":"初次使用MongoDB","date":"2018-11-24T08:18:59.000Z","path":"2018/11/24/初次使用MongoDB/","content":"<h2 id=\"简单了解\"><a href=\"#简单了解\" class=\"headerlink\" title=\"简单了解\"></a>简单了解</h2><p>MongoDB在Go中是有官方的API接口库的，不过在官方开发库之前，一直是存在个人开发版（mgo），后来交由社区进行维护了，貌似此人也是与MongoDB官方进行合作进行官方库的开发。</p>\n<a id=\"more\"></a>\n\n<p>官方库大概是2018年出了第一版正式版，现在已经是正在服役阶段了。而不管是社区版还是官方版，且都是在个人版的基础上进行开发，这里都需要感谢<a href=\"https://github.com/niemeyer\" target=\"_blank\" rel=\"noopener\">niemeyer</a>。</p>\n<p>社区版：<a href=\"https://github.com/globalsign/mgo\" target=\"_blank\" rel=\"noopener\">https://github.com/globalsign/mgo</a></p>\n<p>官方版：<a href=\"https://github.com/mongodb/mongo-go-driver\" target=\"_blank\" rel=\"noopener\">https://github.com/mongodb/mongo-go-driver</a></p>\n<p>网上相对较多的资料还是以mgo的为主，比较mongo-go-driver相对较晚，基于同一主干，且mgo也并没有处于废弃状态，所以在使用上依然还是倾向于使用mgo，当然，在官方版更新了好几个版本后，后续会考虑将版本给更换过来。</p>\n<h2 id=\"基础操作\"><a href=\"#基础操作\" class=\"headerlink\" title=\"基础操作\"></a>基础操作</h2><h3 id=\"连接serve\"><a href=\"#连接serve\" class=\"headerlink\" title=\"连接serve\"></a>连接serve</h3><p>mgo：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 解析MongoDB参数</span></span><br><span class=\"line\">mongo, err := mgo.ParseURL(<span class=\"string\">\"mongodb://localhost:27017/articles_demo_dev\"</span>)</span><br><span class=\"line\"><span class=\"comment\">// 1、连接MongoDB</span></span><br><span class=\"line\">s, err := mgo.Dial(<span class=\"string\">\"mongodb://localhost:27017/articles_demo_dev\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">\"Can't connect to mongo, go error %v\\n\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(err.Error())</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"comment\">// 2、选择数据库</span></span><br><span class=\"line\">coll := session.DB(mongo.Database)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 3、选择表（集合）</span></span><br><span class=\"line\">coll.C(g.DbModuleBindFile)</span><br></pre></td></tr></table></figure>\n\n<p>mongo-go-driver：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 1, 建立连接</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> client, err = mongo.Connect(context.TODO(), <span class=\"string\">\"mongodb://localhost:27017\"</span>, clientopt.ConnectTimeout(<span class=\"number\">5</span>*time.Second)); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    fmt.Println(err)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 2, 选择数据库my_db</span></span><br><span class=\"line\">database = client.Database(<span class=\"string\">\"my_db\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 3, 选择表my_collection</span></span><br><span class=\"line\">collection = database.Collection(<span class=\"string\">\"my_collection\"</span>)</span><br></pre></td></tr></table></figure>\n\n<p>插入数据：</p>\n<p>MongoDB的ID是推特很早的时候开源的，tweet的ID。</p>\n<p>snowflake: 毫秒/微秒的当前时间 + 机器的ID + 当前毫秒/微秒内的自增ID(每当毫秒变化了, 会重置成0，继续自增）。</p>\n<p>mgo：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">idTest := bson.NewObjectId()</span><br><span class=\"line\">err = r.C.Insert(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">    <span class=\"string\">\"test\"</span>: <span class=\"string\">\"ID由开发者指定,否则MongoDB自己生成\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"_id\"</span>:  idTest,</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 插入多条数据</span></span><br><span class=\"line\">r.C.Insert(&amp;Person&#123;<span class=\"string\">\"Heln\"</span>, <span class=\"string\">\"31\"</span>&#125;,</span><br><span class=\"line\">           &amp;Person&#123;<span class=\"string\">\"Ana\"</span>, <span class=\"string\">\"32\"</span>&#125;,</span><br><span class=\"line\">           &amp;Person&#123;<span class=\"string\">\"A3a\"</span>, <span class=\"string\">\"27\"</span>&#125;,</span><br><span class=\"line\">           &amp;Person&#123;<span class=\"string\">\"Awa\"</span>, <span class=\"string\">\"24\"</span>&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>mongo-go-driver：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> result, err = collection.InsertOne(context.TODO(), <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">    <span class=\"string\">\"test\"</span>: <span class=\"string\">\"ID由开发者指定,否则MongoDB自己生成\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"one\"</span>:  <span class=\"string\">\"one\"</span>,</span><br><span class=\"line\">&#125;); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// _id: 默认生成一个全局唯一ID, ObjectID：12字节的二进制</span></span><br><span class=\"line\">docId = result.InsertedID.(objectid.ObjectID)</span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"自增ID:\"</span>, docId.Hex())</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查询\"><a href=\"#查询\" class=\"headerlink\" title=\"查询\"></a>查询</h3><p>mgo：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">err = r.C.Find(bson.M&#123;<span class=\"string\">\"index_no\"</span>: <span class=\"string\">\"123\"</span>&#125;).</span><br><span class=\"line\">\tSelect(bson.M&#123;<span class=\"string\">\"_id\"</span>: <span class=\"number\">0</span>, <span class=\"string\">\"test\"</span>: <span class=\"number\">1</span>&#125;).One(&amp;tes)</span><br></pre></td></tr></table></figure>\n\n<p><strong>注意：</strong>查询时，select中除了id外，其他要么是1，要么是0，否则将报错，select是选择返回的参数。</p>\n<p>mongo-go-driver：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 4, 按照jobName字段过滤, 想找出jobName=job10, 找出5条</span></span><br><span class=\"line\">cond = &amp;FindByJobName&#123;JobName: <span class=\"string\">\"job10\"</span>&#125; <span class=\"comment\">// &#123;\"jobName\": \"job10\"&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 5, 查询（过滤 +翻页参数）</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> cursor, err = collection.Find(context.TODO(), cond, findopt.Skip(<span class=\"number\">0</span>), findopt.Limit(<span class=\"number\">2</span>)); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Println(err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 延迟释放游标</span></span><br><span class=\"line\"><span class=\"keyword\">defer</span> cursor.Close(context.TODO())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 6, 遍历结果集</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> cursor.Next(context.TODO()) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 定义一个日志对象</span></span><br><span class=\"line\">\trecord = &amp;LogRecord&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 反序列化bson到对象</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err = cursor.Decode(record); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// 把日志行打印出来</span></span><br><span class=\"line\">\tfmt.Println(*record)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除\"><a href=\"#删除\" class=\"headerlink\" title=\"删除\"></a>删除</h3><p>mgo：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">r.C.Remove(bson.M&#123;<span class=\"string\">\"_id\"</span>: bson.ObjectIdHex(id)&#125;)  <span class=\"comment\">// 多条一条记录</span></span><br><span class=\"line\">r.C.RemoveAll(bson.M&#123;<span class=\"string\">\"_id\"</span>: bson.ObjectIdHex(id)&#125;) <span class=\"comment\">// 多条记录</span></span><br></pre></td></tr></table></figure>\n\n<p>mongo-go-driver：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 4, 要删除开始时间早于当前时间的所有日志($lt是less than)</span></span><br><span class=\"line\"><span class=\"comment\">//  delete(&#123;\"timePoint.startTime\": &#123;\"$lt\": 当前时间&#125;&#125;)</span></span><br><span class=\"line\">delCond = &amp;DeleteCond&#123;beforeCond: TimeBeforeCond&#123;Before: time.Now().Unix()&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 执行删除</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> delResult, err = collection.DeleteMany(context.TODO(), delCond); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\tfmt.Println(err)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"删除的行数:\"</span>, delResult.DeletedCount)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"特殊标识\"><a href=\"#特殊标识\" class=\"headerlink\" title=\"特殊标识\"></a>特殊标识</h2><p>MongoDB的Go<a href=\"https://github.com/mongodb/mongo-go-driver\" target=\"_blank\" rel=\"noopener\">官方库</a>已经是趋于稳定，发布正式版本了，所以作为开发者来说，以后选择官方库应该是最佳选择了，毕竟这个库会一直保持维护的。</p>\n<p>但毕竟是一个新的库，网上大部分博客都是关于<code>mgo</code>这个社区维护版本的库使用方式，这里有一个库使用的example贴出来。</p>\n<p><a href=\"https://github.com/simagix/mongo-go-examples\" target=\"_blank\" rel=\"noopener\">mongo-go-examples</a>。</p>\n<h2 id=\"其他操作\"><a href=\"#其他操作\" class=\"headerlink\" title=\"其他操作\"></a>其他操作</h2><h3 id=\"计算数组大小\"><a href=\"#计算数组大小\" class=\"headerlink\" title=\"计算数组大小\"></a>计算数组大小</h3><p>MongoDB获取内嵌数组的长度：</p>\n<p><a href=\"https://stackoverflow.com/questions/21387969/mongodb-count-the-number-of-items-in-an-array\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/21387969/mongodb-count-the-number-of-items-in-an-array</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; db.mycollection.insert(&#123;&apos;foo&apos;:[1,2,3,4]&#125;)</span><br><span class=\"line\">&gt; db.mycollection.insert(&#123;&apos;foo&apos;:[5,6,7]&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; db.mycollection.aggregate(&#123;$project: &#123; count: &#123; $size:&quot;$foo&quot; &#125;&#125;&#125;)</span><br><span class=\"line\">&#123; &quot;_id&quot; : ObjectId(&quot;5314b5c360477752b449eedf&quot;), &quot;count&quot; : 4 &#125;</span><br><span class=\"line\">&#123; &quot;_id&quot; : ObjectId(&quot;5314b5c860477752b449eee0&quot;), &quot;count&quot; : 3 &#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用Go实现，使用mgo，需要用到聚合操作：</p>\n<p><img src=\"1542714314472.png\" alt=\"数据库数据\"></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mgo</span></span><br><span class=\"line\">pipe := r.C.Pipe([]bson.M&#123;</span><br><span class=\"line\">    &#123;<span class=\"string\">\"$match\"</span>: bson.M&#123;<span class=\"string\">\"_id\"</span>: idTest&#125;&#125;,</span><br><span class=\"line\">    &#123;<span class=\"string\">\"$project\"</span>: bson.M&#123;<span class=\"string\">\"count\"</span>: bson.M&#123;<span class=\"string\">\"$size\"</span>:<span class=\"string\">\"$fileid_bind_module\"</span>&#125;&#125;&#125;,</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">resp := bson.M&#123;&#125;</span><br><span class=\"line\">err = pipe.One(&amp;resp)</span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"error is :\"</span>, err, resp)</span><br><span class=\"line\"><span class=\"comment\">// result:</span></span><br><span class=\"line\"><span class=\"comment\">// map[count:3 _id:ObjectIdHex(\"5bf3f2b290054419149526ef\")]</span></span><br></pre></td></tr></table></figure>\n\n<p>另外一种方法：<a href=\"http://cw.hubwiz.com/card/c/543b2f3cf86387171814c026/1/1/9/\" target=\"_blank\" rel=\"noopener\">$size数组元素个数</a>。</p>\n<h4 id=\"addToSet\"><a href=\"#addToSet\" class=\"headerlink\" title=\"$addToSet\"></a>$addToSet</h4><p>设置一个字段<code>size</code>来保存数组的大小，不过这种操作无法与<code>$addToSet</code>一起进行使用。因为<code>$addToSet</code>不会在数组中插入重复的数据，而inc操作依然会继续加<code>1</code>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">err := r.C.Update(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t<span class=\"string\">\"_id\"</span>: bson.ObjectIdHex(<span class=\"string\">\"5bebe0cf7f45aa3270c9e532\"</span>),</span><br><span class=\"line\">&#125;, <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t<span class=\"string\">\"$addToSet\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">\"test\"</span>: <span class=\"string\">\"1234567890\"</span>,</span><br><span class=\"line\">\t&#125;,</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"加一个size字段\"><a href=\"#加一个size字段\" class=\"headerlink\" title=\"加一个size字段\"></a>加一个size字段</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">err = db.C(<span class=\"string\">\"xxxxxx\"</span>).Update(bson.M&#123;<span class=\"string\">\"_id\"</span>: tmpFile.Id&#125;,</span><br><span class=\"line\">\t<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t<span class=\"string\">\"$push\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;<span class=\"string\">\"file_id_list\"</span>: p.FileIdList[<span class=\"number\">0</span>]&#125;,</span><br><span class=\"line\">\t<span class=\"string\">\"$inc\"</span>:  <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;<span class=\"string\">\"list_size\"</span>: <span class=\"number\">1</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MongoDB数组操作\"><a href=\"#MongoDB数组操作\" class=\"headerlink\" title=\"MongoDB数组操作\"></a>MongoDB数组操作</h3><p>对数组的增删查改，可以学习：<a href=\"https://www.cnblogs.com/ljhdo/p/5428037.html\" target=\"_blank\" rel=\"noopener\">MongoDB 数组</a>。</p>\n<h4 id=\"mgo查找单层数组\"><a href=\"#mgo查找单层数组\" class=\"headerlink\" title=\"mgo查找单层数组\"></a>mgo查找单层数组</h4><p><img src=\"1542714781584.png\" alt=\"单层数组\"></p>\n<p>代码中需要使用到<code>$elemMatch</code>参数。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">err = r.C.Find(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">        <span class=\"string\">\"test\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">        <span class=\"string\">\"$elemMatch\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;<span class=\"string\">\"$eq\"</span>: ids&#125;,</span><br><span class=\"line\">\t&#125;,</span><br><span class=\"line\">&#125;).One(&amp;bind)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"mgo查找多层数组\"><a href=\"#mgo查找多层数组\" class=\"headerlink\" title=\"mgo查找多层数组\"></a>mgo查找多层数组</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> testData <span class=\"keyword\">interface</span>&#123;&#125;</span><br><span class=\"line\">err = r.C.Find(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">    <span class=\"string\">\"_id\"</span>: idTest123,</span><br><span class=\"line\">    <span class=\"string\">\"testArr\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">    <span class=\"string\">\"$elemMatch\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;<span class=\"string\">\"test1\"</span>: <span class=\"number\">1</span>&#125;,</span><br><span class=\"line\">\t&#125;,</span><br><span class=\"line\">&#125;).One(&amp;testData)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"mgo删除数组元素\"><a href=\"#mgo删除数组元素\" class=\"headerlink\" title=\"mgo删除数组元素\"></a>mgo删除数组元素</h4><p>删除数组元素，会将该子结构完全删除。</p>\n<h5 id=\"删除单层数组\"><a href=\"#删除单层数组\" class=\"headerlink\" title=\"删除单层数组\"></a>删除单层数组</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">err := r.C.Update(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t<span class=\"string\">\"_id\"</span>: idTest,</span><br><span class=\"line\">&#125;, <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t<span class=\"string\">\"$pull\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">\"test\"</span>: <span class=\"string\">\"123\"</span>,</span><br><span class=\"line\">\t&#125;,</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"删除两层数组\"><a href=\"#删除两层数组\" class=\"headerlink\" title=\"删除两层数组\"></a>删除两层数组</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 删除数组元素</span></span><br><span class=\"line\">r.C.Update(<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t<span class=\"string\">\"_id\"</span>: idTest123&#125;,</span><br><span class=\"line\">\t<span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">\"$pull\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t\t\t<span class=\"string\">\"testArr\"</span>: <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">\"test1\"</span>: <span class=\"number\">1</span>&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"聚合操作：Aggregation\"><a href=\"#聚合操作：Aggregation\" class=\"headerlink\" title=\"聚合操作：Aggregation\"></a>聚合操作：Aggregation</h4><p><code>$match</code>：类似于find中条件匹配；</p>\n<p><code>$unwind</code>：将数组拆开，化成一个个独立信息，除了散开的数组字段不同，其他字段均相同；</p>\n<p><code>$skip</code>与<code>limit</code>：类似于MongoDB中的skip与limit；</p>\n<p><code>$project</code>：修改输入文档的结构。可以用来重命名、增加或删除域，指定获取的字段，没有的字段，也可以用于创建计算结果以及嵌套文档。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipe := r.C.Pipe([]bson.M&#123;</span><br><span class=\"line\">\t&#123;<span class=\"string\">\"$match\"</span>: bson.M&#123;<span class=\"string\">\"_id\"</span>: idTest123, <span class=\"string\">\"product_id\"</span>: <span class=\"number\">123</span>&#125;&#125;,</span><br><span class=\"line\">\t&#123;<span class=\"string\">\"$unwind\"</span>: <span class=\"string\">\"$testArr\"</span>&#125;,</span><br><span class=\"line\">\t&#123;<span class=\"string\">\"$skip\"</span>: <span class=\"number\">1</span>&#125;,</span><br><span class=\"line\">\t&#123;<span class=\"string\">\"$limit\"</span>: <span class=\"number\">1</span>&#125;,</span><br><span class=\"line\">\t&#123;<span class=\"string\">\"$project\"</span>: bson.M&#123;<span class=\"string\">\"product_id\"</span>: <span class=\"number\">1</span>, <span class=\"string\">\"one\"</span>: <span class=\"string\">\"$testArr.test1\"</span>&#125;&#125;,</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">resp := bson.M&#123;&#125;</span><br><span class=\"line\">err = pipe.One(&amp;resp)  </span><br><span class=\"line\"><span class=\"comment\">//pipe.All(&amp;resp)  匹配数据表中全部符合的数据</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用objectID查询某一时间段内数据\"><a href=\"#用objectID查询某一时间段内数据\" class=\"headerlink\" title=\"用objectID查询某一时间段内数据\"></a>用objectID查询某一时间段内数据</h3><p>ObjectID是由精确到秒的时间戳再加上机器标识等信息组成的，并且建有索引，因此ObjectID本身就可以用于按时间范围查询数据，而不用专门另建时间戳字段和索引。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">timeToObjId</span><span class=\"params\">(t <span class=\"keyword\">int64</span>)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//var t = time.Now().Unix()</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 转换成16进制的字符串，再加补齐16个0</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fmt.Sprintf(<span class=\"string\">\"%x0000000000000000\"</span>, t)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//往前多少天时间戳</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">GetUnixToOldTimeDay</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span> <span class=\"title\">int64</span></span> &#123;</span><br><span class=\"line\">\tday := time.Now().Day()</span><br><span class=\"line\">\toldMonth := day - i</span><br><span class=\"line\">\tt := time.Date(time.Now().Year(), time.Now().Month(), oldMonth, time.Now().Hour(), time.Now().Minute(), time.Now().Second(), time.Now().Nanosecond(), time.Local)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> t.Unix()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">objIdOneMonth</span><span class=\"params\">()</span> <span class=\"params\">(oldMonthId <span class=\"keyword\">string</span>, nowId <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">\ttimeUinx := GetUnixToOldTimeDay(<span class=\"number\">30</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\toldMonthId = timeToObjId(timeUinx)</span><br><span class=\"line\">\tnowId = timeToObjId(time.Now().Unix())</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">db.C(DbSysMsg).Pipe([]bson.M&#123;</span><br><span class=\"line\">\t\t\t&#123;<span class=\"string\">\"$match\"</span>: bson.M&#123;<span class=\"string\">\"_id\"</span>: bson.M&#123;<span class=\"string\">\"$lte\"</span>: bson.ObjectIdHex(nowId),</span><br><span class=\"line\">                                           <span class=\"string\">\"$gt\"</span>: bson.ObjectIdHex(oldMonthId)&#125;&#125;&#125;,</span><br><span class=\"line\">\t\t\t&#123;<span class=\"string\">\"$limit\"</span>: <span class=\"number\">200</span>&#125;, <span class=\"comment\">//每个月1号都清除当前时间的前200条已经空了的消息连接关系</span></span><br><span class=\"line\">\t\t\t&#123;<span class=\"string\">\"$project\"</span>: bson.M&#123;<span class=\"string\">\"count\"</span>: bson.M&#123;<span class=\"string\">\"$size\"</span>: <span class=\"string\">\"user_list_status\"</span>&#125;&#125;&#125;,</span><br><span class=\"line\">\t\t&#125;)</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"MongoDB","slug":"MongoDB","permalink":"chunlife.top/categories/MongoDB/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"MongoDB","slug":"MongoDB","permalink":"chunlife.top/tags/MongoDB/"}]},{"title":"slice理解以及range","date":"2018-10-22T12:56:26.000Z","path":"2018/10/22/slice理解/","content":"<h2 id=\"slice理解\"><a href=\"#slice理解\" class=\"headerlink\" title=\"slice理解\"></a>slice理解</h2><p>slice本身没有数据，是对底层的一个view。</p>\n<a id=\"more\"></a>\n\n<p>为什么这么说呢，可以看看slice的构造。</p>\n<p>可以看到切片的结构体由3部分构成，Pointer 是指向一个数组的指针，len 代表当前切片的长度，cap 是当前切片的容量。cap 总是大于等于 len 的。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> slice <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tarray unsafe.Pointer</span><br><span class=\"line\">\t<span class=\"built_in\">len</span>   <span class=\"keyword\">int</span></span><br><span class=\"line\">\t<span class=\"built_in\">cap</span>   <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用时，切片类似动用的是指针，真正占用内存的是实际分配了内存的一个数组，所以说其本身没有数据。</p>\n<p><img src=\"1540737171037.png\" alt=\"slice的实现\"></p>\n<p>更多slice的代码细节可以参考：<a href=\"https://halfrost.com/go_slice/\" target=\"_blank\" rel=\"noopener\">深入解析 Go 中 Slice 底层实现</a></p>\n<h2 id=\"slice的扩展\"><a href=\"#slice的扩展\" class=\"headerlink\" title=\"slice的扩展\"></a>slice的扩展</h2><p>先上一段代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">arr := [...]<span class=\"keyword\">int</span>&#123;<span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>, <span class=\"number\">5</span>, <span class=\"number\">6</span>, <span class=\"number\">7</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">arr[<span class=\"number\">0</span>], arr[<span class=\"number\">2</span>] = <span class=\"number\">0</span>, <span class=\"number\">2</span></span><br><span class=\"line\">s1 := arr[<span class=\"number\">2</span>:<span class=\"number\">6</span>]</span><br><span class=\"line\">s2 := s1[<span class=\"number\">3</span>:<span class=\"number\">5</span>] <span class=\"comment\">// [s1[3], s1[4]]</span></span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"s1=%v, len(s1)=%d, cap(s1)=%d\\n\"</span>, s1, <span class=\"built_in\">len</span>(s1), <span class=\"built_in\">cap</span>(s1))</span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"s2=%v, len(s2)=%d, cap(s2)=%d\\n\"</span>, s2, <span class=\"built_in\">len</span>(s2), <span class=\"built_in\">cap</span>(s2))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 结果：</span></span><br><span class=\"line\"><span class=\"comment\">// s1=[2 3 4 5], len(s1)=4, cap(s1)=6</span></span><br><span class=\"line\"><span class=\"comment\">// s2=[5 6], len(s2)=2, cap(s2)=3</span></span><br></pre></td></tr></table></figure>\n\n<p>结果是比较奇怪的，因为S1切片元素中没有元素[6]，为什么会出现这个现象呢，说到底还是由于slice的特性导致的，其作为对于底层数组的一个view。</p>\n<p>s1 = arr[2:6]，s1这里依然作为arr数组的view，当s2在s1的基础上取数据时，操作的底层数组都为arr，而s1[3:5]下标对应的arr的元素恰好是[5 6]。</p>\n<p>参考图片描述，可以看到不同slice，对应底层数组的下标变化。</p>\n<p><img src=\"slice%E7%9A%84%E6%89%A9%E5%B1%95.png\" alt=\"slice的扩展\"></p>\n<p>slice的len限定了切片能够索引的数据，但并不代表slice只能“看到”len长度的数据，capacity才表示底层数组具体的内存大小。</p>\n<p>也就是说：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fmt.Printf(<span class=\"string\">\"s2=%v \\n\"</span>, s2[<span class=\"number\">2</span>])  <span class=\"comment\">// 报错，panic: runtime error: index out of range</span></span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"s2=%v \\n\"</span>, s2[<span class=\"number\">2</span>:<span class=\"number\">3</span>])  <span class=\"comment\">// '7'</span></span><br></pre></td></tr></table></figure>\n\n<p>总的可以继续得出：</p>\n<p><code>slice可以向后扩展，不可以向前扩展</code><br><code>s[i]不可以超越len(s)，向后扩展不可以超越底层数组cap(s)</code></p>\n<h2 id=\"添加slice\"><a href=\"#添加slice\" class=\"headerlink\" title=\"添加slice\"></a>添加slice</h2><p><code>添加元素时如果超越cap，系统会重新分配更大的底层数组</code></p>\n<p>这里的重新分配，也就是意味着底层数据会被copy到一个新的内存，此内存的容量大于分配前的底层数组。至于会分配多大的内存，一般采取的是一次性给足，而不是适量分配。</p>\n<p>例如：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// https://www.cnblogs.com/baylorqu/p/9588733.html idea上运行正常</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">testAppend</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ts := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">\toldcap := <span class=\"built_in\">cap</span>(s)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">20</span>; i++ &#123;</span><br><span class=\"line\">\t\ts = <span class=\"built_in\">append</span>(s, i)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newcap := <span class=\"built_in\">cap</span>(s); oldcap &lt; newcap &#123;</span><br><span class=\"line\">\t\t\tfmt.Printf(<span class=\"string\">\"oldcap %d ===&gt; newcap %d\\n\"</span>, oldcap, newcap)</span><br><span class=\"line\">\t\t\toldcap = newcap</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//oldcap 1 ===&gt; newcap 2</span></span><br><span class=\"line\"><span class=\"comment\">//oldcap 2 ===&gt; newcap 4</span></span><br><span class=\"line\"><span class=\"comment\">//oldcap 4 ===&gt; newcap 8</span></span><br><span class=\"line\"><span class=\"comment\">//oldcap 8 ===&gt; newcap 16</span></span><br><span class=\"line\"><span class=\"comment\">//oldcap 16 ===&gt; newcap 32</span></span><br></pre></td></tr></table></figure>\n\n<p><code>由于值传递的关系，必须接收append的返回值</code></p>\n<p><code>append的用法：s=append(s,Val)</code></p>\n<p>这里另举一个有意思的代码，引出下一个章节。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"keyword\">range</span> v &#123;</span><br><span class=\"line\">\tv = <span class=\"built_in\">append</span>(v, i)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>看这个代码是否可以猜到代码运行结果呢？程序是否会崩溃呢？</p>\n<h2 id=\"go-range\"><a href=\"#go-range\" class=\"headerlink\" title=\"go range\"></a>go range</h2><p>在实际的打印结果中，可以看到打印是：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[1 2 3 0 1 2]</span><br></pre></td></tr></table></figure>\n\n<p>比较奇怪，打印成功，而不是死循环。</p>\n<p>不是死循环，切片增加了三个元素，循环了三次，为什么会循环三次呢？好像和slice的长度有关系，粗略的看是可以这么看的，这里我找了下具体原因。</p>\n<p>由于懒，先看了下前辈们是否有分析过这个问题，所以直接上了Google，果然没有让我失望，参考：<a href=\"http://newt0n.github.io/2017/04/06/Go-Range-%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0/?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io\" target=\"_blank\" rel=\"noopener\">Go Range 内部实现</a>。</p>\n<p>博客看到range语法糖还原部分，就可以得到我所需要的信息了。取自博客：</p>\n<p><code>range</code> 循环在内部实现上实际就是 C 风格循环的语法糖，意料之外而又在情理之中。编译器会对每一种 <code>range</code> 支持的类型做专门的 “<strong>语法糖还原</strong>”。比如，</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//   slice</span></span><br><span class=\"line\"><span class=\"comment\">//   for_temp := range</span></span><br><span class=\"line\"><span class=\"comment\">//   len_temp := len(for_temp)</span></span><br><span class=\"line\"><span class=\"comment\">//   for index_temp = 0; index_temp &lt; len_temp; index_temp++ &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//           value_temp = for_temp[index_temp]</span></span><br><span class=\"line\"><span class=\"comment\">//           index = index_temp</span></span><br><span class=\"line\"><span class=\"comment\">//           value = value_temp</span></span><br><span class=\"line\"><span class=\"comment\">//           original body</span></span><br><span class=\"line\"><span class=\"comment\">//   &#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>可以看到的是，这个转化在编译器编译时完成，也就是说range循环的长度不会在运行时产生变化的，<strong>因为slice的长度是被直接赋值给了一个临时变量，所以slice本身的长度变化，并不能影响到整个循环的变化</strong>。</p>\n<p>这段代码之所以会终止是因为它其实可以粗略的翻译成类似下面的这段：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for_temp := v</span><br><span class=\"line\">len_temp := len(for_temp)</span><br><span class=\"line\">for index_temp = 0; index_temp &lt; len_temp; index_temp++ &#123;</span><br><span class=\"line\">        value_temp = for_temp[index_temp]</span><br><span class=\"line\">        index = index_temp</span><br><span class=\"line\">        value = value_temp</span><br><span class=\"line\">        v = append(v, index)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们知道切片实际上是一个结构体的语法糖，这个结构体有着一个指向数组的指针成员。在循环开始前对这个结构体生成副本然后赋值给 <code>for_temp</code>，后面的循环实际上是在对 <code>for_temp</code> 进行迭代。任何对于原始变量 <code>v</code> 本身（而非对其背后指向的数组）的更改都和生成的副本 <code>for_temp</code> 没有关系。<strong>但其背后指向的数组还是以指针的形式共享给 <code>v</code> 和 <code>for_temp</code>，所以 <code>v[i] = 1</code> 这样的语句仍然可以工作</strong>。</p>\n<p>这里引出我遇到的一个问题，我需要移除slice中的一些参数，于是在range中做一些判断，然后使用类似于<code>arr = append(arr[:2], arr[3:]...)</code>。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">testRangeSlice</span><span class=\"params\">(arr []<span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%p \\n\"</span>, &amp;arr)</span><br><span class=\"line\">\tfmt.Println(<span class=\"built_in\">cap</span>(arr), <span class=\"built_in\">len</span>(arr), arr)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index, a := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> index == <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\tarr = <span class=\"built_in\">append</span>(arr[:<span class=\"number\">2</span>], arr[<span class=\"number\">3</span>:]...)</span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"built_in\">cap</span>(arr), <span class=\"built_in\">len</span>(arr), arr)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"index\"</span>, index, a)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfmt.Println(<span class=\"built_in\">cap</span>(arr), <span class=\"built_in\">len</span>(arr), arr)</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%p \\n\"</span>, &amp;arr)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>执行结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0xc000042400 </span><br><span class=\"line\">6 6 [1 2 3 4 5 6]</span><br><span class=\"line\">index 0 1</span><br><span class=\"line\">index 1 2</span><br><span class=\"line\">6 5 [1 2 4 5 6]</span><br><span class=\"line\">index 2 3</span><br><span class=\"line\">index 3 5</span><br><span class=\"line\">index 4 6   // ********</span><br><span class=\"line\">index 5 6   // ********</span><br><span class=\"line\">6 5 [1 2 4 5 6]</span><br><span class=\"line\">0xc000042400</span><br></pre></td></tr></table></figure>\n\n<p>可以看到执行结果出现了重复的数据，原始数据的<code>4</code>没有被访问到，这里依然是range语法糖还原后造成的这个结果。中期改变切片，造成切片数据的变化（这里应该是造成了底层数组的真实变化），因为长度早已被固定，这里依然会选择循环<code>6</code>次，而slice的容量没有因为append操作改变，依然为<code>6</code>。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"slice","slug":"slice","permalink":"chunlife.top/tags/slice/"},{"name":"range","slug":"range","permalink":"chunlife.top/tags/range/"}]},{"title":"我收藏的博客","date":"2018-10-22T12:56:26.000Z","path":"2018/10/22/我收藏的博客/","content":"<p>有干货，界面好看的博客  <a href=\"https://halfrost.com\" target=\"_blank\" rel=\"noopener\">https://halfrost.com</a></p>\n<hr>\n<p>阮一峰，<a href=\"https://www.yuque.com/ruanyf/share\" target=\"_blank\" rel=\"noopener\">每周分享</a></p>\n<hr>\n<a id=\"more\"></a>\n\n<p><a href=\"https://www.cnblogs.com/esingchan/p/3958962.html\" target=\"_blank\" rel=\"noopener\">ZIP压缩算法详细分析及解压实例解释</a></p>\n<hr>\n<p>次碳酸钴的<a href=\"https://www.web-tinker.com/articles/\" target=\"_blank\" rel=\"noopener\">技术博客</a></p>\n<hr>\n<p>Articles by <a href=\"http://blog.ralch.com/articles/\" target=\"_blank\" rel=\"noopener\">Svetlin Ralchev</a>，博客质量都挺高，界面很简洁。</p>\n<hr>\n<p>初学者<a href=\"https://www.kancloud.cn/liupengjie/go/570004\" target=\"_blank\" rel=\"noopener\">资料</a>，用于突然忘记基础知识的时候，去看看。</p>\n<hr>\n<p><a href=\"https://github.com/developer-learning/reading-go\" target=\"_blank\" rel=\"noopener\">Go 每日阅读和 Go 夜读</a></p>\n<hr>\n<p><a href=\"http://blog.betacat.io/post/raft-implementation-in-etcd/#life-of-a-vote-request\" target=\"_blank\" rel=\"noopener\">Raft在etcd中的实现</a></p>\n<hr>\n<p>Go标准库的示例，查看string包的时候翻到的，<a href=\"https://github.com/polaris1119/The-Golang-Standard-Library-by-Example\" target=\"_blank\" rel=\"noopener\">The-Golang-Standard-Library-by-Example</a></p>\n<hr>\n<p><a href=\"https://github.com/gocn/news\" target=\"_blank\" rel=\"noopener\">GoCN</a> 每日新闻</p>\n<hr>\n<p><a href=\"https://github.com/521xueweihan/git-tips\" target=\"_blank\" rel=\"noopener\">git-tips</a>，有一个很详细的<a href=\"https://github.com/521xueweihan/git-tips/blob/master/git.png\" target=\"_blank\" rel=\"noopener\">思维导图</a>。</p>\n<h3 id=\"面试时需要\"><a href=\"#面试时需要\" class=\"headerlink\" title=\"面试时需要\"></a>面试时需要</h3><p>技术面试必备<a href=\"https://cyc2018.github.io/CS-Notes/#/README\" target=\"_blank\" rel=\"noopener\">基础知识</a></p>\n<p><img src=\"1554885421792.png\" alt=\"帮助了解\"></p>\n<p><a href=\"https://github.com/xmge/gonote\" target=\"_blank\" rel=\"noopener\">xmge/gonote</a>，<code>go</code>学习笔记。</p>\n<p><img src=\"1554885523893.png\" alt=\"学习笔记\"></p>\n<p><a href=\"https://github.com/imhuay/Algorithm_Interview_Notes-Chinese\" target=\"_blank\" rel=\"noopener\">imhuay/Algorithm_Interview_Notes-Chinese</a>，2018/2019/校招/春招/秋招/算法/机器学习(Machine Learning)/深度学习(Deep Learning)/自然语言处理(NLP)/C/C++/Python/面试笔记。</p>\n<p><img src=\"1554885757696.png\" alt=\"面试\"></p>\n<p><a href=\"https://github.com/MisterBooo/LeetCodeAnimation\" target=\"_blank\" rel=\"noopener\">MisterBooo/LeetCodeAnimation</a>，用动画的形式呈现解LeetCode题目的思路。</p>\n<p><img src=\"1554886318716.png\" alt=\"动画算法\"></p>\n<p><a href=\"https://github.com/Snailclimb/JavaGuide\" target=\"_blank\" rel=\"noopener\">【Java学习+面试指南】</a> 一份涵盖大部分Java程序员所需要掌握的核心知识。</p>\n<p><img src=\"1554886372815.png\" alt=\"1554886372815\"></p>\n<p><a href=\"https://github.com/kylesliu/awesome-golang-leetcode\" target=\"_blank\" rel=\"noopener\">kylesliu/awesome-golang-leetcode</a>，使用Go语言解题。</p>\n<p><img src=\"1554886435676.png\" alt=\"1554886435676\"></p>\n","categories":[{"name":"学习","slug":"学习","permalink":"chunlife.top/categories/学习/"}],"tags":[{"name":"学习博客","slug":"学习博客","permalink":"chunlife.top/tags/学习博客/"}]},{"title":"Go依赖管理","date":"2018-10-18T14:32:48.000Z","path":"2018/10/18/go 依赖管理/","content":"<h2 id=\"依赖管理的选择\"><a href=\"#依赖管理的选择\" class=\"headerlink\" title=\"依赖管理的选择\"></a>依赖管理的选择</h2><p>Go主要依赖管理工具包括dep，govendor，glide，gomodule。</p>\n<a id=\"more\"></a>\n\n<p>dep：<a href=\"https://github.com/golang/dep\" target=\"_blank\" rel=\"noopener\">https://github.com/golang/dep</a></p>\n<p>govendor：<a href=\"https://github.com/kardianos/govendor\" target=\"_blank\" rel=\"noopener\">https://github.com/kardianos/govendor</a></p>\n<p>glide：<a href=\"https://github.com/Masterminds/glide/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/Masterminds/glide/releases</a></p>\n<p>dep，govendor，gomodule，前两者是使用go 1.5版本的Vendor特性，已成为go的实际功能，其非常成熟；</p>\n<p>gomodule是作为Go 1.11引入的新特性，还未正式合并作为一个功能，为此，go废弃了之前作为准官方的vendor机制，目的是为了摆脱Go项目中一直存在坏境变量：GOPATH，而且目前可以使用此功能配合<a href=\"https://github.com/gomods/athens\" target=\"_blank\" rel=\"noopener\">athens</a>，做到访问私人仓库，访问国外仓库，使依赖管理做到无任何多余的操作。参考<a href=\"http://blog.cyeam.com/golang/2018/09/27/athens#get-goproxyvlist-%E8%BF%94%E5%9B%9E%E6%89%80%E6%9C%89%E5%B7%B2%E7%9F%A5%E7%9A%84%E5%BD%93%E5%89%8D-module-%E7%9A%84%E7%89%88%E6%9C%AC%E5%8F%B7%E6%AF%8F%E8%A1%8C%E4%B8%80%E6%9D%A1\" target=\"_blank\" rel=\"noopener\">为 Go module 搭建私服</a>，需要搭建代理服务器，未来建议包依赖管理可使用该功能。</p>\n<p>上述几种功能在使用中，面对私人仓库，均出现一些拉取错误，无法正常的进行拉取，进行相应的配置后，错误并未消除，选用glide后，可以顺利完成包管理的操作，而且目前来说，Glide几乎等同于官方依赖管理工具，gomodule也可以兼容Glide的管理，这里有包管理工具一些对比：<a href=\"https://github.com/Masterminds/glide/wiki/Go-Package-Manager-Comparison。\" target=\"_blank\" rel=\"noopener\">https://github.com/Masterminds/glide/wiki/Go-Package-Manager-Comparison。</a></p>\n<h2 id=\"Glide\"><a href=\"#Glide\" class=\"headerlink\" title=\"Glide\"></a>Glide</h2><p>Glide信息可以参考官方文档：<a href=\"https://glidedocs.readthedocs.io/zh/latest/glide.yaml/\" target=\"_blank\" rel=\"noopener\">https://glidedocs.readthedocs.io/zh/latest/glide.yaml/</a></p>\n<h3 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h3><p>下载glide，<a href=\"https://github.com/Masterminds/glide/releases，将文件放至$GOROOT/bin。\" target=\"_blank\" rel=\"noopener\">https://github.com/Masterminds/glide/releases，将文件放至$GOROOT/bin。</a></p>\n<p>使用代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"log\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t. <span class=\"string\">\"gitlab.com/Utils/ErrCode\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlog.Println(<span class=\"string\">\"test\"</span>, ERROR[<span class=\"string\">\"OK\"</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用Glide\"><a href=\"#使用Glide\" class=\"headerlink\" title=\"使用Glide\"></a>使用Glide</h3><p><strong>注意</strong>：Glide与其他利用Vendor特性的工具一样，工程项目必须要放在GOPATH目录下。</p>\n<h4 id=\"大概流程：\"><a href=\"#大概流程：\" class=\"headerlink\" title=\"大概流程：\"></a>大概流程：</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">进入到项目目录</span></span><br><span class=\"line\">cd ~/src/testDep</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">glide初始化，初始化配置文件glide.yaml</span></span><br><span class=\"line\">glide init</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">glide加载依赖包，自动归档到vendor目录</span></span><br><span class=\"line\">glide up -v</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"示例：\"><a href=\"#示例：\" class=\"headerlink\" title=\"示例：\"></a>示例：</h4><p>在项目顶层目录运行：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ glide.exe init testDep  <span class=\"comment\"># specify project name</span></span><br></pre></td></tr></table></figure>\n\n<p>该工具会将项目依赖自动扫入配置文件（glide.yaml）中。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">package:</span> <span class=\"string\">testDep</span></span><br><span class=\"line\"><span class=\"attr\">import:</span></span><br><span class=\"line\"><span class=\"attr\">- package:</span> <span class=\"string\">gitlab.com/Utils</span></span><br></pre></td></tr></table></figure>\n\n<p>接下来可以使用”glide.exe install”，但对于私有库，若直接安装将无法正常clone到git项目，需要手动对配置文件进行改造：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">package:</span> <span class=\"string\">testDep</span></span><br><span class=\"line\"><span class=\"attr\">import:</span></span><br><span class=\"line\"><span class=\"attr\">- package:</span> <span class=\"string\">gitlab.com/Utils</span></span><br><span class=\"line\"><span class=\"attr\">  repo:</span>    <span class=\"string\">git@172.16.8.189:third-party/Utils.git</span></span><br><span class=\"line\"><span class=\"attr\">  version:</span> <span class=\"string\">branch</span></span><br></pre></td></tr></table></figure>\n\n<p>repo：指定真实仓库地址；</p>\n<p>version：指定tag，branch等其他参数，具体可参考文档。</p>\n<p>完成后，可使用：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ glide.exe install // 或者是glide up -v，配置文件更改后使用，一般第一次使用install，后面使用up</span><br></pre></td></tr></table></figure>\n\n<p>正常情况下，会自动下载Git项目到vendor目录中，且生成”glide.lock”。</p>\n<h3 id=\"其他操作\"><a href=\"#其他操作\" class=\"headerlink\" title=\"其他操作\"></a>其他操作</h3><h3 id=\"手动更新包依赖\"><a href=\"#手动更新包依赖\" class=\"headerlink\" title=\"手动更新包依赖\"></a>手动更新包依赖</h3><p>glide get操作通过手动维护Git包，使用此命令，包配置会自动配置到配置文件中，但对于私有仓库的操作是无法成功的。</p>\n<p>示例，#后面跟tag，branch。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">glide get github.com/go-sql-driver/mysql#v1.2</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"包被墙\"><a href=\"#包被墙\" class=\"headerlink\" title=\"包被墙\"></a>包被墙</h3><p>包若因为网络因素被墙，可使用glide的mirror命令绕过一些包访问的问题。</p>\n<p>例如<a href=\"https://golang.org/x/net。\" target=\"_blank\" rel=\"noopener\">https://golang.org/x/net。</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> glide mirror <span class=\"built_in\">set</span> https://golang.org/x/net https://github.com/golang/net --vcs git</span></span><br></pre></td></tr></table></figure>\n\n<p>然后使用update。</p>\n<p>这里glide无法处理包的子包，那可以参考：<a href=\"https://zhuanlan.zhihu.com/p/31402004\" target=\"_blank\" rel=\"noopener\">让golang依赖也走mirror</a>，参考<a href=\"https://github.com/jokimina/glide-mirrors-yaml，一些常用的mirror，将文件放到~/.glide/。\" target=\"_blank\" rel=\"noopener\">https://github.com/jokimina/glide-mirrors-yaml，一些常用的mirror，将文件放到~/.glide/。</a></p>\n<p>对包被墙的一些解决办法：<a href=\"https://blog.csdn.net/fenglailea/article/details/79107124\" target=\"_blank\" rel=\"noopener\">golang 包管理工具</a>，综合来看，唯有代理才能彻底解决这个痛点。</p>\n<h2 id=\"项目管理\"><a href=\"#项目管理\" class=\"headerlink\" title=\"项目管理\"></a>项目管理</h2><p>上传git项目一般是只需上传glide.lock，glide.yaml即可，vendor目录可不做上传，若网络包被本地修改，或包需翻墙进行下载，此时建议一并上传。</p>\n<p>若依赖需要更新，或者配置更改，则可使用update。</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ glide.exe update</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Add-2019-3-19\"><a href=\"#Add-2019-3-19\" class=\"headerlink\" title=\"Add 2019-3-19\"></a>Add 2019-3-19</h2><p>go如今已经发布到1.12了，之前说过Go1.11强势发布了gomodule特性，以此来统一整个包管理的江湖，但在之前刚发布时，对这个的使用实在是有点搞不明白，不过在不经意间就找到了一个Go的包代理网站，以此来使用gomodule即可应对各类<code>墙</code>包。<a href=\"https://goproxy.io。\" target=\"_blank\" rel=\"noopener\">https://goproxy.io。</a></p>\n<p>1、升级Go1.12，启用GO111MODULE</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export GO111MODULE=on</span><br></pre></td></tr></table></figure>\n\n<p>2、配置GOPROXY</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export GOPROXY=https://goproxy.io</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Glide","slug":"Glide","permalink":"chunlife.top/tags/Glide/"},{"name":"包依赖管理","slug":"包依赖管理","permalink":"chunlife.top/tags/包依赖管理/"}]},{"title":"Go依赖管理","date":"2018-10-18T14:32:48.000Z","path":"2018/10/18/go build条件编译/","content":"<p><a href=\"http://manguijie.top/2018/08/go-condition-build\" target=\"_blank\" rel=\"noopener\">go build条件编译</a></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"}]},{"title":"Go打印结构体的field","date":"2018-10-12T03:12:20.000Z","path":"2018/10/12/Go打印结构体的field/","content":"<p>Go可以很方便的打印出结构体的<code>field</code>，不同于<code>json.Marshal()</code>操作，<code>json</code>操作有很多局限性，首先其要求结构体字段为大写字段，否则没有访问权限，其二，其会多出一步函数调用，比较麻烦。</p>\n<a id=\"more\"></a>\n\n<p>这里又很方便既可以将结构体<code>field</code>打印出来的方法，不用区分大小写。</p>\n<p>printf的关键字：<code>%+v</code>，其中v不加<code>+</code>也是有所区别的。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> info <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tKey   <span class=\"keyword\">string</span></span><br><span class=\"line\">\tValue <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tv := info&#123;<span class=\"string\">\"键值\"</span>, <span class=\"string\">\"数据\"</span>&#125;</span><br><span class=\"line\">\tbytes, _ := json.Marshal(v)</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%v\\n\"</span>, v)</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"%+v\\n\"</span>, v)</span><br><span class=\"line\">\tfmt.Println(<span class=\"keyword\">string</span>(bytes))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// output</span></span><br><span class=\"line\"><span class=\"comment\">// &#123;键值 数据&#125;</span></span><br><span class=\"line\"><span class=\"comment\">// &#123;Key:键值 Value:数据&#125;</span></span><br><span class=\"line\"><span class=\"comment\">// &#123;\"Key\":\"键值\",\"Value\":\"数据\"&#125;</span></span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"}]},{"title":"国庆回家","date":"2018-10-11T11:10:50.000Z","path":"2018/10/11/国庆回家/","content":"<p>因家里有点事，本来准备窝在深圳，手撸几行代码的想法是泡汤了，一想到国庆路上千军万马，心里只能是七零八落之后，做好长期的心理防线，免得在路上对生活失去信心，毕竟还有远方的苟且。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"出发\"><a href=\"#出发\" class=\"headerlink\" title=\"出发\"></a>出发</h2><p>临时起意的情况下，对于火车票，基本就没有其他奢望了，于是联系了我表哥，搭一趟顺风车回家，原定是9月30号中午出发，不过我哥表示没睡醒，晚上需要开夜路，那得多睡一会。</p>\n<p>六点钟，东莞开车出发；</p>\n<p>十点钟，深圳南山区西丽，上车。</p>\n<h2 id=\"在路上\"><a href=\"#在路上\" class=\"headerlink\" title=\"在路上\"></a>在路上</h2><p>在出深圳的路上，一路都很顺畅，深深的怀疑是要回去的都已经回去了，没回去的已经躺在家里了。</p>\n<p>出了深圳就开始出现堵车到爆炸的现象了，事故不断，堵车不断，总之两者都是相关的，让我也是第一次感受到宛如春运的感觉，这对我一个之前在武汉，从没感受到春运人流，对国家的特质缺少了一块体验，虽然不是什么好的体验。</p>\n<p>大概是跑了14个小时，才完整的出了广东省，这里只能说广东是深深的爱着外乡人的，连离别的前戏都是这么充足。</p>\n<p>出来了才会发现广东省的富足，这点感觉是从通信基建上感受到的，出广东省前，一路上4G网都是妥妥的，手机玩个游戏延迟基本不会太高；出了广东，就会发现4G信号还是一个飘忽的东西，时有时无。一路上的车流变得越来越少，过了岳阳，到湖北来，几乎是无法构成车流，这点数量上也是欠缺的。</p>\n<p>难得回趟家，快要回到家，还是感觉家里比较亲切的，整个道路上都是亮起的路灯，迎国庆的气息弥漫到各个角落里，荆州这座古城……。</p>\n<h2 id=\"家\"><a href=\"#家\" class=\"headerlink\" title=\"家\"></a>家</h2><p>一回家，那只有沙发能够托住我整个身体，撑住我疲惫的身体，将满足感满满的给予我，深怕是辜负了我辛苦的路程，家里的沙发是如此可爱。</p>\n<p>简练的打理了一下自己，就将自己摔到床上休息了，重重的倒下，暖暖的幸福。</p>\n<h2 id=\"生活\"><a href=\"#生活\" class=\"headerlink\" title=\"生活\"></a>生活</h2><p>回家后，去看了外婆，也去了看了爷爷。</p>\n<p>外婆的身体相比过年，真是无法形容的变法，一个夏天和冬天的感觉，外婆性子硬，不愿意去医院，整个人可以很好的对照着一个老人的样子，一点都不像是从一个大户人家过来的女人，让人心疼。</p>\n<p>爷爷的身体依然如此，一年中大病小病，一个人辛苦的生活，听着爷爷说，一个人生病了，用一把椅子慢慢的把自己挪到医院，300米的距离，走了两个小时，这时候我只能无话可说，即使明白老人最需要的是什么，但也只能是沉默，静静听着爷爷的讲述。</p>\n<p>生活的路很奇怪，好好的一段路，走着的人走一段歇一段，下一个路口，人流总需要被分化，往前的人不断，可没有人在原地。</p>\n","categories":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/categories/随笔/"}],"tags":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/tags/随笔/"}]},{"title":"MySQL查询","date":"2018-09-22T08:17:51.000Z","path":"2018/09/22/MySQL查询/","content":"<h2 id=\"问题的出现\"><a href=\"#问题的出现\" class=\"headerlink\" title=\"问题的出现\"></a>问题的出现</h2><p>分页查询，其中数据量变大后导致查询速度变慢。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"分页查询\"><a href=\"#分页查询\" class=\"headerlink\" title=\"分页查询\"></a>分页查询</h2><p>在查询操作能够做到优化的地方，也是效果最明显的地方应该就是索引的优化，建立好索引能够有效的提高数据查询的速度。</p>\n<p>首先，了解下一个比较有意思的讨论：<a href=\"https://www.v2ex.com/t/443491\" target=\"_blank\" rel=\"noopener\">分页查询，查个 total 很难吗？</a></p>\n<p>通过链接能够看到不同的开发者对分页的理解和提供的解决问题的方法，对了解这个问题的具体含义很有帮助。单单的分页查询其实是涉及到了数据库的一些优化问题，并非表面上看起来那么简单。</p>\n<h2 id=\"分页方式\"><a href=\"#分页方式\" class=\"headerlink\" title=\"分页方式\"></a>分页方式</h2><p>参考链接：<a href=\"https://blog.csdn.net/SpeedMe/article/details/45690027>\" target=\"_blank\" rel=\"noopener\">分页性能探索-mysql</a></p>\n<p>1、扶梯分页法：</p>\n<p><img src=\"20150512171006.png\" alt=\"扶梯方式\"></p>\n<p>扶梯分页方式实现简单，操作高效，以当前页为起始页预取下一页。</p>\n<p>2、电梯分页法：</p>\n<p><img src=\"1538187698007.png\" alt=\"电梯分页法\"></p>\n<p>此方法其实是一种精准分页的方式，能够通过前端按键精确跳转页面，精确跳转的前提是需要排除需要跳转的页面（page*count），然后才会获取页面，这个偏移的过程就是一个非常慢的过程，经常是无法用到索引操作。</p>\n<h2 id=\"电梯分页优化\"><a href=\"#电梯分页优化\" class=\"headerlink\" title=\"电梯分页优化\"></a>电梯分页优化</h2><p>博文中提到了一种常见的优化方式，可以说一种”万金油”优化方式，也就是常见的“查两次”：</p>\n<p>先查找出主键ID，利用ID去查询数据（“查两次”）：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from production_recorder.6 inner join (select id from production_recorder.6 WHERE errcode like &apos;86:54:37:00:00:%&apos; LIMIT 150000,10) as ids using(id);</span><br></pre></td></tr></table></figure>\n\n<p>先使用较少IO查找来拿到主键id，然后利用主键id即可超快的获取数据了。</p>\n<p>但是这种方式还是会受到数据库数据持续变大带来的查询效率变低的影响。我们可以使用explain来对mysql语句进行分析：对explain的参数的了解参考链接<a href=\"https://www.cnblogs.com/zhanjindong/p/3439042.html\" target=\"_blank\" rel=\"noopener\">MySQL优化—工欲善其事，必先利其器之EXPLAIN</a>，</p>\n<p>explain分析结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*************************** 1. row ***************************</span><br><span class=\"line\">           id: 1</span><br><span class=\"line\">  select_type: PRIMARY</span><br><span class=\"line\">        table: &lt;derived2&gt;</span><br><span class=\"line\">         type: ALL</span><br><span class=\"line\">possible_keys: NULL</span><br><span class=\"line\">          key: NULL</span><br><span class=\"line\">      key_len: NULL</span><br><span class=\"line\">          ref: NULL</span><br><span class=\"line\">         rows: 10</span><br><span class=\"line\">        Extra: </span><br><span class=\"line\">*************************** 2. row ***************************</span><br><span class=\"line\">           id: 1</span><br><span class=\"line\">  select_type: PRIMARY</span><br><span class=\"line\">        table: 6</span><br><span class=\"line\">         type: eq_ref</span><br><span class=\"line\">possible_keys: PRIMARY</span><br><span class=\"line\">          key: PRIMARY</span><br><span class=\"line\">      key_len: 4</span><br><span class=\"line\">          ref: id.id</span><br><span class=\"line\">         rows: 1</span><br><span class=\"line\">        Extra: </span><br><span class=\"line\">*************************** 3. row ***************************</span><br><span class=\"line\">           id: 2</span><br><span class=\"line\">  select_type: DERIVED</span><br><span class=\"line\">        table: 6</span><br><span class=\"line\">         type: range</span><br><span class=\"line\">possible_keys: idx_6_errcode</span><br><span class=\"line\">          key: idx_6_errcode</span><br><span class=\"line\">      key_len: 768</span><br><span class=\"line\">          ref: NULL</span><br><span class=\"line\">         rows: 518056</span><br><span class=\"line\">        Extra: Using where; Using index</span><br><span class=\"line\">3 rows in set (0.10 sec)</span><br></pre></td></tr></table></figure>\n\n<p>对电梯分页的性能下降，经过百度与Google的查找，一个疑似的答案是，当数据库偏移一个相对于表数据量来说也是比较大的数据时，那么mysql优化器可能就会不选择走索引，而是走全表扫描，这相当于是mysql优化器在权衡索引与全表扫描后的做出的选择。</p>\n<h2 id=\"扶梯分页的优化\"><a href=\"#扶梯分页的优化\" class=\"headerlink\" title=\"扶梯分页的优化\"></a>扶梯分页的优化</h2><p>参考链接：<a href=\"https://blog.jamespan.me/2015/01/22/trick-of-paging-query\" target=\"_blank\" rel=\"noopener\">分页查询的那些坑和各种技巧</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from product.record WHERE errcode in (&quot;2134&quot;,&quot;13253&quot;) and id &gt; 10000 LIMIT 10;</span><br></pre></td></tr></table></figure>\n\n<p>这里使用id进行直接跳转，能够非常快速的越过已查询的数据，对未查询的数据进行查询，速度非常稳定。</p>\n<p>为了检测下一页是否有数据，在查询时可以</p>\n<p>查询完成后，计算结果集中ID的最大值，作为下一次id的起始值。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">requiredResultMaxId</span><span class=\"params\">(recordList []models.Record)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\tlens := <span class=\"built_in\">len</span>(recordList)</span><br><span class=\"line\">\tidArr := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, lens)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index, record := <span class=\"keyword\">range</span> recordList &#123;</span><br><span class=\"line\">\t\tidArr[index] = <span class=\"keyword\">int</span>(record.Id)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !sort.IntsAreSorted(idArr) &#123;</span><br><span class=\"line\">\t\tsort.Ints(idArr)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> idArr[lens<span class=\"number\">-1</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"总数\"><a href=\"#总数\" class=\"headerlink\" title=\"总数\"></a>总数</h2><p>除了获取具体的数量，分页还有一个就是获取查询的总数，这样前端才能很好的进行渲染工作。</p>\n<p>这里也是有几种方法：</p>\n<p>1、若取全表，则可以直接取自增主键的最大值（数据不会变化，且ID为自增主键）。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select max(id) from tablename</span><br></pre></td></tr></table></figure>\n\n<p>2、使用explain获取近似主键。</p>\n<p>3、在另外一张表中维护一个总数，插入一个加1。</p>\n<h2 id=\"选择\"><a href=\"#选择\" class=\"headerlink\" title=\"选择\"></a>选择</h2><p>就像参考博客中说的，根据业务对分页方式进行选择。当然作为开发者那得根据整体的设计来进行选择，有时候也会身不由己。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>对于分页好像没有想象中那么简单，分页具体到细节其实是查询，对于查询有分区，分库分表，这样的操作，这些东西现在还不太了解，借此机会还是需要去好好了解了解的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">分表以后只有一种查询方式会效率高，那就是根据分表键查。其他查询条件相反会慢于没分表前的正表查询。 所以能不分尽量不要分表。大数据量的查询可以使用读写分离，旧数据归档。（取自某一篇博客）</span><br></pre></td></tr></table></figure>\n\n<p>上述中，参考的博客都写得非常不错，具有可观的参考价值，感谢这些前辈的意见。</p>\n<p>如果有相关信息违反任何版权，请直接联系我进行删除。</p>\n<h2 id=\"2018年11月20日\"><a href=\"#2018年11月20日\" class=\"headerlink\" title=\"2018年11月20日\"></a>2018年11月20日</h2><p>分页中其实可以采取一种取巧的方式：</p>\n<p>如何将分页方法过渡到电梯分页的方法上呢？</p>\n<p>这里需要与前端进行配合。例如：</p>\n<p><img src=\"clip_image002.jpg\" alt=\"img\"></p>\n<p>这种分页是大多数电梯分页的选择，可以看到用户在选择分页时，其实是只能选择7页的，例如用户在点击第5页后的变化。</p>\n<p><img src=\"clip_image004.jpg\" alt=\"img\"></p>\n<p>等于说，在当前页，用户最多能看见第一页和最后一页，以及当前页的前两页和后两页数据，那么也就可以将查询范围给控制在7页的范围内。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> current_id; <span class=\"comment\">// id of first record on current page.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// go to page current+N</span></span><br><span class=\"line\">db.collection.find(&#123;_id: &#123;$gte: current_id&#125;&#125;).</span><br><span class=\"line\">              skip(N * page_size).</span><br><span class=\"line\">              limit(page_size).</span><br><span class=\"line\">              sort(&#123;_id: <span class=\"number\">1</span>&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// go to page current-N</span></span><br><span class=\"line\"><span class=\"comment\">// note that due to the nature of skipping back,</span></span><br><span class=\"line\"><span class=\"comment\">// this query will get you records in reverse order </span></span><br><span class=\"line\"><span class=\"comment\">// (last records on the page being first in the resultset)</span></span><br><span class=\"line\"><span class=\"comment\">// You should reverse them in the app.</span></span><br><span class=\"line\">db.collection.find(&#123;_id: &#123;$lt: current_id&#125;&#125;).</span><br><span class=\"line\">              skip((N<span class=\"number\">-1</span>)*page_size).</span><br><span class=\"line\">              limit(page_size).</span><br><span class=\"line\">              sort(&#123;_id: <span class=\"number\">-1</span>&#125;);</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://stackoverflow.com/questions/9703319/mongodb-ranged-pagination\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/9703319/mongodb-ranged-pagination</a></p>\n<p>MySQL同样可以使用这种方式进行分页，分页效率非常稳定可靠。</p>\n<p>而对总数信息的获取，则可以使用：SHOW TABLE STATUS或者是explain。</p>\n","categories":[{"name":"MySQL","slug":"MySQL","permalink":"chunlife.top/categories/MySQL/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"MySQL","slug":"MySQL","permalink":"chunlife.top/tags/MySQL/"}]},{"title":"KSDK USB 例程分析","date":"2018-09-22T08:17:51.000Z","path":"2018/09/22/KSDK USB 例程分析/","content":"<p>在USB example里面文件：</p>\n<a id=\"more\"></a>\n\n<p><img src=\"28180756_Z7bj.png\" alt=\"img\"></p>\n<p>lite为精简版，省略了很多USB枝干上的功能，保留了USB通讯部分的主干功能，我使用的是全功能版。</p>\n<p><img src=\"28180756_hylo.png\" alt=\"img\"></p>\n<p>函数 BOARD_InitPins()中，主要是PORT以及GPIO相关的初始化。</p>\n<p><img src=\"28180757_A6DK.png\" alt=\"img\"></p>\n<ol>\n<li>使能PORT的时钟，当外设时钟没有打开时，程序不能读出外设寄存器的值，同时也不能使用外设。</li>\n<li>通过PORT设置GPIO引脚功能，此处为设置LPUART功能。芯片手册P115。</li>\n<li>将键盘涉及到的GPIO引脚统统都设为GPIO引脚（自己定义的函数）。</li>\n<li>进行UART相关配置。</li>\n<li>将USB 键盘对应的相关引脚都设置为输入引脚。</li>\n</ol>\n<p>BOARD_BootClockRUN()，设置芯片时钟为48MHZ，总线时钟为24MHZ。</p>\n<p>BOARD_InitDebugConsole()，主要是初始化UART相关的配置，例入波特率等等。</p>\n<p>USB_DeviceApplicationInit()，这个函数很重要，应用初始化，这里的设置关乎于后面程序的成功与否，不过这里是KSDK已经实现了的，我们仅仅是需要做一下了解即可。</p>\n<p>使能USB工作时钟。</p>\n<p><img src=\"28180757_tFJa.png\" alt=\"img\"></p>\n<p>这段代码是由宏定义给包裹起来的，根据注释可以粗略判断出，主要是针对KHCI USB中的RAM特定的，将RAM里面的数据全部清0。</p>\n<p><img src=\"28180758_yCrm.png\" alt=\"img\"></p>\n<p>对composite结构体进行简单的初始化。</p>\n<p><img src=\"28180759_16WL.png\" alt=\"img\"></p>\n<p>USB_DeviceClassInit，这个函数比较重要，在上一个步骤中被初始化的g_UsbDeviceComposite.deviceHandle，将被在这个函数中重新赋予新的含义，里面设计到很多函数指针，推荐使用source insight可以看得清楚些。</p>\n<p>另外，我这里将Mouse的相关函数给屏蔽掉了，因为我需要实现的是Keyboard。</p>\n<p><img src=\"28180759_16WL-1552581570473.png\" alt=\"img\"></p>\n<p>USB_DeviceClassInit</p>\n<p><img src=\"28180759_wwDU.png\" alt=\"img\"></p>\n<p>configList也就是g_UsbDeviceCompositeConfigList</p>\n<p><img src=\"28180800_V8GF.png\" alt=\"img\"></p>\n<p><img src=\"28180800_YwY2.png\" alt=\"img\"></p>\n<p>可以看到USB_DeviceHidKeyboardCallback显然是个很重要的主，我们进去look look。</p>\n<p><img src=\"28180801_ghw8.png\" alt=\"img\"></p>\n<p>从这个函数里面又会碰到另一个很重要的函数，USB_DeviceHidKeyboardAction()，这个函数里面也就是KSDK中需要我们自己写的用户处理操作函数。</p>\n<p><img src=\"28180801_9eAr.png\" alt=\"img\"></p>\n<p>这个案例默认键盘是不断发出PAGEUP和PAGEDOWN键值，这里只是演示，所以若是要实现真正的产品，那是必须要把这段代码注释掉，来从新写一段新的功能函数代码的。</p>\n","categories":[{"name":"嵌入式","slug":"嵌入式","permalink":"chunlife.top/categories/嵌入式/"}],"tags":[{"name":"Freescale","slug":"Freescale","permalink":"chunlife.top/tags/Freescale/"},{"name":"C语言","slug":"C语言","permalink":"chunlife.top/tags/C语言/"}]},{"title":"网关选择","date":"2018-09-22T08:11:30.000Z","path":"2018/09/22/网关选择/","content":"<h2 id=\"可选择\"><a href=\"#可选择\" class=\"headerlink\" title=\"可选择\"></a>可选择</h2><p><a href=\"https://github.com/TykTechnologies/tyk\" target=\"_blank\" rel=\"noopener\">https://github.com/TykTechnologies/tyk</a></p>\n<p><a href=\"https://github.com/fagongzi/gateway\" target=\"_blank\" rel=\"noopener\">https://github.com/fagongzi/gateway</a></p>\n<p><a href=\"https://github.com/hellofresh/janus\" target=\"_blank\" rel=\"noopener\">https://github.com/hellofresh/janus</a></p>\n<p><a href=\"https://github.com/Netflix/zuul\" target=\"_blank\" rel=\"noopener\">https://github.com/Netflix/zuul</a></p>\n<a id=\"more\"></a>\n\n<p><a href=\"https://aws.amazon.com/api-gateway\" target=\"_blank\" rel=\"noopener\">https://aws.amazon.com/api-gateway</a></p>\n<p><a href=\"https://getkong.org/\" target=\"_blank\" rel=\"noopener\">https://getkong.org/</a></p>\n<p><a href=\"https://github.com/adobe-apiplatform/apigateway\" target=\"_blank\" rel=\"noopener\">https://github.com/adobe-apiplatform/apigateway</a></p>\n<p><a href=\"https://github.com/claudiajs/claudia\" target=\"_blank\" rel=\"noopener\">https://github.com/claudiajs/claudia</a></p>\n<p><a href=\"http://orange.sumory.com/\" target=\"_blank\" rel=\"noopener\">http://orange.sumory.com/</a></p>\n<p>主要可使用的网关大概是上述的这些（不包括某些专业级网关以及名气不够且star数量低于1K的项目）。</p>\n<h2 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h2><p>用的最多的是网关kong，使用的是Nginx-Lua，Gateway开源，使用的插件部分免费，属于基本可用的范畴，考虑到技术栈使用的是Go，考虑使用相同语言的插件便于后期进行改造，节省人力。（虽然微服务提倡的观念是对特定的服务使用其最适合的语言进行编写，但是在考虑到不同技术栈的同步问题，使用同一技术栈在前期可能会好一点）。</p>\n<p>在此想法的前提下，可以考虑的网关包括：</p>\n<p><a href=\"https://github.com/TykTechnologies/tyk\" target=\"_blank\" rel=\"noopener\">https://github.com/TykTechnologies/tyk</a></p>\n<p><a href=\"https://github.com/fagongzi/gateway\" target=\"_blank\" rel=\"noopener\">https://github.com/fagongzi/gateway</a></p>\n<p><a href=\"https://github.com/hellofresh/janus\" target=\"_blank\" rel=\"noopener\">https://github.com/hellofresh/janus</a></p>\n<p>tyk也算是比较好的，同样是该有的都有，根据使用的人数，可能是仅次于kong的，tyk是需要收取费用来进行使用的，当然若需求只需要进行单节点布置，那也可以使用Tyk，若考虑到以后进行分布式部署的情况，Tyk显然就不太适合进行后续部署了（若是能够花钱的话，当然也是没有问题的，俩节点$600每月）。</p>\n<p>那这样就剩下gateway和janus。</p>\n<p>gateway与Janus两者较相似，都是轻量级网关，故功能相对于一个成熟的网关来说都各有各的缺失，具体上如果针对于小型需求来说，其基本都能满足；</p>\n<ul>\n<li>GitHub star均超过1.2K；</li>\n<li>资料，两者都属于较少，不过根据官方文档部署和基础使用没有太大问题；</li>\n<li>部署，支持docker部署，官方文档都有基础的介绍。</li>\n<li>功能，两者基本功能可能都有（例如限流，断路器等），高级功能可能都缺失，例如日志收集和消息队列，两者的文档里面好像都没有提到。</li>\n<li>周边，两者都是没有社区存在的，janus star数量会超过gateway一些；</li>\n<li>配置，janus设置使用json文件，gateway通过client模块API调用进行配置，两者都不需要重启网关；</li>\n<li>分布式支持；</li>\n</ul>\n<p>根据分析来看，在项目的部署上使用哪一种，主要是看在网关本身的部署难度和使用难度上。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Gateway","slug":"Gateway","permalink":"chunlife.top/tags/Gateway/"}]},{"title":"mysql操作(不定时持续补充)","date":"2018-09-14T09:40:39.000Z","path":"2018/09/14/mysql操作-不定时持续补充/","content":"<p>mysql操作是不区分大小写的。</p>\n<h1 id=\"Mysql安装后若出现问题\"><a href=\"#Mysql安装后若出现问题\" class=\"headerlink\" title=\"Mysql安装后若出现问题\"></a>Mysql安装后若出现问题</h1><p>ERROR 2002 (HY000): Can’t connect to local MySQL server through socket ‘/var/run/mysqld/mysqld.sock’ (2)</p>\n<a id=\"more\"></a>\n\n<p>解决方式：</p>\n<p> touch /var/run/mysqld/mysqld.sock</p>\n<p>ls -lart /var/run/mysqld/</p>\n<p>chown -R mysql /var/run/mysqld</p>\n<p>ls -lart /var/run/mysqld/</p>\n<p>mysql restart</p>\n<p>/etc/init.d/mysql restart</p>\n<h1 id=\"基础操作\"><a href=\"#基础操作\" class=\"headerlink\" title=\"基础操作\"></a>基础操作</h1><p>1 添加表字段</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter table table1 add transactor varchar(10) not Null;</span><br><span class=\"line\"></span><br><span class=\"line\">alter table table1 add id int unsigned not Null auto_increment primary key</span><br></pre></td></tr></table></figure>\n\n<p>2 如果要删除某一字段</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ALTER TABLE mytable DROP 字段名;</span><br></pre></td></tr></table></figure>\n\n<p>3 修改数据表字段的默认值：</p>\n<p>修改字段默认值：role_id默认值设置为：1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; alter table users_info alter column role_id set default 1;</span><br></pre></td></tr></table></figure>\n\n<p>修改字段默认值语法：</p>\n<p>alter table 表名 alter column 字段名 drop default; (若本身存在默认值，则先删除)</p>\n<p>alter table 表名 alter column 字段名 set default 默认值;(若本身不存在则可以直接设定)</p>\n<h1 id=\"预处理\"><a href=\"#预处理\" class=\"headerlink\" title=\"预处理\"></a>预处理</h1><p><a href=\"https://cloud.tencent.com/developer/article/1066988\" target=\"_blank\" rel=\"noopener\">数据库操作, 关于stmt, prepare</a></p>\n<h1 id=\"JOIN\"><a href=\"#JOIN\" class=\"headerlink\" title=\"JOIN\"></a>JOIN</h1><p>使用Join， Inner join取得两表间类似的数据，<a href=\"https://blog.csdn.net/w348399060/article/details/70158125\" target=\"_blank\" rel=\"noopener\">链接</a></p>\n<p><img src=\"1.png\" alt=\"命令\"></p>\n<p><img src=\"2.png\" alt=\"432\"></p>\n<h1 id=\"mysql隐式转换\"><a href=\"#mysql隐式转换\" class=\"headerlink\" title=\"mysql隐式转换\"></a>mysql隐式转换</h1><p>mysql隐式转换，会造成SQL慢查询，因为SQL转化后，即使使用索引查询，SQL也不会认为其是索引。</p>\n<p>也就是说，若字段为字符串数字，则需要使用字符串类型作为<code>where</code>查询条件去查询数据，若使用整型数据，则会发生隐式转换，这相当于在字段前加上了<code>to_int(xxx)</code>，类似于：<code>where to_int(xxx) = xxx</code>，在字段前加函数，其将无法使用索引，这是条准则。</p>\n<p><a href=\"http://xiaorui.cc/2018/04/13/%e8%ae%b0%e4%b8%80%e6%ac%a1%e9%9a%90%e5%bc%8f%e8%bd%ac%e6%8d%a2%e5%bc%95%e8%b5%b7%e7%9a%84sql%e6%85%a2%e6%9f%a5%e8%af%a2/\" target=\"_blank\" rel=\"noopener\">记一次隐式转换引起的sql慢查询</a></p>\n<h1 id=\"日期索引\"><a href=\"#日期索引\" class=\"headerlink\" title=\"日期索引\"></a>日期索引</h1><p><a href=\"https://blog.csdn.net/spider_zhcl/article/details/53323166\" target=\"_blank\" rel=\"noopener\">Mysql 索引问题-日期索引使用</a></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在查询数据条数约占总条数五分之一以下时能够使用到索引，但超过五分之一时，则使用全表扫描了。</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查询缓存\"><a href=\"#查询缓存\" class=\"headerlink\" title=\"查询缓存\"></a>查询缓存</h1><p><a href=\"https://www.cnblogs.com/gimin/p/5459689.html\" target=\"_blank\" rel=\"noopener\">MySQL查询缓存打开、设置、参数查询、性能变量</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SHOW VARIABLES LIKE &apos;%query_cache%&apos;;</span><br><span class=\"line\">+------------------------------+---------+</span><br><span class=\"line\">| Variable_name                | Value   |</span><br><span class=\"line\">+------------------------------+---------+</span><br><span class=\"line\">| have_query_cache             | YES     |</span><br><span class=\"line\">| query_cache_limit            | 1048576 |</span><br><span class=\"line\">| query_cache_min_res_unit     | 4096    |</span><br><span class=\"line\">| query_cache_size             | 1048576 |</span><br><span class=\"line\">| query_cache_type             | OFF     |</span><br><span class=\"line\">| query_cache_wlock_invalidate | OFF     |</span><br><span class=\"line\">+------------------------------+---------+</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; show global status like &apos;QCache%&apos;;</span><br><span class=\"line\">+-------------------------+---------+</span><br><span class=\"line\">| Variable_name           | Value   |</span><br><span class=\"line\">+-------------------------+---------+</span><br><span class=\"line\">| Qcache_free_blocks      | 1       |</span><br><span class=\"line\">| Qcache_free_memory      | 1031832 |</span><br><span class=\"line\">| Qcache_hits             | 0       |</span><br><span class=\"line\">| Qcache_inserts          | 0       |</span><br><span class=\"line\">| Qcache_lowmem_prunes    | 0       |</span><br><span class=\"line\">| Qcache_not_cached       | 106     |</span><br><span class=\"line\">| Qcache_queries_in_cache | 0       |</span><br><span class=\"line\">| Qcache_total_blocks     | 1       |</span><br><span class=\"line\">+-------------------------+---------+</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"mysql调试\"><a href=\"#mysql调试\" class=\"headerlink\" title=\"mysql调试\"></a>mysql调试</h1><p>慢查询可以将mysql执行慢的语句记录下来。</p>\n<p><a href=\"http://blog.51yip.com/mysql/972.html>\" target=\"_blank\" rel=\"noopener\">linux下开启mysql慢查询，分析查询语句</a></p>\n<p><a href=\"http://www.cnblogs.com/luyucheng/p/6265594.html\" target=\"_blank\" rel=\"noopener\">http://www.cnblogs.com/luyucheng/p/6265594.html</a></p>\n<p>慢查询使用pt-query-digest进行分析：</p>\n<p>安装过程：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# wget percona.com/get/pt-query-digest</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost ~]# chmod u+x pt-query-digest</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost ~]# mv /root/pt-query-digest /usr/bin/</span><br></pre></td></tr></table></figure>\n\n<p>开启慢查询后，会有慢查询的日志，对日志使用工具：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pt-query-digest --explain h=127.0.0.1,u=root,p=123 mysql_slow.log &gt; pt.ref</span><br></pre></td></tr></table></figure>\n\n<p>开启实时查询，能够得到每一次SQL语句的完整执行语句。</p>\n<p><a href=\"https://blog.csdn.net/qidaif/article/details/80931703\" target=\"_blank\" rel=\"noopener\">MySQL查看实时执行的SQL语句</a></p>\n<h1 id=\"mysql插入CSV文件\"><a href=\"#mysql插入CSV文件\" class=\"headerlink\" title=\"mysql插入CSV文件\"></a>mysql插入CSV文件</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LOAD DATA LOCAL INFILE &apos;./dbtestdata.csv&apos; INTO TABLE production_recorder.6 CHARACTER SET UTF8 FIELDS TERMINATED BY &apos;,&apos; LINES TERMINATED BY &apos;\\n&apos;;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"GORM使用\"><a href=\"#GORM使用\" class=\"headerlink\" title=\"GORM使用\"></a>GORM使用</h1><h2 id=\"查找最大值\"><a href=\"#查找最大值\" class=\"headerlink\" title=\"查找最大值\"></a>查找最大值</h2><p><img src=\"3.png\" alt=\"查询\"></p>\n<h2 id=\"时间戳跟踪\"><a href=\"#时间戳跟踪\" class=\"headerlink\" title=\"时间戳跟踪\"></a>时间戳跟踪</h2><p>Gorm里面有个结构体：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// gorm.Model definition</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> Model <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">  ID        <span class=\"keyword\">uint</span> <span class=\"string\">`gorm:\"primary_key\"`</span></span><br><span class=\"line\">  CreatedAt time.Time</span><br><span class=\"line\">  UpdatedAt time.Time</span><br><span class=\"line\">  DeletedAt *time.Time</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这四个参数是Gorm固定的参数，例如，如果结构体中有“ID”成员，那么建表时它就是表中的主键。</p>\n<p>CreatedAt：也就是插入值时默认添加的时间戳；</p>\n<p>UpdatedAt：更新时添加的时间戳；</p>\n<p>DeletedAt：被删除时添加的时间戳。（有一个软删除的概念）</p>\n<p>GORM默认是使用蛇形命名，也就是CreatedAt成员将被命名为“created_at”。</p>\n<p>select * from production_recorder.6  WHERE errcode like “86:54:37%” LIMIT 1000000,10;</p>\n<h2 id=\"子查询\"><a href=\"#子查询\" class=\"headerlink\" title=\"子查询\"></a>子查询</h2><p><a href=\"https://stackoverflow.com/questions/46807891/using-a-subquery-in-from-in-gorm?rq=1\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/46807891/using-a-subquery-in-from-in-gorm?rq=1</a></p>\n<p><img src=\"count%E8%87%AA%E5%8A%A01.png\" alt=\"count自加1\"></p>\n<p><img src=\"1538015777465.png\" alt=\"子查询\"></p>\n<p>从手册上摘出来的子查询使用方法：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">db.Where(<span class=\"string\">\"amount &gt; ?\"</span>, DB.Table(<span class=\"string\">\"orders\"</span>).Select(<span class=\"string\">\"AVG(amount)\"</span>).Where(<span class=\"string\">\"state = ?\"</span>, <span class=\"string\">\"paid\"</span>).QueryExpr()).Find(&amp;orders)</span><br><span class=\"line\"><span class=\"comment\">// SELECT * FROM \"orders\"  WHERE \"orders\".\"deleted_at\" IS NULL AND (amount &gt; (SELECT AVG(amount) FROM \"orders\"  WHERE (state = 'paid')));</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"打印Gorm执行语句（包含时间）\"><a href=\"#打印Gorm执行语句（包含时间）\" class=\"headerlink\" title=\"打印Gorm执行语句（包含时间）\"></a>打印Gorm执行语句（包含时间）</h2><p>将执行的语句打印出来。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Debug a single operation, show detailed log for this operation</span></span><br><span class=\"line\">db.Debug().Where(<span class=\"string\">\"name = ?\"</span>, <span class=\"string\">\"jinzhu\"</span>).First(&amp;User&#123;&#125;)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"gorm拼接SQL语句\"><a href=\"#gorm拼接SQL语句\" class=\"headerlink\" title=\"gorm拼接SQL语句\"></a>gorm拼接SQL语句</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dt = dt.Table(models.TableRecords)</span><br><span class=\"line\"></span><br><span class=\"line\">scope := dt.NewScope(dt.Value)</span><br><span class=\"line\">scope.InstanceSet(<span class=\"string\">\"skip_bindvar\"</span>, <span class=\"literal\">true</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">scope.Raw(fmt.Sprintf(<span class=\"string\">\"explain SELECT %v FROM %v %v\"</span>, <span class=\"string\">\"count(*)\"</span>,</span><br><span class=\"line\">\tscope.QuotedTableName(),</span><br><span class=\"line\">\tscope.CombinedConditionSql()))</span><br><span class=\"line\"></span><br><span class=\"line\">dbs.DbRecords.Raw(scope.SQL, scope.SQLVars...).Scan(&amp;test)</span><br></pre></td></tr></table></figure>\n\n<p>Gorm的官方文档其实已经比较详细了，想跟深入的了解，可以直接去看官方文档：</p>\n<p><a href=\"http://gorm.io/docs/conventions.html#Timestamp-Tracking\" target=\"_blank\" rel=\"noopener\">http://gorm.io/docs/conventions.html#Timestamp-Tracking</a></p>\n<p><a href=\"https://jasperxu.github.io/gorm-zh/\" target=\"_blank\" rel=\"noopener\">https://jasperxu.github.io/gorm-zh/</a></p>\n","categories":[{"name":"MySQL","slug":"MySQL","permalink":"chunlife.top/categories/MySQL/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"MySQL","slug":"MySQL","permalink":"chunlife.top/tags/MySQL/"}]},{"title":"interface对结构体数组","date":"2018-09-14T07:29:01.000Z","path":"2018/09/14/interface对结构体数组/","content":"<p>interface非常好用，相当于一个空类型，什么类型都可以被它接受，可以说在传参上是非常方便的，那问题来了，什么类型它都能转得回去吗，结果是不能的。</p>\n<p>这个问题，我自己碰到了两次，每次都没记录，每次都很干脆的忘了。</p>\n<a id=\"more\"></a>\n\n<p>一个API接口上可以接受好几个结构体数组，我使用interface来进行接受，此时我使用断言来进行类型转换，很显然无法成功进行断言。</p>\n<p>这个问题呢，我们先看看官方对interfaceSlice做出的一个解释。</p>\n<p><a href=\"https://github.com/golang/go/wiki/InterfaceSlice\" target=\"_blank\" rel=\"noopener\">https://github.com/golang/go/wiki/InterfaceSlice</a></p>\n<p>也可以看此篇博客的中文，和原文大概意思相同，建议两篇都看，毕竟原文才是官方的原意。</p>\n<p><a href=\"https://www.jianshu.com/p/e0abcbc220a4\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/e0abcbc220a4</a></p>\n<p>其中说的其实是interfaceSlice的问题，这里我们知道了interface的结构组成，再来解决问题。</p>\n<p><a href=\"https://stackoverflow.com/questions/12753805/type-converting-slices-of-interfaces-in-go\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/12753805/type-converting-slices-of-interfaces-in-go</a></p>\n<p>楼主的问题：</p>\n<p><img src=\"question.png\" alt=\"问题\"></p>\n<p>得分最高的回答：</p>\n<p><img src=\"1536911326824.png\" alt=\"解答\"></p>\n<p>这里我翻译一下：</p>\n<p>在Go中，一般语法是不应该隐藏那些复杂或耗费资源的操作的，转换string类型到interface类型算法可以O（1）时间内完成。切片[]string依然可以被视作是一个值（译者：我感觉这里可以将切片看做是一个连续内存的结构来将其视作一个值），转换到interface依然可以在O（1）时间内完成。</p>\n<p>此规则有一个例外——就是转换字符串，当转换变量string a，[]byte a或者是[]rune a，虽然算法难度为O（n），但还是可以视作正常操作。</p>\n<p>其实到这里就可以解决我们的问题了，interface用断言来做类型转换是官方干脆就没想过要做到那么复杂的程度，若是开发者需要做，可以采用反射来自己去实现这种操作的。</p>\n<p>这里贴一个：</p>\n<p><a href=\"https://github.com/issue9/conv/blob/master/obj.go#L75\" target=\"_blank\" rel=\"noopener\">https://github.com/issue9/conv/blob/master/obj.go#L75</a></p>\n<p>另外，还附上一个对interface断言的博客文章：</p>\n<p><a href=\"https://medium.com/golangspec/type-assertions-in-go-e609759c42e1\" target=\"_blank\" rel=\"noopener\">Type assertions in Go</a></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"interface","slug":"interface","permalink":"chunlife.top/tags/interface/"}]},{"title":"json操作","date":"2018-09-14T06:07:42.000Z","path":"2018/09/14/json操作/","content":"<p>json算是比较好理解的组织结构方式了，现在RESTful那一套基本也是使用json来作为传输的数据格式了。</p>\n<a id=\"more\"></a>\n\n<h1 id=\"json库\"><a href=\"#json库\" class=\"headerlink\" title=\"json库\"></a>json库</h1><p>我使用的是<a href=\"https://github.com/json-iterator/go，号称是非常快的，与Java的库类似。\" target=\"_blank\" rel=\"noopener\">https://github.com/json-iterator/go，号称是非常快的，与Java的库类似。</a></p>\n<p>还有一些其他的，摘自json-iterator/go。</p>\n<table>\n<thead>\n<tr>\n<th>ns/op</th>\n<th>allocation bytes</th>\n<th>allocation times</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>std decode</td>\n<td>35510 ns/op</td>\n<td>1960 B/op</td>\n<td>99 allocs/op</td>\n</tr>\n<tr>\n<td>easyjson decode</td>\n<td>8499 ns/op</td>\n<td>160 B/op</td>\n<td>4 allocs/op</td>\n</tr>\n<tr>\n<td>jsoniter decode</td>\n<td>5623 ns/op</td>\n<td>160 B/op</td>\n<td>3 allocs/op</td>\n</tr>\n<tr>\n<td>std encode</td>\n<td>2213 ns/op</td>\n<td>712 B/op</td>\n<td>5 allocs/op</td>\n</tr>\n<tr>\n<td>easyjson encode</td>\n<td>883 ns/op</td>\n<td>576 B/op</td>\n<td>3 allocs/op</td>\n</tr>\n<tr>\n<td>jsoniter encode</td>\n<td>837 ns/op</td>\n<td>384 B/op</td>\n<td>4 allocs/op</td>\n</tr>\n</tbody></table>\n<p>当然，这是开发者提供的，golang json库还有很多，性能差距感觉不会是最影响项目的因素，若是代码本身出了问题，那不是单单是一个好库能够解决的。</p>\n<h1 id=\"json格式\"><a href=\"#json格式\" class=\"headerlink\" title=\"json格式\"></a>json格式</h1><p><img src=\"json%E6%A0%BC%E5%BC%8F.png\" alt=\"json格式\"></p>\n<h1 id=\"json-解析\"><a href=\"#json-解析\" class=\"headerlink\" title=\"json 解析\"></a>json 解析</h1><p>库是怎么找到结构体对应的字段进行解析的呢？</p>\n<p><img src=\"1536908063319.png\" alt=\"1536908063319\"></p>\n<p>json的tag是库用来响应使用者提前预设的操作的，用来控制库的编码解码操作。</p>\n<p><img src=\"1536908018808.png\" alt=\"json解析\"></p>\n<p>我常用到的tag：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Message struct &#123;  </span><br><span class=\"line\">    Name string `json:\"msg_name\"`       // 对应JSON的msg_name  </span><br><span class=\"line\">    Body string `json:\"body,omitempty\"` // 如果为空置则忽略字段  </span><br><span class=\"line\">    Time int64  `json:\"-\"`              // 直接忽略字段  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用omitempty，如果该字段为nil或0值（数字0,字符串””,空数组[]等），则打包的JSON结果不会有这个字段。</p>\n<p>golang官方库中其实没有对“required”字段的支持，这个字段表示被标识的字段没有接受到值则报错（数字0,字符串””,空数组[]等也会报错）。</p>\n<p>使用web gin有这个tag，</p>\n<p><img src=\"clip_image001.png\" alt=\"gin required\"></p>\n<p>我还查到过一个很有意思的解决字段是否被传递的方法：</p>\n<p>若需要使用encoding/json来检查缺少的字段，则必须使用指针来区分missing/null和zero值：</p>\n<p><a href=\"https://stackoverflow.com/questions/19633763/unmarshaling-json-in-golang-required-field\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/19633763/unmarshaling-json-in-golang-required-field</a></p>\n<p><img src=\"clip_image001.png\" alt=\"指针方式\"></p>\n<h1 id=\"序列化美化json数据\"><a href=\"#序列化美化json数据\" class=\"headerlink\" title=\"序列化美化json数据\"></a>序列化美化json数据</h1><p>json.MarshalIndent</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"gin","slug":"gin","permalink":"chunlife.top/tags/gin/"},{"name":"json","slug":"json","permalink":"chunlife.top/tags/json/"}]},{"title":"gin的学习框架","date":"2018-09-11T06:22:14.000Z","path":"2018/09/11/gin的学习框架/","content":"<p>为了以后的开发便利，这里添加一个gin的框架结构。 </p>\n<a id=\"more\"></a>\n\n<p>gin现在已经有自己的中文帮助手册，那直接参考它的中文手册就好了，<a href=\"https://gin-gonic.com/zh-cn/docs/#contents\" target=\"_blank\" rel=\"noopener\">文档</a>。</p>\n<p><a href=\"https://github.com/younglifestyle/goexamples/tree/master/gin-demo\" target=\"_blank\" rel=\"noopener\">https://github.com/younglifestyle/goexamples/tree/master/gin-demo</a></p>\n<p>gin中还有对session的中间库，很多中间库和beego很类似，还是很方便的。</p>\n<h3 id=\"gin-HTTP-Server启动时自定义参数\"><a href=\"#gin-HTTP-Server启动时自定义参数\" class=\"headerlink\" title=\"gin HTTP Server启动时自定义参数\"></a>gin HTTP Server启动时自定义参数</h3><p>例如：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\trouter := gin.Default()</span><br><span class=\"line\">\thttp.ListenAndServe(<span class=\"string\">\":8080\"</span>, router)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\trouter := gin.Default()</span><br><span class=\"line\"></span><br><span class=\"line\">\ts := &amp;http.Server&#123;</span><br><span class=\"line\">\t\tAddr:           <span class=\"string\">\":8080\"</span>,</span><br><span class=\"line\">\t\tHandler:        router,</span><br><span class=\"line\">\t\tReadTimeout:    <span class=\"number\">10</span> * time.Second,</span><br><span class=\"line\">\t\tWriteTimeout:   <span class=\"number\">10</span> * time.Second,</span><br><span class=\"line\">\t\tMaxHeaderBytes: <span class=\"number\">1</span> &lt;&lt; <span class=\"number\">20</span>,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ts.ListenAndServe()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"参数支持\"><a href=\"#参数支持\" class=\"headerlink\" title=\"参数支持\"></a>参数支持</h3><p>gin可以直接对URL query、json以及form进行序列化。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 使用gin可以猜测传递的参数</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> tmp <span class=\"keyword\">interface</span>&#123;&#125;</span><br><span class=\"line\">c.ShouldBind(&amp;tmp)   </span><br><span class=\"line\">c.Bind(&amp;tmp)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"json-Tag\"><a href=\"#json-Tag\" class=\"headerlink\" title=\"json Tag\"></a>json Tag</h3><p><code>binding:&quot;required&quot;</code>，gin框架会对此tag进行检查，添加后，意味着在接受数据时，query、表单或者body中必须要匹配到该字段。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> UserToken <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tUserId <span class=\"keyword\">string</span> <span class=\"string\">`json:\"userid\" form:\"userid\" binding:\"required\"`</span></span><br><span class=\"line\">\tToken  <span class=\"keyword\">string</span> <span class=\"string\">`json:\"token\" form:\"token\" binding:\"required\"`</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"请求中使用Goroutine\"><a href=\"#请求中使用Goroutine\" class=\"headerlink\" title=\"请求中使用Goroutine\"></a>请求中使用Goroutine</h3><p>在中间件或处理程序中启动新的Goroutines时，不应该使用其中的原始上下文，必须使用只读副本。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tr := gin.Default()</span><br><span class=\"line\"></span><br><span class=\"line\">\tr.GET(<span class=\"string\">\"/long_async\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// create copy to be used inside the goroutine</span></span><br><span class=\"line\">\t\tcCp := c.Copy()</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// simulate a long task with time.Sleep(). 5 seconds</span></span><br><span class=\"line\">\t\t\ttime.Sleep(<span class=\"number\">5</span> * time.Second)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// note that you are using the copied context \"cCp\", IMPORTANT</span></span><br><span class=\"line\">\t\t\tlog.Println(<span class=\"string\">\"Done! in path \"</span> + cCp.Request.URL.Path)</span><br><span class=\"line\">\t\t&#125;()</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tr.GET(<span class=\"string\">\"/long_sync\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// simulate a long task with time.Sleep(). 5 seconds</span></span><br><span class=\"line\">\t\ttime.Sleep(<span class=\"number\">5</span> * time.Second)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// since we are NOT using a goroutine, we do not have to copy the context</span></span><br><span class=\"line\">\t\tlog.Println(<span class=\"string\">\"Done! in path \"</span> + c.Request.URL.Path)</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Listen and serve on 0.0.0.0:8080</span></span><br><span class=\"line\">\tr.Run(<span class=\"string\">\":8080\"</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"gin","slug":"gin","permalink":"chunlife.top/tags/gin/"}]},{"title":"服务器上传下载问题","date":"2018-09-02T12:34:19.000Z","path":"2018/09/02/服务器上传下载问题/","content":"<p>做过服务器上传下载的一个接口，将其整理整理写出来备忘吧。</p>\n<a id=\"more\"></a>\n\n<h1 id=\"上传文件\"><a href=\"#上传文件\" class=\"headerlink\" title=\"上传文件\"></a>上传文件</h1><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 上传时，前端需要使用form对文件进行上传</span></span><br><span class=\"line\">r.Body = http.MaxBytesReader(w, r.Body, MAX_UPLOAD_SIZE)  <span class=\"comment\">// 设置文件限制大小</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> err := r.ParseMultipartForm(MAX_UPLOAD_SIZE); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    sendErrorResponse(w, http.StatusBadRequest, <span class=\"string\">\"File is too big\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">file, _, err := r.FormFile(<span class=\"string\">\"file\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    log.Printf(<span class=\"string\">\"Error when try to get file: %v\"</span>, err)</span><br><span class=\"line\">    sendErrorResponse(w, http.StatusInternalServerError, <span class=\"string\">\"Internal Error\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">data, err := ioutil.ReadAll(file)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    log.Printf(<span class=\"string\">\"Read file error: %v\"</span>, err)</span><br><span class=\"line\">    sendErrorResponse(w, http.StatusInternalServerError, <span class=\"string\">\"Internal Error\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">err = ioutil.WriteFile(<span class=\"string\">\"./store\"</span><span class=\"string\">\"\"</span>, data, <span class=\"number\">0666</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">    log.Printf(<span class=\"string\">\"write file error: %v\"</span>, err)</span><br><span class=\"line\">    sendErrorResponse(w, http.StatusInternalServerError, <span class=\"string\">\"Internal Error\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"下载文件（Gin）\"><a href=\"#下载文件（Gin）\" class=\"headerlink\" title=\"下载文件（Gin）\"></a>下载文件（Gin）</h1><p>下载前端可直接使用windows.location.href，该函数会发出“Get”请求到服务器，不过这里就会要求将通信参数都置于URL中，若别人拿着链接就可以直接进行下载操作了。</p>\n<p>此处是可以将请求变为POST的，也就是不使用windows.location.href来做，这里我就不做太多介绍了。</p>\n<p>后端核心代码，Header参数填写来自beego，见文章末尾。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">downloadFileToClient</span><span class=\"params\">(c *gin.Context, filePath <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 设置浏览器是否为直接下载文件，且为浏览器指定下载文件的名字</span></span><br><span class=\"line\">        c.Header(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\"</span>+url.QueryEscape(path.Base(filePath)))</span><br><span class=\"line\">        c.Header(<span class=\"string\">\"Content-Description\"</span>, <span class=\"string\">\"File Transfer\"</span>)</span><br><span class=\"line\">        c.Header(<span class=\"string\">\"Content-Type\"</span>, <span class=\"string\">\"application/octet-stream\"</span>)</span><br><span class=\"line\">        c.Header(<span class=\"string\">\"Content-Transfer-Encoding\"</span>, <span class=\"string\">\"binary\"</span>)</span><br><span class=\"line\">        c.Header(<span class=\"string\">\"Expires\"</span>, <span class=\"string\">\"0\"</span>)</span><br><span class=\"line\">        <span class=\"comment\">// 如果缓存过期了，会再次和原来的服务器确定是否为最新数据，而不是和中间的proxy</span></span><br><span class=\"line\">        c.Header(<span class=\"string\">\"Cache-Control\"</span>, <span class=\"string\">\"must-revalidate\"</span>)</span><br><span class=\"line\">        c.Header(<span class=\"string\">\"Pragma\"</span>, <span class=\"string\">\"public\"</span>)</span><br><span class=\"line\">        c.File(filePath)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h1><h2 id=\"指定浏览器直接下载文件，不进行打开操作\"><a href=\"#指定浏览器直接下载文件，不进行打开操作\" class=\"headerlink\" title=\"指定浏览器直接下载文件，不进行打开操作\"></a>指定浏览器直接下载文件，不进行打开操作</h2><p><a href=\"https://segmentfault.com/q/1010000000692593\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/q/1010000000692593</a></p>\n<p><a href=\"https://golangtc.com/t/54d9ca47421aa9170200000f\" target=\"_blank\" rel=\"noopener\">https://golangtc.com/t/54d9ca47421aa9170200000f</a></p>\n<p><img src=\"clip_image001.png\" alt=\"下载Header设置\"></p>\n<h2 id=\"Go作为客户端下载文件，实现类似于Wget的效果\"><a href=\"#Go作为客户端下载文件，实现类似于Wget的效果\" class=\"headerlink\" title=\"Go作为客户端下载文件，实现类似于Wget的效果\"></a>Go作为客户端下载文件，实现类似于Wget的效果</h2><p>Downloading large files in Go  <a href=\"https://github.com/cavaliercoder/grab\" target=\"_blank\" rel=\"noopener\">https://github.com/cavaliercoder/grab</a></p>\n<p>来自 &lt;<a href=\"http://cavaliercoder.com/blog/downloading-large-files-in-go.html\" target=\"_blank\" rel=\"noopener\">http://cavaliercoder.com/blog/downloading-large-files-in-go.html</a>&gt; </p>\n<h2 id=\"文件读写的问题：\"><a href=\"#文件读写的问题：\" class=\"headerlink\" title=\"文件读写的问题：\"></a>文件读写的问题：</h2><p>ReadAll后，再去读文件数据，为空，使用seek重新回到文件头位置。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; Seek 设置下一次 Read 或 Write 的偏移量为 offset，它的解释取决于 whence： 0 表示相对于文件的起始处，1 表示相对于当前的偏移，而 2 表示相对于其结尾处。 Seek 返回新的偏移量和一个错误，如果有的话。</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"clip_image001-1535892856347.png\" alt=\"读写文件\"></p>\n<h2 id=\"Go-删除文件和文件夹\"><a href=\"#Go-删除文件和文件夹\" class=\"headerlink\" title=\"Go 删除文件和文件夹\"></a>Go 删除文件和文件夹</h2><p>删除空目录</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Remove</span><span class=\"params\">(name <span class=\"keyword\">string</span>)</span> <span class=\"title\">error</span></span></span><br></pre></td></tr></table></figure>\n\n<p>强制删除目录，无论目录是否有文件</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">RemoveAll</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span> <span class=\"title\">error</span></span></span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"服务器","slug":"服务器","permalink":"chunlife.top/tags/服务器/"},{"name":"上传下载","slug":"上传下载","permalink":"chunlife.top/tags/上传下载/"}]},{"title":"服务器限流问题","date":"2018-09-02T11:47:34.000Z","path":"2018/09/02/服务器限流问题/","content":"<p>在观看慕课网的<a href=\"https://coding.imooc.com/class/227.html\" target=\"_blank\" rel=\"noopener\">Go语言实战流媒体视频网站</a> ，里面有提高bucket token算法，也就是令牌桶算法，用于服务器限流。因为我刚好在做一个包含上传和下载的服务器接口，貌似会需要到这一块地方，就多加了一些了解，这里主要是将结果进行粘贴。</p>\n<a id=\"more\"></a>\n\n<h1 id=\"服务器限流介绍\"><a href=\"#服务器限流介绍\" class=\"headerlink\" title=\"服务器限流介绍\"></a>服务器限流介绍</h1><p>服务治理之限流</p>\n<p>来自 &lt;<a href=\"https://blog.frognew.com/2017/06/rate-limiting.html\" target=\"_blank\" rel=\"noopener\">https://blog.frognew.com/2017/06/rate-limiting.html</a>&gt; </p>\n<p>如何测试服务器带宽？</p>\n<p>来自 &lt;<a href=\"https://www.zhihu.com/question/20561349\" target=\"_blank\" rel=\"noopener\">https://www.zhihu.com/question/20561349</a>&gt; </p>\n<h1 id=\"简单的限流方法\"><a href=\"#简单的限流方法\" class=\"headerlink\" title=\"简单的限流方法\"></a>简单的限流方法</h1><p>贴上视频中老师写的方法（代码出处为老师视频）。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> ConnLimiter <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tconcurrentConn <span class=\"keyword\">int</span></span><br><span class=\"line\">\tbucket         <span class=\"keyword\">chan</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// concurrentConn可以连接的数量，channel满了则</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewConnLimiter</span><span class=\"params\">(cc <span class=\"keyword\">int</span>)</span> *<span class=\"title\">ConnLimiter</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;ConnLimiter&#123;</span><br><span class=\"line\">\t\tconcurrentConn: cc,</span><br><span class=\"line\">\t\tbucket:         <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, cc),</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(cl *ConnLimiter)</span> <span class=\"title\">GetConn</span><span class=\"params\">()</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(cl.bucket) &gt;= cl.concurrentConn &#123;</span><br><span class=\"line\">\t\tlog.Printf(<span class=\"string\">\"Reached the rate limitation\"</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tcl.bucket &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"Successfully got connection\"</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(cl *ConnLimiter)</span> <span class=\"title\">ReleaseConn</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tc := &lt;-cl.bucket</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"New connection coming: %d\"</span>, c)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>通过封装ServeHTTP方法，达到嵌入限流代码的目的。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> middleWareHandler <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tr *httprouter.Router</span><br><span class=\"line\">\tl *ConnLimiter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//NewMiddleWareHandler def</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewMiddleWareHandler</span><span class=\"params\">(r *httprouter.Router, cc <span class=\"keyword\">int</span>)</span> <span class=\"title\">http</span>.<span class=\"title\">Handler</span></span> &#123;</span><br><span class=\"line\">\tm := middleWareHandler&#123;&#125;</span><br><span class=\"line\">\tm.r = r</span><br><span class=\"line\">\tm.l = NewConnLimiter(cc)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> m</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">RegisterHandlers</span><span class=\"params\">()</span> *<span class=\"title\">httprouter</span>.<span class=\"title\">Router</span></span> &#123;</span><br><span class=\"line\">\trouter := httprouter.New()</span><br><span class=\"line\"></span><br><span class=\"line\">\trouter.GET(<span class=\"string\">\"/videos/:vid-id\"</span>, streamHandler)</span><br><span class=\"line\"></span><br><span class=\"line\">\trouter.POST(<span class=\"string\">\"/upload/:vid-id\"</span>, uploadHandler)</span><br><span class=\"line\"></span><br><span class=\"line\">\trouter.GET(<span class=\"string\">\"/testpage\"</span>, testPageHandler)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> router</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Handler最终会调用httprouter.Router接口方法中的ServeHTTP，这里对Go方法进行DIY封装</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m middleWareHandler)</span> <span class=\"title\">ServeHTTP</span><span class=\"params\">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !m.l.GetConn() &#123;</span><br><span class=\"line\">\t\tsendErrorResponse(w, http.StatusTooManyRequests, <span class=\"string\">\"Too many requests\"</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> m.l.ReleaseConn()</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// 调用router起作用ServeHTTP</span></span><br><span class=\"line\">\tm.r.ServeHTTP(w, r)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tr := RegisterHandlers()</span><br><span class=\"line\">\tmh := NewMiddleWareHandler(r, <span class=\"number\">2</span>)</span><br><span class=\"line\">\thttp.ListenAndServe(<span class=\"string\">\":9000\"</span>, mh)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"复杂的限流方法介绍\"><a href=\"#复杂的限流方法介绍\" class=\"headerlink\" title=\"复杂的限流方法介绍\"></a>复杂的限流方法介绍</h1><p>服务器下载限流操作（使用token bucket）：</p>\n<p>各种类似算法实现：</p>\n<p><a href=\"https://hustcat.github.io/rate-limit-example-in-go/\" target=\"_blank\" rel=\"noopener\">https://hustcat.github.io/rate-limit-example-in-go/</a></p>\n<p>HTTP限速中间件：</p>\n<p><a href=\"https://github.com/didip/tollbooth\" target=\"_blank\" rel=\"noopener\">https://github.com/didip/tollbooth</a></p>\n<p>修改servefile来实现（用到<a href=\"https://github.com/juju/ratelimit）：\" target=\"_blank\" rel=\"noopener\">https://github.com/juju/ratelimit）：</a></p>\n<p><a href=\"https://stackoverflow.com/questions/29445173/how-to-limit-download-speed-with-go\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/29445173/how-to-limit-download-speed-with-go</a></p>\n<p>使用包来实现：</p>\n<p><a href=\"https://www.0value.com/throttled--guardian-of-the-web-server\" target=\"_blank\" rel=\"noopener\">https://www.0value.com/throttled--guardian-of-the-web-server</a></p>\n<p><a href=\"https://github.com/throttled/throttled\" target=\"_blank\" rel=\"noopener\">https://github.com/throttled/throttled</a></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"服务器","slug":"服务器","permalink":"chunlife.top/tags/服务器/"},{"name":"限流","slug":"限流","permalink":"chunlife.top/tags/限流/"},{"name":"bucket token","slug":"bucket-token","permalink":"chunlife.top/tags/bucket-token/"}]},{"title":"组件与语言特性的学习","date":"2018-08-26T03:03:53.000Z","path":"2018/08/26/组件与语言特性的学习/","content":"<h2 id=\"sync-Map\"><a href=\"#sync-Map\" class=\"headerlink\" title=\"sync.Map\"></a>sync.Map</h2><p>这是一种线程安全的map用法，在版本1.9时出现，按照以前的用法，多协程情况下，需要使用将map和锁一起使用才可以做到线程安全，而现在可直接使用该类型。</p>\n<a id=\"more\"></a>\n\n<p>以下内容取自<a href=\"https://blog.csdn.net/champly/article/details/77622328\" target=\"_blank\" rel=\"noopener\">Go1.9 安全map用法</a>。</p>\n<p><img src=\"1535253147536.png\" alt=\"1535253147536\"></p>\n<h2 id=\"Gin框架\"><a href=\"#Gin框架\" class=\"headerlink\" title=\"Gin框架\"></a>Gin框架</h2><p>encoding/json 貌似不支持required json tag，实际验证好像也不支持，这个字段表示传递的json数据没有这个字段就会报错。</p>\n<p>GIN框架补充了这个字段，使用binding tag，如果没有该字段，直接报错。</p>\n<p><img src=\"clip_image001.png\" alt=\"img\"></p>\n<p>c.BindQuery可以直接把Query映射出来，当然可以操作form表单的数据，操作及其方便，涉及到反射操作，还有检查的时间。</p>\n<h2 id=\"文件下载\"><a href=\"#文件下载\" class=\"headerlink\" title=\"文件下载\"></a>文件下载</h2><p>指定浏览器直接下载文件，且使用文件下载原名，其不进行打开操作。</p>\n<p><a href=\"https://segmentfault.com/q/1010000000692593\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/q/1010000000692593</a></p>\n<p><a href=\"https://golangtc.com/t/54d9ca47421aa9170200000f\" target=\"_blank\" rel=\"noopener\">https://golangtc.com/t/54d9ca47421aa9170200000f</a></p>\n<p><img src=\"clip_image002.png\" alt=\"指定下载文件名\"></p>\n<p>golang filepath.Ext  获取文件后缀名 </p>\n<h2 id=\"时间戳格式变换为YYYYMMDD\"><a href=\"#时间戳格式变换为YYYYMMDD\" class=\"headerlink\" title=\"时间戳格式变换为YYYYMMDD\"></a>时间戳格式变换为YYYYMMDD</h2><p>//返回现在时间</p>\n<p>tNow:=time.Now()</p>\n<p>//时间转化为string，layout必须为”2006-01-0215:04:05”</p>\n<p>timeNow:=tNow.Format(“20060102”)</p>\n<p>fmt.Println(“tNow(timeformat):”,tNow)</p>\n<p>fmt.Println(“tNow(stringformat):”,timeNow)</p>\n<h2 id=\"数据库操作\"><a href=\"#数据库操作\" class=\"headerlink\" title=\"数据库操作\"></a>数据库操作</h2><p>Gorm使用first、find查询单个参数时，没有查到会返回not found错误，当Find使用数组去接数据时，没有找到也不会报错。</p>\n<p><strong>MySQL时间类型：</strong></p>\n<p><img src=\"1535287076868.png\" alt=\"MySQL时间类参数\"></p>\n<p>MySQL 中timestamp 类型使用默认值CURRENT_TIMESTAMP创建成功，使用datetime则不行。</p>\n<p>时间戳和时间格式的转换：</p>\n<p><img src=\"first.png\" alt=\"1535287353268\"></p>\n<p>转换成：</p>\n<p><img src=\"1535287393700.png\" alt=\"时间戳\"></p>\n<p><img src=\"1535287745538.png\" alt=\"as用法\"></p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"学习","slug":"学习","permalink":"chunlife.top/tags/学习/"}]},{"title":"Go Goroutine运行切换","date":"2018-08-19T02:32:59.000Z","path":"2018/08/19/Go-Goroutine运行切换/","content":"<p>Goroutine称呼上一般被我们理解为协程（Coroutine），类似于轻量级“线程”。</p>\n<a id=\"more\"></a>\n\n<ul>\n<li>Goroutine是一种编译器/解释器/虚拟机层面的多任务，并不属于操作系统。</li>\n<li>多个协程可能在一个或多个线程上运行（由调度器决定）</li>\n</ul>\n<p>对比操作系统（<em>nix）的进程或线程来说，Goroutine作为*</em>非抢占式**多任务处理，由协程主动交出控制权，也就是说，要么协程自动运行完毕，或者调度器主动来进行切换，否则，协程不会主动交出运行控制的。</p>\n<p>什么情况下，调度器会参与呢？</p>\n<ul>\n<li>I/O操作，类似于阻塞的系统的调用（异步唤醒）。</li>\n<li>select Channel </li>\n<li>等待锁 </li>\n<li>函数调用 </li>\n<li>Runtime.Gosched() </li>\n<li>其他地方也有可能会切换</li>\n</ul>\n<p>总的来说，当Goroutine不能继续向下执行时，需要等待时，调度器都有可能参与调度（根据以上状况和查Google得出，未结合源码进行分析验证）。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Goroutine","slug":"Goroutine","permalink":"chunlife.top/tags/Goroutine/"}]},{"title":"创建CSV，数据导入excel文件","date":"2018-08-15T07:45:25.000Z","path":"2018/08/15/创建CSV，数据导入excel文件/","content":"<p>代码：</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Create a csv file</span></span><br><span class=\"line\">f, err := os.OpenFile(facNFileName, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, os.ModePerm)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">defer</span> f.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">wsv := csv.NewWriter(f)</span><br><span class=\"line\"><span class=\"comment\">// write csv</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> facNo, count := <span class=\"keyword\">range</span> facNMap &#123;</span><br><span class=\"line\">\twsv.Write([]<span class=\"keyword\">string</span>&#123;facNo, strconv.FormatInt(<span class=\"keyword\">int64</span>(count), <span class=\"number\">10</span>)&#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">wsv.Flush()     <span class=\"comment\">// 需要将数据写入文件系统中</span></span><br></pre></td></tr></table></figure>\n\n<p><code>func (w *Writer) Write(record []string) error</code>，一次就是写一行数据；</p>\n<p>使用<code>Write</code>进行写数据，需要显示调用<code>Flush</code>函数将数据真实写入目标中。</p>\n<p><code>func (w *Writer) Flush()</code>，</p>\n<p>一次性写多行数据，<code>func (w *Writer) WriteAll(records [][]string) error</code>，一次即写多行数据。</p>\n<p><strong>中文乱码</strong>，若文件写入有中文，那么打开<code>.csv</code>文件时将会出现乱码的现象，可以写入UTF-8 BOM，防止中文乱码。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f.WriteString(<span class=\"string\">\"\\xEF\\xBB\\xBF\"</span>)</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"CSV文件","slug":"CSV文件","permalink":"chunlife.top/tags/CSV文件/"}]},{"title":"使用Gateway","date":"2018-08-12T09:50:22.000Z","path":"2018/08/12/Gateway初次使用/","content":"<h2 id=\"部署Gateway\"><a href=\"#部署Gateway\" class=\"headerlink\" title=\"部署Gateway\"></a>部署Gateway</h2><p>参考：github.com\\fagongzi\\gateway\\docs\\build.md</p>\n<a id=\"more\"></a>\n\n<p>网关依赖于ETCD，用于设备发现服务，可使用如下命令进行安装：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> wget https://github.com/coreos/etcd/releases/download/v3.3.9/etcd-v3.3.9-linux-amd64.tar.gz </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">$</span> tar -xzvf etcd-v3.3.9-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">$</span> ./etcd  (默认配置运行即可)</span><br></pre></td></tr></table></figure>\n\n<p>根据build.md文档，生成apiserver和proxy可执行文件后，将两者启动。</p>\n<p>proxy使用的是80接口，可能会被占用，可使用“–addr”参数进行设置，apiserver默认使用9092作为HTTP Server接口，9093作为Rpc Server接口，可保持不变，若接口依然被占用，则可参考build.md文档中参数进行设置。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> ./apiserver &amp;</span><br><span class=\"line\"><span class=\"meta\">$</span> ./proxy --addr=:8088  &amp;</span><br></pre></td></tr></table></figure>\n\n<p>程序运行失败将打印error信息。</p>\n<h2 id=\"docker部署gateway\"><a href=\"#docker部署gateway\" class=\"headerlink\" title=\"docker部署gateway\"></a>docker部署gateway</h2><ul>\n<li>8080:80，将本机的8080端口映射至docker的80端口；</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -d -p 0.0.0.0:8080:80 -p 9095:9092 -p 9093:9093 fagongzi/gateway</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"编写测试\"><a href=\"#编写测试\" class=\"headerlink\" title=\"编写测试\"></a>编写测试</h2><p>编写程序进行测试，用到gateway的client接口：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"log\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"net/http\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"time\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/fagongzi/gateway/pkg/pb/metapb\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/fagongzi/gateway/pkg/client\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/gin-gonic/gin\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> clusterA <span class=\"keyword\">uint64</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\trouter := gin.Default()</span><br><span class=\"line\"></span><br><span class=\"line\">\trouter.GET(<span class=\"string\">\"/hello/1\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</span><br><span class=\"line\">\t\tc.JSON(http.StatusOK, <span class=\"string\">\"yes, this is hello\"</span>)</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"comment\">// 第一步： 创建Cluster，类似于服务分类</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err := createCluster1(); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Println(<span class=\"string\">\"1 error,\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">\t<span class=\"comment\">// 第二步： 对应真正的业务服务器</span></span><br><span class=\"line\">\terr := createServer1()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Println(<span class=\"string\">\"2 error,\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"comment\">// 第三步： 创建API，该API会被转发到ClusterA</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err := createAPI1(); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Println(<span class=\"string\">\"3 error,\"</span>, err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\trouter.Run(<span class=\"string\">\":8068\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">createCluster1</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\tc, err := getClient()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tclusterA, err = c.NewClusterBuilder().Name(<span class=\"string\">\"cluster-A\"</span>).</span><br><span class=\"line\">\t\tLoadbalance(metapb.RoundRobin).Commit()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">createServer1</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\tc, err := getClient()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsb := c.NewServerBuilder()</span><br><span class=\"line\">\t<span class=\"comment\">// 必选项</span></span><br><span class=\"line\">\tsb.Addr(<span class=\"string\">\"127.0.0.1:8068\"</span>).HTTPBackend().MaxQPS(<span class=\"number\">100</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tid, err := sb.Commit()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 把这个server加入到cluster A</span></span><br><span class=\"line\">\tc.AddBind(clusterA, id)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">createAPI1</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\tc, err := getClient()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsb := c.NewAPIBuilder()</span><br><span class=\"line\">\t<span class=\"comment\">// 必选项</span></span><br><span class=\"line\">\tsb.Name(<span class=\"string\">\"用户API\"</span>)</span><br><span class=\"line\">\t<span class=\"comment\">// 设置URL规则，匹配所有开头为/api/user的请求</span></span><br><span class=\"line\">\tsb.MatchURLPattern(<span class=\"string\">\"/hello/(.+)\"</span>)</span><br><span class=\"line\">\t<span class=\"comment\">// 匹配GET请求</span></span><br><span class=\"line\">\tsb.MatchMethod(<span class=\"string\">\"GET\"</span>)</span><br><span class=\"line\">\t<span class=\"comment\">// 匹配所有请求</span></span><br><span class=\"line\">\t<span class=\"comment\">//sb.MatchMethod(\"*\")</span></span><br><span class=\"line\">\t<span class=\"comment\">// 不启动</span></span><br><span class=\"line\">\t<span class=\"comment\">//sb.Down()</span></span><br><span class=\"line\">\t<span class=\"comment\">// 启用</span></span><br><span class=\"line\">\tsb.UP()</span><br><span class=\"line\">\t<span class=\"comment\">// 分发到Cluster A</span></span><br><span class=\"line\">\tsb.AddDispatchNode(clusterA)</span><br><span class=\"line\"></span><br><span class=\"line\">\tid, err := sb.Commit()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"api id is: %d\"</span>, id)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 如果你的api server使用了\"--discovery\"参数启动</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getClientWithDiscovery</span><span class=\"params\">()</span> <span class=\"params\">(client.Client, error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> client.NewClientWithEtcdDiscovery(<span class=\"string\">\"/services\"</span>,</span><br><span class=\"line\">\t\ttime.Second*<span class=\"number\">10</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">\"127.0.0.1:2379\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 如果你的api server没有使用\"--discovery\"参数启动</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getClient</span><span class=\"params\">()</span> <span class=\"params\">(client.Client, error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> client.NewClient(time.Second*<span class=\"number\">10</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">\"127.0.0.1:9091\"</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"运行测试程序\"><a href=\"#运行测试程序\" class=\"headerlink\" title=\"运行测试程序\"></a>运行测试程序</h2><p>若程序出现如下打印，代表程序运行成功。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2018/09/17 19:16:08.755386 [info] cluster &lt;1&gt; added, data &lt;id:1 name:\"cluster-A\" &gt;</span><br><span class=\"line\">2018/09/17 19:16:08.763781 [info] analysis: added, key=&lt;2&gt; interval=&lt;1s&gt;</span><br><span class=\"line\">2018/09/17 19:16:08.763872 [info] server &lt;2&gt; added, data &lt;id:2 addr:\"127.0.0.1:8068\" maxQPS:100 &gt;</span><br><span class=\"line\">2018/09/17 19:16:08.763883 [warning] server &lt;2&gt; heath check not setting</span><br><span class=\"line\">2018/09/17 19:16:08.763887 [info] server &lt;2&gt; UP</span><br><span class=\"line\">2018/09/17 19:16:08.771950 [info] bind &lt;1,2&gt; created</span><br><span class=\"line\">2018/09/17 19:16:08.771957 [info] bind &lt;1,2&gt; actived</span><br></pre></td></tr></table></figure>\n\n<p>可使用curl命令去测试接口：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> curl http://localhost:8088/hello/1</span><br></pre></td></tr></table></figure>\n\n<p>出现”yes, this is hello”，代表程序测试成功。</p>\n<h2 id=\"部署gateway-ui\"><a href=\"#部署gateway-ui\" class=\"headerlink\" title=\"部署gateway_ui\"></a>部署gateway_ui</h2><p>gateway有两个UI管理界面，这里我只部署了一个，gateway_ui。</p>\n<p><a href=\"https://github.com/archfish/gateway_ui\" target=\"_blank\" rel=\"noopener\">https://github.com/archfish/gateway_ui</a></p>\n<p><a href=\"https://github.com/wilehos/gateway_admin_ui\" target=\"_blank\" rel=\"noopener\">https://github.com/wilehos/gateway_admin_ui</a></p>\n<p>拉取镜像：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull hub.c.163.com/weihailang/gateway_ui:latest</span><br></pre></td></tr></table></figure>\n\n<p>使用docker进行部署：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -d --restart always -p 3000:3000 --name gateway_ui -u 1001:1001 -h gateway.ui.production -e RAILS_ENV=production -e GATEWAY_BACKEND=172.31.242.128:9093 hub.c.163.com/weihailang/gateway_ui</span><br></pre></td></tr></table></figure>\n\n<p>由于没有登录鉴权接口（可以使用Nginx密码登录验证来代替），所以管理界面是不建立部署在外网环境中。</p>\n<p>UI使用docker部署是最为方便的，若UI使用docker部署，那么gateway也得使用docker进行部署，因为docker内的应用是无法访问到外网的，需要使用NAT技术进行桥接。以后的服务也是需要统一部署到docker中的。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"Gateway","slug":"Gateway","permalink":"chunlife.top/tags/Gateway/"}]},{"title":"EE小白到CS小白","date":"2018-08-12T09:50:22.000Z","path":"2018/08/12/EE小白到CS小白/","content":"<p>从武汉来到深圳，怀揣着一个傲娇的想法走出来，纯粹就是想要看看世界，毕业呆了四年的城市毕竟太过熟悉了。同时，之前做的是嵌入式开发，在公司当个软件组长太过安逸，而且在武汉工资和前景感觉都不是太好看，于是在毕业又做了大半年后，于公司辞职后，来到了深圳。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"五一\"><a href=\"#五一\" class=\"headerlink\" title=\"五一\"></a>五一</h2><p>五月一号到的深圳，听着《飞得更高》，一路忐忑。</p>\n<p>一个陌生的城市，感受当然是深圳各个方面都是666，什么都是新样式。（实际感受和武汉没有啥一样）</p>\n<p>到深圳肯定是先叫同学一顿约约约，过个五一再说，然后就是忙碌的面试过程了。</p>\n<p>工作基本方向都是嵌入式，因为自己之前就是从事的嵌入式军工行业，对Linux、VxWorks比较熟悉，找工作当然也是跟这方面息息相关的，工资普遍会比在武汉高出一个3-4K的额度，对于我这样毕业一年的人，主要还是想定一个好点的行业与公司好好的发展发展，这样手上才有个屠龙技。非常感谢面试的那些公司，对我都比较友善，知道我刚来深圳，有的面试官在面试完后还会告诉我一些</p>\n<p>在第三天的时候面了一家做存储的公司，面的是嵌入式软件工程师，安排职位时是给的Go开发（后端开发）岗位，面试得比较愉快，当时手里已经拿了有几份offer了，所以对工作会有点自己的考虑。</p>\n<p>嵌入式对于我肯定是熟悉一点，在大学里，实习，工作所做的都是嵌入式开发，我也自学了Android开发，找的工作也有对Android方向的，这个方向的嵌入式虽没有互联网一些热门方向霸道，但不会太差，现在手里工作的offer工资也很好看。</p>\n<p>后端的职位，是使用Go开发，对比Java来说，足够小众，所做的内容我也可以说出其各种不好，但换个角度，我将其视作一个机会，一个我尝试的机会，在做嵌入式时，已经听闻很多CS方面的事了，单纯的，我想过去看看，可能不成功，大不了我就滚回去做嵌入式就可以了，谁还不允许我犯错了。</p>\n<p>心理足够忐忑，即使到了现在还是那么忐忑，想想这个决定可能对我的影响，中间还有大华的邀约，现在想来做出这个决定依然是很刺激的。</p>\n<h2 id=\"五一前\"><a href=\"#五一前\" class=\"headerlink\" title=\"五一前\"></a>五一前</h2><p>在武汉，出学校后，自己就不断的懈怠了，并没有在学校那种冲劲，对自己的发展比较迷茫，不知道路在哪里。</p>\n<p>之前是在一家做军工产品的公司工作，做的也是比较安逸，算是平静的发展吧。但我自己逐渐不太满足，因为我对自己的要求在逐渐下降，这让我自己很苦恼，我标准应该是一直提高啊。</p>\n<p>对于出去，我就想着出去走走，见见世面嘛，外面不见得会有多好，但没在外面待一段时间，哪里来的深刻对比呢？所以，还是出来走走比较靠谱。</p>\n<h2 id=\"如今\"><a href=\"#如今\" class=\"headerlink\" title=\"如今\"></a>如今</h2><p>对于两个方向，我都是个小白，嵌入式工作了两年，后端才刚开始，小白摸着石头过个河，路上见见更多的前辈恩师，还有更多的风景，求个快活。</p>\n<p>现在，我也是迷茫的，但我知道自己还是向前的，对自己是要求的。毕竟我还有追求。</p>\n<p>我追求嘛，谁都需要，谁都可以去实现。毕竟有一句话是，和尚摸得，我摸不得？</p>\n<p>哈哈，不怎么应景。</p>\n","categories":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/categories/随笔/"}],"tags":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/tags/随笔/"}]},{"title":"比特币—-挖矿","date":"2018-08-11T14:42:02.000Z","path":"2018/08/11/比特币—-挖矿/","content":"<p>以前做嵌入式智能感叹比特币价格的疯狂，曾突破到一万多美元一枚的价格，让我流下了没有技术的泪水，现在却是可以理解理解到底啥玩意叫个区块链，啥叫个比特币了。</p>\n<a id=\"more\"></a>\n\n<h1 id=\"区块链与比特币\"><a href=\"#区块链与比特币\" class=\"headerlink\" title=\"区块链与比特币\"></a>区块链与比特币</h1><p>区块链可以说是类比特币技术的一个大的集合，囊括了其一个整体的技术演变而来，并不与比特币相等同。</p>\n<p>比特币的出现很多地方应该是吸收了很多“密码朋克”这个组织的很多成果，对于这个组织里面的人，我只能表示佩服，很了不起。2008年中本聪发表的比特币白皮书——《比特币：一个点对点的电子现金系统》，其提出的去中心化思想确实厉害，更应该让我感到佩服的是，这个东西不仅仅是一个白皮书一样的存在，它让这个思想具象化了。</p>\n<h2 id=\"比特币\"><a href=\"#比特币\" class=\"headerlink\" title=\"比特币\"></a>比特币</h2><p>比特币是一种数字货币。</p>\n<p>当我们共同承认它具有价值时，它就具有了购买力。举个例子：RMB是国家给予其价值，那么其就被赋予了价值，那数字货币也一样。</p>\n<h3 id=\"区块\"><a href=\"#区块\" class=\"headerlink\" title=\"区块\"></a>区块</h3><p>比特币使用Hash进行校验，使用Hash对内容进行Hash计算，得出Hash值，拿这个值进行内容校验。</p>\n<p><img src=\"1534000072795.png\" alt=\"1534000072795\"></p>\n<p>拿以后的区块，会将前一个Hash值与当前内容一起进行Hash计算，得到一个现在区块持有的Hash值。</p>\n<p><img src=\"1534000007496.png\" alt=\"1534000007496\"></p>\n<p>区块不断在累加，逐渐累积成链。我们若是需要验证区块，那么只需要抽取链最后一个区块Hash进行校验即可。</p>\n<p><img src=\"1533999959460.png\" alt=\"1533999959460\"></p>\n<h3 id=\"账户所有权\"><a href=\"#账户所有权\" class=\"headerlink\" title=\"账户所有权\"></a>账户所有权</h3><p>比特币很安全，安全的原因是分布式账本上没有存储任何个人信息，交易信息的对接使用的是“地址”（账号），也就是地址对地址间的通信，那地址是什么呢？</p>\n<p>一个“地址”对应于一个私钥，私钥是唯一的，其不可重置。地址与私钥为非对称关系，也就是说私钥可进行两次Hash计算后得到地址，而地址是不可进行逆推的（可查看RSA加密解密）。</p>\n<p><img src=\"1534000622004.png\" alt=\"1534000622004\"></p>\n<p>利用非对称密钥，公钥是开放出去的，验证私钥的过程既是使用公钥验证的过程。</p>\n<p><img src=\"1534061724465.png\" alt=\"1534061724465\"></p>\n<p>然后将个交易记录广播给其他节点，由其他节点去验证信息的正确。</p>\n<h3 id=\"挖矿\"><a href=\"#挖矿\" class=\"headerlink\" title=\"挖矿\"></a>挖矿</h3><p>挖矿的过程既是记账的过程，记账需要提供算力，使用Hash算法打包记录，而比特币作为记账的奖励分发给用户。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"区块链","slug":"区块链","permalink":"chunlife.top/tags/区块链/"},{"name":"比特币","slug":"比特币","permalink":"chunlife.top/tags/比特币/"}]},{"title":"RSA加密解密","date":"2018-07-29T13:43:46.000Z","path":"2018/07/29/RSA加密解密/","content":"<p>因为项目需要，最近做一个RSA加密解密的接口，使用Go进行开发，接口使用jsonrpc，go 对RSA加密解密有很好的支持，不过由于受限于底层单片机，所以上层应用需要做一些稍微的调整。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"一、概要\"><a href=\"#一、概要\" class=\"headerlink\" title=\"一、概要\"></a>一、概要</h2><p>RSA是一种非对称加密算法，什么是非对称加密算法呢，那就是公钥、私钥可互相进行加密解密：公钥加密—私钥解密，私钥加密—公钥解密。 </p>\n<p>了解RSA算法的实现原理，可参考：<a href=\"https://www.cnblogs.com/fangxupeng/p/4128990.html\" target=\"_blank\" rel=\"noopener\">非对称加密过程详解（基于RSA非对称加密算法实现）</a></p>\n<p>RSA算法的基本原理（截图的来源没有保留链接，若侵权请直接告诉我，我会直接删除的）：</p>\n<p><img src=\"1537603491913.png\" alt=\"1537603491913\"></p>\n<h2 id=\"三、RSA一些名词的解释\"><a href=\"#三、RSA一些名词的解释\" class=\"headerlink\" title=\"三、RSA一些名词的解释\"></a>三、RSA一些名词的解释</h2><p>什么是PKCS#1，PKCS（公钥密码标准），而#1就是RSA的标准。 </p>\n<p>PEM文件，也就是公私钥的编码格式。</p>\n<p>RSA算法的原理：<a href=\"https://blog.csdn.net/starryheavens/article/details/8536238\" target=\"_blank\" rel=\"noopener\">RSA算法详解</a>，从这篇博客主要是提取出RSA算法的公式。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C=(P^e)%n</span><br></pre></td></tr></table></figure>\n\n<p>N是公钥私钥共同使用的，其为模数。另外还有公钥的指数E，私钥的指数E。</p>\n<p>公钥的指数一般是65537，私钥的指数则是一个极大的数，想想一个极大的数作为指数，计算时间是会耗费很长时间的。故公钥加密解密都很快，私钥则会慢很多 </p>\n<h2 id=\"二、Go中的RSA加密解密\"><a href=\"#二、Go中的RSA加密解密\" class=\"headerlink\" title=\"二、Go中的RSA加密解密\"></a>二、Go中的RSA加密解密</h2><p>RSA标准是通过公钥加密，私钥解密 ，没有私钥加密，公钥解密。为什么会这样呢？</p>\n<p>Go设计库一般会严格按照标准来进行设计（在很多地方都见过相似做法），那是RSA标准中没有后一种情况的使用场景吗？其实是有的，只不过这个过程不要加密解密，而是RSA签名与验签。所以按照标准，RSA标准库也就不会有私钥加密，公钥解密的方法了。</p>\n<p>这个问题想想应该是很多人的问题了，那么在Google上进行搜索了下，还是发现了解决方法。</p>\n<p><a href=\"https://github.com/wenzhenxi/gorsa\" target=\"_blank\" rel=\"noopener\">https://github.com/wenzhenxi/gorsa</a></p>\n<p>库中实现了公钥加解密的方法。</p>\n<p>还有其他解决方法吗？是有的，在Google上进行搜索就可以找到，记得还有人使用CGO调用C库来解决。</p>\n<h2 id=\"四、Go-RSA库的使用\"><a href=\"#四、Go-RSA库的使用\" class=\"headerlink\" title=\"四、Go RSA库的使用\"></a>四、Go RSA库的使用</h2><p>标准库的使用者很多，博客也很多，这里不做多的介绍，放上一个博主的链接。</p>\n<p><a href=\"http://blog.studygolang.com/2013/01/go%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86%E4%B9%8Brsa/\" target=\"_blank\" rel=\"noopener\">GO加密解密之RSA</a></p>\n<h2 id=\"五、项目中的问题\"><a href=\"#五、项目中的问题\" class=\"headerlink\" title=\"五、项目中的问题\"></a>五、项目中的问题</h2><p>此处，由于我的问题比较特殊，所以到此并没完全解决我的问题，还记得上面说的RSA指数与模数的东西吗，因为上层是与stm32进行通信，32RSA的库是需要自己手动将指数与模数填入结构体中的，那么上层就应该将生成的私钥进行分解开来，得到stm32所需要的指数和模数，那么怎么得到这些数据呢。</p>\n<p>我使用的方法是借用OpenSSL，理论上来说像Python就可以做到，但是我并不想将事情复杂化，直接借用现有的工具是最省事的。</p>\n<p>参考：<a href=\"https://blog.csdn.net/junkie0901/article/details/40539857\" target=\"_blank\" rel=\"noopener\">如何用 openssl 生成RSA双密匙；签名证书；加密文件邮件</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl rsa -in private.pem -text -noout</span><br></pre></td></tr></table></figure>\n\n<p>-noout : 表示不显示密钥</p>\n<p>运行结果：</p>\n<p><img src=\"1533047035026.png\" alt=\"1533047035026\"></p>\n<p>modulus、publicExponent、privateExponent，这三个数就是我们所需要的数据（publicExponent一般算法会设为65537）。</p>\n<p>那么此处就很简单的进行字符串截取就可以做到拿出这三个数据了。</p>\n<h2 id=\"六、AES加密解密\"><a href=\"#六、AES加密解密\" class=\"headerlink\" title=\"六、AES加密解密\"></a>六、AES加密解密</h2><p>既然提到了RSA，不对称加密算法了，那么也去了解了解AES对称加密算法吧。</p>\n<p><a href=\"https://blog.csdn.net/yue7603835/article/details/73395580\" target=\"_blank\" rel=\"noopener\">golang实现AES ECB模式的加密和解密</a></p>\n<p>Go的实现可参考贴出来的链接，不过此处给出我遇到的一个问题。</p>\n<p>截取自博客中的原文：</p>\n<p><img src=\"1533047635959.png\" alt=\"1533047635959\"></p>\n<p>标记出来的话，其实是有问题的，AES算法，区块长度是固定的，为128bit。</p>\n<p>摘抄自<a href=\"https://baike.baidu.com/item/aes/5903?fr=aladdin\" target=\"_blank\" rel=\"noopener\">百度百科</a>：严格地说，AES和Rijndael加密法并不完全一样（虽然在实际应用中二者可以互换），因为Rijndael加密法可以支持更大范围的区块和密钥长度：AES的区块长度固定为128比特，密钥长度则可以是128、192、256比特；而Rijndael使用的密钥和区块长度可以是32位的整数倍，以128位为下限，256比特为上限。加密过程中使用的密钥是由Rijndael密钥生成方案产生。</p>\n<p>在golang的源码设计中也可以证明这点，其blocksize设定为const，其值为16(byte)，显然，标准库是并不允许使用者去修改这个值的，那么AES-128/192/256，其实是针对的密钥长度来说的。</p>\n<p>另外，使用go AES库需要注意的是，go aes输入的密钥不满足16、24、32的要求，会直接返回错误，其并没有设计补全机制，需要自己实现。</p>\n<p>数据块长度不足128bit，其同样也需要补全；很遗憾的是go依然没有帮助自动补全。补全方式有多种，一般常见的是zeropadding，pkcs5padding，pkcs7padding。 </p>\n<p>参考<a href=\"https://studygolang.com/articles/6662\" target=\"_blank\" rel=\"noopener\">golang AES/ECB/PKCS5 加密解密 url-safe-base64</a></p>\n<p>博客使用的是pkcs5padding，这里补上zeropadding。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">ZeroPadding</span><span class=\"params\">(ciphertext []<span class=\"keyword\">byte</span>, blockSize <span class=\"keyword\">int</span>)</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\">\tpadding := blockSize - <span class=\"built_in\">len</span>(ciphertext)%blockSize</span><br><span class=\"line\">\tpadtext := bytes.Repeat([]<span class=\"keyword\">byte</span>&#123;<span class=\"number\">0</span>&#125;, padding) </span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">append</span>(ciphertext, padtext...)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">ZeroUnPadding</span><span class=\"params\">(origData []<span class=\"keyword\">byte</span>)</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> bytes.TrimFunc(origData,</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(r <span class=\"keyword\">rune</span>)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> r == <span class=\"keyword\">rune</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>附上我写的填充key的代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">KeyPadding</span><span class=\"params\">(key <span class=\"keyword\">string</span>)</span> <span class=\"params\">(keyByte []<span class=\"keyword\">byte</span>)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tkeyLen := <span class=\"built_in\">len</span>(key)</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> keyLen &lt; <span class=\"number\">16</span>:</span><br><span class=\"line\">\t\tkeyByte = ZeroPadding([]<span class=\"keyword\">byte</span>(key), <span class=\"number\">16</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> keyLen &gt; <span class=\"number\">16</span> &amp;&amp; keyLen &lt; <span class=\"number\">24</span>:</span><br><span class=\"line\">\t\tkeyByte = ZeroPadding([]<span class=\"keyword\">byte</span>(key), <span class=\"number\">24</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> keyLen &gt; <span class=\"number\">24</span> &amp;&amp; keyLen &lt; <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\tkeyByte = ZeroPadding([]<span class=\"keyword\">byte</span>(key), <span class=\"number\">32</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> keyLen &gt; <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\tkeyByte = []<span class=\"keyword\">byte</span>(key)[:<span class=\"number\">32</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\tkeyByte = []<span class=\"keyword\">byte</span>(key)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> keyByte</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"七、使用的方法\"><a href=\"#七、使用的方法\" class=\"headerlink\" title=\"七、使用的方法\"></a>七、使用的方法</h2><h3 id=\"bytes-Join将byte数组的数组进行组合\"><a href=\"#bytes-Join将byte数组的数组进行组合\" class=\"headerlink\" title=\"bytes.Join将byte数组的数组进行组合\"></a>bytes.Join将byte数组的数组进行组合</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bytes.Join(pBytes, []<span class=\"keyword\">byte</span>(<span class=\"string\">\"\"</span>))</span><br></pre></td></tr></table></figure>\n\n<p>第二个参数表示数组间用什么去间隔</p>\n<h3 id=\"将一个大数按大小端转换为byte数组模式\"><a href=\"#将一个大数按大小端转换为byte数组模式\" class=\"headerlink\" title=\"将一个大数按大小端转换为byte数组模式\"></a>将一个大数按大小端转换为byte数组模式</h3><p>binary.BigEndian.PutUint64</p>\n<p><a href=\"https://blog.csdn.net/coledaddy/article/details/71195528\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/coledaddy/article/details/71195528</a> </p>\n<h3 id=\"返回子串在字符串中的索引\"><a href=\"#返回子串在字符串中的索引\" class=\"headerlink\" title=\"返回子串在字符串中的索引\"></a>返回子串在字符串中的索引</h3><p>例如strings.Index(str, “modules”)，返回的是开始出现”modules”的位置，即”m”。</p>\n<h3 id=\"将数组转换为以“-”分割的字符串\"><a href=\"#将数组转换为以“-”分割的字符串\" class=\"headerlink\" title=\"将数组转换为以“,”分割的字符串\"></a>将数组转换为以“,”分割的字符串</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">strings.Replace(strings.Trim(fmt.Sprint(byteArr),<span class=\"string\">\"[]\"</span>), <span class=\"string\">\" \"</span>, <span class=\"string\">\",\"</span>, <span class=\"number\">-1</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将十六进制的字符，转换为整数\"><a href=\"#将十六进制的字符，转换为整数\" class=\"headerlink\" title=\"将十六进制的字符，转换为整数\"></a>将十六进制的字符，转换为整数</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">strconv.ParseUint(data, 16, 8)</span><br></pre></td></tr></table></figure>\n\n<p>data：字符，16：进制，8：转换数据的大小，8则是8bit。</p>\n<h2 id=\"2018年8月22日17-38-32\"><a href=\"#2018年8月22日17-38-32\" class=\"headerlink\" title=\"2018年8月22日17:38:32\"></a>2018年8月22日17:38:32</h2><p>本来以为rsa加密解密的事都要翻篇了，谁知道底层突然和我说交互出了问题，STM32使用的RSA是官方库，Go使用的是官方库，理论上不应该有什么问题的，但实际上就是出了问题。</p>\n<p>问题是这样的，Go使用私钥加密，STM32无法使用公钥进行解密；STM32使用私钥加密，Go无法进行公钥解密。但双方公钥加密，对方都可以进行私钥解密。</p>\n<p>然后花了一天的时间的去细细的琢磨这个事，觉得这个过程还是很有意思的。</p>\n<p>首先，则是两方都去检查源码是否出现使用错误，在互相review代码确认无误，这样不会造成总是去怀疑对方的代码，至少在使用上都是按照官方文档进行的操作。</p>\n<p>第二步，再三确认私钥加密，公钥解密这个种非标用法是可行的。因为RSA签名和验证过程是包含有私钥加密，公钥解密的，这个点是不需要再去考虑正确性的。</p>\n<p>第三步，双方通讯无法通过对方，那么很自然的就会想到，先抛弃掉对方，使用另外一种标准库，或者是语言的标准库来佐证自己的库的正确性，这里我选择的是使用OpenSSL的接口，使用CGo，调用的OpenSSL的接口，放上借用的库链接<a href=\"https://github.com/dgkang/rsa，最终测试结果是与Go库中的结果是一样的。我这里用的库是https://github.com/wenzhenxi/gorsa，因为官方库并没有将RSA私钥加密暴露出来，若需要使用的话就需要自己动手了。\" target=\"_blank\" rel=\"noopener\">https://github.com/dgkang/rsa，最终测试结果是与Go库中的结果是一样的。我这里用的库是https://github.com/wenzhenxi/gorsa，因为官方库并没有将RSA私钥加密暴露出来，若需要使用的话就需要自己动手了。</a></p>\n<p>第四步，我单方面的证明了Go库没有问题，此时怀疑的方向就只能是STM32官方库出了问题，哪里出了问题呢。偶然地，在使用<a href=\"https://github.com/dgkang/rsa库时，OpenSSL上报错信息是：error:0407006A:rsa\" target=\"_blank\" rel=\"noopener\">https://github.com/dgkang/rsa库时，OpenSSL上报错信息是：error:0407006A:rsa</a> routines:RSA_padding_check_PKCS1_type_1:block type is not 01。这个报错信息很关键，STM32库上说的是PKCS1 padding方式，那现在OpenSSL又报出了type方式不同，那只能说明这是有点问题。使用了库的nopadding方式，可以解密出来的数据都打印出来（PKCS1会直接返回数据，填充的信息会直接过滤掉）。</p>\n<p><img src=\"clip_image001.png\" alt=\"img\"></p>\n<p>在调试时，这些数据也是一头雾水的，实际打印的信息是下面的，我实际想要的是后面的数字，这个byte数组和string乱码看的也是脑袋大，为了搞清楚这个，需要了解加密填充信息。</p>\n<p><img src=\"clip_image002.png\" alt=\"img\"></p>\n<p>以下介绍填充方式的知识皆参考自：</p>\n<p>RSA_PKCS1_PADDING</p>\n<p>来自 &lt;<a href=\"https://www.douban.com/note/338531480/\" target=\"_blank\" rel=\"noopener\">https://www.douban.com/note/338531480/</a>&gt; </p>\n<p>padding的三种方式：</p>\n<p>RSA加密常用的填充方式有下面3种：</p>\n<p>1.RSA_PKCS1_PADDING 填充模式，最常用的模式</p>\n<p>要求:</p>\n<p>输入：必须 比 RSA 钥模长(modulus) 短至少11个字节, 也就是　RSA_size(rsa) – 11</p>\n<p>如果输入的明文过长，必须切割，然后填充</p>\n<p>输出：和modulus一样长</p>\n<p>2.RSA_PKCS1_OAEP_PADDING</p>\n<p>输入：RSA_size(rsa) – 41</p>\n<p>输出：和modulus一样长</p>\n<p>3.RSA_NO_PADDING　　不填充</p>\n<p>输入：可以和RSA钥模长一样长（因为不填充，必须要填入模长），如果输入的明文过长，必须切割，然后填充</p>\n<p>输出：和modulus一样长</p>\n<p>其中PKCS1需要遵守的填充规则是</p>\n<p><img src=\"clip_image003.png\" alt=\"img\"></p>\n<p>可以看到数据组成方式是有着固定的规则的。</p>\n<p>那再看看我们从STM32解密出来的数据，可以看到这个数据有点问题，明明是私钥加的密，开头确实0 2，大概率这里有问题。</p>\n<p><img src=\"clip_image001-1534941259919.png\" alt=\"img\"></p>\n<p>于是我在我的私钥加密中，将这位修改成2，将数据发给STM32,32那边随即便将数据返回出来了。</p>\n<p>还有一个问题，那就是为什么PKCS标准需要留11个字节呢。</p>\n<p><img src=\"clip_image004.png\" alt=\"img\"></p>\n<p>这11个字长那么大概率就是为了增加秘钥安全性所预留的随机数了。</p>\n<p>至此，算是终于将问题找到，并找到解决的办法了，解决问题大概是经历了那几个步骤，中间夹杂着各种尝试，当然写出来的却是每一步走得都很正确，中间与人沟通的成本不低，沟通愉快的时候解决问题的方法就会非常的多。</p>\n<h3 id=\"Golang实现Nopadding模式\"><a href=\"#Golang实现Nopadding模式\" class=\"headerlink\" title=\"Golang实现Nopadding模式\"></a>Golang实现Nopadding模式</h3><p><a href=\"https://stackoverflow.com/questions/40870178/golang-rsa-decrypt-no-padding\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/40870178/golang-rsa-decrypt-no-padding</a></p>\n<p><img src=\"123.png\" alt=\"Nopadding\"></p>\n<p>提供解决方法的人特意提醒了，若用户有选择，请尽量不要使用这种填充方式，并给出了提供意见的链接。（不得不说，做事真的严谨）</p>\n<p><a href=\"https://crypto.stackexchange.com/a/15184\" target=\"_blank\" rel=\"noopener\">https://crypto.stackexchange.com/a/15184</a></p>\n<p>我这里直接截取出结论来，具体如何得出结论的，还是希望大家能够读一读原文。</p>\n<p><img src=\"1234.png\" alt=\"Do Not use RSA\"></p>\n<p>不要使用RSA不填充方式，其是一种裸RSA加密方式，</p>\n<p>① 在任何公钥加密场合，当明文具有低熵（低混乱度）时，它是不安全的。</p>\n<p>② 短明文易受到攻击。</p>\n<p>其中，作者还建议为了保证算法的加密性，那么就应该保护算法的随机性，加密的数据不应该太多，2048bit key，最好只加密0-190字节的数据，如果不能满足，应该考虑使用混合加密算法。</p>\n","categories":[{"name":"Go","slug":"Go","permalink":"chunlife.top/categories/Go/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"OpenSSL","slug":"OpenSSL","permalink":"chunlife.top/tags/OpenSSL/"},{"name":"RSA加密解密","slug":"RSA加密解密","permalink":"chunlife.top/tags/RSA加密解密/"}]},{"title":"搭建博客——使用Hexo","date":"2018-07-22T15:32:05.000Z","path":"2018/07/22/搭建博客——使用Hexo/","content":"<h2 id=\"搭建博客\"><a href=\"#搭建博客\" class=\"headerlink\" title=\"搭建博客\"></a>搭建博客</h2><p>使用GitHub和Hexo搭建博客其实是非常顺畅的，毕竟工具到现在都已经经历很多版本的迭代了，已经很傻瓜式了。</p>\n<p>推荐搭建的教程：</p>\n<a id=\"more\"></a>\n\n<p>关于Hexo6.0搭建个人博客(github+Google-收录篇)，博主还有教我们怎么收录百度的博客，道理是一样的。</p>\n<p><a href=\"https://www.imooc.com/article/31085\" target=\"_blank\" rel=\"noopener\">https://www.imooc.com/article/31085</a></p>\n<p>这里提一点绑定的事，附上我的DNS解析：</p>\n<p><img src=\"1532523945344.png\" alt=\"DNS解析\"></p>\n<h3 id=\"参考的博客\"><a href=\"#参考的博客\" class=\"headerlink\" title=\"参考的博客\"></a>参考的博客</h3><p><a href=\"https://www.voidking.com/2018/06/11/deve-hexo-categories/\" target=\"_blank\" rel=\"noopener\">Hexo添加categories页面</a>，<a href=\"https://yanxin152133.github.io/2019/03/21/Hexo%20yilia%20%E6%B7%BB%E5%8A%A0%E7%9B%AE%E5%BD%95%E9%A1%B5%E9%9D%A2/\" target=\"_blank\" rel=\"noopener\">Hexo Yilia 添加目录页面</a></p>\n<p>Hexo——Yilia主题添加文章置顶</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm uninstall hexo-generator-index --save</span><br><span class=\"line\">npm install hexo-generator-index-pin-top --save</span><br><span class=\"line\"></span><br><span class=\"line\">// 文章头加入</span><br><span class=\"line\">Top: True</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://lonepatient.top/2018/02/03/hexo_yilia_2.html\" target=\"_blank\" rel=\"noopener\">GitHub+Hexo+yilia文章浏览量统计</a></p>\n<p><a href=\"https://lonepatient.top/2018/02/02/hexo_yilia_1.html\" target=\"_blank\" rel=\"noopener\">GitHub+Hexo+yilia评论插件</a></p>\n<p><a href=\"http://veronachiu.site/2018/08/03/Hexo-Yilia%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%EF%BC%9AHexo%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-Hexo%E6%96%87%E7%AB%A0%E4%B9%A6%E5%86%99-Yilia%E9%85%8D%E7%BD%AE/\" target=\"_blank\" rel=\"noopener\">Hexo+Yilia博客搭建：Hexo常用命令+Hexo文章书写+Yilia配置</a></p>\n<p><a href=\"http://lawlite.me/2017/04/13/Hexo-Github%E5%AE%9E%E7%8E%B0%E7%9B%B8%E5%86%8C%E5%8A%9F%E8%83%BD/\" target=\"_blank\" rel=\"noopener\">Hexo+Github实现相册功能</a> </p>\n<p><a href=\"http://lawlite.me/2017/04/17/Hexo-yilia%E4%B8%BB%E9%A2%98%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95%E5%92%8C%E6%B7%BB%E5%8A%A0%E8%A7%86%E9%A2%91/\" target=\"_blank\" rel=\"noopener\">Hexo+yilia主题实现文章目录和添加视频</a> </p>\n<p><a href=\"https://www.jianshu.com/p/cb0a105d7a81\" target=\"_blank\" rel=\"noopener\">Hexo Yilia主题增加分享以及访问统计</a></p>\n<p><a href=\"https://ziven.cc/2018/07/03/Hexo%E4%B8%BB%E9%A2%98yilia%E5%A2%9E%E5%8A%A0gitalk%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6/\" target=\"_blank\" rel=\"noopener\">Hexo主题yilia增加gitalk评论插件</a> </p>\n<p><a href=\"https://github.com/litten/hexo-theme-yilia/pull/767\" target=\"_blank\" rel=\"noopener\">Yilia Pull Request</a></p>\n<h2 id=\"插入图片\"><a href=\"#插入图片\" class=\"headerlink\" title=\"插入图片\"></a>插入图片</h2><h3 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h3><p>这里主要是提一下我遇到的一个插入图片的问题，这里我使用的Hexo主题是yilia。 </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://github.com/litten/hexo-theme-yilia.git themes/yilia</span><br></pre></td></tr></table></figure>\n\n<p>yilia需要会提示我们安装一个插件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm i hexo-generator-json-content --save</span><br></pre></td></tr></table></figure>\n\n<p>但很奇怪的是，我在安装完这个插件后，我的hexo-asset-image——图片链接转换插件就不见了，导致我莫名其妙的图片无法显示了，Google多次无果，重新部署时才发现这个问题（没有细心去找），实在是没想到会出现这个问题，所以在装完这个插件后，又手动将hexo-asset-image插件给安装了回来，之后网页和本地都没有显示问题了，撒花。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install https://github.com/CodeFalling/hexo-asset-image --save</span><br></pre></td></tr></table></figure>\n\n<p>当然，我还看到有人遇到图片显示不出来的其他问题，如果和你的问题对上了，可以看看：</p>\n<p>hexo中完美插入本地图片</p>\n<p><a href=\"http://etrd.org/2017/01/23/hexo%E4%B8%AD%E5%AE%8C%E7%BE%8E%E6%8F%92%E5%85%A5%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87/\" target=\"_blank\" rel=\"noopener\">http://etrd.org/2017/01/23/hexo%E4%B8%AD%E5%AE%8C%E7%BE%8E%E6%8F%92%E5%85%A5%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87/</a></p>\n<h3 id=\"2018年7月25日20-54-20\"><a href=\"#2018年7月25日20-54-20\" class=\"headerlink\" title=\"2018年7月25日20:54:20\"></a>2018年7月25日20:54:20</h3><p>在这个时候又添加上这段话，是因为博客无法显示图片了，hexo-asset-image好像无法替我正常转换图片路径了，对JS的源码无法分析，只能提一个issue，同时在网上查找答案，在白天的时候找到一个方法，将其截图，准备晚上试试，发现这个方法好像确实好使。</p>\n<p><strong>注意</strong>：使用该方法则不能保留hexo-asset-image，直接去module目录删除即可。</p>\n<p><img src=\"1532523531403.png\" alt=\"Hexo插入图片方法\"></p>\n<p>原链接没有保存，故无法放出链接了，需要的可自行Google。</p>\n<p>修改后可配合Typora使用，其在“编辑”——“图片工具”中，可设置图片根目录，将其定位到图片所在即可。</p>\n<p>也就是使用Markdown插入图片的语法即可，当然，图片得放在相对路径上。</p>\n","categories":[{"name":"搭建博客","slug":"搭建博客","permalink":"chunlife.top/categories/搭建博客/"}],"tags":[{"name":"搭建博客","slug":"搭建博客","permalink":"chunlife.top/tags/搭建博客/"}]},{"title":"go里面的io Writer操作","date":"2018-07-12T10:17:59.000Z","path":"2018/07/12/go里面的io-Writerr操作/","content":"<p>将string转换成 io.Writer，可以进行类似于write的操作，类似于写文件一样。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s := <span class=\"string\">\"Hello\"</span></span><br><span class=\"line\">buf := bytes.NewBufferString(s)</span><br><span class=\"line\">fmt.Fprint(buf, <span class=\"string\">\", World!\"</span>)</span><br><span class=\"line\">fmt.Println(buf.String())</span><br></pre></td></tr></table></figure>\n\n<p>同样的，打开的文件也可以被转换成 io.Writer，继而直接向其写入数据。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f, err := os.OpenFile(fileName, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, os.ModePerm)</span><br><span class=\"line\"><span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">defer</span> f.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">w := bufio.NewWriter(f)</span><br><span class=\"line\">fmt.Fprintln(w, fmt.Sprintf(<span class=\"string\">\"start analysis log at the %s \\r\\n\"</span>, <span class=\"string\">`\"`</span>+logFileDir+<span class=\"string\">`\"`</span>))</span><br></pre></td></tr></table></figure>\n\n<p>以上不管是写文件还是写字符串，在需要大量写时，效率即会体现出来。</p>\n","categories":[{"name":"Go基础操作","slug":"Go基础操作","permalink":"chunlife.top/categories/Go基础操作/"}],"tags":[{"name":"Go","slug":"Go","permalink":"chunlife.top/tags/Go/"},{"name":"write","slug":"write","permalink":"chunlife.top/tags/write/"}]},{"title":"对如今手机的看法——仅兴趣","date":"2017-12-01T13:43:46.000Z","path":"2017/12/01/对如今手机的看法——仅兴趣/","content":"<p>现在手机大概已经细分成了两大阵营，Android和iOS。</p>\n<a id=\"more\"></a>\n\n<p>当然国内的Android大多是安卓，称得上Android的倒是一些国外原生，例如HTC、索尼大法等，当然要说国内使用原生就是好用那就是太尴尬了，总体来说，国内的系统大体上应该都是差不多的水平（系统稳定性方面，当然还有底层功耗的控制和系统UI的设计方面），主要是看各大厂商对系统易用性的把控，这里面功力深厚的一批是：MIUI、Flyme、EMUI（UI不行外其实还可以），手机系统界的新贵则是smartisan os，个人是比较喜欢锤子的，现在手机牌桌上的玩家越来越少了，能有个创新的玩家是用户们的希望啊。</p>\n<p>IOS阵营就不说了，其优点可能并不是一个真正意义上的创新者，但它从来都不缺顶尖的技术，通过顶尖的技术对当下的热门领域进行加工，即可得到远超行业大众水平，甚至直接就变成行业第一，从技术的布道上，apple喜欢进行一些新尝试时，又拿出另一些东西，以此来构成一套完整的解决方案。（比如，取消3.5mm耳机接口，发布AirPods）。</p>\n<p>两大系统的整体趋势来看，Android比之前是越来越好用了，开源导致生态混乱同时，丰富的代码量的优势也在体现；iOS比之前没那么好用了也是一个事实，毕竟系统最新版的稳定性是有目共睹，但这并不说明Android就已经干倒iOS，至少在认知上Android还是有一段距离才能赶上iOS的。老实说，抛开硬件来说，在易用性上，Android和iOS应该是没有太大的差距的。</p>\n<p>为啥要抛开硬件呢，额，这个对Android阵营来说实在是个忧伤的话题，每年科技春晚（苹果发布会）发布的芯片基本是默秒全，根本不管你Android阵营到底来了神马黑科技，反正都没我黑，基本对比硬件提升，苹果也是只和自家产品比。到现在，Android阵营理由跟上来几个拼桌子的玩家了，华为，联发科，Samsung，高通等等，至少现在高通晓龙835性能还是很强的，配合Android在用户体验上至少不会因为实际应用上出现芯片翻车的情况，具体使用的发挥就是看各家软件体验的优化了。在基础硬件堆砌时代基本过去后，现在大家都忙着建立手机优质标签，避免手机同质化的产生，做到我有你无的地步，最低也是至少要让别人一段时间有不了，比如买断某款芯片几个月，或者买一套比较狠的拍照算法，最狠就是自己研发一套迥异的技术，华为的莱卡，锤子的软件创新等，都是用心的地方，打马后炮说，应该就是他们成功的一小部分原因吧（可能）。</p>\n<p>以用户视角来看现在的手机行业，很明显的感觉是手机同质化已经非常严重了，大家的敌人也很明确，冒尖的那个且引领潮流的玩法，大家就一起去玩；行业领导者怎么玩，大家就一起去玩。如果不这么做，结局估计会不怎么好，向大佬低头，你不会变成大佬，但至少你不会死。像现在，手机大牌玩家已经基本准备完毕，也就说供应链的大主顾已经基本确定，小玩家品牌不被主流人群认可，不被顶尖供货商认可，而且还有名牌厂商的贴牌机在低端市场以非常细分的价格收割不同的人群，那还有啥可以玩的。</p>\n<p>手机同质化是一个问题，但是好歹顶尖厂商都有自家的黑科技，但是Android阵营中的特色软件生态不太令人满意，说起来Android用的和之前能有啥区别呢，我们用户在使用时，用户体验并不是完全是硬件决定的，软件的使用也是个问题，各种毒瘤，崩溃，上传隐私数据等，都是让人恼火的问题，这个时候得拿出信仰之锤——锤子科技了，希望它能走下去，它做的软件创新让我们用户可以为之欢呼。各大厂商也在做，希望能做得快一些，赶紧把竞争战场换到这里来，这样，我们用户估计就有福想了哦。</p>\n","categories":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/categories/随笔/"}],"tags":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/tags/随笔/"}]},{"title":"PCI串口编程","date":"2017-11-03T08:17:51.000Z","path":"2017/11/03/PCI串口编程/","content":"<h2 id=\"一、硬件环境\"><a href=\"#一、硬件环境\" class=\"headerlink\" title=\"一、硬件环境\"></a>一、硬件环境</h2><p>硬件开发环境是PCI9054+FPGA，16串口或8串口。</p>\n<a id=\"more\"></a>\n\n<p>软件开发平台则是linux、VxWorks。</p>\n<p>主要是运用在工控领域，在一般商用平台可能用不到这玩意。</p>\n<h2 id=\"二、PCI相关知识\"><a href=\"#二、PCI相关知识\" class=\"headerlink\" title=\"二、PCI相关知识\"></a>二、PCI相关知识</h2><p>PCI相关知识主要是参考了网上一些前辈写的博文，这里将其贴出来，以免后来人继续收集。</p>\n<p>PCI 总线学习笔记-PCI9054  <a href=\"http://blog.csdn.net/lg2lh/article/details/8042008\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/lg2lh/article/details/8042008</a></p>\n<p>PCI设备的地址空间               <a href=\"http://www.cnblogs.com/zszmhd/archive/2012/05/08/2490105.html\" target=\"_blank\" rel=\"noopener\">http://www.cnblogs.com/zszmhd/archive/2012/05/08/2490105.html</a></p>\n<p>另外《linux设备驱动开发详解》（宋宝华）也有附带讲一些PCI驱动的编程，可以去瞄一瞄。</p>\n<p>第一篇博文主要是介绍PCI9054的相关信息，知道这个片子是怎么做的，以及其是如何将FPGA和PC机连接起来，熟悉硬件原理。在实际的编程中，我们可能根本感觉不到这个片子，作为一个“桥片”，操作系统其实都已经将厂商的驱动给集成了，并不会说还需要我们来进行过多的编程。</p>\n<p>第二篇博文具体内容很重要，是PCI设备的特性属性，但作为使用者，其实我们用到的只是PCI的地址空间，其他的暂时不用理会，PCI地址空间即是系统在启动时，PCI设备向CPU大佬申请的一段独有的地址空间以供自己使用，这段地址的相关信息也就存储在PCI配置空间的BAR(Base Address Registers)中。</p>\n<p>在linux中，需要调用相关的API函数就能将BAR的信息取出进行使用了。</p>\n<p>三、编程相关信息</p>\n<p>Linux中，PCI设备的编程其实和普通设备的编程很相似，没有什么特别不同，主要的不同应该是映射PCI设备的地址空间。</p>\n<p>UART设备，在编程中使用uart_register_driver注册tty设备，同时使用platform_driver_register注册平台总线。PCI-UART则是一实际总线，所以在注册时，我们选择注册为实际的总线——pci_register_driver。（参考Linux xr17v35x.c）</p>\n<p><img src=\"20171203174156903\" alt=\"img\"></p>\n<p><img src=\"20171203174158230\" alt=\"image\"></p>\n<p><img src=\"20171203174159008\" alt=\"image\"></p>\n<p>xr_uart_driver为驱动特殊的信息，xrserial_pci_driver为驱动匹配提供操作方法，在probe方法中，对串口相关资源进行初始化（还未对硬件进行相关设置），为该设备关联文件操作方法（uart_ops）。</p>\n<p>先来看看probe中主要做的事情。</p>\n<p><img src=\"20171203174159459\" alt=\"image\"></p>\n<p>在一个pci设备可以被使用之前，必须调用pci_enable_device进行激活，该函数会调用底层代码激活PCI设备上的I/O和内存，使之可用。而pci_disable_device所做的事情刚好相反，告诉系统该PCI设备不再使用，同时，禁用相关的一些资源。</p>\n<p>经过一系列调用进入函数setup_port。</p>\n<p><img src=\"20171203174200245\" alt=\"image\"></p>\n<p>图中的bar是在xrpciserial_boards数组中flags指定，此处是BAR0。（根据实际产品来，比如，我这里是BAR2）</p>\n<p><img src=\"20171203174200919\" alt=\"image\"></p>\n<p>若是我们的硬件没有预先跟软件这边说，那软件这边有能力得到这个信息吗？答案肯定是可以的。可以使用pci_select_bars来确定该PCI设备是否有申请到地址空间。（若没有肯定是有错误了）</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bars = pci_select_bars(pdev, IORESOURCE_MEM);</span><br></pre></td></tr></table></figure>\n\n<p>返回值若是0x5，则是代表BAR0，BAR2满足select条件的，其条件就是函数的第二个参数IORESOURCE_MEM，因为PCI设备申请的地址空间有两种访问方式，一个是MEM，另一个是以IO方式访问，（第二篇博文中有介绍）。</p>\n<p>这个时候我们可以使用这个返回值来映射这些BAR，若PCI设备使用了BAR0，那软件就使用BAR0去操作特定的内存地址（寄存器）就可以了，一个PCI设备一般不会使用很多BAR的，最多一两个就不得了了，要那么多，FPGA那边也受不了。</p>\n<p>当然，有一些是强制性的就指定了该设备是使用哪一个BAR作为内存映射的基址，其他的BAR则是用于自定义用途，那软件这边强制性映射BAR0就好了。</p>\n<p>看图片上，其实还调用了一个ioremap，BAR中的基址是属于物理地址的，软件想直接访问物理地址是做不到，那么，就需要使用ioremap将物理地址转化为虚拟地址，以供软件来使用。映射完后，使用priv-&gt;remapped_bar[bar]就可以来操作设备上的寄存器了。</p>\n<p>分析完setup后（其实上面主要的工作是内存映射，其他的代码比较繁琐，在实际编程中可以适当简洁）。</p>\n<p>进入serialxr_register_port。</p>\n<p>填充 uart_port 结构体。</p>\n<p><img src=\"20171203174201698\" alt=\"image\"></p>\n<p>填充ops操作方法，也就是在应用层在使用open、write等，底层驱动最终会被调用的方法。使用uart_add_one_port将驱动与串口链接到一起，这样，在应用层操作/dev/tty*时，相应的ops就会被调用了。</p>\n<p><img src=\"20171203174202320\" alt=\"image\"></p>\n<p>到这里，probe函数大体就完成了，再之后的工作就是对ops的接口进行实现了，这里其实就可以参考一般串口设备到底在干嘛了，例如参考S3C2440的串口驱动。</p>\n<p>参考至<a href=\"http://blog.csdn.net/lizuobin2/article/details/51773305\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/lizuobin2/article/details/51773305</a>。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uart_ops</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">unsigned</span> <span class=\"title\">int</span>\t<span class=\"params\">(*tx_empty)</span><span class=\"params\">(struct uart_port *)</span></span>;\t <span class=\"comment\">/* 串口的Tx FIFO缓存是否为空 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*set_mctrl)(struct uart_port *, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> mctrl);\t<span class=\"comment\">/* 设置串口modem控制 */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">unsigned</span> <span class=\"title\">int</span>\t<span class=\"params\">(*get_mctrl)</span><span class=\"params\">(struct uart_port *)</span></span>;\t<span class=\"comment\">/* 获取串口modem控制 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*stop_tx)(struct uart_port *);\t\t<span class=\"comment\">/* 禁止串口发送数据 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*start_tx)(struct uart_port *);\t<span class=\"comment\">/* 使能串口发送数据 */</span>\t</span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*send_xchar)(struct uart_port *, <span class=\"keyword\">char</span> ch);\t<span class=\"comment\">/* 发送xChar */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*stop_rx)(struct uart_port *);\t\t<span class=\"comment\">/* 禁止串口接收数据 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*enable_ms)(struct uart_port *);\t<span class=\"comment\">/* 使能modem的状态信号 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*break_ctl)(struct uart_port *, <span class=\"keyword\">int</span> ctl);\t<span class=\"comment\">/* 设置break信号 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">int</span>\t\t\t(*startup)(struct uart_port *);\t\t<span class=\"comment\">/* 启动串口,应用程序打开串口设备文件时,该函数会被调用 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*shutdown)(struct uart_port *);<span class=\"comment\">/* 关闭串口,应用程序关闭串口设备文件时,该函数会被调用 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*flush_buffer)(struct uart_port *);</span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*set_termios)(struct uart_port *, struct ktermios *<span class=\"keyword\">new</span>,</span><br><span class=\"line\">\t\t\t\t       struct ktermios *old);\t<span class=\"comment\">/* 设置串口参数 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*set_ldisc)(struct uart_port *);<span class=\"comment\">/* 设置线路规程 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*pm)(struct uart_port *, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> state,</span><br><span class=\"line\">\t\t\t      <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> oldstate);\t<span class=\"comment\">/* 串口电源管理 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">int</span>\t\t(*set_wake)(struct uart_port *, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> state);</span><br><span class=\"line\"> </span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a string describing the type of the port</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *(*type)(struct uart_port *);</span><br><span class=\"line\"> </span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Release IO and memory resources used by the port.</span></span><br><span class=\"line\"><span class=\"comment\">\t * This includes iounmap if necessary.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*release_port)(struct uart_port *);</span><br><span class=\"line\"> </span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Request IO and memory resources used by the port.</span></span><br><span class=\"line\"><span class=\"comment\">\t * This includes iomapping the port if necessary.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"keyword\">int</span>\t\t(*request_port)(struct uart_port *);\t<span class=\"comment\">/* 申请必要的IO端口/IO内存资源,必要时还可以重新映射串口端口 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t\t(*config_port)(struct uart_port *, <span class=\"keyword\">int</span>); <span class=\"comment\">/* 执行串口所需的自动配置 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">int</span>\t\t(*verify_port)(struct uart_port *, struct serial_struct *); <span class=\"comment\">/* 核实新串口的信息 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">int</span>\t\t(*ioctl)(struct uart_port *, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span>);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span>\t(*poll_put_char)(struct uart_port *, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">int</span>\t\t(*poll_get_char)(struct uart_port *);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>特别说明下，其中set_termios，与串口数据，流控开关，以及波特率设置相关。应用层若需要操控这些格式或者是打开流控等，需要使用tcgetattr函数得到对应串口的termios结构体。通过tcsetattr函数将设置后termios结构体传递给对应的串口。</p>\n<p>startup则与open函数相关，在串口进行open操作时，上层会调用uart_open（serial_core.c），然后调用打开的设备的文件操作函数方法的startup。shutdown则与之相对。</p>\n<p>ioctl则是支持一些该串口特殊的操作（若没有，则不设置就可以了）。</p>\n<p><img src=\"20171203174202999\" alt=\"image\"></p>\n<p>config_port是在驱动调用uart_add_one_port，链接驱动和串口端口时就被调用的一个函数，这个函数调用的真是早啊，主要的作用也是做一些在串口还没打开时需要处理的一些事，例如，设置串口的模式（232\\485\\422）。</p>\n<p>大概就是这些了，其实VxWorks的驱动与之类似，可以参考vxbTemplateSio.c或者是templateSio.c，应该不会遇到啥比较可怕的大坑 。</p>\n<p>另外需要注意的是VxWorks映射PCI BAR空间的问题，这些个代码网上有很多，可以去直接搜索下，不必去从源码上扣，别人已经整理出来了，我们就不必要花这个功夫了呗！</p>\n","categories":[{"name":"嵌入式","slug":"嵌入式","permalink":"chunlife.top/categories/嵌入式/"}],"tags":[{"name":"串口","slug":"串口","permalink":"chunlife.top/tags/串口/"},{"name":"PCI","slug":"PCI","permalink":"chunlife.top/tags/PCI/"}]},{"title":"Linux搭建小型服务器——文件共享以及邮件服务器","date":"2017-10-29T08:17:51.000Z","path":"2017/10/29/Linux搭建小型服务器——文件共享以及邮件服务器/","content":"<p>因为公司搬家，之前后又采用了新的服务器，所以之前的服务器的东西需要移动到新的服务器上，而且趁着这次机会，搭建了一个局域网使用的邮件服务器使用，虽然不知道别人怎么搭建的，但是把自己的经验记录下来，因为这个邮件服务器确实花了我不少时间去琢磨，因为它这玩意可能还会干扰我的文件共享功能。</p>\n<a id=\"more\"></a>\n\n<p>邮件服务器是IRedMail，文件共享服务是Samba，环境是centos。</p>\n<h3 id=\"IRedMail安装：\"><a href=\"#IRedMail安装：\" class=\"headerlink\" title=\"IRedMail安装：\"></a>IRedMail安装：</h3><p>网上搜索很容易搜索到使用Postfix+Dovecot搭建邮件服务器，不过我没有搭建成功，很遗憾，所以我找到了使用IRedMail去搭建这个服务器，比之前的操作简单多了。</p>\n<p>搭建的步骤主要是参考了这个：<a href=\"https://www.tecmint.com/install-iredmail-on-centos-7-for-samba4-ad-integration/\" target=\"_blank\" rel=\"noopener\">How to Install iRedMail on CentOS 7 for Samba4 AD Integration – Part 10</a></p>\n<p>首先你得有一个centos的系统，这里选择的是centos 7最小化安装，非常快速简洁的便会安装完成。</p>\n<ol>\n<li><p>进入系统，准备设置系统主机名。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># hostnamectl set-hostname mail.demo.com</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>主机名在hosts中设置一下，设置这个东西主要是IRedMail在安装时会需要使用到，所以自定义一下。vim /etc/hosts。</p>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1 mail.demo.com mail localhost localhost.localdomain</span><br></pre></td></tr></table></figure>\n\n<p>先后格式错误的话，IRedMail在安装时也会提醒安装错误的。</p>\n<ol start=\"3\">\n<li>在我参考的那个英文文章里说，需要关闭<a href=\"https://www.baidu.com/s?wd=selinux&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd\" target=\"_blank\" rel=\"noopener\">selinux</a>，我试了下，不关闭也是照样好使的，不过别人的说的是推荐，不是强制。vim /etc/selinux/config。</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELINUX=disabled</span><br><span class=\"line\"># setenforce 0</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>接下来需要安装些必要的Linux工具了，使用yum命令。</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># yum install bzip2 net-tools bash-completion wget</span><br></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li>获取IRedMail的安装包，并解压。</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># wget https://bitbucket.org/zhb/iredmail/downloads/iRedMail-0.9.6.tar.bz2</span><br><span class=\"line\"></span><br><span class=\"line\"># tar xjf iRedMail-0.9.6.tar.bz2</span><br></pre></td></tr></table></figure>\n\n<ol start=\"6\">\n<li>接下来就可以运行IRedMail里面的脚本了，并不需要认为设置，很是方便。</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># IREDMAIL_MIRROR=&apos;http://106.187.51.47&apos; bash iRedMail.sh</span><br></pre></td></tr></table></figure>\n\n<p>如果你直接运行bash iRedMail.sh，是没啥结果的，查了下，好像是因为其下载地址被强了吧，所以需要加入前面的环境设置。</p>\n<ol start=\"7\">\n<li>安装过程基本上选择默认，除了在选择web server上选择Apache，后端选择OpenLDAP外（我之前选择了MariaDB，Samba就死活通不了了，OpenLDAP我实验成功），其他基本上是默认的。</li>\n</ol>\n<p><img src=\"13163018_Uf7x.png\" alt=\"image\"></p>\n<p><img src=\"13163018_RZvU.jpg\" alt=\"clip_image004\"></p>\n<ol start=\"8\">\n<li><p>在需要输入些什么时候稍微看下软件给的提示英文，设置起来应该是没什么问题的。</p>\n</li>\n<li><p>设置完后，就是开始安装了，保证系统可以上网即可，安装完成后，软件将提示重启所有服务，</p>\n</li>\n<li><p>在软件目录的下的iRedMail.tips，其保存了很多服务器设置的内容，包括邮件服务器里面的管理员密码，所以，需要保管好。iRedMail-0.9.6/iRedMail.tips</p>\n</li>\n<li><p>在同一局域网的浏览器上，输入<a href=\"https://192.168.0.254，此处的IP是服务器IP，这样即可连接到邮件服务器了，注意：浏览器可能静止访问，或者兼容模式访问起来有些问题，这个时候需要测试者多整整浏览器的问题，以免误认为安装失败。\" target=\"_blank\" rel=\"noopener\">https://192.168.0.254，此处的IP是服务器IP，这样即可连接到邮件服务器了，注意：浏览器可能静止访问，或者兼容模式访问起来有些问题，这个时候需要测试者多整整浏览器的问题，以免误认为安装失败。</a></p>\n<p><a href=\"httpS://192.168.0.254/mail/\" target=\"_blank\" rel=\"noopener\">httpS://192.168.0.254/mail/</a> 邮箱登录</p>\n<p><a href=\"httpS://192.168.0.254/iredadmin/\" target=\"_blank\" rel=\"noopener\">httpS://192.168.0.254/iredadmin/</a> 管理邮箱账户，添加邮箱</p>\n</li>\n</ol>\n<h3 id=\"Samba安装\"><a href=\"#Samba安装\" class=\"headerlink\" title=\"Samba安装\"></a>Samba安装</h3><p>这个Samba我主要是参考了：<a href=\"http://www.cnblogs.com/linuxprobe/p/5658735.html\" target=\"_blank\" rel=\"noopener\">http://www.cnblogs.com/linuxprobe/p/5658735.html</a></p>\n<h4 id=\"步骤1：在Fedora和CentOS上安装Samba\"><a href=\"#步骤1：在Fedora和CentOS上安装Samba\" class=\"headerlink\" title=\"步骤1：在Fedora和CentOS上安装Samba\"></a><strong>步骤1：在Fedora和CentOS上安装Samba</strong></h4><p>首先，安装Samba以及进行一些基本的配置。</p>\n<p>检验Samba是否已经安装在您的系统中：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ rpm -q samba samba-common samba-client</span><br></pre></td></tr></table></figure>\n\n<p>如果上面的命令没有任何输出，这意味着Samba并未安装。这时，应使用下面的命令来安装Samba。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install samba samba-common samba-client</span><br></pre></td></tr></table></figure>\n\n<p>接下来，创建一个用于在网络中共享的本地文件夹。这个文件夹应该以Samba共享的方式导出到远程的用户。在这个指南中，我们会在顶层文件夹’/‘中创建这个文件夹，因此，请确保您有相应的权限。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo mkdir /shared</span><br></pre></td></tr></table></figure>\n\n<p>如果您想在您的home文件夹内创建共享文件夹（例如，~/shared），您必须激活SELinux中Samba的home文件夹共享选项，具体将在后面提到。</p>\n<p>在创建/shared文件夹后，设置文件夹权限以保证其余用户可以访问它。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo chmod o+rw /shared</span><br></pre></td></tr></table></figure>\n\n<p>如果您不想其他用户对该文件夹拥有写权限，您需要移除命令中的’w’选项。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo chmod o+r /shared</span><br></pre></td></tr></table></figure>\n\n<p>接下来，创建一个空文件来测试。这个文件可以被用来验证Samba的共享已经被挂载。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo touch /shared/file1</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"步骤2：为Samba配置防火墙\"><a href=\"#步骤2：为Samba配置防火墙\" class=\"headerlink\" title=\"步骤2：为Samba配置防火墙\"></a><strong>步骤2：为Samba配置防火墙</strong></h4><p>下面的命令用来打开防火墙中Samba共享所需的TCP/UDP端口。</p>\n<p>如果您在使用firewalld（例如，在Fedora和CentOS7下），接下来的命令将会永久的修改Samba相关的防火墙规则。</p>\n<h4 id=\"步骤3：更改Samba配置\"><a href=\"#步骤3：更改Samba配置\" class=\"headerlink\" title=\"步骤3：更改Samba配置\"></a><strong>步骤3：更改Samba配置</strong></h4><p>后面的步骤用来配置Samba以将本地文件夹导出为Samba共享文件夹。</p>\n<p>使用文件编辑器打开Samba配置文件，并将下面的行添加到文件的末尾。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo nano /etc/samba/smb.conf</span><br><span class=\"line\">[myshare]</span><br><span class=\"line\"></span><br><span class=\"line\">comment=my shared files</span><br><span class=\"line\"></span><br><span class=\"line\">path=/shared</span><br><span class=\"line\"></span><br><span class=\"line\">public=yes</span><br><span class=\"line\"></span><br><span class=\"line\">writeable=yes</span><br></pre></td></tr></table></figure>\n\n<p>上面在括号内的文本（例如，”myshare”）是Samba共享的资源的名字，它被用来从远程主机存取Samba共享。</p>\n<p>创建Samba用户账户，这是挂载和导出Samba文件系统所必须的。我们可以使用smbpasswd工具来创建一个Samba用户。注意，Samba用户帐户必须是已有的Linux用户。如果您尝试使用smbpasswd添加一个不存在的用户，它会返回一个错误的消息。</p>\n<p>如果您不想使用任何已存在的Linux用户作为Samba用户，您可以在您的系统中创建一个新的用户。为安全起见，设置新用户的登录脚本为/sbin/nologin，并且不创建该用户的home文件夹。</p>\n<p>在这个例子中，我们创建了一个名叫”sambaguest”的用户，如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo useradd -M -s /sbin/nologin sambaguest</span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo passwd sambaguest</span><br></pre></td></tr></table></figure>\n\n<p>在创建一个新用户后，使用smbpasswd命令添加Samba用户。当这个命令询问一个密码时，您可以键入一个与其用户密码不同的密码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo smbpasswd -a sambaguest</span><br></pre></td></tr></table></figure>\n\n<p>激活Samba服务，并检测Samba服务是否在运行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo systemctl enable smb.service</span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo systemctl start smb.service</span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo systemctl is-active smb</span><br></pre></td></tr></table></figure>\n\n<p>使用下面的命令来查看Samba中共享的文件夹列表。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ smbclient -U sambaguest -L localhost</span><br></pre></td></tr></table></figure>\n\n<p>Linux之间Samba远程挂载的命令：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount //192.168.1.58/demo /mnt/ -o username=samba</span><br></pre></td></tr></table></figure>\n\n<p>附在末尾：</p>\n<p>Linux关于权限：例如777，rwx(Owner)  r-x(Group)    r-x(Other)。</p>\n<p><img src=\"13163019_vmLd.jpg\" alt=\"clip_image002[5]\"></p>\n<p>cat /etc/passwd 可以查看所有用户的列表</p>\n<p>w 可以查看当前活跃的用户列表</p>\n<p>cat /etc/group 查看用户组</p>\n<h5 id=\"1-建工作组\"><a href=\"#1-建工作组\" class=\"headerlink\" title=\"1. 建工作组\"></a>1. 建工作组</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd test //新建test工作组</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"2-新建用户同时增加工作组\"><a href=\"#2-新建用户同时增加工作组\" class=\"headerlink\" title=\"2. 新建用户同时增加工作组\"></a>2. 新建用户同时增加工作组</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd -g test one //新建one用户并增加到test工作组</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"3-给已有的用户增加工作组\"><a href=\"#3-给已有的用户增加工作组\" class=\"headerlink\" title=\"3. 给已有的用户增加工作组\"></a>3. 给已有的用户增加工作组</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usermod -G groupname username</span><br><span class=\"line\"></span><br><span class=\"line\">或者：gpasswd -a user group</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"4-将一个已有用户添加到一个已有的工作组中，可以使用带-a参数的指令。\"><a href=\"#4-将一个已有用户添加到一个已有的工作组中，可以使用带-a参数的指令。\" class=\"headerlink\" title=\"4. 将一个已有用户添加到一个已有的工作组中，可以使用带-a参数的指令。\"></a>4. 将一个已有用户添加到一个已有的工作组中，可以使用带-a参数的指令。</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usermod -a -G groupname username</span><br><span class=\"line\"></span><br><span class=\"line\">若需要顺便改变主要用户组，则可以使用：</span><br><span class=\"line\"></span><br><span class=\"line\">usermod -g groupname username</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"5-修改文件或目录所属的用户。\"><a href=\"#5-修改文件或目录所属的用户。\" class=\"headerlink\" title=\"5. 修改文件或目录所属的用户。\"></a>5. 修改文件或目录所属的用户。</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chown one /home/one （把home目录下的one目录的有者改为one用户）</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"6-修改文件或目录所属的组。\"><a href=\"#6-修改文件或目录所属的组。\" class=\"headerlink\" title=\"6. 修改文件或目录所属的组。\"></a>6. 修改文件或目录所属的组。</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chgrp one /home/one （把home目录下的one目录的有者改为one组）</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/tags/Linux/"},{"name":"文件共享_邮件","slug":"文件共享-邮件","permalink":"chunlife.top/tags/文件共享-邮件/"}]},{"title":"vxworks中断处理程序不能使用printf的本质","date":"2017-10-27T12:56:26.000Z","path":"2017/10/27/vxworks中断处理程序不能使用printf的本质/","content":"<p>因为之前面试有被人提到，中断处理程序中为什么不能使用printf，在回答的时候一想，Linux驱动里面不是就可以使用打印吗，有啥不能用的（那是printk，当时搞混了）。在vxworks上用的都是logMsg进行打印，至于为啥没使用printf也没去深究，现在正好把它记一下。</p>\n<a id=\"more\"></a>\n\n<p>我的理解是：printf是对IO进行操作，有“信号量”进行加持，也就是所谓的“锁机制”，如果有在uboot上移植过printf的经历，就知道，printf是使用了全局变量的，这也是它申请锁保护的原因吧，但关键就是“锁”这个玩意有点儿危险的是，它是一个需要等待的操作，也就是说·在申请它和使用它的时候，有可能会被“锁”给阻塞，但是vxworks是一个实时操作系统，当发生阻塞时，它的调度就会出现问题，可能就会导致死机的现象。</p>\n<p>下面是我转载的一篇文章，帮助大家进行理解。</p>\n<p><em>本文章转载自：<a href=\"http://blog.csdn.net/mao0514/article/details/32700835\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/mao0514/article/details/32700835</a></em><a href=\"http://http//blog.csdn.net/mao0514/article/details/32700835\" target=\"_blank\" rel=\"noopener\">点击打开链接</a></p>\n<p>vxworks 中断处理程序之所以不用printf，本质在于printf是将信息输出到标准输出设备(STDOUT)中, 整个标准输出设备是一个全局变量，由于有semTake操作，那么就会发生阻塞，vxworks属于硬实时操作系统，不能在规定的时间内完成操作即会死机或复位。所以vxworks不用printf的原因在于阻塞。 网上说printf 因为引用全局变量stdout，所以是不可重入的。这个稍微解释一下。如果用到了全局变量，但是用信号量保护，是线程安全的，但是不可重入的（会导致死锁，譬如一个任务或中断处理程序调用了printf，被另一个高优先级中断打断，那么就会形成死锁而导致系统复位）。 所以这里的阻塞和不可重入都是因为对共享变量的保护而采用互斥锁引起的，而这里的阻塞是不可重入的一个真子集。（例如：可能有些函数对静态或全局变量没有锁保护，因此是非线程安全，也是非可重入的，此时并没有阻塞在静态或全局变量上，所以不可重入的概念要大。）。因此printf不能用在中断处理程序中的根本原因在于使用了全局变量后采用了锁机制，而锁机制会导致阻塞，阻塞是不可重入的真子集。 所以网上说printf因为不可重入，也会说得过去的（但不可重入还有其他非阻塞的场景）。更准确的说法是因为阻塞在全局变量STDOUT上）。关于可重入和线程安全的区别，下文会有详细解释：</p>\n<p>线程安全函数<br>• 概念：<br>线程安全的概念比较直观。一般说来，一个函数被称为线程安全的，当且仅当被多个并发线程反复调用时，它会一直产生正确的结果。<br>• 确保线程安全：<br>要确保函数线程安全，主要需要考虑的是线程之间的共享变量。属于同一进程的不同线程会共享进程内存空间中的全局区和堆，而私有的线程空间则主要包括栈和寄 存器。因此，对于同一进程的不同线程来说，每个线程的局部变量都是私有的，而全局变量、局部静态变量、分配于堆的变量都是共享的。在对这些共享变量进行访 问时，如果要保证线程安全，则必须通过加锁的方式。<br>• 线程不安全的后果：<br>线程不安全可能导致的后果是显而易见的——共享变量的值由于不同线程的访问，可能发生不可预料的变化，进而导致程序的错误，甚至崩溃。</p>\n<p>可重入函数<br>• 概念：<br>可重入的概念基本没有比较正式的完整解释，多数的文档都只是说明什么样的情况才能保证函数可重入，但没有完整定义。按照Wiki上的说法，“A computer program or routine is described as reentrant if it can be safely executed concurrently; that is, the routine can be re-entered while it is already running.”根据笔者的经验，所谓“重入”，常见的情况是，程序执行到某个函数foo()时，收到信号，于是暂停目前正在执行的函数，转到信号处理 函数，而这个信号处理函数的执行过程中，又恰恰也会进入到刚刚执行的函数foo()，这样便发生了所谓的重入。此时如果foo()能够正确的运行，而且处理完成后，之前暂停的foo()也能够正确运行，则说明它是可重入的。<br>• 确保可重入：<br>要确保函数可重入，需满足以下几个条件：<br>1、不在函数内部使用静态或全局数据<br>2、不返回静态或全局数据，所有数据都由函数的调用者提供。<br>3、使用本地数据，或者通过制作全局数据的本地拷贝来保护全局数据。<br>4、不调用不可重入函数。<br>• 不可重入的后果：<br>不可重入的后果主要体现在象信号处理函数这样需要重入的情况中。如果信号处理函数中使用了不可重入的函数，则可能导致程序的错误甚至崩溃。</p>\n<p> 可重入与线程安全<br>可重入与线程安全并不等同。一般说来，可重入的函数一定是线程安全的，但反过来不一定成立。<br>- 如果一个函数中用到了全局或静态变量，那么它不是线程安全的，也不是可重入的；<br>- 如果我们对它加以改进，在访问全局或静态变量时使用互斥量或信号量等方式加锁，则可以使它变成线程安全的，但此时它仍然是不可重入的，因为通常加锁方式是针对不同线程的访问，而对同一线程可能出现问题；这里举例说明：假设函数func() 在执行过程中需要访问某个共享资源，因此为了实现线程安全，在使用该资源前加锁，在不需要资源解锁。<br>    假设该函数在某次执行过程中，在已经获得资源锁之后，有异步信号发生，程序的执行流转交给对应的信号处理函数；再假设在该信号处理函数中也需要调用函数 func() ，那么func() 在这次执行中仍会在访问共享资源前试图获得资源锁，然而我们知道前一个func() 实例已然获得该锁，因此信号处理函数阻塞。另一方面，信号处理函数结束前被信号中断的线程是无法恢复执行的，当然也没有释放资源的机会，这样就出现了线程和信号处理函数之间的死锁局面。</p>\n<p>  因此，func() 尽管通过加锁的方式能保证线程安全，但是由于函数体对共享资源的访问，因此是非可重入。如果将函数中的全局或静态变量去掉，改成函数参数等其他形式，则有可能使函数变成既线程安全，又可重入。比如：strtok函数是既不可重入的，也不是线程安全的；加锁的strtok不是可重入的，但线程安全；而strtok_r既是可重入的，也是线程安全的。</p>\n","categories":[{"name":"VxWorks","slug":"VxWorks","permalink":"chunlife.top/categories/VxWorks/"}],"tags":[{"name":"VxWorks","slug":"VxWorks","permalink":"chunlife.top/tags/VxWorks/"}]},{"title":"学PPT时的作品","date":"2017-10-18T08:17:51.000Z","path":"2017/10/18/学PPT时的作品/","content":"<p><img src=\"20171018161922485.jpg\" alt=\"作品\"></p>\n<a id=\"more\"></a>\n\n<p>当年在学校时，就靠这个为（zhuang）生（bi），以为自己会成为一个设计师，迷恋PPT这种简单的软件制作出大师的设计，当然PS这玩意你还是得用，都是工具嘛。</p>\n<p>这些图片单纯的使用PPT是很难达到的，这其中使用到了PPT的插件——OK插件，当然现在PPT的插件还是有一些的，使用插件可以省却很多麻烦，这是在你本身很熟悉的前提下，有兴趣的同学可以去微博找找“只为设计”姥爷的微博，OK插件就是这位大神开发的，PPT当然也是玩得飞起，我反正是很尊敬这位大拿的。</p>\n<p>说多了啊，简单的就把作品放这里就可以了，我还是那个程序员。</p>\n","categories":[{"name":"随笔","slug":"随笔","permalink":"chunlife.top/categories/随笔/"}],"tags":[{"name":"PPT","slug":"PPT","permalink":"chunlife.top/tags/PPT/"}]},{"title":"我的简历","date":"2017-04-13T09:33:44.000Z","path":"2017/04/13/我的简历/","content":"<h2 id=\"联系方式\"><a href=\"#联系方式\" class=\"headerlink\" title=\"联系方式\"></a>联系方式</h2><a id=\"more\"></a>\n\n<ul>\n<li>手机：18271495691</li>\n<li>Email：<a href=\"mailto:chunlife@qq.com\" target=\"_blank\" rel=\"noopener\">chunlife@qq.com</a></li>\n<li>微信号：yu-young222</li>\n</ul>\n<h2 id=\"个人信息\"><a href=\"#个人信息\" class=\"headerlink\" title=\"个人信息\"></a>个人信息</h2><ul>\n<li>藏弘/男/1995 </li>\n<li>本科/汉口学院/电气工程及其自动化</li>\n<li>英语等级：CET-6</li>\n<li>工作年限：3年</li>\n<li>技术博客：<a href=\"https://chunlife.top\">https://chunlife.top</a></li>\n<li>期望职位：后端软件研发工程师</li>\n<li>期望城市：深圳</li>\n</ul>\n<h2 id=\"技能清单\"><a href=\"#技能清单\" class=\"headerlink\" title=\"技能清单\"></a>技能清单</h2><ol>\n<li>熟悉C编程、golang后端web Server开发、Qt多平台开发；</li>\n<li>熟悉Linux开发调试，以及Linux、VxWorks系统底层驱动开发；</li>\n<li>熟悉Linux网络编程；</li>\n<li>熟悉HTML、CSS，了解JavaScript；</li>\n<li>熟悉mysql，redis以及MongoDB数据库，了解ElasticSearch使用；</li>\n</ol>\n<h2 id=\"工作经历\"><a href=\"#工作经历\" class=\"headerlink\" title=\"工作经历\"></a>工作经历</h2><h3 id=\"深圳市江波龙电子股份有限公司-（-2018年5月-至今）\"><a href=\"#深圳市江波龙电子股份有限公司-（-2018年5月-至今）\" class=\"headerlink\" title=\"深圳市江波龙电子股份有限公司  （ 2018年5月 ~ 至今）\"></a>深圳市江波龙电子股份有限公司  （ 2018年5月 ~ 至今）</h3><h4 id=\"量产平台系统-（-2018年5月-2019年4月-）\"><a href=\"#量产平台系统-（-2018年5月-2019年4月-）\" class=\"headerlink\" title=\"量产平台系统  （ 2018年5月 ~ 2019年4月 ）\"></a><strong>量产平台系统</strong>  （ 2018年5月 ~ 2019年4月 ）</h4><h5 id=\"项目描述\"><a href=\"#项目描述\" class=\"headerlink\" title=\"项目描述\"></a><strong>项目描述</strong></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">该系统主要满足为江波龙和Lexar需求对其所管理的代工厂进行生产流程控制，主要实现有用户授权，产品控制，定制订单管理，授权生产，消息通知，生产日志管理，测试机台状态监测以及软件升级等需求。采用go web框架gin、MySQL、MongoDB、以及ElasticSearch。订单管理主要为各个不同的role，选定不同的生产软件，集成不同的配置文件和脚本，提供上传软件与下载，查询，多级软件绑定，以及生产订单的操作；授权模块则主要负责证书的管理，提供证书查询，生产验证；消息通知用于主动推送，可使用email和websocket；另有升级模块，主要为收集测试机台信息，提供在线对测试机台进行升级操作，以及运行命令的能力。</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"个人职责\"><a href=\"#个人职责\" class=\"headerlink\" title=\"个人职责:\"></a><strong>个人职责:</strong></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、参与业务需求分析，开展调研，编写需求文档并进行模块开发；</span><br><span class=\"line\">主要负责文件管理，证书授权管理，生产样品管理，消息通知模块，以及升级模块。</span><br><span class=\"line\">2、使用git管理项目代码，由专员进行审核控制；</span><br><span class=\"line\">3、提供相应的单元测试代码，以及文档，验证基础功能；</span><br><span class=\"line\">4、跟进测试以及线上问题。</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"武汉禾达芯微科技发展有限公司-（-2016年5月-2018年4月-）\"><a href=\"#武汉禾达芯微科技发展有限公司-（-2016年5月-2018年4月-）\" class=\"headerlink\" title=\"武汉禾达芯微科技发展有限公司 （ 2016年5月 ~ 2018年4月 ）\"></a>武汉禾达芯微科技发展有限公司 （ 2016年5月 ~ 2018年4月 ）</h3><h4 id=\"库房管理系统-（-2017年10月-2018年4月-）\"><a href=\"#库房管理系统-（-2017年10月-2018年4月-）\" class=\"headerlink\" title=\"库房管理系统 （ 2017年10月 ~ 2018年4月 ）\"></a><strong>库房管理系统</strong> （ 2017年10月 ~ 2018年4月 ）</h4><h5 id=\"项目描述-1\"><a href=\"#项目描述-1\" class=\"headerlink\" title=\"项目描述\"></a><strong>项目描述</strong></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用qt，golang开发，库房管理系统主要为Java，由其他公司承包开发。</span><br><span class=\"line\">在原有基础上改进原来的库房管理系统，接入嵌入式设备以及机台设备状态信息到已有的库房管理系统。</span><br><span class=\"line\">参与设备信息控制模块开发，以及处理信息数据后，将数据对接至整个库房管理系统。</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"个人职责-1\"><a href=\"#个人职责-1\" class=\"headerlink\" title=\"个人职责:\"></a><strong>个人职责:</strong></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、使用qt开发测试机台以及设备软件，收集错误信息，暂存于sqlite；</span><br><span class=\"line\">2、开发信息处理模块，将设备的状态的信息，监控板信息聚合整理成json信息，客户端与处理模块使用udp连接，然后传递给库房管理系统进行展示；</span><br><span class=\"line\">3、根据后端库房系统的API，编写qt客户端，用户定制功能，以及方便聚合显示信息。独立于库房系统的信息，使用mysql进行存储。</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"通用6U加固计算机平台解决方案-（-2016年6月-2017年9月-）\"><a href=\"#通用6U加固计算机平台解决方案-（-2016年6月-2017年9月-）\" class=\"headerlink\" title=\"通用6U加固计算机平台解决方案  （ 2016年6月 ~ 2017年9月 ）\"></a>通用6U加固计算机平台解决方案  （ 2016年6月 ~ 2017年9月 ）</h4><h5 id=\"项目描述-2\"><a href=\"#项目描述-2\" class=\"headerlink\" title=\"项目描述\"></a><strong>项目描述</strong></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">硬件平台：x86            软件环境：windows、VxWorks、Linux</span><br><span class=\"line\">项目主要是设计一款符合装备采购计划标准的6U标准加固计算机，其中设计包括CPCI背板，CPCI网卡、接口卡，IO卡、串口卡、CAN卡、AD/DA卡以及UPS电源，形成一整套CPCI的板卡解决方案。</span><br><span class=\"line\">在使用上，可为客户提供可靠的外设使用（自定义空白热键，表页显示屏等），还有定制的自检测试程序，另外整套系统还设计了一套监控系统，使用CPCI监控卡，可通过网络远端监控本套系统的温度和电压等参数。</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"个人职责-2\"><a href=\"#个人职责-2\" class=\"headerlink\" title=\"个人职责:\"></a><strong>个人职责:</strong></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">① 参与CPCI板卡的方案设计与评估，完成CPCI 16路串口卡、16路CAN卡、IO卡的驱动设计；串口卡符合RS232标准，实现串口硬／软流控，具备422，485切换模式。CAN卡符合CAN 2.0标准。</span><br><span class=\"line\">② 完成加固平台自检软件的设计开发，使用QT为加固计算机提供一种通用的检查，实现硬盘，内存等必要外设测试的同时，加入公司自有外设的检查，适配三个系统平台，其中涉及多线程编程，以及socket网络编程等。</span><br><span class=\"line\">③ 完成加固计算机监控板卡功能开发，MCU使用MK60，可监控其余板卡的温度、电压，以及板卡工作状态，主从之间使用IIC进行通信开发，外部通信使用UART、USB和LWIP协议栈进行通信开发。</span><br><span class=\"line\">④ USB用户键盘固件开发，MCU选用MKL27，开发USB Generic HID设备，为其适配VxWorks USB1.0、USB2.0版设备驱动。</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"其他项目\"><a href=\"#其他项目\" class=\"headerlink\" title=\"其他项目\"></a>其他项目</h3><h5 id=\"表页显示屏-可编程触摸键盘\"><a href=\"#表页显示屏-可编程触摸键盘\" class=\"headerlink\" title=\"表页显示屏/可编程触摸键盘\"></a>表页显示屏/可编程触摸键盘</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用i.mx287搭配天马TM104组合，通过USB通信与上位机进行通信（跨平台），完成上位机的指令动作。</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"SC-L138工控板测试demo，定制用户使用界面\"><a href=\"#SC-L138工控板测试demo，定制用户使用界面\" class=\"headerlink\" title=\"SC-L138工控板测试demo，定制用户使用界面\"></a>SC-L138工控板测试demo，定制用户使用界面</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">根据客户需求，编写需要的上位机界面；</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"NUC972工控板uboot支持\"><a href=\"#NUC972工控板uboot支持\" class=\"headerlink\" title=\"NUC972工控板uboot支持\"></a>NUC972工控板uboot支持</h4><h3 id=\"校内经历\"><a href=\"#校内经历\" class=\"headerlink\" title=\"校内经历\"></a>校内经历</h3><h5 id=\"湖北省协程与控制实验室实验助理-（-2014年4月-2015年6月-）\"><a href=\"#湖北省协程与控制实验室实验助理-（-2014年4月-2015年6月-）\" class=\"headerlink\" title=\"湖北省协程与控制实验室实验助理  （ 2014年4月 ~ 2015年6月 ）\"></a><strong>湖北省协程与控制实验室实验助理</strong>  （ 2014年4月 ~ 2015年6月 ）</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">学习MATLAB，对风光互补发电有关论文进行演算，修正实验平台相关参数；</span><br><span class=\"line\">外出授课，授课内容包括单片机、演讲以及PPT设计等；</span><br><span class=\"line\">曾单独撰书（https://chunlife.top/categories/%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%86%8C/，关于PPT设计，整书三十二万字）。</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"致谢\"><a href=\"#致谢\" class=\"headerlink\" title=\"致谢\"></a>致谢</h2><p>感谢您花时间阅读我的简历，期待能有机会和您共事。</p>\n","categories":[{"name":"简历","slug":"简历","permalink":"chunlife.top/categories/简历/"}],"tags":[{"name":"简历","slug":"简历","permalink":"chunlife.top/tags/简历/"}]},{"title":"QT 中的Event事件函数","date":"2017-01-16T09:50:22.000Z","path":"2017/01/16/QT 中的Event事件函数/","content":"<p>Event函数是一个Virtual Protected函数，它响应于用户触发的事件，事件多种多类，可以参考help帮助文档。</p>\n<a id=\"more\"></a>\n\n<p>之所以要提到它，是因为我需要实现一个实时显示鼠标坐标的功能，网上实现的方式都是使用<code>setmousetracking()</code>，但是对于我这种情况来说，这并不能实现，我在一篇博客上，也恰好看到了博主跟我同样的问题。</p>\n<p><img src=\"clip_image001.png\" alt=\"123\"></p>\n<p><a href=\"http://lps-683.iteye.com/blog/2260091\" target=\"_blank\" rel=\"noopener\">http://lps-683.iteye.com/blog/2260091</a></p>\n<p>博主是使用的事件过滤器，但是我在实验过后，并没有使用博主的方法（我木有搞成功），于是我在试验鼠标移动是否触发事件时，发现了在event函数中能够响应鼠标移动的事件，所以据此，我采用了另外一种情况。</p>\n<p>那就是，首先，设置<code>setmousetracking(true)</code>，开启鼠标跟踪。第二，构造event事件，判断当前的鼠标坐标与先前的坐标是否不同，以确认是否发生了改变，以免重复操作。</p>\n<p><strong>2017年5月18日11:28:02</strong></p>\n<p>我使用<code>setmousetracking</code>不成功，因为之前使用的界面类是<code>QTabWidget</code>，但是转换为<code>QStackedWidget</code>后，即可使用<code>setmousetracking</code>进行鼠标的实时跟踪了。</p>\n<p><img src=\"clip_image011.png\" alt=\"代码\"></p>\n<p>代码中，为何加入一个“i”来累加呢？</p>\n<p>不加这段代码，将会被判断程序出错，可以实际试试。我调试时的错误：</p>\n<p><img src=\"clip_image101.png\" alt=\"错误\"></p>\n<p>我发现这可能是因为UI的界面的创造时间位于event函数被建立起来之后，所以在event里直接调用界面，此时传送字符串将引发内存泄露的危害，造成程序崩溃。</p>\n","categories":[{"name":"QT","slug":"QT","permalink":"chunlife.top/categories/QT/"}],"tags":[{"name":"QT","slug":"QT","permalink":"chunlife.top/tags/QT/"}]},{"title":"发布QT程序","date":"2017-01-15T09:50:22.000Z","path":"2017/01/15/发布QT程序/","content":"<p>qt程序需要包含很多依赖，并不会编译成一个<code>.exe</code>文件，为了方便程序分发，最好的就是将qt程序进行一下简单的打包操作。</p>\n<a id=\"more\"></a>\n\n<p>一、使用QT自带的windeployqt.exe，进入到D:\\Qt5.7.1\\5.7\\mingw53_32\\bin，在此打开qt自带的”cmd“命令窗口，然后输入后面多加个<code>--release</code>。</p>\n<p><img src=\"clip_image001.png\" alt=\"qt CMD命令窗口\"></p>\n<p>运行命令：</p>\n<p><img src=\"1552644204832.png\" alt=\"1552644204832\"></p>\n<p>它能把大多数依赖文件都拉入到QT生成到的EXE文件夹目录中。</p>\n<p>二、在上一步的基础上直接运行EXE文件，查看具体缺少什么，去QT的安装目录下，查找需要的库文件。（<strong><em>多在几台没有安装任何IDE的电脑上跑一跑</em></strong>）</p>\n<p>在windows下，使用<code>FilePacker</code>将需要的文件打包成一个<code>EXE</code>文件，这样利于发布。</p>\n<p>在Linux下，则估计只有将其压缩成包<code>.tar.gz</code>。</p>\n","categories":[{"name":"QT","slug":"QT","permalink":"chunlife.top/categories/QT/"}],"tags":[{"name":"QT","slug":"QT","permalink":"chunlife.top/tags/QT/"}]},{"title":"QT多线程","date":"2016-12-19T09:50:22.000Z","path":"2016/12/19/QT多线程/","content":"<p>问题是这样的：我需要使用一个界面类的方法，不过呢，QT帮助文档里也说了，咱啊，不能在界面类之外操作UI，那关键是怎么滴也需要操作啊，有方法的，那就是通过signals与slot联合操作，线程发出信号，主线程得到信号后来操作界面函数即可。</p>\n<a id=\"more\"></a>\n\n<p><img src=\"clip_image001.png\" alt=\"QT 线程代码\"></p>\n<p>我出了什么问题呢，即程序运行短时间内卡死了，我猜想是递归过深，导致栈溢出崩溃了，我的系统整个资源消耗非常巨大，我检查了我的槽函数。</p>\n<p><img src=\"clip_image001-1552644779835.png\" alt=\"槽函数\"></p>\n<p>看着像没啥问题的，毕竟我还加上了打印。再瞧瞧connect连接是否出错。</p>\n<p><img src=\"clip_image0012.png\" alt=\"connect连接函数\"></p>\n<p>这也没啥问题啊。</p>\n<p>不过我一直在猜想在线程run函数里面的emit发送信号是否是有问题，但无法得到正确的解决方法，毕竟槽是可重入的，按理说，信号不应该是等待上一个信号处理完再发送的吗？难道是，发送者只负责发，不管对象槽怎么个处理法？？有疑惑。</p>\n<p>这里有篇博客是个合理的理论说法。虽然和信号、槽不一样，但是原理却类似。</p>\n<p><a href=\"http://www.xuebuyuan.com/2041299.html\" target=\"_blank\" rel=\"noopener\"><strong>Qt学习之系列[9] – QCoreApplication:processEvents()可能会引起递归，导致栈溢出崩溃</strong></a></p>\n<p><img src=\"clip_image011.png\" alt=\"博客截图\"></p>\n<p>另外我看到了这篇博客对线程的讲解。</p>\n<p><a href=\"https://www.devbean.net/2013/12/qt-study-road-2-thread-and-qobject/\" target=\"_blank\" rel=\"noopener\">Qt 学习之路 2（74）：线程和 QObject</a></p>\n<p><img src=\"clip_image111.png\" alt=\"信号与槽连接方式\"></p>\n<p>故而我使用了Qt::BlockingQueuedConnection。</p>\n<p><img src=\"1552645124448.png\" alt=\"代码\"></p>\n<p><strong>2016年12月21日22:58:31</strong></p>\n<p>今天我为了使用OpenGL，移植QT的移植例程到自己的程序里面，OpenGL确实是个大学问的，这里暂且不表，3D图形显示嘛，这里涉及到了一个QTime定时器的东西，因为它要刷新图像，但是我的主线程里面时间可是个娇贵的东西（会妨碍界面的响应，影响交互），我不想让定时器这东西出现在我的主线程里面，所以，我还是需要想想怎么将其挪移到我的子线程里面去，这里需要使用到moveToThread。</p>\n<p>将我OpenGLWindow的类运行环境移动到次线程去。</p>\n<p>这里可以参考QT的help文档，它主要介绍了两种方式使用QThread。</p>\n<p>第一种：</p>\n<p><img src=\"clip_image1001.png\" alt=\"第一种方式\"></p>\n<p>第二种：</p>\n<p><img src=\"clip_image11001.png\" alt=\"第二种方式\"></p>\n<p>第一种方式是让整个类都生存在线程之下，使用<code>movetoThread</code>函数；第二种方式则是只有QThread派生出来的那个子类的run函数是运行在次线程中的，使用<code>while(1)</code>固定整个线程。</p>\n<ul>\n<li>run函数是线程的起点，调用start后，新线程会默认调用run函数。</li>\n</ul>\n<p>可以用实验来证明，我的这个工程中使用的是第二种方式，run函数是阻塞的，使用了<code>while(1)</code>，但是在程序将主线程的信号和次线程的槽连接，然后在实际使用中，次线程的槽完全没受影响，照样可以使用，当然，此处我们可以直接打印当前线程的ID，不过网上大多都已经证明了。</p>\n<p>另外，第一种方式情况下，照样连接槽和信号，然后在其中一个函数中实现<code>while(1)</code>，在尝试着去调用其他槽，发现无法调用。</p>\n<p>若我想用第一种方式恐怕还是有点问题，因为我的槽连接方式选择的是<code>Qt::BlockingQueuedConnection</code>，阻塞发送信号的进程，直到接受信号的槽返回，那样的话，我的界面显示不就捉瞎了吗。所以，还是实现一个模态的窗口，强行锁死这个界面看看，但是效果会不太好，可以再想想其他的方法。</p>\n<p><strong>2017年5月23日15:52:45</strong></p>\n<p>VxWorks上，需要显示的设置线程优先级为low。</p>\n<p>线程是有优先级的，就比如在windows和linux上跑该软件，不设置线程优先级则是默认的普通的优先级，但是在VxWorks上则会导致软件卡死，无法运行，这就是系统体系结构不同，线程的实质也不会相同。</p>\n","categories":[{"name":"QT","slug":"QT","permalink":"chunlife.top/categories/QT/"}],"tags":[{"name":"QT","slug":"QT","permalink":"chunlife.top/tags/QT/"}]},{"title":"磁盘组RAID 5","date":"2016-11-17T06:58:52.000Z","path":"2016/11/17/磁盘组RAID 5/","content":"<p>在组建公司的服务器时，需要加上raid管理，raid管理能够帮助数据冗余，防错，但是代价是磁盘的存储不会达到最大的利用率。这里我们使用的是raid5，磁盘利用率能够达到(n - 1) / n。</p>\n<p>在创建raid时主要是参考了这两篇博客：</p>\n<a id=\"more\"></a>\n\n<p>一篇主要是讲究怎么创建的，</p>\n<p><a href=\"http://wqmsl.blog.51cto.com/847418/468700/\" target=\"_blank\" rel=\"noopener\">Linux软raid创建和维护</a></p>\n<p>另外一篇则包含了，怎么将已创建的raid设置为开机自启。</p>\n<p><a href=\"http://blog.chinaunix.net/uid-28267411-id-3522610.html\" target=\"_blank\" rel=\"noopener\">LINUX下软RAID 5实现</a></p>\n<p>但很悲剧的是这两篇博客都没详细介绍怎么分区的，软RAID需要的是至少3块分区，在安装系统时，我们所需要做就是自定义分区，留下一块足够大的地方以满足在安装系统后进行分区的操作，若是全部被分配完成，就没有裕量以供我们进行分区操作。</p>\n<p> 2017年5月8日17:25:17</p>\n<p>补充上面，当留有大量空间，保证了raid的空间后，需要先使用<code>fdisk /dev/sda</code>，对硬件进行分区，将容量利用起来，使用n，选择extended分区，先将所有容量都用作扩展分区，然后再使用n，选择logical分区，raid至少是三个分区组成，所以我们这里建立大于三个分区即可。</p>\n<p><img src=\"clip_image001-1552643069543.png\" alt=\"1241\"></p>\n<p><img src=\"clip_image001.png\" alt=\"123\"></p>\n<p>然后再根据博客中的，将分区格式使用t命令设置为fd的raid格式，w为保存。</p>\n<p><strong>Samba远程挂载：</strong> <code>mount //192.168.8.58/hdxw /mnt/op -o username=superfile</code></p>\n","categories":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/tags/Linux/"},{"name":"raid","slug":"raid","permalink":"chunlife.top/tags/raid/"}]},{"title":"矢量字体字形分布图","date":"2016-06-28T08:17:51.000Z","path":"2016/06/28/矢量字体字形分布图/","content":"<p><img src=\"20160628074647627\" alt=\"image\"></p>\n<a id=\"more\"></a>\n\n<p>origin是字形显示开始的地方，下一个字体开始的位置是：origin + advance的位置，即是指定了下一个字符的origin出现的位置。advance有x方向的，当然有y方向的，不过这里没有使用，使用y方向将会使字体倾斜。</p>\n<p>虽然有坐标基准线，但是英文字体不像汉字方方正正，如果把所有英文字体搞得像汉字一样，那么会很不好看，所以即使在已经订好基准线后，还是会另外设置字体的xmin、xmax和ymin、ymax这四个参数。</p>\n<p>Freetype API的使用</p>\n<p>我们来总结一下显示一个矢量字符我们都做了什么：</p>\n<p>1、初始化一个库</p>\n<p>2、加载字体，并用创建一个face来描述字体</p>\n<p>3、设置字体的像素大小</p>\n<p>4、设置字体的旋转角度以及显示位置</p>\n<p>5、找到字型的点阵信息并记录下来</p>\n<p>6、显示点阵</p>\n<p>要得到上图的信息，我们需要将从face将glyph给取出来，得到box的一些数据，主要是坐标的XY最大、最小值。</p>\n<p>首先，从face中拿到放入字体插槽里面的glyph（此操作并不影响origin glyph）。（函数API名 Extracting the glyph image）</p>\n<p>error = FT_Get_Glyph( face-&gt;glyph, &amp;glyph );</p>\n<p>然后再拿出box里面的数据。（函数API名 Measuring the glyph image）</p>\n<p>FT_Glyph_Get_CBox(glyph, FT_GLYPH_BBOX_TRUNCATE, &amp;bbox );</p>\n<p>一些API函数：</p>\n<p>①：FT_Init_FreeType( &amp;library );</p>\n<p>功能：这是初始化一个库，所谓库我们可以简单的理解为一个空间，用来存放所有的资源。</p>\n<p>②：FT_New_Face( library, argv[1], 0, &amp;face );</p>\n<p>功能：读取字体文件中指定类型的字体，并用face来描述它</p>\n<p>参数1：表示库</p>\n<p>参数2：要打开的文件</p>\n<p>参数3：表示要加载的字体的类型，0表示任何类型都可以</p>\n<p>参数4：face</p>\n<p>一个文件里面可能会含有多种字体，每个字体对应着一个face，也就是说face用来描述某一种字体。</p>\n<p>③：FT_Set_Pixel_Sizes(face, 24, 0);</p>\n<p>功能：设置字符的像素大小</p>\n<p>参数1：face</p>\n<p>参数2：每行多少像素，0表示与列相同</p>\n<p>参数3：每列多少像素，0表示与行相同</p>\n<p>④：FT_Set_Transform( face, &amp;matrix, &amp;pen );</p>\n<p>功能：设置传输</p>\n<p>参数1：face</p>\n<p>参数2：用于设置字体的旋转角度</p>\n<p>参数3：用于设置字体的平显示位置，freetype文档里面的参数提示给的delta，也就是数学里面△符号，即然后把它显示到LCD中间位置，但是“我爱你”三个字符之间位置没发生改变，那么坐标(0,0)和(pen.x, pen.y)之间的位置就是delta。</p>\n<p><img src=\"20160628074648846\" alt=\"image\"></p>\n<p>⑤：FT_Load_Char( face, text[n], FT_LOAD_RENDER );</p>\n<p>功能：将一个字型的点阵信息记录在face-&gt;glyph中</p>\n<p>参数1：face</p>\n<p>参数2：要记录的字型的编码</p>\n<p>参数3：参数</p>\n<p>⑥：draw_bitmap( &amp;slot-&gt;bitmap , slot-&gt;bitmap_left , target_height - slot-&gt;bitmap_top );</p>\n<p>功能：将字符的点阵存放在一个结构体里面</p>\n<p>参数1：用于描述点阵信息的结构体</p>\n<p>参数2：x坐标</p>\n<p>参数3：y坐标</p>\n<p>注意：我们这里的坐标是笛卡尔坐标系，也就是y坐标向上，x坐标向右！而在LCD上的显示坐标系y轴是反向的，所以显示的时候需要将y轴处理一下！</p>\n","categories":[{"name":"嵌入式","slug":"嵌入式","permalink":"chunlife.top/categories/嵌入式/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/tags/Linux/"}]},{"title":"PowerPoint 2013设计小册（目录）","date":"2016-06-25T06:27:56.000Z","path":"2016/06/25/PowerPoint-2013设计小册（目录）/","content":"<h3 id=\"目录：\"><a href=\"#目录：\" class=\"headerlink\" title=\"目录：\"></a>目录：</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./目录.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第一章 相见恨晚 —— 认识PowerPoint 2013","date":"2016-06-25T06:23:56.000Z","path":"2016/06/25/第一章相见恨晚-——-认识PowerPoint-2013/","content":"<h3 id=\"第一章-相见恨晚-——-认识PowerPoint-2013\"><a href=\"#第一章-相见恨晚-——-认识PowerPoint-2013\" class=\"headerlink\" title=\"第一章 相见恨晚 —— 认识PowerPoint 2013\"></a>第一章 相见恨晚 —— 认识PowerPoint 2013</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第一章.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第二章 千里之行","date":"2016-06-25T06:22:56.000Z","path":"2016/06/25/第二章-千里之行/","content":"<h3 id=\"第二章-千里之行\"><a href=\"#第二章-千里之行\" class=\"headerlink\" title=\"第二章 千里之行\"></a>第二章 千里之行</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第二章千里之行.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第三章 胸有成竹","date":"2016-06-25T06:21:56.000Z","path":"2016/06/25/第三章胸有成竹/","content":"<h3 id=\"第三章-胸有成竹\"><a href=\"#第三章-胸有成竹\" class=\"headerlink\" title=\"第三章 胸有成竹\"></a>第三章 胸有成竹</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第三章胸有成竹.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第四章 得心应手","date":"2016-06-25T06:21:55.000Z","path":"2016/06/25/第四章得心应手/","content":"<h3 id=\"第四章-得心应手\"><a href=\"#第四章-得心应手\" class=\"headerlink\" title=\"第四章 得心应手\"></a>第四章 得心应手</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第四章得心应手.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第五章 美轮美奂","date":"2016-06-25T06:20:56.000Z","path":"2016/06/25/第五章美轮美奂/","content":"<h3 id=\"第五章-美轮美奂\"><a href=\"#第五章-美轮美奂\" class=\"headerlink\" title=\"第五章 美轮美奂\"></a>第五章 美轮美奂</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第五章美轮美奂.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第六章 特立独行","date":"2016-06-25T06:20:55.000Z","path":"2016/06/25/第六章特立独行/","content":"<h3 id=\"第六章-特立独行\"><a href=\"#第六章-特立独行\" class=\"headerlink\" title=\"第六章 特立独行\"></a>第六章 特立独行</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第六章特立独行.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第七章 清晰明了","date":"2016-06-25T06:20:54.000Z","path":"2016/06/25/第七章清晰明了/","content":"<h3 id=\"第七章-清晰明了\"><a href=\"#第七章-清晰明了\" class=\"headerlink\" title=\"第七章 清晰明了\"></a>第七章 清晰明了</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第七章清晰明了.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第八章 活灵活现","date":"2016-06-25T06:20:53.000Z","path":"2016/06/25/第八章活灵活现/","content":"<h3 id=\"第八章-活灵活现\"><a href=\"#第八章-活灵活现\" class=\"headerlink\" title=\"第八章 活灵活现\"></a>第八章 活灵活现</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第八章活灵活现.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第九章演示之道","date":"2016-06-25T06:20:51.000Z","path":"2016/06/25/第九章演示之道/","content":"<h3 id=\"第九章-演示之道\"><a href=\"#第九章-演示之道\" class=\"headerlink\" title=\"第九章 演示之道\"></a>第九章 演示之道</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第九章演示之道.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十章 让PPT无处不在","date":"2016-06-25T06:20:50.000Z","path":"2016/06/25/第十章让PPT无处不在/","content":"<h3 id=\"第十章-让PPT无处不在\"><a href=\"#第十章-让PPT无处不在\" class=\"headerlink\" title=\"第十章 让PPT无处不在\"></a>第十章 让PPT无处不在</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十章让PPT无处不在.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十一章 管理你的PPT","date":"2016-06-25T06:20:49.000Z","path":"2016/06/25/第十一章-管理你的PPT/","content":"<h3 id=\"第六章-第十一章-管理你的PPT\"><a href=\"#第六章-第十一章-管理你的PPT\" class=\"headerlink\" title=\"第六章 第十一章 管理你的PPT\"></a>第六章 第十一章 管理你的PPT</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十一章管理你的PPT.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十二章 PPT 的三大原则","date":"2016-06-25T06:20:48.000Z","path":"2016/06/25/第十二章-PPT-的三大原则/","content":"<h3 id=\"第十二章-PPT-的三大原则\"><a href=\"#第十二章-PPT-的三大原则\" class=\"headerlink\" title=\"第十二章 PPT 的三大原则\"></a>第十二章 PPT 的三大原则</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十二章PPT的三大原则.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十三章 搜集资源","date":"2016-06-25T06:20:46.000Z","path":"2016/06/25/第十三章-搜集资源/","content":"<h3 id=\"第十三章-搜集资源\"><a href=\"#第十三章-搜集资源\" class=\"headerlink\" title=\"第十三章 搜集资源\"></a>第十三章 搜集资源</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十三章搜集资源.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十四章 让图形引导逻辑","date":"2016-06-25T06:20:45.000Z","path":"2016/06/25/第十四章-让图形引导逻辑/","content":"<h3 id=\"第十四章-让图形引导逻辑\"><a href=\"#第十四章-让图形引导逻辑\" class=\"headerlink\" title=\"第十四章 让图形引导逻辑\"></a>第十四章 让图形引导逻辑</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十四章让图形引导逻辑.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十五章 PPT之神","date":"2016-06-25T06:20:44.000Z","path":"2016/06/25/第十五章-PPT之神/","content":"<h3 id=\"第十五章-PPT之神\"><a href=\"#第十五章-PPT之神\" class=\"headerlink\" title=\"第十五章 PPT之神\"></a>第十五章 PPT之神</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十五章PPT之神.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十六章 存在不只为了美","date":"2016-06-25T06:20:43.000Z","path":"2016/06/25/第十六章-存在不只为了美/","content":"<h3 id=\"第十六章-存在不只为了美\"><a href=\"#第十六章-存在不只为了美\" class=\"headerlink\" title=\"第十六章 存在不只为了美\"></a>第十六章 存在不只为了美</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十六章存在不只为了美.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十七章 数据的创意展示","date":"2016-06-25T06:20:42.000Z","path":"2016/06/25/第十七章-数据的创意展示/","content":"<h3 id=\"第十七章-数据的创意展示\"><a href=\"#第十七章-数据的创意展示\" class=\"headerlink\" title=\"第十七章 数据的创意展示\"></a>第十七章 数据的创意展示</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十七章数据的创意展示.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十八章 行云流水","date":"2016-06-25T06:20:40.000Z","path":"2016/06/25/第十八章-行云流水/","content":"<h3 id=\"第十八章-行云流水\"><a href=\"#第十八章-行云流水\" class=\"headerlink\" title=\"第十八章 行云流水\"></a>第十八章 行云流水</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十八章行云流水.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第十九章 声形结合","date":"2016-06-25T06:20:39.000Z","path":"2016/06/25/第十九章-声形结合/","content":"<h3 id=\"第十九章-声形结合\"><a href=\"#第十九章-声形结合\" class=\"headerlink\" title=\"第十九章 声形结合\"></a>第十九章 声形结合</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第十九章声形结合.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"第二十章 遥遥可期","date":"2016-06-25T06:20:38.000Z","path":"2016/06/25/第二十章-遥遥可期/","content":"<h3 id=\"第二十章-遥遥可期\"><a href=\"#第二十章-遥遥可期\" class=\"headerlink\" title=\"第二十章 遥遥可期\"></a>第二十章 遥遥可期</h3><a id=\"more\"></a>\n\n\n\n\t<div class=\"row\">\n    <embed src=\"./第二十章遥遥可期.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n\n","categories":[{"name":"设计小册","slug":"设计小册","permalink":"chunlife.top/categories/设计小册/"}],"tags":[]},{"title":"听韦东山老师公开课的理解","date":"2016-06-07T03:34:40.000Z","path":"2016/06/07/听韦东山老师公开课的理解/","content":"<p><strong>为什么需要数据段、代码段和BBS段？这么多的段是干什么用的。</strong></p>\n<a id=\"more\"></a>\n\n<p>程序的指令等是只读的，可以把它们归为一类，以便运行时可以把它们放到ROM等设备上去，当然也可以是内存上，只不过是这段内存时只读的。<br>程序的全局变量等是可读可写的，可以把他们归为一类，放在内存里面去。<br>那么我们来假设一个事，若是我们编写了一个程序中，包含大量的初始值为0的全局变量，那么编译出来的.bin文件是不是会很大，很显然根据日常经验来看，编译的文件中并没有存放这些数据，那么这是怎么回事呢。<br>将它们这些数据归为一类，只记录它们的内存起始地址和结束地址，在程序运行前将这块内存清零。清零BSS段（BSS段通常是指用来存放程序中未初始化的全局变量和静态变量的一块内存区域）。<br>栈的作用？<br>从汇编跃进到C前，调用C函数需要有栈（栈是一种操纵内存的数据结构类型，至于你说为什么不是其他的数据结构，那你得去想想操作系统方面的知识了），至于栈的好处，我参开这篇文章上：<br><a href=\"http://www.cnblogs.com/xmphoenix/archive/2012/04/28/2475399.html\" target=\"_blank\" rel=\"noopener\">http://www.cnblogs.com/xmphoenix/archive/2012/04/28/2475399.html</a><br><strong>一.栈的整体作用</strong><br>(1)保存现场/上下文</p>\n<p>(2)传递参数:汇编代码调用c函数时，需传递参数</p>\n<p>(3)保存临时变量:包括函数的非静态局部变量以及编译器自动生成的其他临时变量。</p>\n<p>这些需要保存在内存的值呢，大家就约定用CPU的sp指针指明位置，这块内存也就是栈。</p>\n<p><strong>SDRAM那么大，程序被复制到了哪里？</strong></p>\n<p>对于2440来说，Nand启动时，CPU会自动将Nand上前4K的程序复制到片内SRAM上运行，而这段代码中就有一个功能就是将Nand上的程序复制到SDRAM上去运行的，而复制到哪里呢，以前的Uboot是采用的把链接地址写死，然后复制代码到SDRAM上的地址也是定死了，但是，现在的Uboot采用的是重定位的方法，那么也就是说，现在的程序猿把代码复制到哪里都可以，主要也是为了适配如今大量不同的板子。</p>\n<p>之所以要复制到链接地址上去使用，是因为程序上的全局变量、函数等都是以链接地址来访问的，在程序运行之前，这些地址都应该有确定的值。</p>\n<p>总结下bootloader的第一阶段大概框架：</p>\n<p>a. 必要的硬件初始化：关看门狗，时钟，SDRAM</p>\n<p>b. 重定位，将程序从Flash上读到内存相应的链接地址上</p>\n<p>c. 清除BSS段</p>\n<p>d. 调用C函数</p>\n<p><strong>前4K所使用的是位置无关码所编写的程序，也就是说为什么没有在链接地址上，还能正确运行着程序，没有上面说的限制</strong></p>\n<p>何为位置无关， ① 不去访问全局变量/静态变量； ② 跳转指令均是采用相对跳转，例如b, bl。</p>\n","categories":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/tags/Linux/"},{"name":"ARM","slug":"ARM","permalink":"chunlife.top/tags/ARM/"}]},{"title":"strcat函数引起的血案","date":"2016-06-07T03:34:40.000Z","path":"2016/06/07/strcat函数引起的血案/","content":"<p>/*</p>\n<p> <a href=\"http://www.cnblogs.com/kaituorensheng/archive/2012/10/23/2736069.html\" target=\"_blank\" rel=\"noopener\">http://www.cnblogs.com/kaituorensheng/archive/2012/10/23/2736069.html</a><br>参考这篇文章</p>\n<ul>\n<li><p>char *a = “Hello”;Hello存放在常量区，是无法修改的。</p>\n</li>\n<li><p>通过指针只可以访问字符串常量，而不可以去改变它</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<ul>\n<li></li>\n<li><p>char a[] = “Hello”;而数组存放在栈中，是可以修改的</p>\n</li>\n<li><p>Hello存放在栈中，可以通过指针去访问和修改数组内容</p>\n</li>\n</ul>\n<p>*/</p>\n<p>sizeof和strlen两个函数的随想：</p>\n<p>①sizeof的参数是数组，返回的是编译时分配的数组空间 （sizeof是运算符，值在编译时已计算好）</p>\n<p>②strlen的参数是字符型指针（char *），当数组名作为参数传入时，实际上数组就退化为指针了。</p>\n<p>（strlen是函数，值需要在运行时才能得出）</p>\n<p>该函数的实际功能从代表字符串的第一个地址开始遍历，知道遇到结束符’\\0’,返回长度不包括’\\0’</p>\n<p>这也就说明下面的函数为什么会将数组越界的字符串也一起显示了，strlen的限制就只是’\\0’，而</p>\n<p>且数组传入后即退化为指针，指针只是在读这些地址的值，没有修改，所以也不“违法”。</p>\n<p><em>总的来说就是，数组可以越界，编译器也不会报警，至于越界使用的地址会造成什么，谁也不知道</em></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">char</span> *a= <span class=\"string\">\"Hello, \"</span>;</span><br><span class=\"line\"><span class=\"keyword\">char</span> b[]= <span class=\"string\">\"World!\"</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"built_in\">strcat</span>(b, a);     <span class=\"comment\">//  这样是可行的，但是将b和a互换位置后，将导致段错误</span></span><br><span class=\"line\">                 a是常量，不可被更改</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">\"%s\"</span>,b);</span><br><span class=\"line\"> </span><br><span class=\"line\">*/</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\">voidstrcat(<span class=\"keyword\">char</span> a[], <span class=\"keyword\">char</span> b[]);</span><br><span class=\"line\">intstrlen(<span class=\"keyword\">char</span> *s);</span><br><span class=\"line\"> </span><br><span class=\"line\">intmain()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> a[] = <span class=\"string\">\"Hello, \"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> b[] = <span class=\"string\">\"World!\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(a, b);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d\\n\"</span>, <span class=\"built_in\">strlen</span>(a));</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d\\n\"</span>, <span class=\"keyword\">sizeof</span>(a));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%s\"</span>, a);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">strcat</span><span class=\"params\">(<span class=\"keyword\">char</span> a[], <span class=\"keyword\">char</span> b[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>, j = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(a[i] != <span class=\"string\">'\\0'</span>)</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>( (a[i++] = b[j++]) != <span class=\"string\">'\\0'</span> );</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">strlen</span><span class=\"params\">(<span class=\"keyword\">char</span> *s)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">char</span> *p = s;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*p != <span class=\"string\">'\\0'</span>)</span><br><span class=\"line\">\t\tp++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> p-s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"C语言","slug":"C语言","permalink":"chunlife.top/categories/C语言/"}],"tags":[{"name":"C语言","slug":"C语言","permalink":"chunlife.top/tags/C语言/"}]},{"title":"Tiny6410 的NandFlash（K9GAG08U0E）","date":"2016-06-03T13:43:46.000Z","path":"2016/06/03/Tiny6410 的NandFlash（K9GAG08U0E）/","content":"<p>学的实在是揪心，一开始以为的8K每页读，才发现前4页为2K，但当以前4页2K读，后面8K读，又发现坑爹的来了，这个问题的引出主要是我读取内核并启动没有成功，然后基于这样的一个考虑，我以2K每页读取NandFlash，代码运行成功，我以8K每页读取NandFlash，代码运行一样成功，问题就在这里，如果这样考虑，代码到底是每页多少被写到NandFlash的？事实证明的是，这篇文章给了我答案，看来还真是。</p>\n<a id=\"more\"></a>\n\n<p>以下文章转载自：<strong><a href=\"http://blog.csdn.net/o0Avalon0o/article/details/49644553\" target=\"_blank\" rel=\"noopener\">Tiny6410+K9GAG08U0E</a></strong> </p>\n<h3 id=\"Tiny6410-K9GAG08U0E-使用小记\"><a href=\"#Tiny6410-K9GAG08U0E-使用小记\" class=\"headerlink\" title=\"Tiny6410(K9GAG08U0E)使用小记\"></a>Tiny6410(K9GAG08U0E)使用小记</h3><p>友善采用这颗8K Page的Nand，在6410上面搭配使用，确实给用户添加了不少麻烦，再加上ecc部分使用软件实现，代码不开源，学到块驱动的时候确实揪心啊~~</p>\n<h3 id=\"内部SRAM的大小\"><a href=\"#内部SRAM的大小\" class=\"headerlink\" title=\"内部SRAM的大小\"></a>内部SRAM的大小</h3><p>先从启动说起，Tiny6410启动选用的是用户手册里面屏蔽掉的一种直接Nand启动方式，如下图，根据友善原理图的OM[4:0]电平，对应表中的RESERVED，这种启动方式就是上电后直接将Nand的前面一部分代码映射到片内SRAM中，开始启动。</p>\n<p><img src=\"clip_image001.png\" alt=\"123\"></p>\n<p>而三星官方推荐的启动方式应该是从IROM中启动，然后通过IROM将NAND中的代码拷贝到片内SRAM，再跳转到SRAM中启动。 </p>\n<p>这里看了网上很多资料，有的人说SRAM是8K，有的说是4K，这里我看到用户手册里面是说有4K，但是我用Tiny6410调试裸板程序的时候，发现确实是拷贝了8K代码：</p>\n<p><img src=\"clip_image001-1552580396633.png\" alt=\"1231\"></p>\n<p>这里自己有个猜测：对于友善使用的这种隐藏的启动方式，就是直接将代码放到SRAM空间运行，此时当然就有8K RAM空间了；但是当使用三星推荐的从IROM中运行，那么IROM中运行的代码的临时变量都是保存在SRAM上面的，所以可能是官方想保留上半4K RAM用于IROM启动。</p>\n<h3 id=\"8K页大小问题\"><a href=\"#8K页大小问题\" class=\"headerlink\" title=\"8K页大小问题\"></a>8K页大小问题</h3><p>从上面启动选择那张图片可以看到，其实上6410最大仅支持4K页，并不支持8K页，而对于友善使用的被保留启动方式更是最多支持large page(2K)。 </p>\n<p>所以在开始的8K SRAM代码拷贝中需要注意，系统只会拷贝每个8K页中的前2K数据，而友善配套提供的superboot升级程序在烧写U-boot镜像的时候都只是操作每页中前2K空间。 </p>\n<p>而对应的在U-Boot源码中也可以看到拷贝U-boot到SDRAM中运行的函数，仅操作了前2K数据：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">nandll_read_blocks</span> <span class=\"params\">(ulong dst_addr, ulong size, <span class=\"keyword\">int</span> large_block)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        uchar *buf = (uchar *)dst_addr;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">    \tuint page_shift = <span class=\"number\">9</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (large_block)</span><br><span class=\"line\">        \tpage_shift = <span class=\"number\">11</span>;</span><br><span class=\"line\">\t\t<span class=\"comment\">/* Read pages */</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; (<span class=\"number\">0x3c000</span>&gt;&gt;page_shift); i++, buf+=(<span class=\"number\">1</span>&lt;&lt;page_shift)) &#123;</span><br><span class=\"line\">                nandll_read_page(buf, i, large_block);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看到在整个启动到U-boot代码搬运过程中，都没有启动ecc，所以在这个过程中数据都是不可靠的，而在友善的论坛里面也看到过他们承认，有掉U-boot固件的可能性。这也不能全怪人家，硬件决定6410拷贝8K代码的时候已经不安全了，那么后面Uboot重定向的时候做不做ecc都不是太重要了。。。</p>\n<p>在进入U-boot第二阶段start_armboot中之后，通过调用nand_scan()跟友善不开源的NAND_Init()，从这里之后即对K9GAG08U0E完成初始化，开启软件ECC，此后对Kernel、Rootfs的数据操作都是变为可靠了。 </p>\n<p>这里再吐槽一下，调用NAND_Init()竟然会改变U-Boot的环境变量，搞的我每次通过mini6410.h文件设置的环境变量都无效，这也是醉了。。。P.S.经过验证，友善应该是在Nand上面开辟了一段空间用于保存环境变量，调用NAND_Init之后，系统将直接从Nand的这段地址中还原环境参数，也就是说修改/include/configs/mini6410.h下面的环境变量屁用都没有，对于一块全新的开发板只要在Uboot中调用一次setenv、saveenv，保存到Nand中，下次如果仅更新Uboot固件时，则不需要再重新设置环境变量了(确保你用的Uboot是最新版，旧版本Uboot命令行下不支持saveenv保存参数)。 </p>\n<p>推荐解决方法可以在NAND_Init()后面使用void setenv (char *varname, char *varvalue)重新设置。</p>\n<h3 id=\"Tiny6410中的nand命令\"><a href=\"#Tiny6410中的nand命令\" class=\"headerlink\" title=\"Tiny6410中的nand命令\"></a>Tiny6410中的nand命令</h3><p>友善提供的最新U-Boot终于支持对K9GAG08U0E进行写入操作了，分析cmd_nand.c中的do_nand()：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">/* read write */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">strncmp</span>(cmd, <span class=\"string\">\"read\"</span>, <span class=\"number\">4</span>) == <span class=\"number\">0</span> || <span class=\"built_in\">strncmp</span>(cmd, <span class=\"string\">\"write\"</span>, <span class=\"number\">5</span>) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> read;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">4</span>)</span><br><span class=\"line\">            <span class=\"keyword\">goto</span> usage;</span><br><span class=\"line\">\taddr = (ulong)simple_strtoul(argv[<span class=\"number\">2</span>], <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">\tread = <span class=\"built_in\">strncmp</span>(cmd, <span class=\"string\">\"read\"</span>, <span class=\"number\">4</span>) == <span class=\"number\">0</span>; <span class=\"comment\">/* 1 = read, 0 = write */</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">\"\\nNAND %s: \"</span>, read ? <span class=\"string\">\"read\"</span> : <span class=\"string\">\"write\"</span>);</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (arg_off_size(argc - <span class=\"number\">3</span>, argv + <span class=\"number\">3</span>, nand, &amp;off, &amp;size) != <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\ts = <span class=\"built_in\">strchr</span>(cmd, <span class=\"string\">'.'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (s != <span class=\"literal\">NULL</span> &amp;&amp;</span><br><span class=\"line\">            (!<span class=\"built_in\">strcmp</span>(s, <span class=\"string\">\".jffs2\"</span>) || !<span class=\"built_in\">strcmp</span>(s, <span class=\"string\">\".e\"</span>) || !<span class=\"built_in\">strcmp</span>(s, <span class=\"string\">\".i\"</span>))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (read) &#123;</span><br><span class=\"line\">                ret = FriendlyARMReadNand( (u_char*)addr, size, off);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (ret == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"offset should be multiple of page size\\n\"</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">/* write */</span></span><br><span class=\"line\">                <span class=\"keyword\">nand_write_options_t</span> opts;</span><br><span class=\"line\">                <span class=\"built_in\">memset</span>(&amp;opts, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(opts));</span><br><span class=\"line\">                opts.buffer = (u_char*) addr;</span><br><span class=\"line\">                opts.length = size;</span><br><span class=\"line\">                opts.offset = off;</span><br><span class=\"line\">                <span class=\"comment\">/* opts.forcejffs2 = 1; */</span></span><br><span class=\"line\">                opts.pad    = <span class=\"number\">1</span>;</span><br><span class=\"line\">                opts.blockalign = <span class=\"number\">1</span>;</span><br><span class=\"line\">                opts.quiet      = quiet;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (NandIsMlc()) &#123;</span><br><span class=\"line\">                    ret = <span class=\"number\">-1</span>;</span><br><span class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"write.jffs2/write.e/write.i is not supported\\n\"</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span></span><br><span class=\"line\">                    ret = nand_write_opts(nand, &amp;opts);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">ifdef</span> CFG_NAND_YAFFS_WRITE</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!read &amp;&amp; s != <span class=\"literal\">NULL</span> &amp;&amp; + (!<span class=\"built_in\">strcmp</span>(s, <span class=\"string\">\".yaffs\"</span>) || !<span class=\"built_in\">strcmp</span>(s, <span class=\"string\">\".yaffs1\"</span>))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">nand_write_options_t</span> opts;</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(&amp;opts, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(opts));</span><br><span class=\"line\">            opts.buffer = (u_char*) addr;</span><br><span class=\"line\">            opts.length = size;</span><br><span class=\"line\">            opts.offset = off;</span><br><span class=\"line\">            opts.pad = <span class=\"number\">0</span>;</span><br><span class=\"line\">            opts.blockalign = <span class=\"number\">1</span>;</span><br><span class=\"line\">            opts.quiet = quiet;</span><br><span class=\"line\">            opts.writeoob = <span class=\"number\">1</span>;</span><br><span class=\"line\">            opts.autoplace = <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"comment\">/* jsgood */</span></span><br><span class=\"line\">            <span class=\"comment\">/* if (s[6] == '1')</span></span><br><span class=\"line\"><span class=\"comment\">                opts.forceyaffs = 1; */</span></span><br><span class=\"line\">ret = nand_write_opts(nand, &amp;opts);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (read) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!NandIsMlc()) &#123;</span><br><span class=\"line\">                    ret = nand_read(nand, off, &amp;size, (u_char *)addr);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    ret = FriendlyARMReadNand( (u_char*)addr, size, off);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (ret == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">                        <span class=\"built_in\">puts</span>(<span class=\"string\">\"offset should be multiple of page size\\n\"</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (NandIsMlc()) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (off % NandBlockSizeInByte != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                        <span class=\"built_in\">puts</span>(<span class=\"string\">\"offset should be multiple of block size\\n\"</span>);</span><br><span class=\"line\">                        ret = <span class=\"number\">-1</span>;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">                        ret = <span class=\"number\">0</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; size; i += NandBlockSizeInByte) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">int</span> len = size - i;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (len &gt; NandBlockSizeInByte) &#123;</span><br><span class=\"line\">                                len = NandBlockSizeInByte;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            FriendlyARMWriteNand(((u_char *)addr) + i, len, off + i, NandBlockSizeInByte);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    ret = nand_write(nand, off, &amp;size, (u_char *)addr);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (ret == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                        uint *magic = (uint*)(PHYS_SDRAM_1);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> ((<span class=\"number\">0x24564236</span> == magic[<span class=\"number\">0</span>]) &amp;&amp; (<span class=\"number\">0x20764316</span> == magic[<span class=\"number\">1</span>]))</span><br><span class=\"line\">                            magic[<span class=\"number\">0</span>] = <span class=\"number\">0x27051956</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p>从代码可以看到，只有nand read.i == nand read可以完成K9GAG08U0E的读操作，且它们都要求操作地址必须是page对齐； </p>\n<p>而nand write可以完成K9GAG08U0E的写操作，同样，操作地址需要page对齐(8K)，且暂时还不支持带oob数据的文件系统镜像的烧写(yaffs)！！</p>\n","categories":[{"name":"嵌入式","slug":"嵌入式","permalink":"chunlife.top/categories/嵌入式/"}],"tags":[{"name":"ARM","slug":"ARM","permalink":"chunlife.top/tags/ARM/"},{"name":"Tiny6410","slug":"Tiny6410","permalink":"chunlife.top/tags/Tiny6410/"}]},{"title":"改正国嵌Makefile对底层目录更改无响应的毛病","date":"2016-06-01T12:51:52.000Z","path":"2016/06/01/改正国嵌Makefile对底层目录更改无响应的毛病/","content":"<a id=\"more\"></a>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OBJS := start.o mem.o main.o dev/dev.o lib/lib.o</span><br><span class=\"line\"></span><br><span class=\"line\">CFLAGS = -fno-builtin -I$(shell pwd)/include</span><br><span class=\"line\">export CFLAGS</span><br><span class=\"line\"></span><br><span class=\"line\">gbbot.bin : $(OBJS)</span><br><span class=\"line\">\tarm-linux-ld -Tgboot.lds -o gboot.elf $^</span><br><span class=\"line\">\tarm-linux-objcopy -O binary gboot.elf $@</span><br><span class=\"line\">\t</span><br><span class=\"line\">%.o : %.S</span><br><span class=\"line\">\tarm-linux-gcc -g -c $&lt;</span><br><span class=\"line\"></span><br><span class=\"line\">%.o : %.c</span><br><span class=\"line\">\tarm-linux-gcc -g $(CFLAGS) -c $&lt;</span><br><span class=\"line\"></span><br><span class=\"line\">.PHONY : lib/lib.o @  根据其他的Makefile琢磨出来的一种响应底层目录文件更改后Makefile不响应的解决之道</span><br><span class=\"line\">lib/lib.o:</span><br><span class=\"line\">\tcd lib; make; cd ..</span><br><span class=\"line\"></span><br><span class=\"line\">.PHONY : dev/dev.o</span><br><span class=\"line\">dev/dev.o:</span><br><span class=\"line\">\tcd dev; make; cd ..</span><br><span class=\"line\"></span><br><span class=\"line\">clean:</span><br><span class=\"line\">\trm -f *.o *.elf *.bin</span><br><span class=\"line\">\tmake clean -C lib</span><br><span class=\"line\"></span><br><span class=\"line\">make clean -C dev</span><br></pre></td></tr></table></figure>\n\n","categories":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/categories/Linux/"}],"tags":[{"name":"Shell","slug":"Shell","permalink":"chunlife.top/tags/Shell/"},{"name":"Linux","slug":"Linux","permalink":"chunlife.top/tags/Linux/"}]},{"title":"串口终端没有打印字符","date":"2016-06-01T01:55:52.000Z","path":"2016/06/01/串口终端没有打印字符/","content":"<p>​         首先是UART.c上的错误，这个错误比较低级，由于将putc中的这个寄存器UFSTAT0写错了，还是写的以前那个没有开FIFO使用的寄存器，那也就导致了UART打印的字符乱码了，这个是根据源码一步一步找到的（替换文件，一个个来找），但是这个问题还不是最终需要解决的问题。</p>\n<a id=\"more\"></a>\n\n<p>​         Nand.c是我一开始就怀疑的代码，因为这段代码是我自己写的，但是似乎没有什么明显的现象指到这里来，而且将串口打印加到main函数中去后，按键中断还出现了问题，这让我实在摸不清楚代码到底在哪出现了BUG，通过替换代码才从这些繁杂中找到一点头绪。</p>\n<p>​          Nand.c有错误，那也只有一个地方的错误导致了串口打印的出错，那就是复制代码那个地方有问题。</p>\n<p>2016-6-1 16:35:08</p>\n<p>​          问题的症结出现了，copy_to_ram分为了两步，① 将NF那2K前4页复制到DDR中；②将后续的那些8K的页复制到内存。 第一步没有问题，这也是小灯可以点亮，但是按键中断却没有啥反应或者是反应几下就没了，还有UART控制台显示不出来的原因了，代码都找不到，bootloader死在了重定位上。</p>\n<p>​          问题的出现也是自己粗心大意了。buf[i]，i++，但是当i=0,重新循环时，buf地址并没有变化，也就造成了向一个重复内存里重复写数据的现象。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for(i=0; i &lt; page; i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tbuff[i] = NFDATA;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>解决方法：</p>\n<p>① buff[i++] = NFDATA;        修改前面的代码，去掉for里面的i++。</p>\n<p>② 修改buff[i] = NFDATA;为   *buff++ = NFDATA；</p>\n","categories":[{"name":"嵌入式","slug":"嵌入式","permalink":"chunlife.top/categories/嵌入式/"}],"tags":[{"name":"C语言","slug":"C语言","permalink":"chunlife.top/tags/C语言/"},{"name":"Linux","slug":"Linux","permalink":"chunlife.top/tags/Linux/"},{"name":"uboot","slug":"uboot","permalink":"chunlife.top/tags/uboot/"}]},{"title":"Linux下的栈的实现","date":"2016-05-19T09:15:52.000Z","path":"2016/05/19/Linux下的栈的实现/","content":"<p>Linux下的栈是由glibc这个库，glibc其实是C运行库，它提供了Linux系统最底层的API（应用程序接口），glibc除了封装linux操作系统所提供的系统服务外，它本身也提供了许多其它一些必要功能服务的实现。</p>\n<a id=\"more\"></a>\n\n<p>​        例如堆的实现就是由它提供所提供的，那么堆是怎么被它所提供的呢，首先若是你使用malloc这个函数，就会向内核申请一块空间，Linux内存是以页框为单位，一个页框就是4K的大小，这么大的一块空间，若是我只申请malloc(16)，内核返回一大片空间（页框），多余的空间由glibc来管理。</p>\n<p>  ① 源头（申请）：malloc</p>\n<p>  ② 内核返回一大块空间（以页框为单位）</p>\n<p>  ③ glibc，从一大块的内存挖出程序需要的内存给程序，剩下来的进行管理。</p>\n<p><img src=\"1552641421054.png\" alt=\"malloc函数操作\"></p>\n<p><img src=\"1552641464939.png\" alt=\"1552641464939\"></p>\n","categories":[{"name":"Linux","slug":"Linux","permalink":"chunlife.top/categories/Linux/"}],"tags":[{"name":"C语言","slug":"C语言","permalink":"chunlife.top/tags/C语言/"},{"name":"Linux","slug":"Linux","permalink":"chunlife.top/tags/Linux/"}]}]