<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>go操作usb | Pure Life</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'e155b64355fa51e2e8a4ca9edc59e825';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">go操作usb</h1><a id="logo" href="/.">Pure Life</a><p class="description">一亩三分路漫漫</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">go操作usb</h1><div class="post-meta">2019-07-17<span> | </span><span class="category"><a href="/categories/编程技术/">编程技术</a></span></div><div class="post-content"><p>因为要涉及到重新置换以前的硬件操作方案，在重新梳理以前项目后，发现使用的语言繁多，其中使用到了一种公司内部开发的脚本，从易读性和功能性上来看，出于<code>减负</code>的目的，将这些个能被替换的语言，尽量统一到一种语言——Go。</p>
<p>同时，在使用过程中，Go里面的USB库能找到的使用方面的博客少的可怜，于是写下这一篇操作USB详细的使用解析，方便后来人，避免遇到一知半解的问题。</p>
<a id="more"></a>
<p>像一些USB设备，都是串接在一个arm设备上进行管理，然后由arm设备进行状态控制。（这里有点疑惑以前的方案为啥要使用USB，一般情况这种一对多的，使用像485组网大概会更方便些，算是一个更有性价比的方案，当然现在的方案是不可能变动的了。）</p>
<h2><span id="准备">准备</span></h2>
<h3><span id="gousb">gousb</span></h3>
<p>Go操作USB使用到的库是<a href="https://github.com/google/gousb" target="_blank" rel="noopener">gousb</a>，不过在使用过程中，库不支持USB的热插拔event，在这个<a href="https://github.com/google/gousb/issues/8" target="_blank" rel="noopener">issue</a>中有coder完成了这项功能，在这里贴上。感谢作者<a href="https://github.com/nkovacs" target="_blank" rel="noopener">nkovacs</a>。当然作者提交了pr，当被拒绝了，主要是维护者认为库的注册方式是链式调用函数，他们认为在Go中不太常使用，更为常见的是使用的是<code>函数选择模式</code>，这在我之前的博客有讲解过（竟然又见了）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">h := gousb.Hotplug().Enumerate().ProductID(<span class="number">0x1234</span>).Register(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>因为主库没有合并这个特性，我们直接使用该特性即可，这里我讲主库与这个特性合并了。<a href="https://github.com/younglifestyle/gousb" target="_blank" rel="noopener">库</a>。</p>
<h3><span id="libusb">libusb</span></h3>
<p>很遗憾，这个库是一个Cgo库，也就是需要使用到C库，所以程序并不是一个无依赖，可直接单文件使用的库，这里我们需要安装库——<a href="http://sourceforge.net/projects/libusb/files/libusb-1.0/" target="_blank" rel="noopener">libusb</a>。</p>
<p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 准备条件</span><br><span class="line">sudo apt-get install gcc</span><br><span class="line">sudo apt-get install libudev-dev</span><br><span class="line"></span><br><span class="line">// 进入安装包解压目录中，使用root权限编译</span><br><span class="line">./configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>若需要程序运行到其他平台，则需要配置交叉编译工具链。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ./configure --build=i686-linux --host=arm-linux CC=/xxxx/xxxx-linux-gn</span><br><span class="line">u-gcc CXX=/xxxx/xxxxx-linux-gnu-g++ --disable-udev</span><br></pre></td></tr></table></figure>
<blockquote>
<p>交叉编译中的udev我没有去编译了，要用到hotplug的话，此处是要使能的。</p>
</blockquote>
<h2><span id="举个栗子">举个栗子</span></h2>
<p>使用介绍可以参考<a href="https://godoc.org/github.com/google/gousb" target="_blank" rel="noopener">GoDoc</a>，这里头有两个简单的例子，若使用，则最好清楚函数的为何要填写这些数据。</p>
<p>直接上我写的一个例子，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize a new Context.</span></span><br><span class="line">ctx := gousb.NewContext()</span><br><span class="line"><span class="keyword">defer</span> ctx.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open any device with a given VID/PID using a convenience function.</span></span><br><span class="line">dev, err := ctx.OpenDeviceWithVIDPID(<span class="number">0xba57</span>, <span class="number">0x1001</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Could not open a device: "</span>, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> dev.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detach INTERFACE1 &amp; INTERFACE2</span></span><br><span class="line">fmt.Println(<span class="string">"Set auto-detach"</span>)</span><br><span class="line"><span class="keyword">if</span> err := dev.SetAutoDetach(<span class="literal">true</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"Failed to set auto-detach: %v"</span>, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Switch the configuration to #1</span></span><br><span class="line">cfg, err := dev.Config(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"%s.Config(1): %v \n"</span>, dev, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> cfg.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// In the config #1, claim interface #0 with alt setting #0.</span></span><br><span class="line">intf, err := cfg.Interface(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"%s.Interface(0, 0): %v \n"</span>, cfg, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> intf.Close()</span><br><span class="line"></span><br><span class="line">fmt.Println(intf.Setting.Endpoints)</span><br><span class="line"></span><br><span class="line"><span class="comment">// And in the same interface open endpoint #5 for writing.</span></span><br><span class="line">epOut, err := intf.OutEndpoint(<span class="number">0x02</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"%s.OutEndpoint(0x02): %v"</span>, intf, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(epOut.String())</span><br><span class="line"></span><br><span class="line"><span class="comment">// In this interface open endpoint #6 for reading. 0x81</span></span><br><span class="line">epIn, err := intf.InEndpoint(<span class="number">0x82</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"%s.InEndpoint(0x81): %v"</span>, intf, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(epIn.String())</span><br><span class="line"></span><br><span class="line"><span class="comment">// writeBytes might be smaller than the buffer size if an error occurred. writeBytes might be greater than zero even if err is not nil.</span></span><br><span class="line">writes, err := epOut.Write([]<span class="keyword">byte</span>(<span class="string">`&#123;"xxx":"xxx"&#125;\r`</span>))</span><br><span class="line"><span class="comment">//writes, err := epOut.Write([]byte("123"))</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Write returned an error:"</span>, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"write :"</span>, writes)</span><br><span class="line"></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">20</span>)</span><br><span class="line">readBytes, err := epIn.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Read returned an error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> readBytes == <span class="number">0</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"IN endpoint returned 0 bytes of data."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"read :"</span>, readBytes, <span class="keyword">string</span>(buf))</span><br></pre></td></tr></table></figure>
<h2><span id="解析函数">解析函数</span></h2>
<ul>
<li><code>gousb.NewContext()</code>中的context：</li>
</ul>
<p>Context管理与USB设备通信所需的所有资源。通过Context，用户可以遍历可用的USB设备。</p>
<ul>
<li><code>OpenDeviceWithVIDPID</code>：</li>
</ul>
<p>根据PID和VID打开设备，当设备不存在，则无法打开。还可以循环遍历设备进行打开设备操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var devs []*gousb.Device</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// OpenDevices is used to find the devices to open.</span></span><br><span class="line">devs, err := ctx.OpenDevices(<span class="function"><span class="keyword">func</span><span class="params">(desc *gousb.DeviceDesc)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// After inspecting the descriptor, return true or false depending on whether</span></span><br><span class="line">	<span class="comment">// the device is "interesting" or not.  Any descriptor for which true is returned</span></span><br><span class="line">	<span class="comment">// opens a Device which is retuned in a slice (and must be subsequently closed).</span></span><br><span class="line">	<span class="keyword">if</span> desc.Vendor == gousb.ID(xxxx) &amp;&amp; desc.Product == gousb.ID(xxxx) &#123;</span><br><span class="line">		log.Debugf(<span class="string">"Found device: %v"</span>, desc)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>SetAutoDetach</code>：</li>
</ul>
<p><code>SetAutoDetach</code>启用/禁用自动内核驱动程序分离。 启用auto-detach后，gousb将自动分离接口上的内核驱动程序，并在释放接口时重新挂接它。 默认情况下，在新打开的设备句柄上禁用自动内核驱动程序分离。</p>
<ul>
<li><code>dev.Config(1)</code>：</li>
</ul>
<p>获取配置描述符，这里涉及usb的一些概念，在usb中其实有很多描述符来配置usb的相关属性，和描述usb的相关特性，这里就是通过该函数去获取其中的配置描述符。可以在linux中使用<code>lsusb</code>命令查看到。<br>
<img src="1563335549361.png" alt="1563335549361"></p>
<p>这些是概念，其中参数填<code>1</code>，我们还未搞清楚。</p>
<p>接下来，看代码，配置描述符是具象化在库中的结构体<code>ConfigDesc</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ConfigDesc <span class="keyword">struct</span> &#123;</span><br><span class="line">    Number         <span class="keyword">int</span></span><br><span class="line">    SelfPowered    <span class="keyword">bool</span></span><br><span class="line">    RemoteWakeup   <span class="keyword">bool</span></span><br><span class="line">    MaxPower       Milliamperes</span><br><span class="line">    Interfaces     []InterfaceDesc</span><br><span class="line">    iConfiguration <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而这些数据都在调用<code>OpenDeviceWithVIDPID</code>函数后，被读取到程序中，相应的配置描述符在<code>dev.Desc.Configs</code>中，该变量为<code>map[int]ConfigDesc</code>，而案例中，我只有一个配置描述符，且<code>key</code>为<code>1</code>，所以在程序中直接就给定了。</p>
<ul>
<li><code>cfg.Interface(0, 0)</code>：</li>
</ul>
<p>程序需要透过操作系统的中间层<code>USB controller interface</code>，以此来和device进行交互操作。接口声明并返回USB设备上的接口。 num指定要声明的接口的编号，alt指定该接口的备用设置编号。若指定出错，库会打印出正确的配置信息。</p>
<p><strong>这里的参数时怎么得来的呢</strong>？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(<span class="built_in">len</span>(cfg.Desc.Interfaces), cfg.Desc.Interfaces[<span class="number">0</span>].String())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1    Interface 0 (1 alternate settings)</span></span><br></pre></td></tr></table></figure>
<p>填入<code>interface</code>数组索引，引用其中的第一个<code>alternate settings</code>。根据实际设备上的参数可以得到<code>(0, 0)</code>的传参。</p>
<ul>
<li><code>endpoint</code>：</li>
</ul>
<p>usb中数据传输有个endpoint的概念，可以被认为类似于UDP / IP端口，但数据传输是单向的。端点由Endpoint结构表示，所有定义的端点都可以通过<code>Interface.Setting</code>的Endpoints字段获得。<br>
调用函数返回的结构体中分别含有<code>read</code>或<code>write</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> epNum, endpoints := <span class="keyword">range</span> st.intf.Setting.Endpoints &#123;</span><br><span class="line">	<span class="keyword">if</span> endpoints.Direction == gousb.EndpointDirectionOut &#123;</span><br><span class="line">		st.output, err = st.intf.OutEndpoint(<span class="keyword">int</span>(epNum))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Error(<span class="string">"set outpoint error,"</span>, err)</span><br><span class="line">			st.Close()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		st.input, err = st.intf.InEndpoint(<span class="keyword">int</span>(epNum))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Error(<span class="string">"set inpoint error,"</span>, err)</span><br><span class="line">			st.Close()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>control</code>函数：</li>
</ul>
<p>这里提一下，USB传输可以分为四种传输方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">传输方式</span><br><span class="line">      USB，有四种的传输方式，控制(Control)，同步(isochronous)，中断(interrupt)，大量(bulk)。如果你是从硬件开始来设计整个的系统，你还要正确选择传输的方式，而作为一个驱动程序的书写者，就只需要弄清楚他是采用的什么工作方式就行了，通常所有的传输方式下的主动权都在PC边,也就是host边。</span><br><span class="line">1、控制(Control)方式传输，控制传输是双向传输，数据量通常较小，USB系统软件用来主要进行查询，配置和给USB设备发送通用的命令，控制传输方式可以包括，8，16，32和64字节的数据，这依赖于设备和传输速度，控制传输典型地用在主计算机和USB外设之间的端点(Endpoint)0之间的传输，但是指定供应商的控制传输可能用到其它的端点。</span><br><span class="line"></span><br><span class="line">2、同步(isochronous)方式传输，同步传输提供了确定的带宽和间隔时间（latency)，它被用于时间严格并具有较强容错性的流数据传输，或者用于要求恒定的数据传输率的即时应用中，例如执行即时通话的网络电话应用时，使用同步传输模式是很好的选择，同步数据要求确定的带宽值和确定的最大传输次数，对于同步传输来说，即时的数据传递比完美的精度和数据的完整性更重要一些。</span><br><span class="line"></span><br><span class="line">3、中断(interrupt)方式传输，中断方式传输主要用于定时查询设备是否有中断数据要传输设备的端点模式器的结构决定了它的查询频率，从1到255ms之间，这种传输方式典型的应用在少量的分散的，不可预测数据的传输，键盘，操纵杆和鼠标就属于这一类型中断方式传输是单向的并且对于host，来说只有输入的方式。</span><br><span class="line"></span><br><span class="line">4、大量(bulk)传输，主要应用在数据大量传输传输和接受数据上，同时又没有带宽和间隔时间要求的情况下，要求保证传输，打印机和扫描仪属于这种类型，这种类型的设备适合于传输非常慢和大量被延迟的传输，可以等到所有其它类型的数据的传输完成之后再传输和接收数据。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>USB将其有效的带宽分成各个不同的帧(frame)，每帧通常是1ms时间长，每个设备每帧只能传输一个同步的传输包，在完成了系统的配置信息和连接之后，USB的host就会对不同的传输点和传输方式做一个统筹安排，用来适应整个的USB的带宽，<strong>通常情况下，同步方式和中断方式的传输会占据整个带宽的90%，剩下的就安排给控制方式传输数据。</strong></p>
</blockquote>
<p>函数有为control传输留有函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Device)</span> <span class="title">Control</span><span class="params">(rType <span class="keyword">uint8</span>, request <span class="keyword">uint8</span>, val <span class="keyword">uint16</span>, idx <span class="keyword">uint16</span>, data []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span></span><br></pre></td></tr></table></figure>
<p>参数的填写需要对照数据手册：<a href="http://www.jungo.com/st/support/documentation/windriver/802/wdusb_man_mhtml/node55.html" target="_blank" rel="noopener">USB Control Transfers Overview</a>。这里头就有几张表记录着这些参数的对照。</p>
<h2><span id="热插拔">热插拔</span></h2>
<p>热插拔的使用在这个issue中被介绍，<a href="https://github.com/google/gousb/issues/8" target="_blank" rel="noopener">Hot Plug Support</a>，可以参考，使用也很简单，这插一段简单使用的代码。</p>
<p>值得注意的是，注册热插拔函数后，热插拔函数会自动去扫描USB设备，然后触发注册的热插拔处理函数，也就是说，我的系统有三个usb设备，在注册完函数后，其会被自动调用三次，也就说可以在被触发函数中open设备，<code>evt.DeviceDesc()</code>可以获取<code>pid</code>和<code>vid</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ctx.RegisterHotplug(<span class="function"><span class="keyword">func</span><span class="params">(evt gousb.HotplugEvent)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> evt.Type() == gousb.HotplugEventDeviceArrived &#123;</span><br><span class="line">		fmt.Println(<span class="string">"arrived device"</span>, evt.Type())</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"un-arrived device"</span>, evt.Type())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<div><br><hr><h1 style="margin-top:0.7em; margin-bottom:0.7em"><span id="推荐文章由hexo文章推荐插件驱动">推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></span></h1><ul><li><a href="chunlife.top/2020/04/09/服务器文件分片合并下载/">服务器文件分片合并下载</a></li><li><a href="chunlife.top/2020/04/01/json-tag-中的inline属性/">json tag 中的inline属性</a></li><li><a href="chunlife.top/2020/04/01/json-解析int到string类型中/">json 解析int到string类型中</a></li><li><a href="https://abelsu7.top/2019/11/10/gops-intro/">gops：Go 程序查看和诊断分析工具简介</a></li></ul></div></div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css"><script type="text/javascript" src="/js/donate.js" successtext="复制成功!"></script><a class="pos-f tr3" id="github" href="https://github.com/Kaiyuan/donate-page" arget="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="PayPal"><a href="https://paypal.me/zanghong" target="_blank"></a></li><li id="AliPay" qr="/img/zhifubao.png"></li><li id="WeChat" qr="/img/weixin.png"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>go操作usb</p><p><span>文章作者：</span>小师</p><p><span>发布时间：</span>2019-07-17</p><p><span>最后更新：</span>2022-05-04</p><p><span>原始链接：</span><a href="/2019/07/17/go操作usb/">chunlife.top/2019/07/17/go操作usb/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="chunlife.top/2019/07/17/go操作usb/"></i></span></p><p><span>版权声明：</span>本站所有文章均采用知识共享署名4.0国际许可协议进行许可</p></div><br><div class="tags"><a href="/tags/Go/"><i class="fa fa-tag"></i>Go</a><a href="/tags/Functional-Options-Patter/"><i class="fa fa-tag"></i>Functional Options Patter</a><a href="/tags/函数选择模式/"><i class="fa fa-tag"></i>函数选择模式</a></div><div class="post-nav"><a class="pre" href="/2019/07/17/函数选择模式-Functional-Options-Patter/">函数选择模式(Functional Options Patter)</a><a class="next" href="/2019/07/01/CSDN自动展开chorme插件/">CSDN自动展开chorme插件</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=1.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=1.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=1.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '01eb77bfd18de524243f',
  clientSecret: '8cb336d6c7ac88bcc0ffb29c496f7dafe5c082e3',
  repo: 'younglifestyle.github.io',
  owner: 'younglifestyle',
  admin: ['younglifestyle'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-client="ca-pub-2375091422289560" data-ad-slot="8776143066" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="chunlife.top"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DB/">DB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式服务/">分布式服务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂项/">杂项</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统/">系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程技术/">编程技术</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/高并发/" style="font-size: 15px;">高并发</a> <a href="/tags/6-824/" style="font-size: 15px;">6.824</a> <a href="/tags/MapReduce/" style="font-size: 15px;">MapReduce</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/MIT-6-824/" style="font-size: 15px;">MIT 6.824</a> <a href="/tags/论文/" style="font-size: 15px;">论文</a> <a href="/tags/Axure/" style="font-size: 15px;">Axure</a> <a href="/tags/微信和小程序/" style="font-size: 15px;">微信和小程序</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/macOS/" style="font-size: 15px;">macOS</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/Bigtable/" style="font-size: 15px;">Bigtable</a> <a href="/tags/结构化数据存储系统/" style="font-size: 15px;">结构化数据存储系统</a> <a href="/tags/幂等/" style="font-size: 15px;">幂等</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a> <a href="/tags/CSDN/" style="font-size: 15px;">CSDN</a> <a href="/tags/bilibili源码/" style="font-size: 15px;">bilibili源码</a> <a href="/tags/bilibili-code/" style="font-size: 15px;">bilibili code</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/Gateway/" style="font-size: 15px;">Gateway</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/搭建博客/" style="font-size: 15px;">搭建博客</a> <a href="/tags/github-pages/" style="font-size: 15px;">github pages</a> <a href="/tags/coding-Pages/" style="font-size: 15px;">coding Pages</a> <a href="/tags/A-Scalable-Distributed-File-System/" style="font-size: 15px;">A Scalable Distributed File System</a> <a href="/tags/apidoc/" style="font-size: 15px;">apidoc</a> <a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/Goroutine/" style="font-size: 15px;">Goroutine</a> <a href="/tags/Go-Micro/" style="font-size: 15px;">Go Micro</a> <a href="/tags/调试/" style="font-size: 15px;">调试</a> <a href="/tags/pprof/" style="font-size: 15px;">pprof</a> <a href="/tags/performance/" style="font-size: 15px;">performance</a> <a href="/tags/性能/" style="font-size: 15px;">性能</a> <a href="/tags/go-mod/" style="font-size: 15px;">go mod</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/OpenTrace/" style="font-size: 15px;">OpenTrace</a> <a href="/tags/Prometheus/" style="font-size: 15px;">Prometheus</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/Google-MapReduce/" style="font-size: 15px;">Google MapReduce</a> <a href="/tags/gin/" style="font-size: 15px;">gin</a> <a href="/tags/go-test/" style="font-size: 15px;">go test</a> <a href="/tags/httptest/" style="font-size: 15px;">httptest</a> <a href="/tags/plugin/" style="font-size: 15px;">plugin</a> <a href="/tags/nil-compare-interface/" style="font-size: 15px;">nil compare interface</a> <a href="/tags/fanout/" style="font-size: 15px;">fanout</a> <a href="/tags/fanin/" style="font-size: 15px;">fanin</a> <a href="/tags/基础/" style="font-size: 15px;">基础</a> <a href="/tags/读写文件/" style="font-size: 15px;">读写文件</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/exec/" style="font-size: 15px;">exec</a> <a href="/tags/Google/" style="font-size: 15px;">Google</a> <a href="/tags/lantern/" style="font-size: 15px;">lantern</a> <a href="/tags/chromium-谷歌访问助手/" style="font-size: 15px;">chromium 谷歌访问助手</a> <a href="/tags/goroutine/" style="font-size: 15px;">goroutine</a> <a href="/tags/Goland/" style="font-size: 15px;">Goland</a> <a href="/tags/GRPC/" style="font-size: 15px;">GRPC</a> <a href="/tags/Jetbrains/" style="font-size: 15px;">Jetbrains</a> <a href="/tags/singleflight/" style="font-size: 15px;">singleflight</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/后台运行/" style="font-size: 15px;">后台运行</a> <a href="/tags/nohub/" style="font-size: 15px;">nohub</a> <a href="/tags/Freescale/" style="font-size: 15px;">Freescale</a> <a href="/tags/C语言/" style="font-size: 15px;">C语言</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/文件共享-邮件/" style="font-size: 15px;">文件共享_邮件</a> <a href="/tags/Leaf/" style="font-size: 15px;">Leaf</a> <a href="/tags/mongoDB/" style="font-size: 15px;">mongoDB</a> <a href="/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/tags/事务/" style="font-size: 15px;">事务</a> <a href="/tags/MVCC/" style="font-size: 15px;">MVCC</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/explain/" style="font-size: 15px;">explain</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Gorm/" style="font-size: 15px;">Gorm</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/存储/" style="font-size: 15px;">存储</a> <a href="/tags/索引/" style="font-size: 15px;">索引</a> <a href="/tags/优化/" style="font-size: 15px;">优化</a> <a href="/tags/串口/" style="font-size: 15px;">串口</a> <a href="/tags/PCI/" style="font-size: 15px;">PCI</a> <a href="/tags/翻页/" style="font-size: 15px;">翻页</a> <a href="/tags/QT/" style="font-size: 15px;">QT</a> <a href="/tags/raft/" style="font-size: 15px;">raft</a> <a href="/tags/OpenSSL/" style="font-size: 15px;">OpenSSL</a> <a href="/tags/RSA加密解密/" style="font-size: 15px;">RSA加密解密</a> <a href="/tags/SECS-GEM-Go/" style="font-size: 15px;">SECS/GEM - Go</a> <a href="/tags/SECS-GEM/" style="font-size: 15px;">SECS/GEM</a> <a href="/tags/UDP/" style="font-size: 15px;">UDP</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/GFS/" style="font-size: 15px;">GFS</a> <a href="/tags/The-Google-File-System/" style="font-size: 15px;">The Google File System</a> <a href="/tags/ARM/" style="font-size: 15px;">ARM</a> <a href="/tags/Tiny6410/" style="font-size: 15px;">Tiny6410</a> <a href="/tags/yapi/" style="font-size: 15px;">yapi</a> <a href="/tags/函数/" style="font-size: 15px;">函数</a> <a href="/tags/bufio/" style="font-size: 15px;">bufio</a> <a href="/tags/ReadLine-ReadBytes/" style="font-size: 15px;">ReadLine - ReadBytes</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/08/18/桌面客户端Golang-Wails快速开发/">桌面客户端Golang-Wails快速开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/11/15/SECS-GEM-Golang解包、封包库/">SECS/GEM-Golang解包、封包库</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/18/Go语言实现HTTP到gRPC请求转换的最简单方法/">Go语言实现HTTP到gRPC请求转换的最简单方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/04/01/自动mock-grpc服务/">自动mock grpc服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/02/22/SECS-GEM协议学习/">SECS/GEM协议学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/27/Golang-oracle使用/">Golang oracle使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/21/Yapi的安装以及使用/">Yapi的安装以及使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/24/MySQL-实战45讲-学习笔记/">MySQL 实战45讲 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/16/go-kratos写代码浅记/">go-kratos写代码浅记</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/09/proto管理之submodule/">proto管理之submodule</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://purelife.gitbook.io/little-design-powerpoint/" title="PowerPoint设计小册" target="_blank">PowerPoint设计小册</a><ul></ul><a href="https://masuit.com" title="懒得勤快的博客" target="_blank">懒得勤快的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">Pure Life.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>